{"version":3,"file":"index.es.js","sources":["src/index.js"],"sourcesContent":["import karas from 'karas';\nimport { loadSceneAsync, MarsPlayer, RI } from '@alipay/mars-player';\nimport { version } from '../package.json';\n\nconst {\n  refresh: {\n    level: {\n      CACHE,\n    },\n    webgl: {\n      drawTextureCache,\n    },\n  },\n  math: {\n    matrix: {\n      calRectPoint,\n    },\n  },\n  util: {\n    isNil,\n  },\n  mode: {\n    CANVAS,\n    WEBGL,\n  },\n  inject,\n} = karas;\n\nconst r2d = 180 / Math.PI;\n\nconst vertexSimple = `\nprecision lowp float;\nattribute vec2 aPos;\nvoid main(){ gl_Position = vec4(aPos,.0,1.);}\n`;\nconst fragmentSimple = `\nprecision lowp float;\nvoid main(){ gl_FragColor = vec4(1.);}\n`;\n\nfunction mapRange(p, min, max) {\n  return p === 0 ? 0 : min + (max - min) * p;\n}\n\nclass $ extends karas.Geom {\n  scene = null;\n  playOptions = null;\n  mp = null;\n  timeDelta = 0;\n  playbackRate = 1;\n\n  constructor(tagName, props) {\n    super(tagName, props);\n  }\n\n  render(renderMode, ctx, dx, dy) {\n    let res = super.render(renderMode, ctx, dx, dy);\n    if(res.break) {\n      return res;\n    }\n    let root = this.__root;\n    if(renderMode !== root.__renderMode || renderMode !== WEBGL) {\n      return res;\n    }\n    let scene = this.scene;\n    let gl = ctx;\n    if(scene) {\n      let mp = this.mp;\n      if(!mp) {\n        gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);\n        mp = this.mp = new MarsPlayer({\n          gl,\n          manualRender: true,\n        });\n        this.gpu = mp.renderer.gpu;\n        this.renderState = mp.renderer.internal.state;\n        this.defaultMtl = new RI.Material({\n          name: 'defMtl',\n          shader: {\n            vertex: vertexSimple,\n            fragment: fragmentSimple,\n            shared: true,\n          },\n          states: {\n            blending: true,\n            blendSrc: gl.ONE,\n            blendSrcAlpha: gl.ONE,\n            blendDst: gl.ONE_MINUS_SRC_ALPHA,\n            blendDstAlpha: gl.ONE_MINUS_SRC_ALPHA,\n            depthMask: true,\n            depthTest: false,\n            cullFaceEnabled: false,\n            frontFace: gl.CCW,\n            stencilTest: false,\n            polygonOffsetFill: false,\n            polygonOffset: [1, 0],\n          },\n        }).assignRenderer(mp.renderer);\n        this.renderState.bindFramebuffer(gl.FRAMEBUFFER, null);\n        this.renderState.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\n        this.renderState.noCache = true;\n\n        if(!this.host.blend) {\n          this.renderState.disable(RI.constants.BLEND);\n        }\n        let flipY = gl.getParameter(gl.UNPACK_FLIP_Y_WEBGL);\n        let premultiply = gl.getParameter(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL);\n        let program = gl.getParameter(gl.CURRENT_PROGRAM);\n        gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);\n        let activeTexIndex = gl.getParameter(gl.ACTIVE_TEXTURE);\n        let originTexture = gl.getParameter(gl.TEXTURE_BINDING_2D);\n\n        let composition = this.composition = mp.initializeComposition(scene, {\n          onEnd: () => {},\n          keepResource: false,\n          willReverseTime: false,\n          ...this.playOptions,\n        });\n        let onComp = () => {\n          composition.start();\n          if (originTexture) {\n            gl.bindTexture(gl.TEXTURE_2D, originTexture);\n          }\n          gl.activeTexture(activeTexIndex);\n          composition.camera = {\n            aspect: this.width / this.height,\n          };\n          this.renderState.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, +premultiply);\n          this.renderState.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, +flipY);\n          this.renderState.useProgram(null);\n          gl.useProgram(program);\n          scene.textures = void 0;\n        };\n        onComp();\n      }\n      let comp = this.composition;\n      let renderer = comp && comp.renderer;\n      if(renderer && !renderer.isDestroyed && !mp.paused) {\n        this._updateTransform();\n        this._updateComposition();\n        let bit = RI.constants.STENCIL_BUFFER_BIT;\n        if(this.host.clearDepth) {\n          bit = bit | RI.constants.DEPTH_BUFFER_BIT;\n        }\n        this.renderState.clear(bit);\n        comp.renderFrame.render();\n      }\n      this._reset(ctx);\n    }\n  }\n\n  _updateTransform() {\n    let parent = this.domParent;\n    let comp = this.composition;\n    let point = this.project3DPoint(comp.camera);\n    let scaleX = parent.getStyle('scaleX'),\n      scaleY = parent.getStyle('scaleY'),\n      rotateZ = parent.getStyle('rotateZ');\n    let env = this.env;\n    if (this.playOptions && this.playOptions.transform) {\n      comp.rootTransform.setTransform({\n        // position: point,\n        // scale: [scaleX * this.width / env.width, scaleY * this.height / env.height, 1],\n        // rotation: [0, 0, rotateZ],\n        ...this.playOptions.transform,\n      });\n    }\n  }\n\n  _updateComposition() {\n    let comp = this.composition;\n    if(comp.shouldRestart) {\n      comp.restart();\n      comp.tick(0);\n    }\n    else if(!comp.shouldDestroy) {\n      let dt = Math.min(this.timeDelta || 0, 33) * this.playbackRate;\n      comp.tick(dt);\n    }\n  }\n\n  _reset(gl) {\n    gl.useProgram(gl.program);\n    gl.enable(gl.BLEND);\n    gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\n    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, 1);\n    gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);\n    this.aliasRenderState();\n  }\n\n  aliasRenderState() {\n    let mtl = this.defaultMtl.materialInternal;\n    if(mtl && mtl.renderer.state) {\n      let marsRenderState = this.renderState;\n      marsRenderState._reset();\n      mtl.setupStates();\n      delete marsRenderState._dict[RI.constants.BLEND];\n      marsRenderState.depthMask(false);\n      marsRenderState.activeTexture(RI.constants.TEXTURE0);\n    }\n  }\n\n  project3DPoint(camera, z = 0) {\n    let parent = this.domParent;\n    let x1 = this.x, y1 = this.y,\n      translateX = parent.getStyle('translateX'),\n      translateY = parent.getStyle('translateY');\n    let pos = camera.position;\n    let pw = this.width, ph = this.height;\n    let fov = Math.tan(camera.fov / r2d / 2);\n    let depth = pos[2] - z;\n    let width, height;\n    if(camera.clipMode) {\n      width = fov * depth;\n      height = width * ph / pw;\n    }\n    else {\n      height = fov * depth;\n      width = height * pw / ph;\n    }\n    let x = (x1 + translateX) / pw;\n    let y = (y1 + translateY) / ph;\n    return [mapRange(x, -width, width) + pos[0], mapRange(y, -height, height) + pos[1], z];\n  }\n}\n\nclass Mars extends karas.Component {\n  isPlay = false;\n  isLoaded = false;\n  __playbackRate = 1;\n  clearDepth = false;\n  blend = false;\n\n  constructor(props) {\n    super(props);\n    this.isPlay = props.autoPlay !== false;\n    this.__playbackRate = props.playbackRate || 1;\n    this.clearDepth = !!props.clearDepth;\n    this.blend = !!props.blend;\n  }\n\n  componentDidMount() {\n    this.load();\n\n    let { autoPlay = true } = this.props;\n    this.cb = timeDelta => {\n      fake.timeDelta = timeDelta;\n      if(this.isPlay && this.isLoaded) {\n        fake.refresh();\n      }\n    }\n    let fake = this.ref.fake;\n    fake.playbackRate = this.__playbackRate;\n    if(autoPlay) {\n      fake.frameAnimate(this.cb);\n    }\n  }\n\n  componentWillUnmount() {\n    const mp = this.ref.fake.mp;\n    mp && mp.destroy(true);\n  }\n\n  load() {\n    let url = this.props.url;\n    if(!url) {\n      return;\n    }\n    let request = new XMLHttpRequest();\n    request.open('get', url, true);\n    request.responseType = 'json';\n    request.onload = () => {\n      if(request.response) {\n        this.isLoaded = true;\n        let json = request.response;\n        loadSceneAsync(json, {\n          ...this.props?.loadOptions\n        }).then(scene => {\n          this.props.onLoad?.();\n          this.playAnimation(scene);\n        });\n      }\n    };\n    request.send();\n  }\n\n  playAnimation(scene) {\n    let fake = this.ref.fake;\n    fake.scene = scene;\n    fake.playOptions = this.props?.playOptions;\n    // 第一帧强制显示\n    fake.refresh();\n  }\n\n  render() {\n    return <div>\n      <$ ref=\"fake\" style={{\n        width: '100%',\n        height: '100%',\n        fill: 'none',\n        stroke: 0,\n      }}/>\n    </div>;\n  }\n\n  play() {\n    this.pause();\n    let comp = this.ref.fake.composition;\n    if(comp) {\n      comp.restart();\n      comp.tick(0);\n    }\n    this.resume();\n  }\n\n  pause() {\n    this.ref.fake.removeFrameAnimate(this.cb);\n  }\n\n  resume() {\n    this.ref.fake.frameAnimate(this.cb);\n  }\n\n  get playbackRate() {\n    return this.__playbackRate;\n  }\n\n  set playbackRate(v) {\n    v = parseFloat(v) || 1;\n    if(v <= 0) {\n      v = 1;\n    }\n    this.__playbackRate = v;\n    if (this.ref.fake) {\n      this.ref.fake.playbackRate = v;\n    }\n  }\n}\n\nMars.version = version;\n\nexport default Mars;\n"],"names":["_karas$refresh","karas","refresh","CACHE","level","drawTextureCache","webgl","calRectPoint","math","matrix","isNil","util","_karas$mode","mode","CANVAS","WEBGL","inject","r2d","Math","PI","vertexSimple","fragmentSimple","mapRange","p","min","max","$","_karas$Geom","_inherits","tagName","props","_this","call","_defineProperty","_assertThisInitialized","_createClass","key","value","render","renderMode","ctx","dx","dy","_this2","res","_get","_getPrototypeOf","prototype","root","__root","__renderMode","scene","gl","mp","pixelStorei","UNPACK_PREMULTIPLY_ALPHA_WEBGL","MarsPlayer","manualRender","gpu","renderer","renderState","internal","state","defaultMtl","RI","Material","name","shader","vertex","fragment","shared","states","blending","blendSrc","ONE","blendSrcAlpha","blendDst","ONE_MINUS_SRC_ALPHA","blendDstAlpha","depthMask","depthTest","cullFaceEnabled","frontFace","CCW","stencilTest","polygonOffsetFill","polygonOffset","assignRenderer","bindFramebuffer","FRAMEBUFFER","noCache","host","blend","disable","constants","BLEND","flipY","getParameter","UNPACK_FLIP_Y_WEBGL","premultiply","program","CURRENT_PROGRAM","activeTexIndex","ACTIVE_TEXTURE","originTexture","TEXTURE_BINDING_2D","composition","initializeComposition","_objectSpread","onEnd","keepResource","willReverseTime","playOptions","onComp","start","bindTexture","TEXTURE_2D","activeTexture","camera","aspect","width","height","useProgram","textures","comp","isDestroyed","paused","_updateTransform","_updateComposition","bit","STENCIL_BUFFER_BIT","clearDepth","DEPTH_BUFFER_BIT","clear","renderFrame","_reset","parent","domParent","project3DPoint","getStyle","scaleY","rotateZ","env","transform","rootTransform","setTransform","shouldRestart","restart","tick","shouldDestroy","dt","timeDelta","playbackRate","enable","blendFunc","aliasRenderState","mtl","materialInternal","marsRenderState","setupStates","_dict","TEXTURE0","z","arguments","length","undefined","x1","x","y1","y","translateX","translateY","pos","position","pw","ph","fov","tan","depth","clipMode","Geom","Mars","_karas$Component","_this3","isPlay","autoPlay","__playbackRate","componentDidMount","_this4","load","_this$props$autoPlay","cb","fake","isLoaded","ref","frameAnimate","componentWillUnmount","destroy","_this5","url","request","XMLHttpRequest","open","responseType","onload","response","_this5$props","json","loadSceneAsync","loadOptions","then","_this5$props$onLoad","_this5$props2","onLoad","playAnimation","send","_this$props","createElement","style","fill","stroke","play","pause","resume","removeFrameAnimate","get","set","v","parseFloat","Component","version"],"mappings":"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"}