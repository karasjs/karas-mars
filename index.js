(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory(require('karas')) :
  typeof define === 'function' && define.amd ? define(['karas'], factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.Mars = factory(global.karas));
})(this, (function (karas) { 'use strict';

  function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

  var karas__default = /*#__PURE__*/_interopDefaultLegacy(karas);

  function _defineProperties$1(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, _toPropertyKey$1(descriptor.key), descriptor);
    }
  }
  function _createClass$1(Constructor, protoProps, staticProps) {
    if (protoProps) _defineProperties$1(Constructor.prototype, protoProps);
    if (staticProps) _defineProperties$1(Constructor, staticProps);
    Object.defineProperty(Constructor, "prototype", {
      writable: false
    });
    return Constructor;
  }
  function _defineProperty(obj, key, value) {
    key = _toPropertyKey$1(key);
    if (key in obj) {
      Object.defineProperty(obj, key, {
        value: value,
        enumerable: true,
        configurable: true,
        writable: true
      });
    } else {
      obj[key] = value;
    }
    return obj;
  }
  function _inherits(subClass, superClass) {
    if (typeof superClass !== "function" && superClass !== null) {
      throw new TypeError("Super expression must either be null or a function");
    }
    subClass.prototype = Object.create(superClass && superClass.prototype, {
      constructor: {
        value: subClass,
        writable: true,
        configurable: true
      }
    });
    Object.defineProperty(subClass, "prototype", {
      writable: false
    });
    if (superClass) _setPrototypeOf$1(subClass, superClass);
  }
  function _getPrototypeOf(o) {
    _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf.bind() : function _getPrototypeOf(o) {
      return o.__proto__ || Object.getPrototypeOf(o);
    };
    return _getPrototypeOf(o);
  }
  function _setPrototypeOf$1(o, p) {
    _setPrototypeOf$1 = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {
      o.__proto__ = p;
      return o;
    };
    return _setPrototypeOf$1(o, p);
  }
  function _assertThisInitialized(self) {
    if (self === void 0) {
      throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
    }
    return self;
  }
  function _superPropBase(object, property) {
    while (!Object.prototype.hasOwnProperty.call(object, property)) {
      object = _getPrototypeOf(object);
      if (object === null) break;
    }
    return object;
  }
  function _get() {
    if (typeof Reflect !== "undefined" && Reflect.get) {
      _get = Reflect.get.bind();
    } else {
      _get = function _get(target, property, receiver) {
        var base = _superPropBase(target, property);
        if (!base) return;
        var desc = Object.getOwnPropertyDescriptor(base, property);
        if (desc.get) {
          return desc.get.call(arguments.length < 3 ? target : receiver);
        }
        return desc.value;
      };
    }
    return _get.apply(this, arguments);
  }
  function _toPrimitive$1(input, hint) {
    if (typeof input !== "object" || input === null) return input;
    var prim = input[Symbol.toPrimitive];
    if (prim !== undefined) {
      var res = prim.call(input, hint || "default");
      if (typeof res !== "object") return res;
      throw new TypeError("@@toPrimitive must return a primitive value.");
    }
    return (hint === "string" ? String : Number)(input);
  }
  function _toPropertyKey$1(arg) {
    var key = _toPrimitive$1(arg, "string");
    return typeof key === "symbol" ? key : String(key);
  }

  var prefix$1="[Mars Player]";var _log$1=console.log.bind(console);var _warn=console.warn.bind(console);var _error=console.error.bind(console);function inspectLogger(log,warn,error){if(log){_log$1=log;}if(warn){_warn=warn;}if(error){_error=error;}}function consoleLog$1(msg){for(var _len=arguments.length,data=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){data[_key-1]=arguments[_key];}_log$1.apply(void 0,[prefix$1+msg].concat(data));}function consoleWarn$1(msg){for(var _len2=arguments.length,data=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){data[_key2-1]=arguments[_key2];}_warn.apply(void 0,[prefix$1+msg].concat(data));}function consoleError$1(msg){for(var _len3=arguments.length,data=new Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++){data[_key3-1]=arguments[_key3];}_error.apply(void 0,[prefix$1+msg].concat(data));}function _regeneratorRuntime(){_regeneratorRuntime=function(){return exports};var exports={},Op=Object.prototype,hasOwn=Op.hasOwnProperty,defineProperty=Object.defineProperty||function(obj,key,desc){obj[key]=desc.value;},$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){return Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}),obj[key]}try{define({},"");}catch(err){define=function(obj,key,value){return obj[key]=value};}function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator,generator=Object.create(protoGenerator.prototype),context=new Context(tryLocsList||[]);return defineProperty(generator,"_invoke",{value:makeInvokeMethod(innerFn,self,context)}),generator}function tryCatch(fn,obj,arg){try{return {type:"normal",arg:fn.call(obj,arg)}}catch(err){return {type:"throw",arg:err}}}exports.wrap=wrap;var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};define(IteratorPrototype,iteratorSymbol,(function(){return this}));var getProto=Object.getPrototypeOf,NativeIteratorPrototype=getProto&&getProto(getProto(values([])));NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)&&(IteratorPrototype=NativeIteratorPrototype);var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);function defineIteratorMethods(prototype){["next","throw","return"].forEach((function(method){define(prototype,method,(function(arg){return this._invoke(method,arg)}));}));}function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value&&"object"==typeof value&&hasOwn.call(value,"__await")?PromiseImpl.resolve(value.__await).then((function(value){invoke("next",value,resolve,reject);}),(function(err){invoke("throw",err,resolve,reject);})):PromiseImpl.resolve(value).then((function(unwrapped){result.value=unwrapped,resolve(result);}),(function(error){return invoke("throw",error,resolve,reject)}))}reject(record.arg);}var previousPromise;defineProperty(this,"_invoke",{value:function(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl((function(resolve,reject){invoke(method,arg,resolve,reject);}))}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}});}function makeInvokeMethod(innerFn,self,context){var state="suspendedStart";return function(method,arg){if("executing"===state)throw new Error("Generator is already running");if("completed"===state){if("throw"===method)throw arg;return doneResult()}for(context.method=method,context.arg=arg;;){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if("next"===context.method)context.sent=context._sent=context.arg;else if("throw"===context.method){if("suspendedStart"===state)throw state="completed",context.arg;context.dispatchException(context.arg);}else "return"===context.method&&context.abrupt("return",context.arg);state="executing";var record=tryCatch(innerFn,self,context);if("normal"===record.type){if(state=context.done?"completed":"suspendedYield",record.arg===ContinueSentinel)continue;return {value:record.arg,done:context.done}}"throw"===record.type&&(state="completed",context.method="throw",context.arg=record.arg);}}}function maybeInvokeDelegate(delegate,context){var methodName=context.method,method=delegate.iterator[methodName];if(undefined===method)return context.delegate=null,"throw"===methodName&&delegate.iterator.return&&(context.method="return",context.arg=undefined,maybeInvokeDelegate(delegate,context),"throw"===context.method)||"return"!==methodName&&(context.method="throw",context.arg=new TypeError("The iterator does not provide a '"+methodName+"' method")),ContinueSentinel;var record=tryCatch(method,delegate.iterator,context.arg);if("throw"===record.type)return context.method="throw",context.arg=record.arg,context.delegate=null,ContinueSentinel;var info=record.arg;return info?info.done?(context[delegate.resultName]=info.value,context.next=delegate.nextLoc,"return"!==context.method&&(context.method="next",context.arg=undefined),context.delegate=null,ContinueSentinel):info:(context.method="throw",context.arg=new TypeError("iterator result is not an object"),context.delegate=null,ContinueSentinel)}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry);}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record;}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0);}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;)if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;return next.value=undefined,next.done=!0,next};return next.next=next}}return {next:doneResult}}function doneResult(){return {value:undefined,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,defineProperty(Gp,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),defineProperty(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction"),exports.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return !!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name))},exports.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,define(genFun,toStringTagSymbol,"GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun},exports.awrap=function(arg){return {__await:arg}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,asyncIteratorSymbol,(function(){return this})),exports.AsyncIterator=AsyncIterator,exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){void 0===PromiseImpl&&(PromiseImpl=Promise);var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then((function(result){return result.done?result.value:iter.next()}))},defineIteratorMethods(Gp),define(Gp,toStringTagSymbol,"Generator"),define(Gp,iteratorSymbol,(function(){return this})),define(Gp,"toString",(function(){return "[object Generator]"})),exports.keys=function(val){var object=Object(val),keys=[];for(var key in object)keys.push(key);return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next}return next.done=!0,next}},exports.values=values,Context.prototype={constructor:Context,reset:function(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this)"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined);},stop:function(){this.done=!0;var rootRecord=this.tryEntries[0].completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval},dispatchException:function(exception){if(this.done)throw exception;var context=this;function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,caught&&(context.method="next",context.arg=undefined),!!caught}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0)}else {if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?(this.method="next",this.next=finallyEntry.finallyLoc,ContinueSentinel):this.complete(record)},complete:function(record,afterLoc){if("throw"===record.type)throw record.arg;return "break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=this.arg=record.arg,this.method="return",this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc),ContinueSentinel},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),resetTryEntry(entry),ContinueSentinel}},catch:function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry);}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},"next"===this.method&&(this.arg=undefined),ContinueSentinel}},exports}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return}if(info.done){resolve(value);}else {Promise.resolve(value).then(_next,_throw);}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);}))}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor}function _extends(){_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target};return _extends.apply(this,arguments)}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _createForOfIteratorHelperLoose(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(it)return (it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;return function(){if(i>=o.length)return {done:true};return {done:false,value:o[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _toPrimitive(input,hint){if(typeof input!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(typeof res!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return (hint==="string"?String:Number)(input)}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return typeof key==="symbol"?key:String(key)}var RENDER_PREFER_LOOKUP_TEXTURE="lookup_texture";var LOAD_PREFER_IMAGE_BITMAP="load_image_bitmap";var TEMPLATE_USE_OFFSCREEN_CANVAS="offscreen_canvas";if(typeof __MarsConfig__==="undefined"){if(typeof window==="object"){window.__MarsConfig__={};}else {global.__MarsConfig__={};}}var config=__MarsConfig__;function getConfig(name){return config[name]}function setConfig(name,value){return config[name]=value}var _objAssign=Object.assign;function objAssign(target,source1,source2,source3){var _arguments=arguments;if(_objAssign){return _objAssign.apply(this,arguments)}var _loop=function _loop(){var obj=_arguments[i];if(obj){Object.keys(obj).forEach((function(key){target[key]=obj[key];}));}};for(var i=1;i<arguments.length;i++){_loop();}return target}var imageBitMapAvailable$2=typeof createImageBitmap==="function";function closeImageBitMap$1(img){if(imageBitMapAvailable$2){if(img instanceof ImageBitmap){img.close();}else if(img instanceof Array){img.forEach(closeImageBitMap$1);}}}function loadImageWithTypeAsync(url){return requestAsync$1(url,{responseType:"blob"}).then((function(blob){return loadImageAsync$1(blob).then((function(image){return {image:image,url:url,type:blob.type}}))}))}function loadImageAsync$1(img,noBitmap){var url;var revokeURL;if(img instanceof Blob){if(imageBitMapAvailable$2&&getConfig(LOAD_PREFER_IMAGE_BITMAP));url=URL.createObjectURL(img);revokeURL=true;}else if(imageBitMapAvailable$2&&img instanceof ImageBitmap);else if(img instanceof HTMLImageElement){if(img.complete){return Promise.resolve(img)}url=img.src;}else if(typeof img==="string"){url=img;}if(url){if(imageBitMapAvailable$2&&getConfig(LOAD_PREFER_IMAGE_BITMAP)&&!noBitmap){return requestAsync$1(url,{responseType:"blob"}).then((function(blob){return createImageBitmap(blob)})).catch((function(e){throw Error("load image fail:"+url)}))}var _img=new Image;if(!/^data:/.test(url)){_img.crossOrigin="*";}_img.src=url;return new Promise((function(resolve,reject){_img.onload=function(){_img.onload=null;if(revokeURL){URL.revokeObjectURL(url);}return resolve(_img)};_img.onerror=function(err){_img.onerror=null;if(revokeURL){URL.revokeObjectURL(url);}return reject(Error("load image fail:"+url))};}))}return Promise.reject(Error("invalid url type "+img))}function arrRemove$1(arr,ele){var idx=arr.indexOf(ele);if(idx>-1){arr.splice(idx,1);return true}return false}function arrAdd$1(arr,item){if(!arr.includes(item)){arr.push(item);return true}return false}var hasOwnProperty$1=Object.prototype.hasOwnProperty;function forEach$1(object,callback,thisObj){if(isObj$1(object)){if(thisObj===undefined){thisObj=object;}if(object instanceof Array||"length"in object){var len=object.length;for(var i=0;i<len;i++){callback.call(thisObj,object[i],i);}}else {for(var name in object){if(hasOwnProperty$1.call(object,name)){callback.call(thisObj,object[name],name);}}}}return object}function isFunc$1(any){return typeof any==="function"}function isObj$1(any){return typeof any==="object"&&any}function isStr$1(any){return typeof any==="string"}function noop(){}function random(min,max){return min+Math.random()*(max-min)}function randomArrItem(arr,keepArr){var index=Math.floor(Math.random()*arr.length);var item=arr[index];if(!keepArr){arr.splice(index,1);}return item}function requestAsync$1(url,opt){{opt=opt||{};return new Promise((function(resolve,reject){var xhr=new XMLHttpRequest;xhr.responseType=opt.responseType||"json";xhr.addEventListener("load",(function(){return resolve(xhr.response)}));xhr.addEventListener("error",(function(){return reject(Error("load "+url+" fail"))}));xhr.open(opt.method||"get",url);xhr.send(opt.data);}))}}function arrAddWithOrder(arr,item,property,descending){if(arr.includes(item)){return}arr.push(item);if(arr.length===1){return}var index=arr.length-1;if(index){var currentItem=arr[index];if(descending){while(arr[index-1][property]<currentItem[property]){arr[index]=arr[index-1];index--;if(index===0){break}}}else {while(arr[index-1][property]>currentItem[property]){arr[index]=arr[index-1];index--;if(index===0){break}}}arr[index]=currentItem;}}function deepClone(a){if(Array.isArray(a)){return a.map(deepClone)}else if(isObj$1(a)){if(ArrayBuffer.isView(a)){return a.slice()}var ret={};var kas=Object.keys(a);for(var i=0;i<kas.length;i++){var _key=kas[i];ret[_key]=deepClone(a[_key]);}return ret}return a}var toHalf=function(){var floatView=new Float32Array(1);var int32View=new Int32Array(floatView.buffer);return function toHalf(val){floatView[0]=val;var x=int32View[0];var bits=x>>16&32768;var m=x>>12&2047;var e=x>>23&255;if(e<103){return bits}if(e>142){bits|=31744;bits|=(e==255?0:1)&&x&8388607;return bits}if(e<113){m|=2048;bits|=(m>>114-e)+(m>>113-e&1);return bits}bits|=e-112<<10|m>>1;bits+=m&1;return bits}}();var Float16ArrayWrapper=function(){function Float16ArrayWrapper(num){if(Number.isInteger(num)){this.data=new Uint16Array(num);}else if(isObj$1(num)&&Number.isInteger(num.length)){var data=this.data=new Uint16Array(num.length);for(var i=0;i<data.length;i++){data[i]=toHalf(num[i]);}}}var _proto=Float16ArrayWrapper.prototype;_proto.set=function set(number,startIndex){for(var i=0;i<number.length;i++){this.data[i+startIndex]=toHalf(number[i]);}};return Float16ArrayWrapper}();function imageDataFromColor(color){if(isStr$1(color)){color=colorToArr(color);}var image=createImageData(1,1);var data=image.data;for(var i=0;i<4;i++){data[i]=color[i];}return image}function colorStopsFromGradient(gradient){var stops=[];if(gradient instanceof Array){gradient.forEach((function(val){var s=val[0],r=val[1],g=val[2],b=val[3],a=val[4];stops.push({stop:parsePercent(s),color:[r,g,b,a]});}));}else {forEach$1(gradient,(function(colorRGB,stop){var color=colorToArr(colorRGB);stops.push({stop:parsePercent(stop),color:color});}));}stops=stops.sort((function(a,b){return a.stop-b.stop}));if(stops.length){if(stops[0].stop!==0){stops.unshift({stop:0,color:stops[0].color.slice()});}var lastStop=stops[stops.length-1];if(lastStop.stop!==1){stops.push({stop:1,color:lastStop.color.slice()});}}return stops}function createImageData(width,height){return {width:width,height:height,data:new Uint8Array(width*height*4)}}function getColorFromGradientStops(stops,key,normalize){if(stops.length){var _color;for(var j=1;j<=stops.length-1;j++){var s0=stops[j-1];var s1=stops[j];if(s0.stop<=key&&key<=s1.stop){_color=interpolateColor(s0.color,s1.color,(key-s0.stop)/(s1.stop-s0.stop));break}}if(!_color){_color=stops[stops.length-1].color;}return normalize?_color.map((function(n){return n/255})):_color}return [0,0,0,0]}function imageDataFromGradient(gradient){var width=128;var image=createImageData(width,1);var data=image.data;var stops=colorStopsFromGradient(gradient);if(stops.length){data.set(stops[0].color,0);for(var i=1,cursor=0;i<width-1;i++){var index=i/width;var s0=void 0,s1=void 0;for(var j=cursor;j<stops.length;j++){s0=stops[j];s1=stops[j+1];if(s0.stop<=index&&s1.stop>index){break}}var _color2=interpolateColor(s0.color,s1.color,(index-s0.stop)/(s1.stop-s0.stop));data.set(_color2,i*4);}data.set(stops[stops.length-1].color,(width-1)*4);}return image}function interpolateColor(a,b,s,origin){var ret=[];var ms=1-s;if(origin){for(var i=0;i<4;i++){ret[i]=a[i]*ms+b[i]*s;}}else {for(var _i2=0;_i2<3;_i2++){ret[_i2]=Math.round(Math.sqrt(a[_i2]*a[_i2]*ms+b[_i2]*b[_i2]*s));}ret[3]=Math.round(a[3]*ms+b[3]*s);}return ret}function colorToArr(hex,normalized){var ret;if(isStr$1(hex)){hex=hex.replace(/[\s\t\r\n]/g,"");var m=/rgba?\(([.\d]+),([.\d]+),([.\d]+),?([.\d]+)?\)/.exec(hex);if(m){var _a=+m[4];ret=[+m[1],+m[2],+m[3],isNaN(_a)?255:_a*255];}else if(/^#[a-f\d]{3}$/i.test(hex)){ret=[parseInt(hex[1]+hex[1],16),parseInt(hex[2]+hex[2],16),parseInt(hex[3]+hex[3],16),255];}else if(m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)){ret=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16),255]||[0,0,0,255];}}else if(hex instanceof Array){ret=[hex[0],hex[1],hex[2],isNaN(hex[3])?255:hex[3]];}if(normalized){for(var i=0;i<4;i++){ret[i]/=255;}}return ret}function parsePercent(c){var match=/^(-)?([\d+.]+)%$/.exec(c);if(match){return +match[2]/100*(match[1]?-1:1)}return +c}
  /*!
   * Name: @ali/specification
   * Description: Mars JSON Specification
   * Author: zbr80259@alibaba-inc.com
   * Version: v1.6.6
   */var RenderLevel;(function(RenderLevel){RenderLevel["S"]="S";RenderLevel["APlus"]="A+";RenderLevel["A"]="A";RenderLevel["BPlus"]="B+";RenderLevel["B"]="B";})(RenderLevel||(RenderLevel={}));var BlendingMode;(function(BlendingMode){BlendingMode[BlendingMode["alpha"]=0]="alpha";BlendingMode[BlendingMode["ADD"]=1]="ADD";BlendingMode[BlendingMode["MULTIPLY"]=2]="MULTIPLY";BlendingMode[BlendingMode["BRIGHTNESS"]=3]="BRIGHTNESS";BlendingMode[BlendingMode["SUBTRACTION"]=4]="SUBTRACTION";BlendingMode[BlendingMode["STRONG_LIGHT"]=5]="STRONG_LIGHT";BlendingMode[BlendingMode["WEAK_LIGHT"]=6]="WEAK_LIGHT";BlendingMode[BlendingMode["SUPERPOSITION"]=7]="SUPERPOSITION";})(BlendingMode||(BlendingMode={}));var SideMode;(function(SideMode){SideMode[SideMode["DOUBLE"]=1032]="DOUBLE";SideMode[SideMode["FRONT"]=1028]="FRONT";SideMode[SideMode["BACK"]=1029]="BACK";})(SideMode||(SideMode={}));var MaskMode;(function(MaskMode){MaskMode[MaskMode["NONE"]=0]="NONE";MaskMode[MaskMode["MASK"]=1]="MASK";MaskMode[MaskMode["OBSCURED"]=2]="OBSCURED";MaskMode[MaskMode["REVERSE_OBSCURED"]=3]="REVERSE_OBSCURED";})(MaskMode||(MaskMode={}));var ShapeType;(function(ShapeType){ShapeType[ShapeType["NONE"]=0]="NONE";ShapeType[ShapeType["SPHERE"]=1]="SPHERE";ShapeType[ShapeType["CONE"]=2]="CONE";ShapeType[ShapeType["HEMISPHERE"]=3]="HEMISPHERE";ShapeType[ShapeType["CIRCLE"]=4]="CIRCLE";ShapeType[ShapeType["DONUT"]=5]="DONUT";ShapeType[ShapeType["RECTANGLE"]=6]="RECTANGLE";ShapeType[ShapeType["RECTANGLE_EDGE"]=7]="RECTANGLE_EDGE";ShapeType[ShapeType["RECTANGLEEDGE"]=7]="RECTANGLEEDGE";ShapeType[ShapeType["EDGE"]=8]="EDGE";ShapeType[ShapeType["TEXTURE"]=9]="TEXTURE";})(ShapeType||(ShapeType={}));var PluginType;(function(PluginType){PluginType[PluginType["GYROSCOPE"]=0]="GYROSCOPE";PluginType[PluginType["SPINE"]=1]="SPINE";})(PluginType||(PluginType={}));var InteractType;(function(InteractType){InteractType[InteractType["CLICK"]=0]="CLICK";InteractType[InteractType["MESSAGE"]=1]="MESSAGE";InteractType[InteractType["DRAG"]=2]="DRAG";})(InteractType||(InteractType={}));var InteractBehavior;(function(InteractBehavior){InteractBehavior[InteractBehavior["NONE"]=0]="NONE";InteractBehavior[InteractBehavior["NOTIFY"]=1]="NOTIFY";InteractBehavior[InteractBehavior["RESUME_PLAYER"]=2]="RESUME_PLAYER";InteractBehavior[InteractBehavior["REMOVE"]=3]="REMOVE";InteractBehavior[InteractBehavior["PAUSE"]=4]="PAUSE";})(InteractBehavior||(InteractBehavior={}));var ItemType;(function(ItemType){ItemType["base"]="0";ItemType["sprite"]="1";ItemType["particle"]="2";ItemType["null"]="3";ItemType["interact"]="4";ItemType["plugin"]="5";ItemType["camera"]="6";ItemType["composition"]="7";ItemType["filter"]="8";ItemType["spine"]="spine";})(ItemType||(ItemType={}));var RenderMode;(function(RenderMode){RenderMode[RenderMode["BILLBOARD"]=0]="BILLBOARD";RenderMode[RenderMode["MESH"]=1]="MESH";RenderMode[RenderMode["VERTICAL_BILLBOARD"]=2]="VERTICAL_BILLBOARD";RenderMode[RenderMode["HORIZONTAL_BILLBOARD"]=3]="HORIZONTAL_BILLBOARD";})(RenderMode||(RenderMode={}));var ParticleOrigin;(function(ParticleOrigin){ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_CENTER"]=0]="PARTICLE_ORIGIN_CENTER";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_LEFT_TOP"]=1]="PARTICLE_ORIGIN_LEFT_TOP";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_LEFT_CENTER"]=2]="PARTICLE_ORIGIN_LEFT_CENTER";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_LEFT_BOTTOM"]=3]="PARTICLE_ORIGIN_LEFT_BOTTOM";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_CENTER_TOP"]=4]="PARTICLE_ORIGIN_CENTER_TOP";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_CENTER_BOTTOM"]=5]="PARTICLE_ORIGIN_CENTER_BOTTOM";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_RIGHT_TOP"]=6]="PARTICLE_ORIGIN_RIGHT_TOP";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_RIGHT_CENTER"]=7]="PARTICLE_ORIGIN_RIGHT_CENTER";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_RIGHT_BOTTOM"]=8]="PARTICLE_ORIGIN_RIGHT_BOTTOM";})(ParticleOrigin||(ParticleOrigin={}));var END_BEHAVIOR_DESTROY$1=0;var END_BEHAVIOR_PAUSE$1=1;var END_BEHAVIOR_FORWARD$1=2;var END_BEHAVIOR_PAUSE_AND_DESTROY$1=3;var END_BEHAVIOR_FREEZE$1=4;var END_BEHAVIOR_RESTART$1=5;var END_BEHAVIOR_DESTROY_CHILDREN$1=6;var CAMERA_CLIP_MODE_VERTICAL$1=1;var CAMERA_CLIP_MODE_NORMAL$1=0;var CameraClipMode;(function(CameraClipMode){CameraClipMode[CameraClipMode["portrait"]=CAMERA_CLIP_MODE_VERTICAL$1]="portrait";CameraClipMode[CameraClipMode["landscape"]=CAMERA_CLIP_MODE_NORMAL$1]="landscape";})(CameraClipMode||(CameraClipMode={}));var CompositionEndBehavior;(function(CompositionEndBehavior){CompositionEndBehavior[CompositionEndBehavior["destroy"]=END_BEHAVIOR_DESTROY$1]="destroy";CompositionEndBehavior[CompositionEndBehavior["pause"]=END_BEHAVIOR_PAUSE$1]="pause";CompositionEndBehavior[CompositionEndBehavior["restart"]=END_BEHAVIOR_RESTART$1]="restart";CompositionEndBehavior[CompositionEndBehavior["forward"]=END_BEHAVIOR_FORWARD$1]="forward";CompositionEndBehavior[CompositionEndBehavior["pause_destroy"]=END_BEHAVIOR_PAUSE_AND_DESTROY$1]="pause_destroy";})(CompositionEndBehavior||(CompositionEndBehavior={}));var TextOverflow;(function(TextOverflow){TextOverflow[TextOverflow["display"]=0]="display";TextOverflow[TextOverflow["clip"]=1]="clip";TextOverflow[TextOverflow["ellipsis"]=2]="ellipsis";})(TextOverflow||(TextOverflow={}));var TextAlignment;(function(TextAlignment){TextAlignment[TextAlignment["left"]=0]="left";TextAlignment[TextAlignment["middle"]=1]="middle";TextAlignment[TextAlignment["right"]=2]="right";})(TextAlignment||(TextAlignment={}));var FontStyle;(function(FontStyle){FontStyle[FontStyle["normal"]=0]="normal";FontStyle[FontStyle["italic"]=1]="italic";FontStyle[FontStyle["oblique"]=2]="oblique";})(FontStyle||(FontStyle={}));var ValueType;(function(ValueType){ValueType[ValueType["CONSTANT"]=0]="CONSTANT";ValueType[ValueType["CONSTANT_VEC2"]=1]="CONSTANT_VEC2";ValueType[ValueType["CONSTANT_VEC3"]=2]="CONSTANT_VEC3";ValueType[ValueType["CONSTANT_VEC4"]=3]="CONSTANT_VEC4";ValueType[ValueType["RANDOM"]=4]="RANDOM";ValueType[ValueType["LINE"]=5]="LINE";ValueType[ValueType["CURVE"]=6]="CURVE";ValueType[ValueType["BEZIER_PATH"]=7]="BEZIER_PATH";ValueType[ValueType["RGBA_COLOR"]=8]="RGBA_COLOR";ValueType[ValueType["GRADIENT_COLOR"]=9]="GRADIENT_COLOR";ValueType[ValueType["SHAPE_POINTS"]=10]="SHAPE_POINTS";ValueType[ValueType["SHAPE_SPLITS"]=11]="SHAPE_SPLITS";ValueType[ValueType["LINEAR_PATH"]=12]="LINEAR_PATH";ValueType[ValueType["COLORS"]=13]="COLORS";ValueType[ValueType["BINARY"]=20]="BINARY";})(ValueType||(ValueType={}));var ItemEndBehavior;(function(ItemEndBehavior){ItemEndBehavior[ItemEndBehavior["destroy"]=END_BEHAVIOR_DESTROY$1]="destroy";ItemEndBehavior[ItemEndBehavior["loop"]=END_BEHAVIOR_RESTART$1]="loop";ItemEndBehavior[ItemEndBehavior["forward"]=END_BEHAVIOR_FREEZE$1]="forward";})(ItemEndBehavior||(ItemEndBehavior={}));var ParentItemEndBehavior;(function(ParentItemEndBehavior){ParentItemEndBehavior[ParentItemEndBehavior["destroyChildren"]=END_BEHAVIOR_DESTROY_CHILDREN$1]="destroyChildren";})(ParentItemEndBehavior||(ParentItemEndBehavior={}));var ParticleInteractionBehavior;(function(ParticleInteractionBehavior){ParticleInteractionBehavior[ParticleInteractionBehavior["none"]=0]="none";ParticleInteractionBehavior[ParticleInteractionBehavior["removeParticle"]=1]="removeParticle";})(ParticleInteractionBehavior||(ParticleInteractionBehavior={}));var ShapeArcMode;(function(ShapeArcMode){ShapeArcMode[ShapeArcMode["RANDOM"]=0]="RANDOM";ShapeArcMode[ShapeArcMode["UNIDIRECTIONAL_CYCLE"]=1]="UNIDIRECTIONAL_CYCLE";ShapeArcMode[ShapeArcMode["BIDIRECTIONAL_CYCLE"]=2]="BIDIRECTIONAL_CYCLE";ShapeArcMode[ShapeArcMode["UNIFORM_BURST"]=3]="UNIFORM_BURST";})(ShapeArcMode||(ShapeArcMode={}));var ModelBoundingType;(function(ModelBoundingType){ModelBoundingType[ModelBoundingType["box"]=2]="box";ModelBoundingType[ModelBoundingType["sphere"]=3]="sphere";})(ModelBoundingType||(ModelBoundingType={}));var MaterialType;(function(MaterialType){MaterialType["unlit"]="unlit";MaterialType["pbr"]="pbr";MaterialType["hair"]="hair";})(MaterialType||(MaterialType={}));var MaterialBlending;(function(MaterialBlending){MaterialBlending[MaterialBlending["opaque"]=100]="opaque";MaterialBlending[MaterialBlending["masked"]=101]="masked";MaterialBlending[MaterialBlending["translucent"]=102]="translucent";MaterialBlending[MaterialBlending["additive"]=103]="additive";})(MaterialBlending||(MaterialBlending={}));var RenderMode3D;(function(RenderMode3D){RenderMode3D["none"]="none";RenderMode3D["uv"]="uv";RenderMode3D["normal"]="normal";RenderMode3D["basecolor"]="basecolor";RenderMode3D["alpha"]="alpha";RenderMode3D["metallic"]="metallic";RenderMode3D["roughness"]="roughness";RenderMode3D["ao"]="ao";RenderMode3D["emissive"]="emissive";})(RenderMode3D||(RenderMode3D={}));var NOT_IMPLEMENT="not_implement";var map$2={[ValueType.RANDOM](props){if(props[0]instanceof Array){return new RandomVectorValue(props)}return new RandomValue(props)},[ValueType.CONSTANT](props){return new StaticValue(props)},[ValueType.CONSTANT_VEC2](props){return new StaticValue(props)},[ValueType.CONSTANT_VEC3](props){return new StaticValue(props)},[ValueType.CONSTANT_VEC4](props){return new StaticValue(props)},[ValueType.CURVE](props){return new CurveValue(props)},[ValueType.RGBA_COLOR](props){return new StaticValue(props)},[ValueType.COLORS](props){return new RandomSetValue(props.map((function(c){return colorToArr(c,false)})))},[ValueType.LINE](props){if(props.length===2&&props[0][0]===0&&props[1][0]===1){return new LinearValue([props[0][1],props[1][1]])}return new LineSegments(props)},[ValueType.GRADIENT_COLOR](props){return new GradientValue(props)},[ValueType.LINEAR_PATH](pros){return new PathSegments(pros)},[ValueType.BEZIER_PATH](pros){return new BezierSegments(pros)}};function createValueGetter(args){if(!args||!isNaN(+args)){return new StaticValue(args||0)}return map$2[args[0]](args[1])}var ValueGetter=function(){function ValueGetter(arg){this.onCreate(arg);}var _proto=ValueGetter.prototype;_proto.onCreate=function onCreate(props){throw Error(NOT_IMPLEMENT)};_proto.getIntegrateValue=function getIntegrateValue(t0,t1,timeScale){throw Error(NOT_IMPLEMENT)};_proto.getIntegrateByTime=function getIntegrateByTime(t0,time){throw Error(NOT_IMPLEMENT)};_proto.getValue=function getValue(time){throw Error(NOT_IMPLEMENT)};_proto.toUniform=function toUniform(meta){throw Error(NOT_IMPLEMENT)};_proto.map=function map(func){throw Error(NOT_IMPLEMENT)};_proto.scaleXCoord=function scaleXCoord(scale){return this};return ValueGetter}();var StaticValue=function(_ValueGetter){_inheritsLoose(StaticValue,_ValueGetter);function StaticValue(){return _ValueGetter.apply(this,arguments)||this}var _proto2=StaticValue.prototype;_proto2.onCreate=function onCreate(arg){this._value=arg;};_proto2.getIntegrateValue=function getIntegrateValue(t0,t1,ts){return this._value*(t1-t0)};_proto2.getIntegrateByTime=function getIntegrateByTime(t0,t1){return .5*this._value*(t1*t1-t0*t0)};_proto2.getValue=function getValue(time){return this._value};_proto2.toUniform=function toUniform(meta){return new Float32Array([0,this._value,0,0])};_proto2.map=function map(func){var val=this._value;this._value=func(val);return this};return StaticValue}(ValueGetter);var RandomSetValue=function(_ValueGetter2){_inheritsLoose(RandomSetValue,_ValueGetter2);function RandomSetValue(){return _ValueGetter2.apply(this,arguments)||this}var _proto3=RandomSetValue.prototype;_proto3.onCreate=function onCreate(arg){this._items=arg;};_proto3.getValue=function getValue(t){var items=this._items;return items[Math.floor(Math.random()*items.length)]};_proto3.map=function map(func){this._items=this._items.map(func);return this};return RandomSetValue}(ValueGetter);var RandomValue=function(_ValueGetter3){_inheritsLoose(RandomValue,_ValueGetter3);function RandomValue(){return _ValueGetter3.apply(this,arguments)||this}var _proto4=RandomValue.prototype;_proto4.onCreate=function onCreate(props){this._min=props[0];this._max=props[1];};_proto4.getValue=function getValue(time){return random(this._min,this._max)};_proto4.toUniform=function toUniform(meta){return new Float32Array([4,this._min,this._max,0])};_proto4.map=function map(func){this._min=func(this._min);this._max=func(this._max);return this};return RandomValue}(ValueGetter);var RandomVectorValue=function(_ValueGetter4){_inheritsLoose(RandomVectorValue,_ValueGetter4);function RandomVectorValue(){return _ValueGetter4.apply(this,arguments)||this}var _proto5=RandomVectorValue.prototype;_proto5.onCreate=function onCreate(props){this._min=props[0];this._max=props[1];};_proto5.getValue=function getValue(time){var min=this._min;var max=this._max;var ret=[];for(var i=0;i<min.length;i++){var t=Math.random();ret[i]=min[i]*(1-t)+max[i]*t;}return ret};_proto5.map=function map(func){this._min=this._min.map(func);this._max=this._max.map(func);return this};return RandomVectorValue}(ValueGetter);var LinearValue=function(_ValueGetter5){_inheritsLoose(LinearValue,_ValueGetter5);function LinearValue(){return _ValueGetter5.apply(this,arguments)||this}var _proto6=LinearValue.prototype;_proto6.onCreate=function onCreate(props){this._min=props[0];this._max=props[1];this._xCoord=1;};_proto6.getValue=function getValue(t){t/=this._xCoord;return this._min*(1-t)+this._max*t};_proto6.toUniform=function toUniform(){return new Float32Array([1,this._min,this._max,this._xCoord])};_proto6.getIntegrateValue=function getIntegrateValue(t0,t1,timeScale){var min=this._min;var max=this._max;var ts=this._xCoord*(timeScale||1);var v1=min+(max-min)*(t1/ts);var v0=min+(max-min)*(t0/ts);return ((v1+min)*t1-(v0+min)*t0)/2};_proto6.getIntegrateByTime=function getIntegrateByTime(t0,t1){return lineSegIntegrateByTime(t1,0,this._xCoord,this._min,this._max)-lineSegIntegrateByTime(t0,0,this._xCoord,this._min,this._max)};_proto6.map=function map(func){this._min=func(this._min);this._max=func(this._max);return this};_proto6.scaleXCoord=function scaleXCoord(scale){this._xCoord=scale;return this};return LinearValue}(ValueGetter);var GradientValue=function(_ValueGetter6){_inheritsLoose(GradientValue,_ValueGetter6);function GradientValue(){return _ValueGetter6.apply(this,arguments)||this}var _proto7=GradientValue.prototype;_proto7.onCreate=function onCreate(props){this.stops=colorStopsFromGradient(props);};_proto7.getStops=function getStops(){return this.stops};_proto7.getValue=function getValue(time){var stops=this.stops;var last=stops.length-1;for(var i=0;i<last;i++){var a=stops[i];var b=stops[i+1];if(a.stop<=time&&b.stop>time){var t=(time-a.stop)/(b.stop-a.stop);return interpolateColor(a.color,b.color,t,true)}}return stops[last].color.slice()};return GradientValue}(ValueGetter);var CURVE_PRO_TIME=0;var CURVE_PRO_VALUE=1;var CURVE_PRO_IN_TANGENT=2;var CURVE_PRO_OUT_TANGENT=3;var CurveValue=function(_ValueGetter7){_inheritsLoose(CurveValue,_ValueGetter7);function CurveValue(){return _ValueGetter7.apply(this,arguments)||this}CurveValue.getAllData=function getAllData(meta,halfFloat){var ret=new(halfFloat?Float16ArrayWrapper:Float32Array)(meta.index*4);for(var i=0,cursor=0,curves=meta.curves;i<curves.length;i++){var data=curves[i].toData();ret.set(data,cursor);cursor+=data.length;}return halfFloat?ret.data:ret};var _proto8=CurveValue.prototype;_proto8.onCreate=function onCreate(props){var min=Infinity;var max=-Infinity;if(Number.isFinite(props[0])&&Number.isFinite(props[1])){var keys=[];for(var i=2;i<props.length;i++){keys.push(props[i].slice(0,4));}this.keys=keys;this.min=props[0];this.dist=props[1]-props[0];}else {var _keys=this.keys=props.map((function(item){if(item instanceof Array){min=Math.min(min,item[1]);max=Math.max(max,item[1]);return item.slice(0,4)}else if(isObj$1(item)){min=Math.min(min,item.value);max=Math.max(max,item.value);return [item.time,item.value,item.inTangent||0,item.outTangent||0]}throw Error("invalid keyframe")}));var dist=max-min;if(dist!==0){for(var _i2=0;_i2<_keys.length;_i2++){var key=_keys[_i2];key[1]=(key[1]-min)/dist;}}var key0=_keys[0];if(key0[0]>0){key0[2]=0;_keys.unshift([0,key0[1],0,0]);}var key1=_keys[_keys.length-1];if(key1[0]<1){key1[3]=0;_keys.push([1,key1[1],0,0]);}this.min=min;this.dist=dist;}this.isCurveValue=true;};_proto8.getValue=function getValue(time){var keys=this.keys,min=this.min,dist=this.dist;if(time<=keys[0][CURVE_PRO_TIME]){return keys[0][CURVE_PRO_VALUE]*dist+min}var end=keys.length-1;for(var i=0;i<end;i++){var key=keys[i];var k2=keys[i+1];if(time>key[CURVE_PRO_TIME]&&time<=k2[CURVE_PRO_TIME]){return curveValueEvaluate(time,key,k2)*dist+min}}return keys[end][CURVE_PRO_VALUE]*dist+min};_proto8.getIntegrateByTime=function getIntegrateByTime(t0,t1){var d=this._integrate(t1,true)-this._integrate(t0,true);return this.min*.5*(t1-t0)*(t1-t0)+d*this.dist};_proto8.getIntegrateValue=function getIntegrateValue(t0,t1,ts){ts=ts||1;var d=(this._integrate(t1/ts,false)-this._integrate(t0/ts,false))*ts;var dt=(t1-t0)/ts;return this.min*dt+d*this.dist};_proto8._integrate=function _integrate(time,byTime){var keys=this.keys;if(time<=keys[0][CURVE_PRO_TIME]){return 0}var ret=0;var end=keys.length-1;var func=byTime?curveValueIntegrateByTime:curveValueIntegrate;for(var i=0;i<end;i++){var key=keys[i];var k2=keys[i+1];var t1=key[CURVE_PRO_TIME];var t2=k2[CURVE_PRO_TIME];if(time>t1&&time<=t2){return ret+func(time,key,k2)}else {ret+=func(t2,key,k2);}}return ret};_proto8.toData=function toData(){var keys=this.keys;var data=new Float32Array(keys.length*4);for(var i=0,cursor=0;i<keys.length;i++,cursor+=4){data.set(keys[i],cursor);}return data};_proto8.toUniform=function toUniform(meta){var index=meta.index;var keys=this.keys;meta.curves.push(this);meta.index+=keys.length;meta.max=Math.max(meta.max,keys.length);meta.curveCount+=keys.length;return new Float32Array([2,index+1/keys.length,this.min,this.dist])};_proto8.map=function map(func){this.keys.forEach((function(k){k[CURVE_PRO_VALUE]=func(k[CURVE_PRO_VALUE]);}));return this};_proto8.scaleXCoord=function scaleXCoord(scale){this.keys.forEach((function(k){return k[CURVE_PRO_TIME]=scale*k[CURVE_PRO_TIME]}));return this};return CurveValue}(ValueGetter);var LineSegments=function(_ValueGetter8){_inheritsLoose(LineSegments,_ValueGetter8);function LineSegments(){return _ValueGetter8.apply(this,arguments)||this}var _proto9=LineSegments.prototype;_proto9.onCreate=function onCreate(props){var keys=this.keys=props.map((function(p){if(p.slice){return p.slice(0,2)}return [p.time,p.value]})).sort((function(a,b){return a[0]-b[0]}));var last=keys[keys.length-1];if(last[0]<1){keys.push([1,last[1]]);}var first=keys[0];if(first[0]>0){keys.unshift([0,first[1]]);}this.isLineSeg=true;};_proto9.getValue=function getValue(time){var keys=this.keys;if(time<keys[0][0]){return keys[0][1]}var end=keys.length-1;for(var i=0;i<end;i++){var key=keys[i];var k2=keys[i+1];var x0=key[0];var x1=k2[0];if(time>=x0&&time<=x1){var p=(time-x0)/(x1-x0);var y0=key[1];return y0+p*(k2[1]-y0)}}return keys[end][1]};_proto9.getIntegrateValue=function getIntegrateValue(t0,t1,ts){if(ts===void 0){ts=1;}return (this._integrate(t1,false)-this._integrate(t0,false))*ts};_proto9.getIntegrateByTime=function getIntegrateByTime(t0,t1){return this._integrate(t1,true)-this._integrate(t0,true)};_proto9._integrate=function _integrate(time,byTime){var keys=this.keys;if(time<=keys[0][0]){return 0}var ret=0;var end=keys.length-1;var func=byTime?lineSegIntegrateByTime:lineSegIntegrate;for(var i=0;i<end;i++){var k1=keys[i];var k2=keys[i+1];var t0=k1[0];var t1=k2[0];if(time>t0&&time<=t1){return ret+func(time,t0,t1,k1[1],k2[1])}else {ret+=func(t1,t0,t1,k1[1],k2[1]);}}return ret};_proto9.toData=function toData(){var keys=this.keys;var data=new Float32Array(Math.ceil(keys.length/2)*4);for(var i=0,cursor=0;i<keys.length;i++,cursor+=2){data.set(keys[i],cursor);}data.set(keys[keys.length-1],data.length-2);return data};_proto9.toUniform=function toUniform(meta){var index=meta.index;var keys=this.keys;var uniformCount=Math.ceil(keys.length/2);meta.lineSegCount+=uniformCount;meta.curves.push(this);meta.index+=uniformCount;meta.max=Math.max(meta.max,uniformCount);return new Float32Array([3,index,uniformCount,0])};_proto9.map=function map(func){this.keys.forEach((function(k){return k[1]=func(k[1])}));return this};_proto9.scaleXCoord=function scaleXCoord(scale){this.keys.forEach((function(k){return k[0]=scale*k[0]}));return this};return LineSegments}(ValueGetter);var PathSegments=function(_ValueGetter9){_inheritsLoose(PathSegments,_ValueGetter9);function PathSegments(){return _ValueGetter9.apply(this,arguments)||this}var _proto10=PathSegments.prototype;_proto10.onCreate=function onCreate(props){this.keys=props[0];this.values=props[1];};_proto10.getValue=function getValue(time){var keys=this.keys;var values=this.values;for(var i=0;i<keys.length-1;i++){var k0=keys[i];var k1=keys[i+1];if(k0[0]<=time&&k1[0]>=time){var dis=k1[1]-k0[1];var dt=void 0;if(dis===0){dt=(time-k0[0])/(k1[0]-k0[0]);}else {var val=curveValueEvaluate(time,k0,k1);dt=(val-k0[1])/dis;}return this._calculateVec(i,dt)}}if(time<=keys[0][0]){return values[0].slice()}return values[values.length-1].slice()};_proto10._calculateVec=function _calculateVec(i,dt){var vec0=this.values[i];var vec1=this.values[i+1];var ret=[0,0,0];for(var j=0;j<vec0.length;j++){ret[j]=vec0[j]*(1-dt)+vec1[j]*dt;}return ret};return PathSegments}(ValueGetter);var BezierSegments=function(_PathSegments){_inheritsLoose(BezierSegments,_PathSegments);function BezierSegments(){return _PathSegments.apply(this,arguments)||this}var _proto11=BezierSegments.prototype;_proto11.onCreate=function onCreate(props){_PathSegments.prototype.onCreate.call(this,props);this.cps=props[2];};_proto11._calculateVec=function _calculateVec(i,t){var vec0=this.values[i];var vec1=this.values[i+1];var outCp=this.cps[i+i];var inCp=this.cps[i+i+1];var ret=[0,0,0];var ddt=1-t;var a=ddt*ddt*ddt;var b=3*t*ddt*ddt;var c=3*t*t*ddt;var d=t*t*t;for(var j=0;j<vec0.length;j++){ret[j]=a*vec0[j]+b*outCp[j]+c*inCp[j]+d*vec1[j];}return ret};return BezierSegments}(PathSegments);function lineSegIntegrate(t,t0,t1,y0,y1){var h=t-t0;return (y0+y0+(y1-y0)*h/(t1-t0))*h/2}function lineSegIntegrateByTime(t,t0,t1,y0,y1){var t2=t*t;var t3=t2*t;var t02=t0*t0;var t03=t02*t0;return (2*t3*(y0-y1)+3*t2*(t0*y1-t1*y0)-t03*(2*y0+y1)+3*t02*t1*y0)/(6*(t0-t1))}function curveValueEvaluate(time,keyframe0,keyframe1){var dt=keyframe1[CURVE_PRO_TIME]-keyframe0[CURVE_PRO_TIME];var m0=keyframe0[CURVE_PRO_OUT_TANGENT]*dt;var m1=keyframe1[CURVE_PRO_IN_TANGENT]*dt;var t=(time-keyframe0[CURVE_PRO_TIME])/dt;var t2=t*t;var t3=t2*t;var a=2*t3-3*t2+1;var b=t3-2*t2+t;var c=t3-t2;var d=-2*t3+3*t2;return a*keyframe0[CURVE_PRO_VALUE]+b*m0+c*m1+d*keyframe1[CURVE_PRO_VALUE]}function curveValueIntegrate(time,keyframe0,keyframe1){var k=keyframe1[CURVE_PRO_TIME]-keyframe0[CURVE_PRO_TIME];var m0=keyframe0[CURVE_PRO_OUT_TANGENT]*k;var m1=keyframe1[CURVE_PRO_IN_TANGENT]*k;var t0=keyframe0[CURVE_PRO_TIME];var v0=keyframe0[CURVE_PRO_VALUE];var v1=keyframe1[CURVE_PRO_VALUE];var dt=t0-time;var dt2=dt*dt;var dt3=dt2*dt;return (m0+m1+2*v0-2*v1)*dt3*dt/(4*k*k*k)+(2*m0+m1+3*v0-3*v1)*dt3/(3*k*k)+m0*dt2/2/k-v0*dt}function curveValueIntegrateByTime(t1,keyframe0,keyframe1){var k=keyframe1[CURVE_PRO_TIME]-keyframe0[CURVE_PRO_TIME];var m0=keyframe0[CURVE_PRO_OUT_TANGENT]*k;var m1=keyframe1[CURVE_PRO_IN_TANGENT]*k;var t0=keyframe0[CURVE_PRO_TIME];var v0=keyframe0[CURVE_PRO_VALUE];var v1=keyframe1[CURVE_PRO_VALUE];var dt=t0-t1;var dt2=dt*dt;var dt3=dt2*dt;var k2=k*k;var k3=k2*k;var ret=-30*k3*v0*(t0+t1)*dt+10*k2*m0*(t0+2*t1)*dt2+5*k*(t0+3*t1)*(2*m0+m1+3*v0-3*v1)*dt3+3*(t0+4*t1)*(m0+m1+2*v0-2*v1)*dt3*dt;return ret/60/k3}function createKeyFrameMeta(){return {curves:[],index:0,max:0,lineSegCount:0,curveCount:0}}var d2r$2=.017453292519943295;var r2d=180/Math.PI;var cos$1=Math.cos;var sin$1=Math.sin;function vecAdd(out,a,b){for(var i=0,len=a.length;i<len;i++){out[i]=a[i]+b[i];}return out}function vecFill(out,number){for(var i=0,len=out.length;i<len;i++){out[i]=number;}return out}function vecAddCombine(out,a,b){if(a&&b){for(var i=0,len=a.length;i<len;i++){out[i]=a[i]+b[i];}return out}return a||b}function vecAssign(out,a,count,start){if(start===void 0){start=0;}for(var i=0;i<count;i++){out[i]=a[i+start];}return out}function vecMulCombine(out,a,b){if(a&&b){for(var i=0,len=a.length;i<len;i++){out[i]=a[i]*b[i];}}else if(a){if(out!==a){for(var _i2=0;_i2<a.length;_i2++){out[_i2]=a[_i2];}}}else if(b){if(out!==b){for(var _i4=0;_i4<b.length;_i4++){out[_i4]=b[_i4];}}}return out}function mat3NormalFromMat4(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out}function vecMinus(out,v0,v1){for(var i=0,len=v0.length;i<len;i++){out[i]=v0[i]-v1[i];}return out}function vecSquareDistance(v0,v1){var sum=0;for(var i=0,len=v0.length;i<len;i++){var d=v0[i]-v1[i];sum+=d*d;}return sum}var NumberEpsilon=Number.EPSILON||Math.pow(2,-32);function vecNormalize(out,a){if(arguments.length===1){a=out;out=[];}var sum=Math.hypot.apply(Math,a);if(sum===0){return vecAssign(out,a,a.length)}for(var i=0;i<a.length;i++){out[i]=a[i]/sum;}return out}function vecMulScalar(out,vec,a){for(var i=0,len=vec.length;i<len;i++){out[i]=vec[i]*a;}return out}function vecDot(out,a,b){if(isNaN(b)){var sum=0;for(var i=0,len=a.length;i<len;i++){sum+=out[i]*a[i];}return sum}for(var _i6=0,_len2=a.length;_i6<_len2;_i6++){out[_i6]=a[_i6]*b;}return out}function vec3Cross(out,a,b){var ax=a[0],ay=a[1],az=a[2];var bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out}function vec3MulMat4(out,vec3,mat4){var x=vec3[0],y=vec3[1],z=vec3[2];var w=mat4[3]*x+mat4[7]*y+mat4[11]*z+mat4[15];w=w||1;out[0]=(mat4[0]*x+mat4[4]*y+mat4[8]*z+mat4[12])/w;out[1]=(mat4[1]*x+mat4[5]*y+mat4[9]*z+mat4[13])/w;out[2]=(mat4[2]*x+mat4[6]*y+mat4[10]*z+mat4[14])/w;return out}function vec3TranslateByMat4(out,vec3,matrix4){out[0]=vec3[0]+matrix4[12];out[1]=vec3[1]+matrix4[13];out[2]=vec3[2]+matrix4[14];return out}function vec3RotateByMat4(out,a,m){var x=a[0],y=a[1],z=a[2];var w=m[3]*x+m[7]*y+m[11]*z+m[15]||1;out[0]=(m[0]*x+m[4]*y+m[8]*z)/w;out[1]=(m[1]*x+m[5]*y+m[9]*z)/w;out[2]=(m[2]*x+m[6]*y+m[10]*z)/w;return out}function vec3MulMat3(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];out[2]=x*m[2]+y*m[5]+z*m[8];return out}var tempMat3FromRotationZ=[0,0,0,0,0,0,0,0,0];function mat3FromRotationZ(out,rad){if(!out){out=tempMat3FromRotationZ;}var s=sin$1(rad);var c=cos$1(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=-s;out[4]=c;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out}function mat3FromRotationZYX(ret,x,y,z){var cosX=cos$1(x*d2r$2);var cosY=cos$1(y*d2r$2);var cosZ=cos$1(z*d2r$2);var sinX=sin$1(x*d2r$2);var sinY=sin$1(y*d2r$2);var sinZ=sin$1(z*d2r$2);ret[0]=cosY*cosZ;ret[1]=cosY*sinZ;ret[2]=-sinY;ret[3]=-cosX*sinZ+sinX*sinY*cosZ;ret[4]=cosX*cosZ+sinX*sinY*sinZ;ret[5]=sinX*cosY;ret[6]=sinZ*sinX+cosX*sinY*cosZ;ret[7]=-sinX*cosZ+cosX*sinY*sinZ;ret[8]=cosX*cosY;return ret}function mat3FromRotation(ret,rotation){return mat3FromRotationZYX(ret,-rotation[0],-rotation[1],-rotation[2])}function invertMat4(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out}function isZeroVec(vec){for(var i=0,len=vec.length;i<len;i++){if(Math.abs(vec[i])>NumberEpsilon){return false}}return true}var isArray=Array.isArray;function ensureVec3(num){return isArray(num)?[num[0],num[1],num[2]]:[0,0,0]}function rotateVec2(out,vec2,angleInRad){var c=cos$1(angleInRad);var s=sin$1(angleInRad);var x=vec2[0];var y=vec2[1];out[0]=c*x+s*y;out[1]=-s*x+c*y;return out}function rotationZYXFromMat3(out,mat3){var te=mat3;var m11=te[0],m12=te[3];te[6];var m21=te[1],m22=te[4];te[7];var m31=te[2],m32=te[5],m33=te[8];out[1]=Math.asin(clamp(-m31,-1,1))*r2d;if(Math.abs(m31)<.9999999){out[0]=Math.atan2(m32,m33)*r2d;out[2]=Math.atan2(m21,m11)*r2d;}else {out[0]=0;out[2]=Math.atan2(-m12,m22)*r2d;}return out}function rotationFromMat3(out,mat3){rotationZYXFromMat3(out,mat3);return out}function mat3MulMat3(out,a,b){var a00=a[0],a01=a[1],a02=a[2];var a10=a[3],a11=a[4],a12=a[5];var a20=a[6],a21=a[7],a22=a[8];var b00=b[0],b01=b[1],b02=b[2];var b10=b[3],b11=b[4],b12=b[5];var b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out}function clamp(v,min,max){return v>max?max:v<min?min:v}var d2r$1=Math.PI/180;function mat4create(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function mat4perspective(out,fovy,aspect,near,far,reverse){var f=1/Math.tan(fovy*d2r$1/2);var nf;out[0]=reverse?f:f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=reverse?f*aspect:f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[11]=-1;out[12]=0;out[13]=0;out[15]=0;if(far!=null&&far!==Infinity){nf=1/(near-far);out[10]=(far+near)*nf;out[14]=2*far*near*nf;}else {out[10]=-1;out[14]=-2*near;}return out}function mat4fromRotationTranslationScale(out,q,v,s){var x=q[0];var y=q[1];var z=q[2];var w=q[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var xy=x*y2;var xz=x*z2;var yy=y*y2;var yz=y*z2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;var sx=s[0];var sy=s[1];var sz=s[2];out[0]=(1-(yy+zz))*sx;out[1]=(xy+wz)*sx;out[2]=(xz-wy)*sx;out[3]=0;out[4]=(xy-wz)*sy;out[5]=(1-(xx+zz))*sy;out[6]=(yz+wx)*sy;out[7]=0;out[8]=(xz+wy)*sz;out[9]=(yz-wx)*sz;out[10]=(1-(xx+yy))*sz;out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out}var temps=[];var matrixRotation=new Float32Array(9);var quatOut=[0,0,0,1];function mat4Determinate(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06}function getMat4TR(mat4,translate,quat,scaling){var m11=mat4[0];var m12=mat4[1];var m13=mat4[2];var m21=mat4[4];var m22=mat4[5];var m23=mat4[6];var m31=mat4[8];var m32=mat4[9];var m33=mat4[10];if(quat){var is1=1/scaling[0];var is2=1/scaling[1];var is3=1/scaling[2];matrixRotation[0]=m11*is1;matrixRotation[1]=m12*is1;matrixRotation[2]=m13*is1;matrixRotation[3]=m21*is2;matrixRotation[4]=m22*is2;matrixRotation[5]=m23*is2;matrixRotation[6]=m31*is3;matrixRotation[7]=m32*is3;matrixRotation[8]=m33*is3;var fTrace=matrixRotation[0]+matrixRotation[4]+matrixRotation[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);quatOut[3]=.5*fRoot;fRoot=.5/fRoot;quatOut[0]=(matrixRotation[5]-matrixRotation[7])*fRoot;quatOut[1]=(matrixRotation[6]-matrixRotation[2])*fRoot;quatOut[2]=(matrixRotation[1]-matrixRotation[3])*fRoot;}else {var i=0;if(matrixRotation[4]>matrixRotation[0]){i=1;}if(matrixRotation[8]>matrixRotation[i*3+i]){i=2;}var j=(i+1)%3;var k=(i+2)%3;fRoot=Math.sqrt(matrixRotation[i*3+i]-matrixRotation[j*3+j]-matrixRotation[k*3+k]+1);quatOut[i]=.5*fRoot;fRoot=.5/fRoot;quatOut[3]=(matrixRotation[j*3+k]-matrixRotation[k*3+j])*fRoot;quatOut[j]=(matrixRotation[j*3+i]+matrixRotation[i*3+j])*fRoot;quatOut[k]=(matrixRotation[k*3+i]+matrixRotation[i*3+k])*fRoot;}quat[0]=quatOut[0];quat[1]=quatOut[1];quat[2]=quatOut[2];quat[3]=quatOut[3];}if(translate){translate[0]=mat4[12];translate[1]=mat4[13];translate[2]=mat4[14];}}function getMat4TRS(mat4,translate,quat,scaling){if(scaling===void 0){scaling=temps;}var m11=mat4[0];var m12=mat4[1];var m13=mat4[2];var m21=mat4[4];var m22=mat4[5];var m23=mat4[6];var m31=mat4[8];var m32=mat4[9];var m33=mat4[10];var det=mat4Determinate(mat4);scaling[0]=Math.hypot(m11,m12,m13);scaling[1]=Math.hypot(m21,m22,m23);scaling[2]=Math.hypot(m31,m32,m33);if(det<0){scaling[0]=-scaling[0];}return getMat4TR(mat4,translate,quat,scaling)}function mat4multiply(out,a,b){var a00=a[0];var a01=a[1];var a02=a[2];var a03=a[3];var a10=a[4];var a11=a[5];var a12=a[6];var a13=a[7];var a20=a[8];var a21=a[9];var a22=a[10];var a23=a[11];var a30=a[12];var a31=a[13];var a32=a[14];var a33=a[15];var b0=b[0];var b1=b[1];var b2=b[2];var b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out}function mat4Clone(out,from){for(var i=0;i<16;i++){out[i]=from[i];}return out}function mat4invert(out,a){var a00=a[0];var a01=a[1];var a02=a[2];var a03=a[3];var a10=a[4];var a11=a[5];var a12=a[6];var a13=a[7];var a20=a[8];var a21=a[9];var a22=a[10];var a23=a[11];var a30=a[12];var a31=a[13];var a32=a[14];var a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){for(var i=0;i<16;i++){out[i]=NaN;}return out}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out}var d2r=Math.PI/180;var cos=Math.cos;var sin=Math.sin;function quatMultiply(out,a,b){var ax=a[0],ay=a[1],az=a[2],aw=a[3];var bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out}function mat3FromQuat(out,quat){var x=quat[0],y=quat[1],z=quat[2],w=quat[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var yx=y*x2;var yy=y*y2;var zx=z*x2;var zy=z*y2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;out[0]=1-yy-zz;out[3]=yx-wz;out[6]=zx+wy;out[1]=yx+wz;out[4]=1-xx-zz;out[7]=zy-wx;out[2]=zx-wy;out[5]=zy+wx;out[8]=1-xx-yy;return out}function quatFromRotation(out,x,y,z){var c1=cos(x*d2r/2);var c2=cos(y*d2r/2);var c3=cos(z*d2r/2);var s1=sin(x*d2r/2);var s2=sin(y*d2r/2);var s3=sin(z*d2r/2);out[0]=s1*c2*c3-c1*s2*s3;out[1]=c1*s2*c3+s1*c2*s3;out[2]=c1*c2*s3-s1*s2*c3;out[3]=c1*c2*c3+s1*s2*s3;return out}function rotateByQuat(out,a,quat){var x=quat[0],y=quat[1],z=quat[2],w=quat[3];var qvec=[x,y,z];var uv=vec3Cross([],qvec,a);var uuv=vec3Cross([],qvec,uv);vecDot(uuv,uuv,2);vecDot(uv,uv,2*w);vecAdd(uuv,uuv,uv);vecAdd(out,a,uuv);return out}function quatStar(out,quat){var x=quat[0],y=quat[1],z=quat[2],w=quat[3];out[0]=-x;out[1]=-y;out[2]=-z;out[3]=w;return out}var tempMat3$3=[];var tempMat4=[];var tempQuat=[];var seed$7=1;var Transform=function(){Transform.getRotation=function getRotation(out,quat){var q=quatStar(tempQuat,quat);var m3=mat3FromQuat(tempMat3$3,q);return rotationFromMat3(out,m3)};function Transform(opt,parent){this._dirty=true;this._matrix=mat4create();this.position=[0,0,0];this.quat=[0,0,0,1];this.scale=[1,1,1];this._worldMat=mat4create();this._worldTRSCache={dirty:true,position:[0,0,0],quat:[0,0,0,1]};this.name=(opt==null?void 0:opt.name)||"transform_"+seed$7++;this._children=[];if(opt){this.setTransform(opt);}if(parent){this.parentTransform=parent;}}var _proto=Transform.prototype;_proto.clone=function clone(){return new Transform(this)};_proto.setTransform=function setTransform(opt,reverseEuler){var position=opt.position,rotation=opt.rotation,scale=opt.scale,quat=opt.quat;if(position){this.setPosition(position[0],position[1],position[2]);}if(quat){this.setQuat(quat[0],quat[1],quat[2],quat[3]);}else if(rotation){var mul=reverseEuler?-1:1;this.setRotation(rotation[0]*mul,rotation[1]*mul,rotation[2]*mul);}if(scale){this.setScale(scale[0],scale[1],scale[2]);}if(opt.name){this.name=opt.name;}};_proto.getRotation=function getRotation(out){return Transform.getRotation(out,this.quat)};_proto.update=function update(){mat4fromRotationTranslationScale(this._matrix,this.quat,this.position,this.scale);this._dirty=false;this._worldTRSCache.dirty=true;};_proto.setQuat=function setQuat(x,y,z,w){this._dirty=true;var quat=this.quat;quat[0]=x;quat[1]=y;quat[2]=z;quat[3]=w;};_proto.setPosition=function setPosition(x,y,z){var pos=this.position;pos[0]=x;pos[1]=y;pos[2]=z;this.invalid();};_proto.setRotation=function setRotation(x,y,z){this.invalid();quatFromRotation(this.quat,x,y,z);quatStar(this.quat,this.quat);};_proto.setScale=function setScale(x,y,z){this.invalid();var scale=this.scale;scale[0]=x;scale[1]=y;scale[2]=z;};_proto.rotate=function rotate(quat){this.invalid();quatMultiply(this.quat,this.quat,quat);};_proto.translate=function translate(x,y,z){this.invalid();var pos=this.position;pos[0]+=x;pos[1]+=y;pos[2]+=z;};_proto.scaleBy=function scaleBy(x,y,z){this.invalid();var scale=this.scale;scale[0]*=x;scale[1]*=y;scale[2]*=z;};_proto.invalid=function invalid(){this._dirty=true;this._parentMat=undefined;this._children.forEach((function(c){return c.invalid()}));};_proto.getWorldScale=function getWorldScale(out){var _this$parentTransform;var ret=out||[1,1,1];return vecMulCombine(out||[1,1,1],this.scale,(_this$parentTransform=this.parentTransform)==null?void 0:_this$parentTransform.getWorldScale(ret))};_proto.getWorldMatrix=function getWorldMatrix(out){var parent=this.parentTransform;var worldMat;if(parent&&(!this._parentMat||parent.dirty)){this._parentMat=parent.getWorldMatrix(parent._worldMat);this._worldScale=this.getWorldScale();this._dirty=true;}var pm=this._parentMat;if(pm){if(this._dirty){this._worldMat=mat4multiply(this._worldMat,this._parentMat,this.matrix);this._worldTRSCache.dirty=true;}worldMat=this._worldMat;}else {worldMat=this.matrix;}return worldMat===out?worldMat:mat4Clone(out||tempMat4,worldMat)};_proto.fromMat4=function fromMat4(m4,scale){this._dirty=true;if(scale){getMat4TR(m4,this.position,this.quat,scale);vecAssign(this.scale,scale,3);}else {getMat4TRS(m4,this.position,this.quat,this.scale);}return this};_proto.getWorldTRS=function getWorldTRS(position,quat,scale){var m=this.getWorldMatrix(this._worldMat);var scaling=this._worldScale||this.scale;var cache=this._worldTRSCache;if(cache.dirty){getMat4TR(m,cache.position,cache.quat,scaling);cache.dirty=false;}if(position){vecAssign(position,cache.position,3);}if(quat){vecAssign(quat,cache.quat,4);}if(scale){vecAssign(scale,scaling,3);}};_createClass(Transform,[{key:"parentTransform",get:function get(){return this._pt},set:function set(t){if(this._pt){arrRemove$1(this._pt._children,this);}this._pt=t;if(t){arrAdd$1(t._children,this);}if(t===this){throw Error("set self to parent transform")}this.invalid();}},{key:"rotation",get:function get(){return Transform.getRotation([],this.quat)}},{key:"matrix",get:function get(){if(this._dirty){this.update();}return this._matrix}},{key:"dirty",get:function get(){var parent=this.parentTransform;if(parent&&parent.dirty){return true}return this._dirty}}]);return Transform}();var tempPos$1=[0,0,0];var tempRot$3=[0,0,0];var CameraController=function(){function CameraController(renderer,model,transform){this.composition=renderer;this.transform=transform;this._onCreate(model);}var _proto=CameraController.prototype;_proto._onCreate=function _onCreate(model){var transform=this.transform;var options=model.options;this.clipMode=model.options.clipMode;this.options={position:vecAssign([0,0,0],transform.position||[0,0,0],3),rotation:vecAssign([0,0,0],transform.rotation||[0,0,0],3),near:createValueGetter(options.near),far:createValueGetter(options.far),fov:createValueGetter(options.fov)};if(model.positionOverLifetime){var positionOverLifetime=model.positionOverLifetime;this.translateOverLifetime={path:positionOverLifetime.path&&createValueGetter(positionOverLifetime.path),x:createValueGetter(positionOverLifetime.linearX||0),y:createValueGetter(positionOverLifetime.linearY||0),z:createValueGetter(positionOverLifetime.linearZ||0)};}if(model.rotationOverLifetime){var rotationOverLifetime=model.rotationOverLifetime;this.rotationOverLifetime={separateAxes:rotationOverLifetime.separateAxes,x:createValueGetter(rotationOverLifetime.x||0),y:createValueGetter(rotationOverLifetime.y||0),z:createValueGetter(rotationOverLifetime.z||0)};}};_proto.onEnd=function onEnd(renderer){this.onItemUpdate(1,renderer);};_proto.onItemUpdate=function onItemUpdate(lifetime,renderer){var options=this.options;var pos=vecAssign(tempPos$1,options.position,3);var rot=vecAssign(tempRot$3,options.rotation,3);lifetime=clamp(lifetime,0,1);var vel=this.translateOverLifetime;if(vel){pos[0]+=vel.x.getValue(lifetime);pos[1]+=vel.y.getValue(lifetime);pos[2]+=vel.z.getValue(lifetime);if(vel.path){vecAdd(pos,pos,vel.path.getValue(lifetime));}}var rotationOverLifetime=this.rotationOverLifetime;if(rotationOverLifetime){var r=rotationOverLifetime.z.getValue(lifetime);rot[2]+=r;if(rotationOverLifetime.separateAxes){rot[0]+=rotationOverLifetime.x.getValue(lifetime);rot[1]+=rotationOverLifetime.y.getValue(lifetime);}else {rot[0]+=r;rot[1]+=r;}}var far=this.options.far.getValue(lifetime);var near=this.options.near.getValue(lifetime);var fov=this.options.fov.getValue(lifetime);this.transform.setPosition(pos[0],pos[1],pos[2]);this.transform.setRotation(rot[0],rot[1],rot[2]);var quat=[0,0,0,1];this.transform.getWorldTRS(pos,quat);return renderer.camera={near:near,far:far,fov:fov,position:pos,rotation:Transform.getRotation(rot,quat),clipMode:this.clipMode}};return CameraController}();var link="https://yuque.antfin.com/yf4elw/knaszl/wozlz0#vFPqF";var VFXItem=function(){function VFXItem(arg,comp){this._v_priority=0;this._hide=false;this._frozen=false;this._contentVisible=false;this.composition=comp;this.id=arg.id;this.name=arg.name;this.reusable=comp.willReverseTime;this.delay=arg.delay;this.transform=new Transform(arg.transform);this.parentId=arg.parentId;this._timeInms=0;this.duration=arg.duration||0;this._delayInms=(arg.delay||0)*1e3;this._durInms=this.duration*1e3;this.endBehavior=arg.endBehavior;this.lifetime=-(this._delayInms/this._durInms);this.listIndex=arg.listIndex||0;this.transform.parentTransform=comp.rootTransform;this.onConstructed(arg);var dur=this.duration;this.transform.name=this.name;if(dur<=0){throw Error("item duration "+dur+" invalid,please see "+link)}}var _proto=VFXItem.prototype;_proto._onHideChanged=function _onHideChanged(hide){};_proto._onFrozenChanged=function _onFrozenChanged(frozen){};_proto.getWorldTransform=function getWorldTransform(transform){return (transform||new Transform).fromMat4(this.transform.getWorldMatrix())};_proto.start=function start(){if(!this._started||this.ended){this._started=true;this._delaying=true;this._timeInms=0;this._callEnd=false;this.ended=false;}return this};_proto.createContent=function createContent(arg){if(!this._content){this._content=this._createContent(this.composition);}return this._content};_proto.precompile=function precompile(shaderLibrary){};_proto.stop=function stop(){this._stop();this._started=false;};_proto.reset=function reset(){var renderer=this.composition;if(this.composition){this.onItemRemoved(renderer,this._content);this._content=null;}this._started=false;return this};_proto.destroy=function destroy(){if(this.composition){this.composition.destroyItem(this);this.reset();this._onUpdate=function(){return -1};this.composition=null;this.transform=new Transform;}};_proto.onConstructed=function onConstructed(options){};_proto._stop=function _stop(){if(this._content&&this._content.stop){this._content.stop();}};_proto.onItemRemoved=function onItemRemoved(renderer,content){};_proto.onLifetimeBegin=function onLifetimeBegin(renderer,content){};_proto._createContent=function _createContent(renderer){return undefined};_proto.onItemUpdate=function onItemUpdate(dt,lifetime){};_proto.getCurrentPosition=function getCurrentPosition(){var pos=[0,0,0];this.transform.getWorldTRS(pos);return pos};_proto._onUpdate=function _onUpdate(dt){if(this._started&&!this.frozen){var time=this._timeInms+=dt;var now=time-this._delayInms;this.transform.invalid();if(this._delaying&&now>=0){this._delaying=false;var renderer=this.composition;this.createContent();this.onLifetimeBegin(renderer,this._content);this.composition.itemLifetimeEvent(this,true);}if(!this._delaying){var endBehavior=this.endBehavior;var lifetime=now/this._durInms;var ended=this._isEnded(now);var shouldUpdate=true;if(ended){shouldUpdate=false;if(!this._callEnd){this._callEnd=true;this.composition.itemLifetimeEvent(this,false);this.onEnd();}if(endBehavior!==2&&endBehavior!==5){this.ended=true;if(endBehavior===1||endBehavior===3){this.composition.pausePlayer(this);}else if(endBehavior===4){shouldUpdate=true;lifetime=1;}if(!this.reusable){if(endBehavior===0||endBehavior===3||endBehavior===6){return this.destroy()}else if(endBehavior===1){this.endBehavior=2;}}else if(endBehavior===0){this.hide=true;}lifetime=Math.min(lifetime,1);}else {shouldUpdate=true;if(endBehavior===5){this.ended=true;lifetime=lifetime%1;}}}else if(this._callEnd&&this.reusable){this.hide=false;this._callEnd=false;}this.lifetime=lifetime;shouldUpdate&&this.onItemUpdate(dt,lifetime);}}};_proto._isEnded=function _isEnded(now){return now-this._durInms>.001};_proto.onEnd=function onEnd(){};_proto.getHitTestParams=function getHitTestParams(force){};_createClass(VFXItem,[{key:"contentVisible",get:function get(){return this._contentVisible&&!this._hide}},{key:"content",get:function get(){return this._content},set:function set(t){}},{key:"type",get:function get(){return "0"},set:function set(v){}},{key:"hide",get:function get(){return this._hide},set:function set(v){if(this._hide!=v){this._onHideChanged(this._hide=!!v);}}},{key:"frozen",get:function get(){return this._frozen},set:function set(v){this._onFrozenChanged(this._frozen=!!v);}},{key:"lifetimeStarted",get:function get(){return this._started&&!this._delaying}}]);return VFXItem}();var MarsPlugin=function(){function MarsPlugin(){this.order=100;}MarsPlugin.processRawJSONAsync=function processRawJSONAsync(json,options){return Promise.resolve(undefined)};MarsPlugin.prepareResourceAsync=function prepareResourceAsync(scene,options){return Promise.resolve(undefined)};MarsPlugin.onPlayerDestroy=function onPlayerDestroy(player){};MarsPlugin.onPlayerCreated=function onPlayerCreated(player){};var _proto=MarsPlugin.prototype;_proto.onCompositionConstructed=function onCompositionConstructed(composition,scene){};_proto.onCompositionItemLifeBegin=function onCompositionItemLifeBegin(composition,item){};_proto.onCompositionItemLifeEnd=function onCompositionItemLifeEnd(composition,item){};_proto.onCompositionItemRemoved=function onCompositionItemRemoved(composition,item){};_proto.onCompositionReset=function onCompositionReset(composition,frame){};_proto.onCompositionWillReset=function onCompositionWillReset(composition,frame){};_proto.onCompositionPrecompile=function onCompositionPrecompile(composition,shaderLib){};_proto.onCompositionDestroyed=function onCompositionDestroyed(composition){};_proto.onCompositionUpdate=function onCompositionUpdate(composition,dt){};_proto.prepareRenderFrame=function prepareRenderFrame(composition,frame){return false};_proto.postProcessFrame=function postProcessFrame(composition,frame){};return MarsPlugin}();var pluginLoaderMap={};var pluginCtrlMap={};var defaultPlugins=[];function registerPlugin(name,pluginClass,itemClass,isDefault){pluginCtrlMap[name]=itemClass;pluginLoaderMap[name]=pluginClass;if(isDefault){arrAdd$1(defaultPlugins,name);}}function broadcastPlayerEvent(player,create){forEach$1(pluginLoaderMap,(function(ctrl){var func=create?ctrl.onPlayerCreated:ctrl.onPlayerDestroy;if(func){func(player);}}));}function unregisterPlugin(name){delete pluginCtrlMap[name];delete pluginLoaderMap[name];arrRemove$1(defaultPlugins,name);}var PluginSystem=function(){function PluginSystem(pluginNames){var loaders={};var loaded=[];defaultPlugins.forEach(addLoader);pluginNames.forEach(addLoader);this.plugins=Object.keys(loaders).map((function(name){var CTRL=pluginLoaderMap[name];if(!CTRL){throw Error("plugin:"+name+" not found")}var loader=new CTRL;loader.name=name;return loader})).sort((function(a,b){return a.order-b.order}));function addLoader(name){var loader=pluginLoaderMap[name];if(!loaded.includes(loader)){loaded.push(loader);loaders[name]=loader;}}}var _proto2=PluginSystem.prototype;_proto2.initializeComposition=function initializeComposition(comp,scene){this.plugins.forEach((function(loader){return loader.onCompositionConstructed(comp,scene)}));};_proto2.destroyComposition=function destroyComposition(comp){this.plugins.forEach((function(loader){return loader.onCompositionDestroyed(comp)}));};_proto2.resetComposition=function resetComposition(comp,renderFrame){this.plugins.forEach((function(loader){return loader.onCompositionReset(comp,renderFrame)}));};_proto2.createPluginItem=function createPluginItem(type,options,composition){var Ctrl=pluginCtrlMap[type];if(!Ctrl){throw Error("plugin "+type+" no registered constructor")}var item=new Ctrl(options,composition);if(!(item instanceof VFXItem)){throw Error("plugin "+type+" invalid constructor type")}return item};_proto2.onPlayerDestroy=function onPlayerDestroy(player){var plugins=this.plugins;for(var i=0;i<plugins.length;i++){var plugin=plugins[i];var ctrl=pluginLoaderMap[plugin.name];if(ctrl.onPlayerDestroy){ctrl.onPlayerDestroy(player);}}};_proto2.processRawJSONAsync=function processRawJSONAsync(json,options){return this.callStaticAsync("processRawJSONAsync",json,options)};_proto2.callStaticAsync=function callStaticAsync(name){var pendings=[];var plugins=this.plugins;for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}for(var i=0;i<plugins.length;i++){var plugin=plugins[i];var ctrl=pluginLoaderMap[plugin.name];if(ctrl[name]){pendings.push(Promise.resolve(ctrl[name].apply(ctrl,args)));}}return Promise.all(pendings)};_proto2.loadResourcesAsync=function loadResourcesAsync(scene,options){return this.callStaticAsync("prepareResourceAsync",scene,options)};return PluginSystem}();var CameraVFXItem=function(_VFXItem){_inheritsLoose(CameraVFXItem,_VFXItem);function CameraVFXItem(){return _VFXItem.apply(this,arguments)||this}var _proto=CameraVFXItem.prototype;_proto.onConstructed=function onConstructed(options){this.model=options.content;};_proto._createContent=function _createContent(renderer){if(!this.delegate){return this.delegate=new CameraController(this.composition,this.model,this.transform)}};_proto.getCurrentPosition=function getCurrentPosition(){return this.delegate.position};_proto.onItemUpdate=function onItemUpdate(dt,lifetime){if(this.delegate){this.delegate.onItemUpdate(lifetime,this.composition);}};_createClass(CameraVFXItem,[{key:"type",get:function get(){return "6"},set:function set(v){}}]);return CameraVFXItem}(VFXItem);var CameraVFXItemLoader=function(_MarsPlugin){_inheritsLoose(CameraVFXItemLoader,_MarsPlugin);function CameraVFXItemLoader(){return _MarsPlugin.apply(this,arguments)||this}return CameraVFXItemLoader}(MarsPlugin);
  /*!
   * Name: @ali/mars-render-interface
   * Description: Mars Render Interface
   * Author: zbr80259@alibab-inc.com
   * Version: v0.0.6
   */
  /*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return extendStatics(d,b)};function __extends(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d;}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __);}var __assign=function(){__assign=Object.assign||function __assign(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p];}return t};return __assign.apply(this,arguments)};function __spreadArray(to,from,pack){if(pack||arguments.length===2)for(var i=0,l=from.length,ar;i<l;i++){if(ar||!(i in from)){if(!ar)ar=Array.prototype.slice.call(from,0,i);ar[i]=from[i];}}return to.concat(ar||Array.prototype.slice.call(from))}var prefix="[Mars RI]";function consoleLog(msg){var data=[];for(var _i=1;_i<arguments.length;_i++){data[_i-1]=arguments[_i];}console.info.apply(console,__spreadArray([prefix+msg],data,false));}function consoleWarn(msg){var data=[];for(var _i=1;_i<arguments.length;_i++){data[_i-1]=arguments[_i];}console.warn.apply(console,__spreadArray([prefix+msg],data,false));}function consoleError(msg){var data=[];for(var _i=1;_i<arguments.length;_i++){data[_i-1]=arguments[_i];}console.error.apply(console,__spreadArray([prefix+msg],data,false));}var DestroyOptions;(function(DestroyOptions){DestroyOptions[DestroyOptions["destroy"]=0]="destroy";DestroyOptions[DestroyOptions["keep"]=1]="keep";DestroyOptions[DestroyOptions["force"]=0]="force";})(DestroyOptions||(DestroyOptions={}));var RenderPassDestroyAttachmentType;(function(RenderPassDestroyAttachmentType){RenderPassDestroyAttachmentType[RenderPassDestroyAttachmentType["force"]=0]="force";RenderPassDestroyAttachmentType[RenderPassDestroyAttachmentType["keep"]=1]="keep";RenderPassDestroyAttachmentType[RenderPassDestroyAttachmentType["keepExternal"]=2]="keepExternal";RenderPassDestroyAttachmentType[RenderPassDestroyAttachmentType["destroy"]=0]="destroy";})(RenderPassDestroyAttachmentType||(RenderPassDestroyAttachmentType={}));var RenderPassPriorityPrepare=0;var RenderPassPriorityNormal=1e3;var RenderPassPriorityPostprocess=3e3;var TextureLoadAction;(function(TextureLoadAction){TextureLoadAction[TextureLoadAction["whatever"]=0]="whatever";TextureLoadAction[TextureLoadAction["clear"]=2]="clear";})(TextureLoadAction||(TextureLoadAction={}));var TextureStoreAction;(function(TextureStoreAction){TextureStoreAction[TextureStoreAction["store"]=0]="store";TextureStoreAction[TextureStoreAction["clear"]=2]="clear";})(TextureStoreAction||(TextureStoreAction={}));var RenderPassAttachmentStorageType;(function(RenderPassAttachmentStorageType){RenderPassAttachmentStorageType[RenderPassAttachmentStorageType["none"]=0]="none";RenderPassAttachmentStorageType[RenderPassAttachmentStorageType["color"]=1]="color";RenderPassAttachmentStorageType[RenderPassAttachmentStorageType["stencil_8_opaque"]=2]="stencil_8_opaque";RenderPassAttachmentStorageType[RenderPassAttachmentStorageType["depth_16_opaque"]=3]="depth_16_opaque";RenderPassAttachmentStorageType[RenderPassAttachmentStorageType["depth_stencil_opaque"]=4]="depth_stencil_opaque";RenderPassAttachmentStorageType[RenderPassAttachmentStorageType["depth_16_texture"]=5]="depth_16_texture";RenderPassAttachmentStorageType[RenderPassAttachmentStorageType["depth_24_stencil_8_texture"]=6]="depth_24_stencil_8_texture";})(RenderPassAttachmentStorageType||(RenderPassAttachmentStorageType={}));var RenderPassMeshOrder;(function(RenderPassMeshOrder){RenderPassMeshOrder[RenderPassMeshOrder["none"]=1]="none";RenderPassMeshOrder[RenderPassMeshOrder["ascending"]=2]="ascending";RenderPassMeshOrder[RenderPassMeshOrder["descending"]=3]="descending";})(RenderPassMeshOrder||(RenderPassMeshOrder={}));var TextureSourceType;(function(TextureSourceType){TextureSourceType[TextureSourceType["none"]=0]="none";TextureSourceType[TextureSourceType["data"]=1]="data";TextureSourceType[TextureSourceType["image"]=2]="image";TextureSourceType[TextureSourceType["compressed"]=3]="compressed";TextureSourceType[TextureSourceType["video"]=4]="video";TextureSourceType[TextureSourceType["canvas"]=5]="canvas";TextureSourceType[TextureSourceType["framebuffer"]=6]="framebuffer";TextureSourceType[TextureSourceType["mipmaps"]=7]="mipmaps";})(TextureSourceType||(TextureSourceType={}));var _a$6;var constants={};{if(typeof WebGL2RenderingContext==="function"){copy$1(WebGL2RenderingContext);}else if(typeof WebGLRenderingContext!=="undefined"){copy$1(WebGLRenderingContext);copy$1(WebGLRenderingContext.prototype);}else {consoleError("WebGL not in global");}}constants["HALF_FLOAT"]=5131;function copy$1(target){for(var name_1 in target){if(/^[A-Z_]/.test(name_1)){constants[name_1]=target[name_1];}}}var map$1=(_a$6={},_a$6[constants.INT]=Int32Array,_a$6[constants.FLOAT]=Float32Array,_a$6[constants.SHORT]=Int16Array,_a$6[constants.BYTE]=Int8Array,_a$6[constants.UNSIGNED_BYTE]=Uint8Array,_a$6[constants.UNSIGNED_INT]=Uint32Array,_a$6[constants.UNSIGNED_SHORT]=Uint16Array,_a$6);function getBytesPerElementByGLType(type){var _a;return ((_a=map$1[type])===null||_a===void 0?void 0:_a.BYTES_PER_ELEMENT)||0}var ShaderCompileResultStatus;(function(ShaderCompileResultStatus){ShaderCompileResultStatus[ShaderCompileResultStatus["noShader"]=0]="noShader";ShaderCompileResultStatus[ShaderCompileResultStatus["success"]=1]="success";ShaderCompileResultStatus[ShaderCompileResultStatus["fail"]=2]="fail";ShaderCompileResultStatus[ShaderCompileResultStatus["compiling"]=3]="compiling";})(ShaderCompileResultStatus||(ShaderCompileResultStatus={}));var ShaderLibraryEmpty=function(){function ShaderLibraryEmpty(){this.shaderResults={};}ShaderLibraryEmpty.prototype.addShader=function(shader,marcos){return ""};ShaderLibraryEmpty.prototype.compileAllShaders=function(asyncCallback){return []};ShaderLibraryEmpty.prototype.deleteShader=function(cacheId){};ShaderLibraryEmpty.prototype.compileShader=function(shaderCacheId){return {status:ShaderCompileResultStatus.fail}};ShaderLibraryEmpty.prototype.destroy=function(){};return ShaderLibraryEmpty}();function isFunc(val){return typeof val==="function"}function isObj(a){return typeof a==="object"&&a}function isStr(a,withLength){var str=typeof a==="string";if(withLength){return str&&a.length>0}return str}function arrRemove(arr,ele){var idx=arr.indexOf(ele);if(idx>-1){arr.splice(idx,1);return true}return false}function arrAdd(arr,item){if(!arr.includes(item)){arr.push(item);return true}return false}function strHashCode(){var strings=[];for(var _i=0;_i<arguments.length;_i++){strings[_i]=arguments[_i];}var h=0;for(var j=0;j<arguments.length;j++){var s=strings[j];for(var i=0;i<s.length;i++){h=Math.imul(31,h)+s.charCodeAt(i)|0;}}return h}function arrAddByOrder(arr,item,order){var itemOrder=order||RenderPassMeshOrder.ascending;if(arr.includes(item)){return true}arr.push(item);if(arr.length===1){return true}if(itemOrder!==RenderPassMeshOrder.none){var index=arr.length-1;if(index){var currentItem=arr[index];if(itemOrder!==RenderPassMeshOrder.ascending){while(arr[index-1].priority<currentItem.priority){arr[index]=arr[index-1];index--;if(index===0){break}}}else {while(arr[index-1].priority>currentItem.priority){arr[index]=arr[index-1];index--;if(index===0){break}}}arr[index]=currentItem;}}return false}function fastSort(arr,order,start,end){var _a,_b;if(start===void 0){start=0;}if(end===void 0){end=arr.length-1;}if(start>=end){return arr}var left=start,right=end;var base=arr[start];while(left<right){if(order===RenderPassMeshOrder.ascending){while(arr[right].priority>base.priority&&right>=left){right--;}while(arr[left].priority<=base.priority&&left<right){left++;}}else {while(arr[right].priority<base.priority&&right>=left){right--;}while(arr[left].priority>=base.priority&&left<right){left++;}}_a=[arr[right],arr[left]],arr[left]=_a[0],arr[right]=_a[1];}_b=[arr[left],arr[start]],arr[start]=_b[0],arr[left]=_b[1];fastSort(arr,order,start,left-1);fastSort(arr,order,right+1,end);return arr}function sortByOrder(arr,order){var itemOrder=order||RenderPassMeshOrder.ascending;if(arr.length===0||arr.length===1){return arr}if(itemOrder===RenderPassMeshOrder.none){return arr}else {if(arr.length<=30){var length_1=arr.length;for(var i=1;i<length_1;i++){var currentItem=arr[i];var index=i;if(itemOrder!==RenderPassMeshOrder.ascending){while(index>=1&&arr[index-1].priority<currentItem.priority){arr[index]=arr[index-1];index--;if(index===0){break}}}else {while(index>=1&&arr[index-1].priority>currentItem.priority){arr[index]=arr[index-1];index--;if(index===0){break}}}arr[index]=currentItem;}return arr}else {return fastSort(arr,itemOrder)}}}var hasOwnProperty=Object.prototype.hasOwnProperty;function forEach(object,callback,thisObj){if(isObj(object)){if(thisObj===undefined){thisObj=object;}for(var name_1 in object){if(hasOwnProperty.call(object,name_1)){callback.call(thisObj,object[name_1],name_1);}}}return object}function throwDestroyedError(){throw Error("destroyed item cannot be used again")}var RenderFrameInternal=function(){function RenderFrameInternal(){}RenderFrameInternal.render=function(frame){var passes=frame._renderPasses;var renderer=frame.renderer;if(renderer.isDestroyed){return consoleError("renderer is destroyed",renderer)}frame.renderer.shaderLibrary.compileAllShaders();clear(renderer.internal,frame.clearAction);var renderState={currentFrame:frame};for(var i=0;i<passes.length;i++){var pass=passes[i];var delegate=pass.delegate;if(pass.isDestroyed){consoleError("render pass ".concat(pass.name," destroyed"),pass);}else {delegate.willBeginRenderPass&&(delegate===null||delegate===void 0?void 0:delegate.willBeginRenderPass(pass,renderState));this.renderRenderPass(renderer,pass,renderState);delegate.didEndRenderPass&&(delegate===null||delegate===void 0?void 0:delegate.didEndRenderPass(pass,renderState));}}};RenderFrameInternal.renderRenderPass=function(renderer,pass,renderState){renderState.currentPass=pass;setupRenderPass(renderer,pass);var camera=pass.camera;renderMeshesByCamera(renderer,camera,renderState);endRenderPass(renderer,pass);};return RenderFrameInternal}();function endRenderPass(renderer,renderPass){if(renderPass.storeAction){clear(renderer.internal,renderPass.storeAction);}renderPass.unbind();}function renderMeshesByCamera(renderer,camera,state){state.currentCamera=camera;var sortedMeshes=state.currentPass.meshes;var delegate=state.currentPass.delegate;for(var i=0;i<sortedMeshes.length;i++){var mesh=sortedMeshes[i];if(mesh.isDestroyed){consoleError("mesh ".concat(mesh.name," destroyed"),mesh);}else if(!mesh.hide){delegate.willRenderMesh&&delegate.willRenderMesh(mesh,state);renderMesh(renderer,mesh,state);delegate.didiRenderMesh&&delegate.didiRenderMesh(mesh,state);}}for(var i=0;i<sortedMeshes.length;i++){var mtl=sortedMeshes[i].material;if(mtl){mtl.dataBlocks.forEach((function(d){return d.clearFlags()}));}}}function setupRenderPass(renderer,renderPass){renderPass.assignRenderer(renderer);loadRenderPassAttachments(renderer.internal,renderPass);}function renderMesh(renderer,mesh,state){state.currentMesh=mesh;mesh.material.assignRenderer(renderer);var material=mesh.material.materialInternal;if(material){var program_1=material.getProgram();if(program_1){material.setupStates();program_1.setupUniforms(state);mesh.geometries.forEach((function(geometry){geometry.assignRenderer(renderer);geometry.flush();var vao=program_1.setupAttributes(geometry.internal);geometry.internal.draw(state);if(vao){vao.unbind();}}));}}}function loadRenderPassAttachments(renderer,renderPass){renderPass.bind();if(renderPass.clearAction){clear(renderer,renderPass.clearAction);}}function clear(renderer,action){var state=renderer.state;var bit=0;if(action.colorAction===TextureLoadAction.clear){var clearColor=action.clearColor;if(clearColor){state.clearColor(clearColor[0],clearColor[1],clearColor[2],clearColor[3]);}state.colorMask(true,true,true,true);bit=constants.COLOR_BUFFER_BIT;}if(action.stencilAction===TextureLoadAction.clear){state.stencilMask(255);state.clearStencil(action.clearStencil||0);bit=bit|constants.STENCIL_BUFFER_BIT;}if(action.depthAction===TextureLoadAction.clear){var depth=action.clearDepth;state.depthMask(true);state.clearDepth(Number.isFinite(depth)?depth:1);bit=bit|constants.DEPTH_BUFFER_BIT;}if(bit){state.clear(bit);}}var MarsSemanticMap=function(){function MarsSemanticMap(semantics){this.semantics=Object.assign({},semantics||{});}MarsSemanticMap.prototype.toObject=function(){return Object.assign({},this.semantics)};MarsSemanticMap.prototype.setSemantic=function(name,value){if(value===undefined){delete this.semantics[name];}else {this.semantics[name]=value;}};MarsSemanticMap.prototype.getSemanticValue=function(name,state){var ret=this.semantics[name];if(isFunc(ret)){return ret(state)}return ret};MarsSemanticMap.prototype.hasSemanticValue=function(name){return name in this.semantics};MarsSemanticMap.prototype.destroy=function(){var c=this.semantics;forEach(c,(function(va,name){if(va&&isFunc(va.destroy)){va.destroy();}delete c[name];}));};return MarsSemanticMap}();var renderFrameSeed=1;var MarsRenderFrame=function(){function MarsRenderFrame(options,renderer){this._isDestroyed=false;this.setRenderPasses(options.renderPasses||[]);this.semantics=new MarsSemanticMap(options.semantics);this.clearAction=options.clearAction||{};this.name=options.name||"RenderFrame"+renderFrameSeed++;if(renderer){this.assignRenderer(renderer);}}Object.defineProperty(MarsRenderFrame.prototype,"renderPasses",{get:function(){return this._renderPasses.slice()},enumerable:false,configurable:true});Object.defineProperty(MarsRenderFrame.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});Object.defineProperty(MarsRenderFrame.prototype,"renderer",{get:function(){return this._renderer},enumerable:false,configurable:true});MarsRenderFrame.prototype.assignRenderer=function(renderer){if(!this._renderer){this._renderer=renderer;}return this};MarsRenderFrame.prototype.destroy=function(options){if((options===null||options===void 0?void 0:options.semantics)!==DestroyOptions.keep){this.semantics.destroy();}var pass=(options===null||options===void 0?void 0:options.passes)?options.passes:undefined;if(pass!==DestroyOptions.keep){this._renderPasses.forEach((function(renderPass){renderPass.destroy(pass);}));}this._renderPasses.length=0;this.assignRenderer=throwDestroyedError;this._isDestroyed=true;};MarsRenderFrame.prototype.render=function(){RenderFrameInternal.render(this);};MarsRenderFrame.prototype.setRenderPasses=function(passes){this._renderPasses=sortByOrder(passes.slice());};MarsRenderFrame.prototype.addRenderPass=function(pass){arrAddByOrder(this._renderPasses,pass);};MarsRenderFrame.prototype.removeRenderPass=function(pass){arrRemove(this._renderPasses,pass);};MarsRenderFrame.prototype.forEachRenderPass=function(callback){var passes=this._renderPasses;for(var i=0;i<passes.length;i++){callback.call(passes,passes[i],i,this);}};return MarsRenderFrame}();var COMPRESSED_TEXTURE_PVRTC$1=1;var COMPRESSED_TEXTURE_ASTC$1=2;var GPUCapabilityEmpty=function(){function GPUCapabilityEmpty(){this.level=0;this.capability={floatTexture:0,halfFloatTexture:0,maxVertexUniforms:0,maxVertexTextures:0,maxFragmentUniforms:0,maxFragmentTextures:0,maxTextureSize:0,maxShaderTexCount:0,maxTextureAnisotropy:0,compressedTexture:0,shaderTextureLod:false};this.type="none";}GPUCapabilityEmpty.prototype.setup=function(gl){};return GPUCapabilityEmpty}();var GLGPUBuffer=function(){function GLGPUBuffer(options,renderer){this._isDestroyed=false;this.target=options.target||constants.ARRAY_BUFFER;this.type=options.type||constants.FLOAT;this.renderer=renderer;this.glBuffer=renderer.createGLBuffer(this,options.name);this.usage=options.usage||constants.STATIC_DRAW;this.bytesPerElement=getBytesPerElementByGLType(this.type);this._byteLength=0;if(options.data){this.bufferData(options.data);}else if(options.elementCount){this.bufferData(getBytesPerElementByGLType(this.type)*options.elementCount);}}Object.defineProperty(GLGPUBuffer.prototype,"byteLength",{get:function(){return this._byteLength},enumerable:false,configurable:true});Object.defineProperty(GLGPUBuffer.prototype,"isBuffer",{get:function(){return true},enumerable:false,configurable:true});Object.defineProperty(GLGPUBuffer.prototype,"elementCount",{get:function(){return this.byteLength/this.bytesPerElement},enumerable:false,configurable:true});Object.defineProperty(GLGPUBuffer.prototype,"level",{get:function(){var _a;return ((_a=this.renderer)===null||_a===void 0?void 0:_a.level)||1},enumerable:false,configurable:true});Object.defineProperty(GLGPUBuffer.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});GLGPUBuffer.prototype.bind=function(){var _a;var gl=(_a=this.renderer)===null||_a===void 0?void 0:_a.gl;gl.bindBuffer(this.target,this.glBuffer);};GLGPUBuffer.prototype.bufferData=function(typedArray){var byteLength=Number.isInteger(typedArray)?typedArray:typedArray.byteLength;if(this.renderer){this._byteLength=byteLength;var gl=this.renderer.gl;var target=this.target;gl.bindBuffer(target,this.glBuffer);if(byteLength===0){gl.bufferData(target,1,this.usage);}else {gl.bufferData(target,byteLength,this.usage);if(isObj(typedArray)){gl.bufferSubData(target,0,typedArray);}}}else {this._byteLength=0;}};GLGPUBuffer.prototype.bufferSubData=function(elementOffset,typedArray){if(this.renderer){var gl=this.renderer.gl;var target=this.target;var byteOffset=elementOffset*this.bytesPerElement;gl.bindBuffer(target,this.glBuffer);var byteLength=byteOffset+typedArray.byteLength;if(byteLength>this._byteLength){this._byteLength=byteLength;gl.bufferData(target,byteLength,this.usage);}gl.bufferSubData(target,byteOffset,typedArray);}else {this._byteLength=0;}};GLGPUBuffer.prototype.destroy=function(){var _a;(_a=this.renderer)===null||_a===void 0?void 0:_a.deleteGPUBuffer(this);this.glBuffer=this.renderer=null;this._isDestroyed=true;};GLGPUBuffer.prototype.readSubData=function(elementOffset,typedArray){var _a;if(this.level===2){var gl=(_a=this.renderer)===null||_a===void 0?void 0:_a.gl;if(gl){gl.getBufferSubData(this.target,elementOffset*this.bytesPerElement,typedArray);return true}}return false};GLGPUBuffer.prototype.assignRenderer=function(renderer){if(!this.renderer){this.renderer=renderer.internal;}return this};return GLGPUBuffer}();var WebGLState=function(){function WebGLState(gl){this.noCache=false;this._gl=gl;this._maxTextureCount=gl.TEXTURE0+gl.getParameter(gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS)-1;this._reset();}WebGLState.prototype.destroy=function(){this.gl=null;};WebGLState.prototype._reset=function(){this._dict={};this._activeTextureIndex=constants.TEXTURE0;this._textureUnitDict={};this._currentFramebuffer={};this._pixelStorei={};this._currentRenderBuffer={};};WebGLState.prototype.toggle=function(capability,enable){if(enable){this.enable(capability);}else {this.disable(capability);}};WebGLState.prototype.enable=function(capability){var value=this._dict[capability];if(value!==true){this._dict[capability]=true;this._gl.enable(capability);}};WebGLState.prototype.disable=function(capability){var value=this._dict[capability];if(value!==false){this._dict[capability]=false;this._gl.disable(capability);}};WebGLState.prototype.bindFramebuffer=function(target,framebuffer){if(this._currentFramebuffer[target]!==framebuffer){this._currentFramebuffer[target]=framebuffer;this._gl.bindFramebuffer(target,framebuffer);}};WebGLState.prototype.bindRenderBuffer=function(target,renderBuffer){if(this._currentRenderBuffer[target]!==renderBuffer){this._currentRenderBuffer[target]=renderBuffer;this._gl.bindRenderbuffer(target,renderBuffer);}};WebGLState.prototype.bindSystemFramebuffer=function(){this.bindFramebuffer(this._gl.FRAMEBUFFER,null);};WebGLState.prototype.useProgram=function(program){this._set1("useProgram",program);};WebGLState.prototype.clear=function(mask){this._gl.clear(mask);};WebGLState.prototype.clearDepth=function(depth){this._set1("clearDepth",depth);};WebGLState.prototype.depthFunc=function(func){this._set1("depthFunc",func);};WebGLState.prototype.depthMask=function(flag){this._set1("depthMask",flag);};WebGLState.prototype.polygonOffset=function(factor,unit){this._set2("polygonOffset",factor,unit);};WebGLState.prototype.depthRange=function(zNear,zFar){this._set2("depthRange",zNear,zFar);};WebGLState.prototype.clearStencil=function(s){this._set1("clearStencil",s);};WebGLState.prototype.stencilMask=function(mask){this.stencilMaskSeparate(this._gl.FRONT,mask);this.stencilMaskSeparate(this._gl.BACK,mask);};WebGLState.prototype.stencilFunc=function(func,ref,mask){this.stencilFuncSeparate(this._gl.FRONT,func,ref,mask);this.stencilFuncSeparate(this._gl.BACK,func,ref,mask);};WebGLState.prototype.stencilFuncSeparate=function(face,func,ref,mask){this._set4("stencilFuncSeparate",face,func,ref,mask);};WebGLState.prototype.stencilMaskSeparate=function(face,mask){this._set2("stencilMaskSeparate",face,mask);};WebGLState.prototype.stencilOp=function(fail,zfail,zpass){this.stencilOpSeparate(this._gl.FRONT,fail,zfail,zpass);this.stencilOpSeparate(this._gl.BACK,fail,zfail,zpass);};WebGLState.prototype.stencilOpSeparate=function(face,fail,zfail,zpass){this._set4("stencilOpSeparate",face,fail,zfail,zpass);};WebGLState.prototype.cullFace=function(mode){this._set1("cullFace",mode);};WebGLState.prototype.frontFace=function(mode){this._set1("frontFace",mode);};WebGLState.prototype.clearColor=function(red,green,blue,alpha){this._set4("clearColor",red,green,blue,alpha);};WebGLState.prototype.colorMask=function(red,green,blue,alpha){this._set4("colorMask",red,green,blue,alpha);};WebGLState.prototype.blendColor=function(red,green,blue,alpha){this._set4("blendColor",red,green,blue,alpha);};WebGLState.prototype.blendFunc=function(sfactor,dfactor){this.blendFuncSeparate(sfactor,dfactor,sfactor,dfactor);};WebGLState.prototype.blendFuncSeparate=function(srcRGB,dstRGB,srcAlpha,dstAlpha){this._set4("blendFuncSeparate",srcRGB,dstRGB,srcAlpha,dstAlpha);};WebGLState.prototype.blendEquation=function(mode){this._set1("blendEquation",mode);};WebGLState.prototype.blendEquationSeparate=function(modeRGB,modeAlpha){this._set2("blendEquationSeparate",modeRGB,modeAlpha);};WebGLState.prototype.pixelStorei=function(pname,param){var currentParam=this._pixelStorei[pname];if(currentParam!==param){this._pixelStorei[pname]=param;this._gl.pixelStorei(pname,param);}};WebGLState.prototype.viewport=function(x,y,width,height){this._set4("viewport",x,y,width,height);};WebGLState.prototype.activeTexture=function(texture){texture=Math.min(texture,this._maxTextureCount);if(this._activeTextureIndex!==texture||this.noCache){this._activeTextureIndex=texture;this._gl.activeTexture(texture);}};WebGLState.prototype.bindTexture=function(target,texture,force){if(this._currentTextureBinding!==texture||force||this.noCache){this._gl.bindTexture(target,texture);this._currentTextureBinding=texture;}this._textureUnitDict[this._activeTextureIndex]=texture;};WebGLState.prototype._set1=function(name,param){var value=this._dict[name];if(value!==param){this._dict[name]=param;this._gl[name](param);}};WebGLState.prototype._set2=function(name,param0,param1){var value=this._dict[name];if(!value){value=this._dict[name]={x:NaN,y:NaN};}if(value.x!==param0||value.y!==param1){this._gl[name](value.x=param0,value.y=param1);}};WebGLState.prototype._set3=function(name,param0,param1,param2){var value=this._dict[name];if(!value){value=this._dict[name]={x:NaN,y:NaN,z:NaN};}if(value.x!==param0||value.y!==param1||value.z!==param2){this._gl[name](value.x=param0,value.y=param1,value.z=param2);}};WebGLState.prototype._set4=function(name,param0,param1,param2,param3){var value=this._dict[name];if(!value){value=this._dict[name]={x:NaN,y:NaN,z:NaN,w:NaN};}if(value.x!==param0||value.y!==param1||value.z!==param2||value.w!==param3){this._gl[name](value.x=param0,value.y=param1,value.z=param2,value.w=param3);}};WebGLState.prototype.get=function(name){return this._dict[name]};return WebGLState}();function requestAnimationFrame$1(cb){return window.requestAnimationFrame(cb)}var _a$5;var DATA_DICT=(_a$5={},_a$5[constants.FLOAT]={name:constants.FLOAT,uniform:function(gl,info,value){if(value.length!=undefined){gl.uniform1fv(info.loc,value);}else {gl.uniform1f(info.loc,value);}}},_a$5[constants.FLOAT_VEC2]={name:constants.FLOAT_VEC2,uniform:function(gl,info,value){gl.uniform2fv(info.loc,value);}},_a$5[constants.FLOAT_VEC3]={name:constants.FLOAT_VEC3,uniform:function(gl,info,value){gl.uniform3fv(info.loc,value);}},_a$5[constants.FLOAT_VEC4]={name:constants.FLOAT_VEC4,uniform:function(gl,info,value){gl.uniform4fv(info.loc,value);}},_a$5[constants.FLOAT_MAT2]={name:constants.FLOAT_MAT2,uniform:function(gl,info,value){gl.uniformMatrix2fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT2x3]={name:constants.FLOAT_MAT2x3,uniform:function(gl,info,value){gl.uniformMatrix2x3fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT2x4]={name:constants.FLOAT_MAT2x4,uniform:function(gl,info,value){gl.uniformMatrix2x3fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT3]={name:constants.FLOAT_MAT3,uniform:function(gl,info,value){gl.uniformMatrix3fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT3x2]={name:constants.FLOAT_MAT3x2,uniform:function(gl,info,value){gl.uniformMatrix3x2fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT3x4]={name:constants.FLOAT_MAT3x4,uniform:function(gl,info,value){gl.uniformMatrix3x4fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT4]={name:constants.FLOAT_MAT4,uniform:function(gl,info,value){gl.uniformMatrix4fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT4x3]={name:constants.FLOAT_MAT4x3,uniform:function(gl,info,value){gl.uniformMatrix4x3fv(info.loc,false,value);}},_a$5[constants.FLOAT_MAT4x2]={name:constants.FLOAT_MAT4x2,uniform:function(gl,info,value){gl.uniformMatrix4x2fv(info.loc,false,value);}},_a$5[constants.INT]={name:constants.INT,uniform:function(gl,info,value){if(value.length!=undefined){gl.uniform1iv(info.loc,value);}else {gl.uniform1i(info.loc,value);}}},_a$5[constants.INT_VEC2]={name:constants.INT_VEC2,uniform:function(gl,info,value){gl.uniform2iv(info.loc,value);}},_a$5[constants.INT_VEC3]={name:constants.INT_VEC3,uniform:function(gl,info,value){gl.uniform3iv(info.loc,value);}},_a$5[constants.INT_VEC4]={name:constants.INT_VEC4,uniform:function(gl,info,value){gl.uniform4iv(info.loc,value);}},_a$5[constants.UNSIGNED_INT]={name:constants.UNSIGNED_INT,uniform:function(gl,info,value){gl.uniform1uiv(info.loc,value);}},_a$5[constants.UNSIGNED_INT_VEC2]={name:constants.UNSIGNED_INT_VEC2,uniform:function(gl,info,value){gl.uniform2uiv(info.loc,value);}},_a$5[constants.UNSIGNED_INT_VEC3]={name:constants.UNSIGNED_INT_VEC3,uniform:function(gl,info,value){gl.uniform3uiv(info.loc,value);}},_a$5[constants.UNSIGNED_INT_VEC4]={name:constants.UNSIGNED_INT_VEC4,uniform:function(gl,info,value){gl.uniform4uiv(info.loc,value);}},_a$5[constants.BOOL]={name:constants.BOOL,uniform:function(gl,info,value){if(value.length!=undefined){gl.uniform1iv(info.loc,value);}else {gl.uniform1f(info.loc,value);}}},_a$5[constants.BOOL_VEC2]={name:constants.BOOL_VEC2,uniform:function(gl,info,value){gl.uniform2iv(info.loc,value);}},_a$5[constants.BOOL_VEC4]={name:constants.BOOL_VEC4,uniform:function(gl,info,value){gl.uniform4iv(info.loc,value);}},_a$5[constants.BOOL_VEC3]={name:constants.BOOL_VEC3,uniform:function(gl,info,value){gl.uniform3iv(info.loc,value);}},_a$5[constants.SAMPLER_2D]={name:constants.SAMPLER_2D,uniform:assignTexUniform},_a$5[constants.SAMPLER_CUBE]={name:constants.SAMPLER_CUBE,uniform:assignTexUniform},_a$5);function assignTexUniform(gl,info,value,renderer){if(value){if(info.size>1){if(Array.isArray(value)){value.forEach((function(tex,index){assignTextureLoc(gl,info,tex,renderer,index);}));}else {consoleError("".concat(info.name,"[").concat(info.size,"] expect texture arrays"));}}else {assignTextureLoc(gl,info,value,renderer,0);}}}function assignTextureLoc(gl,info,value,renderer,index){if(value){if(value.isDestroyed){return consoleError("texture ".concat(value.name," destroyed "),value)}renderer.state.activeTexture(gl.TEXTURE0+info.textureIndex+index);var glTex=value.internal;if(glTex){renderer.state.bindTexture(glTex.target,glTex.glHandle,true);}else {consoleWarn("texture not assigned to gl");}}}var _a$4,_b$1;var BlockUniformInfoOffset=1;var BlockUniformInfoByteLength=8;var BlockUniformInfoType=0;var BlockUniformInfoArrayStride=4;var BlockUniformInfoArraySize=2;var BlockUniformInfoRowStride=5;function getUboHash(spec){var ret=Object.keys(spec.uniforms).map((function(name){return name+"["+spec.uniforms[name].join(":")+"]"})).join("+");return strHashCode(spec.name+"+",spec.size+"+",spec.uniformIndices.length+"+",ret)}function createUniformBlockSpecsFromProgram(gl,program,blockUniformNames){var blockSpecs=[];var numUniformBlocks=gl.getProgramParameter(program,gl.ACTIVE_UNIFORM_BLOCKS);var _loop_1=function(ii){var name_1=gl.getActiveUniformBlockName(program,ii);var blockSpec={index:gl.getUniformBlockIndex(program,name_1),usedByVertexShader:gl.getActiveUniformBlockParameter(program,ii,gl.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),usedByFragmentShader:gl.getActiveUniformBlockParameter(program,ii,gl.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),size:gl.getActiveUniformBlockParameter(program,ii,gl.UNIFORM_BLOCK_DATA_SIZE),uniformIndices:gl.getActiveUniformBlockParameter(program,ii,gl.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),used:false,uniforms:{},name:name_1,id:""};blockSpec.used=blockSpec.usedByVertexShader||blockSpec.usedByFragmentShader;blockSpecs[ii]=blockSpec;var indices=blockSpec.uniformIndices;var uniformNames=[];for(var i=0;i<indices.length;i++){var name_2=gl.getActiveUniform(program,indices[i]).name.replace("[0]","");blockSpec.uniforms[name_2]=[0,0,0,0,0,0,0,i,0];uniformNames[i]=name_2;blockUniformNames.push(name_2);}[gl.UNIFORM_TYPE,gl.UNIFORM_OFFSET,gl.UNIFORM_SIZE,gl.UNIFORM_BLOCK_INDEX,gl.UNIFORM_ARRAY_STRIDE,gl.UNIFORM_MATRIX_STRIDE,gl.UNIFORM_IS_ROW_MAJOR].forEach((function(param,pi){gl.getActiveUniforms(program,indices,param).forEach((function(value,idx){var name=uniformNames[idx];blockSpec.uniforms[name][pi]=+value;}));}));for(var i=0;i<uniformNames.length;i++){var uniform=blockSpec.uniforms[uniformNames[i]];var nextUniform=blockSpec.uniforms[uniformNames[i+1]];var size=nextUniform?nextUniform[1]:blockSpec.size;uniform[8]=size-uniform[1];}blockSpec.id=getUboHash(blockSpec)+"";};for(var ii=0;ii<numUniformBlocks;++ii){_loop_1(ii);}return blockSpecs}function numberSetter(type){return function(value,info,name,range){var flag={start:info[BlockUniformInfoOffset],dirty:true};var arrSize=info[BlockUniformInfoArraySize];if(arrSize>1){var values=value;if(values.length){var eleCount=range[1]||values.length;var vecLen=info[BlockUniformInfoArrayStride]/type.BYTES_PER_ELEMENT;var buffer=flag.buffer=new type(eleCount*vecLen);var start=range[0]||0;for(var i=0;i<eleCount;i++){buffer[i*vecLen]=values[i+start];}flag.start+=start*vecLen;}}else {flag.buffer=new type([value]);}return flag}}var arrSetter=function(type){return function setArray(value,info,name,range){var blockByteLen=info[BlockUniformInfoByteLength];var arrSize=info[BlockUniformInfoArraySize];var rowStride=info[BlockUniformInfoRowStride];var entryStride=arrSize===1?blockByteLen:info[BlockUniformInfoArrayStride];var entryRowCount=rowStride?entryStride/rowStride:1;var rowNumPadding=entryStride/type.BYTES_PER_ELEMENT/entryRowCount;var maxRowCount=blockByteLen/type.BYTES_PER_ELEMENT/rowNumPadding;var numPerEntry=ItemPerValueMap[info[BlockUniformInfoType]];var numPerRow=numPerEntry/entryRowCount;var valueStartIndex=(range[0]||0)*numPerEntry;var totalRow=range[1]?entryRowCount*range[1]:maxRowCount;var buffer=new type(rowNumPadding*totalRow);var flag={start:info[BlockUniformInfoOffset]+entryStride*(range[0]||0),dirty:true,buffer:buffer};for(var i=0,bufferTarget=0,sourceIndex=valueStartIndex;i<totalRow;i++){for(var j=0;j<numPerRow;j++){buffer[bufferTarget+j]=value[sourceIndex+j];}bufferTarget+=rowNumPadding;sourceIndex+=numPerRow;}return flag}};var setFloat32Array=arrSetter(Float32Array);var setInt32Array=arrSetter(Int32Array);var setUInt8Array=arrSetter(Uint8Array);var MemorySetter=(_a$4={},_a$4[constants.FLOAT]=numberSetter(Float32Array),_a$4[constants.INT]=numberSetter(Int32Array),_a$4[constants.UNSIGNED_INT]=numberSetter(Uint32Array),_a$4[constants.SHORT]=numberSetter(Int16Array),_a$4[constants.BOOL]=numberSetter(Uint8Array),_a$4[constants.UNSIGNED_SHORT]=numberSetter(Uint16Array),_a$4[constants.FLOAT_VEC2]=setFloat32Array,_a$4[constants.FLOAT_VEC3]=setFloat32Array,_a$4[constants.FLOAT_VEC4]=setFloat32Array,_a$4[constants.FLOAT_MAT2]=setFloat32Array,_a$4[constants.FLOAT_MAT3]=setFloat32Array,_a$4[constants.FLOAT_MAT4]=setFloat32Array,_a$4[constants.FLOAT_MAT2x3]=setFloat32Array,_a$4[constants.FLOAT_MAT2x4]=setFloat32Array,_a$4[constants.FLOAT_MAT4x3]=setFloat32Array,_a$4[constants.FLOAT_MAT4x2]=setFloat32Array,_a$4[constants.FLOAT_MAT3x4]=setFloat32Array,_a$4[constants.FLOAT_MAT3x2]=setFloat32Array,_a$4[constants.INT_VEC2]=setInt32Array,_a$4[constants.INT_VEC3]=setInt32Array,_a$4[constants.INT_VEC4]=setInt32Array,_a$4[constants.UNSIGNED_INT_VEC2]=setInt32Array,_a$4[constants.UNSIGNED_INT_VEC3]=setInt32Array,_a$4[constants.UNSIGNED_INT_VEC4]=setInt32Array,_a$4[constants.BOOL_VEC2]=setUInt8Array,_a$4[constants.BOOL_VEC3]=setUInt8Array,_a$4[constants.BOOL_VEC4]=setUInt8Array,_a$4);var ItemPerValueMap=(_b$1={},_b$1[constants.FLOAT]=1,_b$1[constants.INT]=1,_b$1[constants.UNSIGNED_INT]=1,_b$1[constants.SHORT]=1,_b$1[constants.BOOL]=1,_b$1[constants.UNSIGNED_SHORT]=1,_b$1[constants.FLOAT_VEC2]=2,_b$1[constants.FLOAT_VEC3]=3,_b$1[constants.FLOAT_VEC4]=4,_b$1[constants.FLOAT_MAT2]=4,_b$1[constants.FLOAT_MAT3]=9,_b$1[constants.FLOAT_MAT4]=16,_b$1[constants.FLOAT_MAT2x3]=6,_b$1[constants.FLOAT_MAT2x4]=8,_b$1[constants.FLOAT_MAT4x3]=12,_b$1[constants.FLOAT_MAT4x2]=8,_b$1[constants.FLOAT_MAT3x4]=12,_b$1[constants.FLOAT_MAT3x2]=6,_b$1[constants.INT_VEC2]=2,_b$1[constants.INT_VEC3]=3,_b$1[constants.INT_VEC4]=4,_b$1[constants.UNSIGNED_INT_VEC2]=2,_b$1[constants.UNSIGNED_INT_VEC3]=3,_b$1[constants.UNSIGNED_INT_VEC4]=4,_b$1[constants.BOOL_VEC2]=2,_b$1[constants.BOOL_VEC3]=3,_b$1[constants.BOOL_VEC4]=4,_b$1);var fullRange=[0,0];var UniformBlockBuffer=function(){function UniformBlockBuffer(renderer,info){this.buffer=new GLGPUBuffer({target:constants.UNIFORM_BUFFER,name:info.name,type:constants.BYTE,elementCount:info.size},renderer);this.dirtyFlags={};this.info=info;}UniformBlockBuffer.prototype.setValues=function(uniformValues,dirtyFlags,uniformValueOffsets){var _this=this;forEach(uniformValues,(function(value,name){var uniformInfo=_this.info.uniforms[name];if(uniformInfo&&dirtyFlags[name]){var range=uniformValueOffsets[name]||fullRange;var setter=MemorySetter[uniformInfo[BlockUniformInfoType]];_this.dirtyFlags[name]=setter(value,uniformInfo,name,range);}}));};UniformBlockBuffer.prototype.bind=function(gl,program,bufferBindIndex){var _this=this;var buffer=this.buffer;if(buffer){buffer.bind();forEach(this.dirtyFlags,(function(flag,name){if(flag.dirty){buffer.bufferSubData(flag.start,new Uint8Array(flag.buffer.buffer));if(!_this.keepData){delete flag.buffer;}flag.dirty=false;}}));gl.uniformBlockBinding(program,bufferBindIndex,bufferBindIndex);gl.bindBufferRange(gl.UNIFORM_BUFFER,bufferBindIndex,buffer.glBuffer,0,this.info.size);}};UniformBlockBuffer.prototype.destroy=function(){if(this.buffer){this.buffer.destroy();this.buffer=undefined;}};return UniformBlockBuffer}();var temArr=new Set;var GLProgram=function(){function GLProgram(renderer,program,shared,id){this.glHandle=program;this.renderer=renderer;this.shared=shared;this.uniformBlockMap={};this.id=id;this.init(renderer,program);this._vaos=[];}GLProgram.prototype.init=function(renderer,program){var _this=this;var gl=renderer.gl;renderer.state.useProgram(program);var num=gl.getProgramParameter(program,gl.ACTIVE_ATTRIBUTES);var attrMap={};for(var i=0;i<num;i++){var _a=gl.getActiveAttrib(program,i),name_1=_a.name,type=_a.type,size=_a.size;var loc=gl.getAttribLocation(program,name_1);attrMap[name_1]={type:type,name:name_1,size:size,loc:loc};}this.attrInfoMap=attrMap;var uniformMap={};num=gl.getProgramParameter(program,gl.ACTIVE_UNIFORMS);var textureIndex=0;var emptyTexture2D=renderer.emptyTexture2D;var emptyTextureCube=renderer.emptyTextureCube;var blockUniformNames=[];if(renderer.level===2){this._uniformBlocks=createUniformBlockSpecsFromProgram(gl,program,blockUniformNames);this._uniformBlocks.forEach((function(b){return _this.uniformBlockMap[b.name]=b}));}else {this._uniformBlocks=[];}for(var i=0;i<num;i++){var info=gl.getActiveUniform(program,i);var _b=gl.getActiveUniform(program,i),size=_b.size,type=_b.type;var name_2=info.name;var location_1=null;if(/\[0\]$/.test(name_2)){location_1=gl.getUniformLocation(program,name_2);}name_2=name_2.replace(/\[0\]$/,"");if(!location_1){location_1=gl.getUniformLocation(program,name_2);}if(!location_1){if(!blockUniformNames.includes(name_2)){consoleWarn("get uniform ".concat(name_2," loc fail"));}continue}this.renderer._assignInspectorName(location_1,name_2);var locTexIndex=-1;if(type===gl.SAMPLER_2D||type===gl.SAMPLER_CUBE){locTexIndex=textureIndex;for(var k=0;k<size;k++){var subLoc=k>0?gl.getUniformLocation(program,"".concat(name_2,"[").concat(k,"]")):location_1;var activeIndex=textureIndex+k;if(activeIndex<renderer.gpu.capability.maxShaderTexCount){gl.activeTexture(gl.TEXTURE0+activeIndex);if(type===gl.SAMPLER_2D){gl.bindTexture(gl.TEXTURE_2D,emptyTexture2D.glHandle);}else {gl.bindTexture(gl.TEXTURE_CUBE_MAP,emptyTextureCube.glHandle);}gl.uniform1i(subLoc,activeIndex);}else {consoleError("texture index ".concat(activeIndex," overflows max ").concat(renderer.gpu.capability.maxShaderTexCount));}}textureIndex+=size;}var subInfos=[];for(var j=0;j<size;++j){var fullName=name_2+"["+j+"]";var loc=gl.getUniformLocation(program,fullName);if(loc!==null){subInfos.push({name:fullName,loc:loc,subInfos:[],type:type,size:1,textureIndex:locTexIndex,isTexture:locTexIndex>-1});}}uniformMap[name_2]={name:name_2,loc:location_1,subInfos:subInfos,type:type,size:size,textureIndex:locTexIndex,isTexture:locTexIndex>-1};}renderer.state.useProgram(null);gl.activeTexture(gl.TEXTURE0);renderer.state.activeTexture(gl.TEXTURE0);renderer.state.bindTexture(gl.TEXTURE_2D,emptyTexture2D.glHandle,true);this.uniformInfoMap=uniformMap;};GLProgram.prototype.bind=function(){var gl=this.renderer.gl;gl.useProgram(this.glHandle);};GLProgram.prototype.setupUniforms=function(state){var _this=this;this.bind();var frame=state.currentFrame;var material=state.currentMesh.material;var gl=this.renderer.gl;var blocks=material._dataBlocks;var shared=this.shared;var uniformSemantics=material.uniformSemantics;var renderPassSemantics=state.currentPass.semantics;var renderFrameSemantics=frame.semantics;temArr.clear();forEach(this.uniformBlockMap,(function(uboInfo,name){for(var i=0;i<blocks.length;i++){var block=blocks[i];if(uboInfo){var uboBuffer=block.createUboBuffer(uboInfo);if(uboBuffer){block.setUboBuffer(uboBuffer);temArr.add(block);return uboBuffer.bind(gl,_this.glHandle,uboInfo.index)}}}}));forEach(this.uniformInfoMap,(function(info,name){var val,hasUniformValue;for(var i=0;i<blocks.length;i++){var block=blocks[i];if(temArr.has(block)){continue}if(block.hasUniformValue(name)){if(!shared&&!block._uniformFlags[name]&&info.textureIndex===-1){return}val=block.getUniformValue(name);hasUniformValue=true;break}}if(!hasUniformValue){var semanticName=uniformSemantics[name];if(semanticName){if(renderPassSemantics.hasSemanticValue(semanticName)){val=renderPassSemantics.getSemanticValue(semanticName,state);}else if(renderFrameSemantics.hasSemanticValue(semanticName)){val=renderFrameSemantics.getSemanticValue(semanticName,state);}}}if(val!==undefined&&val!==null){_this.setGLUniformValue(name,val,info,gl);}else if(!info.isTexture){consoleWarn("mesh ".concat(state.currentMesh.name," uniform ").concat(name," value unset"));}}));};GLProgram.prototype.setGLUniformValue=function(name,value,info,gl){var uniformInfo=DATA_DICT[info.type];var subInfos=info.subInfos;if(subInfos.length>0&&Array.isArray(value)&&Array.isArray(value[0])){for(var i=0;i<subInfos.length;++i){var subInfo=subInfos[i];uniformInfo.uniform(gl,subInfo,value[i],this.renderer);}return}uniformInfo.uniform(gl,info,value,this.renderer);};GLProgram.prototype.setupAttributes=function(geometry){var _a;var gl=this.renderer.gl;var vao=geometry.createVao(this.id);if(vao){vao.bind();if(vao.ready){return vao}else {arrAdd(this._vaos,vao);}}forEach(this.attrInfoMap,(function(attrInfo,name){var attribute=geometry.attributes[name];if(attribute){var buffer=geometry.getGPUBuffer(attribute.dataSource);if(!buffer){throw Error("no buffer named ".concat(attribute.dataSource||name))}buffer.bind();gl.enableVertexAttribArray(attrInfo.loc);gl.vertexAttribPointer(attrInfo.loc,attribute.size,attribute.type,attribute.normalize,attribute.stride||0,attribute.offset||0);}}));(_a=geometry._indexBuffer)===null||_a===void 0?void 0:_a.bind();if(vao){vao.ready=true;}return vao};GLProgram.prototype.destroy=function(){if(this.renderer){this._vaos.forEach((function(vao){return vao.destroy()}));this._vaos.length=0;this.renderer.gl.deleteProgram(this.glHandle);this.renderer=null;}};return GLProgram}();var _a$3;var ShaderType;(function(ShaderType){ShaderType[ShaderType["vertex"]=0]="vertex";ShaderType[ShaderType["fragment"]=1]="fragment";})(ShaderType||(ShaderType={}));var downgradeKeywords=(_a$3={},_a$3[ShaderType.vertex]={in:"attribute",out:"varying"},_a$3[ShaderType.fragment]={in:"varying"},_a$3);var shaderSeed=1;var GLShaderLibrary=function(){function GLShaderLibrary(renderer){this._shaderAllDone=false;this.renderer=renderer;this._shaderMap={};this.shaderResults={};this._programMap={};this._glVertShaderMap=new Map;this._glFragShaderMap=new Map;var gl=this.renderer.gl;this._glAsyncCompileExt=gl.getExtension("KHR_parallel_shader_compile");}GLShaderLibrary.prototype.compileAllShaders=function(asyncCallback){var _this=this;if(!this._shaderAllDone){var res_1=this.shaderResults;var pendings_1=[];forEach(this._shaderMap,(function(result,id){if(!res_1[id]){arrAdd(pendings_1,id);}}));if(asyncCallback){if(pendings_1.length){Promise.all(pendings_1.map((function(id){return new Promise((function(resolve){return _this.compileShader(id,resolve)}))}))).then(asyncCallback).catch((function(){return 0}));}else {asyncCallback([]);}}else {pendings_1.map((function(id){return _this.compileShader(id)}));}this._shaderAllDone=true;}else if(asyncCallback){asyncCallback([]);}};GLShaderLibrary.prototype.getProgram=function(shaderCacheId){if(this._programMap[shaderCacheId]==undefined){if(this._shaderMap[shaderCacheId]!==undefined){this.compileShader(shaderCacheId);}}return this._programMap[shaderCacheId]};GLShaderLibrary.prototype.addMarcosHeader=function(header,shader,type,downgrade){var versionTag=/#version\s+\b\d{3}\b\s*(es)?/;var GLV="WEBGL".concat(this.renderer.level);if(downgrade){header=header+"\n#ifndef ".concat(GLV,"\n#define ").concat(GLV,"\n#endif");}var fullShader=header+"\n"+shader;var match=fullShader.match(versionTag);var version=match?match[0]:"";var realVersion=version;if(version&&version.includes("300")&&this.renderer.level===1&&downgrade){realVersion="";fullShader=fullShader.replace(/\b(in|out)\b/g,(function(str){return downgradeKeywords[type][str]||str}));}return realVersion+"\n"+fullShader.replace(version,"\n")};GLShaderLibrary.prototype.addShader=function(shader){var marcosHead=shader.marcos?combineMaterialMarcos(shader.marcos):"";var vertex=shader.vertex?this.addMarcosHeader(marcosHead,shader.vertex,ShaderType.vertex,shader.downgrade):"";var fragment=shader.fragment?this.addMarcosHeader(marcosHead,shader.fragment,ShaderType.fragment,shader.downgrade):"";var shaderCacheId;var shared=false;if(shader.shared||shader.cacheId){shaderCacheId=shader.cacheId||"shared_".concat(strHashCode(vertex,fragment));shared=true;}else {shaderCacheId="instanced_"+shaderSeed++;}if(!this._shaderMap[shaderCacheId]){this._shaderAllDone=false;this._shaderMap[shaderCacheId]={vertex:vertex,fragment:fragment,name:shader.name||shaderCacheId,shared:shared};}return shaderCacheId};GLShaderLibrary.prototype.compileShader=function(shaderCacheId,asyncCallback){var _this=this;var shaderResult=this.shaderResults[shaderCacheId];if(!shaderResult){var shader_1=this._shaderMap[shaderCacheId];if(!shader_1){return {status:ShaderCompileResultStatus.noShader}}var gl_1=this.renderer.gl;var result_1={shared:shader_1.shared,status:ShaderCompileResultStatus.compiling};var linkProgram_1=this.createProgram(gl_1,shader_1.vertex,shader_1.fragment,result_1);var ext_1=this._glAsyncCompileExt;var startTime_1=Date.now();var checkComplete_1=function(){var shouldLink=!asyncCallback||!ext_1||ext_1&&gl_1.getProgramParameter(result_1.program,ext_1.COMPLETION_STATUS_KHR)==true;var program=shouldLink&&linkProgram_1();if(program){if(result_1.status!==ShaderCompileResultStatus.fail){_this.renderer._assignInspectorName(program,shader_1.name);var glProgram=new GLProgram(_this.renderer,program,!!shader_1.shared,shaderCacheId);gl_1.validateProgram(program);var valid=gl_1.getProgramParameter(program,gl_1.VALIDATE_STATUS);if(!valid){result_1.status=ShaderCompileResultStatus.fail;}else {result_1.status=ShaderCompileResultStatus.success;result_1.compileTime=Date.now()-startTime_1;_this._programMap[shaderCacheId]=glProgram;}}if(result_1.status===ShaderCompileResultStatus.fail){var error=gl_1.getProgramInfoLog(program);result_1.error=error;consoleError("compileProgramError: "+error,"\nvertex:\n",shader_1.vertex,"\nfragment:\n",shader_1.fragment);gl_1.deleteProgram(program);}if(asyncCallback){asyncCallback(result_1);}}else if(asyncCallback){requestAnimationFrame$1(checkComplete_1);}};this.shaderResults[shaderCacheId]=result_1;checkComplete_1();}else if(asyncCallback){asyncCallback(shaderResult);}return this.shaderResults[shaderCacheId]};GLShaderLibrary.prototype.createProgram=function(gl,vs,fs,result){var program=gl.createProgram();var vertexShader=this.createShader(gl,gl.VERTEX_SHADER,vs);var fragShader=this.createShader(gl,gl.FRAGMENT_SHADER,fs);if(program&&vertexShader&&fragShader){gl.attachShader(program,vertexShader);gl.attachShader(program,fragShader);gl.linkProgram(program);result.program=program;result.status=ShaderCompileResultStatus.compiling;return function(){delete result.program;var linked=gl.getProgramParameter(program,gl.LINK_STATUS);if(!linked){checkShader(vertexShader,"vertex",vs);checkShader(fragShader,"fragment",fs);result.status=ShaderCompileResultStatus.fail;return program}return program}}result.status=ShaderCompileResultStatus.fail;return function(){return null};function checkShader(shader,type,code){if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){var error=gl.getShaderInfoLog(shader);consoleError("compile "+type+" error: "+error,code.split("\n").map((function(line,index){return "".concat(index+1," ").concat(line)})).join("\n"));result.error=error;result.status=ShaderCompileResultStatus.fail;}}};GLShaderLibrary.prototype.createShader=function(gl,shaderType,code){var map=shaderType===gl.VERTEX_SHADER?this._glVertShaderMap:this._glFragShaderMap;var strHash=strHashCode(code);var ret=map.get(strHash);if(ret){return ret}var shader=gl.createShader(shaderType);if(shader){gl.shaderSource(shader,code);gl.compileShader(shader);map.set(strHash,shader);}return shader};GLShaderLibrary.prototype.deleteShader=function(cacheId){var program=this._programMap[cacheId];if(program!==undefined){program.destroy();delete this._programMap[cacheId];}var result=this.shaderResults[cacheId];if(result!==undefined){delete this.shaderResults[cacheId];}};GLShaderLibrary.prototype.destroy=function(){this._shaderMap={};forEach(this._programMap,(function(program){program.destroy();}));this._programMap={};if(this.renderer){var gl_2=this.renderer.gl;this._glFragShaderMap.forEach((function(shader){gl_2.deleteShader(shader);}));this._glVertShaderMap.forEach((function(shader){gl_2.deleteShader(shader);}));this._glVertShaderMap=new Map;this._glFragShaderMap=new Map;}this.renderer=null;};return GLShaderLibrary}();function combineMaterialMarcos(marcos){var ret=[];if(marcos){marcos.forEach((function(_a){var key=_a[0],value=_a[1];if(value===true){ret.push("#define ".concat(key));}else if(Number.isFinite(value)){ret.push("#define ".concat(key," ").concat(value));}}));return ret.length?ret.join("\n")+"\n":""}return ""}function isAndroid$1(){{return /\b[Aa]ndroid\b/.test(navigator.userAgent)}}var textureMaxAnisotropyExt;var webGL2ConstructorAvailable=typeof WebGL2RenderingContext==="function";var TYPE_WEBGL="webgl";var TYPE_WEBGL2="webgl2";var GLGPUCapability=function(){function GLGPUCapability(opt){var _a;var gl=opt.gl;var type="none";opt=opt||{};var canvas;{if(!gl){var prefix=TYPE_WEBGL;if(!isAndroid$1()&&webGL2ConstructorAvailable){prefix=opt.glType||TYPE_WEBGL2;}canvas=document.createElement("canvas");gl=canvas.getContext(prefix);if(!gl){prefix="webgl";gl=canvas.getContext(prefix);}}if(gl){type=webGL2ConstructorAvailable&&gl instanceof WebGL2RenderingContext?TYPE_WEBGL2:TYPE_WEBGL;}}this._setupCapability(gl);this.type=type;if(canvas&&gl){(_a=gl.getExtension("WEBGL_lose_context"))===null||_a===void 0?void 0:_a.loseContext();}}GLGPUCapability.prototype._setupCapability=function(gl){var _a;if(gl){this["level"]=webGL2ConstructorAvailable&&gl instanceof WebGL2RenderingContext?2:1;var level2=this.level===2;var textureAnisotropicExt=gl.getExtension("EXT_texture_filter_anisotropic")||gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(!level2){this.vaoExt=gl.getExtension("OES_vertex_array_object");}else {this.UNSIGNED_INT_24_8=gl.UNSIGNED_INT_24_8;}this.drawBufferExtension=gl.getExtension("WEBGL_draw_buffers");var depthTextureExtension=gl.getExtension("WEBGL_depth_texture");if(depthTextureExtension){this.UNSIGNED_INT_24_8=depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;}var halfFloatLinear=!!gl.getExtension("OES_texture_half_float_linear");if(level2&&!halfFloatLinear){halfFloatLinear=this.checkLinearTextureFilter(gl,gl.HALF_FLOAT);}var floatLinear=!!gl.getExtension("OES_texture_float_linear");if(level2&&!floatLinear){floatLinear=this.checkLinearTextureFilter(gl,gl.FLOAT);}this.internalFormatDepth16=level2?gl.DEPTH_COMPONENT16:gl.DEPTH_COMPONENT;this.internalFormatDepth24_stencil8=level2?gl.DEPTH24_STENCIL8:gl.DEPTH_STENCIL;var floatTexture=level2||gl.getExtension("OES_texture_float")?gl.FLOAT:0;var halfFloatTexture=level2?WebGL2RenderingContext.HALF_FLOAT:((_a=gl.getExtension("OES_texture_half_float"))===null||_a===void 0?void 0:_a.HALF_FLOAT_OES)||0;var detail={floatTexture:floatTexture,halfFloatTexture:halfFloatTexture,maxSample:level2?gl.getParameter(gl.MAX_SAMPLES):1,maxVertexUniforms:gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),maxVertexTextures:gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxFragmentUniforms:gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxFragmentTextures:gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS),floatColorAttachment:level2?!!gl.getExtension("EXT_color_buffer_float"):floatTexture>0&&!!gl.getExtension("WEBGL_color_buffer_float"),halfFloatColorAttachment:level2?!!gl.getExtension("EXT_color_buffer_float"):halfFloatTexture>0&&!!gl.getExtension("EXT_color_buffer_half_float"),maxTextureSize:gl.getParameter(gl.MAX_TEXTURE_SIZE),maxShaderTexCount:gl.getParameter(gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),compressedTexture:registerCompressedTexture(gl),halfFloatLinear:halfFloatLinear,floatLinear:floatLinear,maxTextureAnisotropy:textureAnisotropicExt?gl.getParameter(textureAnisotropicExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,shaderTextureLod:level2||!!gl.getExtension("EXT_shader_texture_lod"),instanceDraw:level2||!!gl.getExtension("ANGLE_instanced_arrays"),drawBuffers:level2||!!this.drawBufferExtension,asyncShaderCompile:!!gl.getExtension("KHR_parallel_shader_compile"),intIndexElementBuffer:!!gl.getExtension("OES_element_index_uint"),standardDerivatives:level2||!!gl.getExtension("OES_standard_derivatives"),readableDepthStencilTextures:level2||!!depthTextureExtension,vao:level2||!!this.vaoExt,writableFragDepth:level2||!!gl.getExtension("EXT_frag_depth")};this["capability"]=detail;if(textureAnisotropicExt){textureMaxAnisotropyExt=textureAnisotropicExt.TEXTURE_MAX_ANISOTROPY_EXT;}this["type"]="webgl"+(level2?"2":"");}else {this["capability"]={};}};GLGPUCapability.prototype.checkLinearTextureFilter=function(gl,type){var ret=false;var tex=gl.createTexture();gl.getError();gl.bindTexture(gl.TEXTURE_2D,tex);gl.texImage2D(gl.TEXTURE_2D,0,gl.R16F,1,1,0,gl.RED,type,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);if(!gl.getError()){ret=true;}gl.deleteTexture(tex);return ret};GLGPUCapability.prototype.framebufferTexture2D=function(gl,target,index,textarget,texture){var ext=this.drawBufferExtension;if(this.level===1&&!ext&&index>0){throw Error("draw multiple color buffers not available")}var attachment=ext?ext["COLOR_ATTACHMENT".concat(index,"_WEBGL")]:gl["COLOR_ATTACHMENT"+index];if(attachment){gl.framebufferTexture2D(target,attachment,textarget,texture,0);}else {consoleError("invalid color attachment index:"+index);}};GLGPUCapability.prototype.drawBuffers=function(gl,bufferStates){var ext=this.drawBufferExtension;if(this.level===1&&!ext){if(bufferStates.length>1){throw Error("draw buffers not available")}else {return}}var buffers=bufferStates.map((function(enabled,index){if(enabled){return ext?ext["COLOR_ATTACHMENT".concat(index,"_WEBGL")]:gl["COLOR_ATTACHMENT"+index]}return gl.NONE}));if(ext){ext.drawBuffersWEBGL(buffers);}else {gl.drawBuffers(buffers);}};GLGPUCapability.prototype.setTextureAnisotropic=function(gl,target,level){var max=this.capability.maxTextureAnisotropy;if(max){gl.texParameterf(target,textureMaxAnisotropyExt,Math.min(max,level||4));}};GLGPUCapability.prototype.setup=function(gl){this._setupCapability(gl);};return GLGPUCapability}();function registerCompressedTexture(gl){if(gl.getExtension("WEBGL_compressed_texture_astc")){return COMPRESSED_TEXTURE_ASTC$1}if(gl.getExtension("WEBGL_compressed_texture_pvrtc")||gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc")){return COMPRESSED_TEXTURE_PVRTC$1}return 0}var _a$2,_b;var flipCanvas;var imageBitMapAvailable$1=typeof ImageBitmap==="function"&&typeof createImageBitmap=="function";var GLTexture=function(){function GLTexture(option,renderer){this._mipmapUsed=false;var gl=renderer.gl;this.renderer=renderer;this.glHandle=renderer.createGLTexture(this,option.name);this.options=option;this.target=option.target||gl.TEXTURE_2D;this.update(option);}GLTexture.prototype.setInspectorName=function(name){var _a;(_a=this.renderer)===null||_a===void 0?void 0:_a._assignInspectorName(this.glHandle,name);};GLTexture.prototype.errorLog=function(){consoleError("this this texture has been destroyed");};GLTexture.prototype.update=function(source){var _a,_b;var _this=this;var renderer=this.renderer;var handle=this.glHandle;var target=this.target;var options=this.options;if(renderer&&handle){var width_1=0;var height_1=0;var gl_1=renderer.gl;renderer.state.bindTexture(target,handle);var sourceType=options.sourceType,flipY=options.flipY;var format_1=options.format;var type_1=options.type;var internalFormat_1=options.internalFormat;if(type_1===constants.HALF_FLOAT){type_1=renderer.gpu.capability.halfFloatTexture;if(!type_1){consoleError("half float texture is not support");}if(renderer.gpu.level===2&&internalFormat_1===format_1){if(format_1===constants.LUMINANCE){format_1=constants.RED;}internalFormat_1=FORMAT_HALF_FLOAT[format_1];}if(!renderer.gpu.capability.halfFloatLinear){options.minFilter=options.magFilter=gl_1.NEAREST;consoleWarn("half float linear not support,change to NEAREST");}}else if(type_1===gl_1.FLOAT){type_1=renderer.gpu.capability.floatTexture;if(!type_1){consoleError("float texture is not support");}if(renderer.gpu.level===2&&internalFormat_1===format_1){if(format_1===constants.LUMINANCE){format_1=constants.RED;}internalFormat_1=FORMAT_FLOAT[format_1];}if(!renderer.gpu.capability.floatLinear){options.minFilter=options.magFilter=gl_1.NEAREST;consoleWarn("float linear not support,change to NEAREST");}}renderer.state.pixelStorei(gl_1.UNPACK_PREMULTIPLY_ALPHA_WEBGL,options.premultiplyAlpha?1:0);renderer.state.pixelStorei(gl_1.UNPACK_FLIP_Y_WEBGL,flipY?1:0);if(sourceType===TextureSourceType.framebuffer){var data=source.data;if(data){width_1=data.width||0;height_1=data.height||0;if(width_1&&height_1&&(this.width!==width_1||this.height!==height_1)){gl_1.texImage2D(target,0,internalFormat_1,width_1,height_1,0,format_1,type_1,null);}}}else if(sourceType===TextureSourceType.data){if(target===gl_1.TEXTURE_CUBE_MAP){var ret_1;var cubeData=source.cube;cubeData.forEach((function(data,key){ret_1=_this.texImage2DData(gl_1,gl_1.TEXTURE_CUBE_MAP_POSITIVE_X+key,0,internalFormat_1,format_1,type_1,data);width_1=Math.max(ret_1[0],width_1);height_1=Math.max(ret_1[1],height_1);}));}else {_a=this.texImage2DData(gl_1,target,0,internalFormat_1,format_1,type_1,source.data),width_1=_a[0],height_1=_a[1];}}else if(sourceType===TextureSourceType.image||sourceType===TextureSourceType.video){if(target===gl_1.TEXTURE_CUBE_MAP){var ret_2;source.cube.forEach((function(image,key){ret_2=_this.texImage2D(gl_1,gl_1.TEXTURE_CUBE_MAP_POSITIVE_X+key,0,internalFormat_1,format_1,type_1,image);width_1=Math.max(ret_2[0],width_1);height_1=Math.max(ret_2[1],height_1);}));}else if(target===gl_1.TEXTURE_2D){var image=source.image||source.video;_b=this.texImage2D(gl_1,target,0,internalFormat_1,format_1,type_1,image),width_1=_b[0],height_1=_b[1];}if(options.generateMipmap){if(isPowerOfTwo(width_1)&&isPowerOfTwo(height_1)||renderer.level==2){gl_1.generateMipmap(target);this._mipmapUsed=true;}}}else if(sourceType===TextureSourceType.mipmaps){var ret_3;if(target===gl_1.TEXTURE_2D){source.mipmaps.forEach((function(mipmap,level){if("data"in mipmap){ret_3=_this.texImage2DData(gl_1,target,level,internalFormat_1,format_1,type_1,mipmap);}else {ret_3=_this.texImage2D(gl_1,target,level,internalFormat_1,format_1,type_1,mipmap);}if(level===0){width_1=ret_3[0],height_1=ret_3[1];}}));this._mipmapUsed=source.mipmaps.length>1;}else if(target===gl_1.TEXTURE_CUBE_MAP){source.mipmaps.forEach((function(mipmap,level){mipmap.forEach((function(face,key){if("data"in face){ret_3=_this.texImage2DData(gl_1,gl_1.TEXTURE_CUBE_MAP_POSITIVE_X+key,level,internalFormat_1,format_1,type_1,face);}else {ret_3=_this.texImage2D(gl_1,gl_1.TEXTURE_CUBE_MAP_POSITIVE_X+key,level,internalFormat_1,format_1,type_1,face);}if(level===0){width_1=ret_3[0],height_1=ret_3[1];}}));}));this._mipmapUsed=source.mipmaps.length>1;}}else if(sourceType===TextureSourceType.compressed){var mipmaps=source.mipmaps;if(mipmaps){width_1=mipmaps[0].width;height_1=mipmaps[0].height;for(var miplevel=0;miplevel<mipmaps.length;miplevel++){var mipmap=mipmaps[miplevel];gl_1.compressedTexImage2D(target,miplevel,internalFormat_1,mipmap.width,mipmap.height,0,mipmap.data);}this._mipmapUsed=mipmaps.length>1;}}this.width=width_1;this.height=height_1;this.setTextureFilters(gl_1,target,options);}else {this.width=this.height=0;}};GLTexture.prototype.setTextureFilters=function(gl,target,options){var _a,_b;if(this.target===gl.TEXTURE_2D){(_a=this.renderer)===null||_a===void 0?void 0:_a.gpu.setTextureAnisotropic(gl,this.target,options.anisotropic||4);}var isPot=((_b=this.renderer)===null||_b===void 0?void 0:_b.level)==2||isPowerOfTwo(this.width)&&isPowerOfTwo(this.height);var minFiler=isPot?options.minFilter||gl.NEAREST:gl.NEAREST;var magFilter=isPot?options.magFilter||gl.NEAREST:gl.NEAREST;gl.texParameteri(target,gl.TEXTURE_MIN_FILTER,minFiler);gl.texParameteri(target,gl.TEXTURE_MAG_FILTER,magFilter);gl.texParameteri(target,gl.TEXTURE_WRAP_S,isPot?options.wrapS||gl.CLAMP_TO_EDGE:gl.CLAMP_TO_EDGE);gl.texParameteri(target,gl.TEXTURE_WRAP_T,isPot?options.wrapT||gl.CLAMP_TO_EDGE:gl.CLAMP_TO_EDGE);};GLTexture.prototype.texImage2D=function(gl,target,level,internalformat,format,type,image){var _a;var options=this.options;var maxSize=((_a=this.renderer)===null||_a===void 0?void 0:_a.gpu.capability.maxTextureSize)||2048;var img=image;if(options.sourceType!==TextureSourceType.video){var shouldResize=options.minFilter!==gl.NEAREST||options.magFilter!==gl.NEAREST||options.wrapS!==gl.CLAMP_TO_EDGE||options.wrapT!==gl.CLAMP_TO_EDGE;shouldResize=shouldResize||image.width>maxSize||image.height>maxSize;if(shouldResize){img=this.resizeImage(image);}if(imageBitMapAvailable$1&&img instanceof ImageBitmap&&options.flipY){img=this.flipImageBitmap(img);}}gl.texImage2D(target,level,internalformat,format,type,img);var size=[img.width,img.height];if(flipCanvas){flipCanvas.width=flipCanvas.height=1;}return options.sourceType===TextureSourceType.video?[image.videoWidth,image.videoHeight]:size};GLTexture.prototype.flipImageBitmap=function(bitmap){if(!flipCanvas){flipCanvas=document.createElement("canvas");}var width=flipCanvas.width=bitmap.width;var height=flipCanvas.height=bitmap.height;var ctx=flipCanvas.getContext("2d");ctx.clearRect(0,0,width,height);ctx.fillStyle="rgba(255,255,255,0.0039)";ctx.fillRect(0,0,width,height);ctx.drawImage(bitmap,0,0);return flipCanvas};GLTexture.prototype.texImage2DData=function(gl,target,level,internalformat,format,type,data){var bufferView=data.data;var neoBuffer=format===gl.UNSIGNED_BYTE?new Uint8Array(bufferView.buffer,data.data.byteOffset,bufferView.byteLength/bufferView.BYTES_PER_ELEMENT):bufferView;gl.texImage2D(target,level,internalformat,data.width,data.height,0,format,type,neoBuffer);return [data.width,data.height]};GLTexture.prototype.resizeImage=function(image,targetWidth,targetHeight){var _a,_b;var maxSize=((_a=this.renderer)===null||_a===void 0?void 0:_a.gpu.capability.maxTextureSize)||2048;if(((_b=this.renderer)===null||_b===void 0?void 0:_b.level)===2&&(image.width<maxSize&&image.height<maxSize)){return image}if(image){var width=image.width;var height=image.height;var nw=Math.min(maxSize,targetWidth||nearestPowerOfTwo$1(width));var nh=Math.min(maxSize,targetHeight||nearestPowerOfTwo$1(height));if(nh!==height||nw!==width){var canvas=document.createElement("canvas");canvas.width=nw;canvas.height=nh;var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0,image.width,image.height,0,0,nw,nh);consoleWarn("image resize from ".concat(width,"x").concat(height," to ").concat(nw,"x").concat(nh));return canvas}}return image};GLTexture.prototype.offloadData=function(){var renderer=this.renderer;var target=this.target;if(renderer&&this.glHandle){var gl=renderer.gl;renderer.state.bindTexture(target,this.glHandle);var data=new Uint8Array([255]);if(target===gl.TEXTURE_2D){gl.texImage2D(target,0,gl.LUMINANCE,1,1,0,gl.LUMINANCE,gl.UNSIGNED_BYTE,data);}else if(target===gl.TEXTURE_CUBE_MAP){var faces=[gl.TEXTURE_CUBE_MAP_NEGATIVE_X,gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,gl.TEXTURE_CUBE_MAP_POSITIVE_X,gl.TEXTURE_CUBE_MAP_POSITIVE_Y,gl.TEXTURE_CUBE_MAP_POSITIVE_Z];for(var i=0;i<faces.length;i++){gl.texImage2D(faces[i],0,gl.LUMINANCE,1,1,0,gl.LUMINANCE,gl.UNSIGNED_BYTE,data);}}gl.generateMipmap(target);this.width=this.height=1;}};GLTexture.prototype.destroy=function(){if(this.renderer){this.renderer.deleteGLTexture(this);this.renderer=this.options=this.glHandle=null;this.update=this.destroy=this.errorLog;}};GLTexture.prototype._assignRenderer=function(renderer){throw new Error("Method not implemented.")};return GLTexture}();function nearestPowerOfTwo$1(value){return Math.pow(2,Math.round(Math.log(value)/Math.LN2))}function isPowerOfTwo(value){return (value&value-1)===0&&value!==0}var FORMAT_HALF_FLOAT=(_a$2={},_a$2[constants.RGBA]=34842,_a$2[constants.RGB]=34843,_a$2[constants.ALPHA]=33325,_a$2[constants.RED]=33325,_a$2[constants.LUMINANCE_ALPHA]=33327,_a$2[constants.LUMINANCE]=33325,_a$2);var FORMAT_FLOAT=(_b={},_b[constants.RGBA]=34836,_b[constants.RGB]=34837,_b[constants.ALPHA]=33326,_b[constants.RED]=33326,_b[constants.LUMINANCE_ALPHA]=33328,_b[constants.LUMINANCE]=33326,_b);var GL_LOST_EVENT="webglcontextlost";var GLGPURenderer=function(){function GLGPURenderer(gl){var _this=this;this._isDestroyed=false;this.extension={};this.onContextLose=function(e){consoleError("gl lost, destroy renderer by default",e.target);_this.destroy();if(e.target){e.target.removeEventListener(GL_LOST_EVENT,_this.onContextLose);}};this.gl=gl;this.state=new WebGLState(gl);this.level=typeof WebGL2RenderingContext!=="undefined"&&gl instanceof WebGL2RenderingContext?2:1;this._buffers=[];this._textures=[];this._vaos=[];this._renderBuffers=[];this._frameBuffers=[];this.shaderLibrary=new GLShaderLibrary(this);this.gpu=new GLGPUCapability({gl:gl});var d={width:1,height:1,data:new Uint8Array([255])};this.emptyTexture2D=new GLTexture({data:d,sourceType:TextureSourceType.data,format:gl.LUMINANCE,internalFormat:gl.LUMINANCE,type:gl.UNSIGNED_BYTE},this);this.emptyTextureCube=new GLTexture({target:gl.TEXTURE_CUBE_MAP,cube:[d,d,d,d,d,d],sourceType:TextureSourceType.data,format:gl.LUMINANCE,internalFormat:gl.LUMINANCE,type:gl.UNSIGNED_BYTE},this);this.bindVertexArray=this.level===2?this._bindVertexArray:this._bindVertexArrayOES;if(gl.canvas){gl.canvas.addEventListener(GL_LOST_EVENT,this.onContextLose);}}Object.defineProperty(GLGPURenderer.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});GLGPURenderer.prototype.copy2=function(source,target){var gl=this.gl;if(gl){if(!this._sourceFbo){this._sourceFbo=gl.createFramebuffer();}if(!this._targetFbo){this._targetFbo=gl.createFramebuffer();}var state=this.state;var COLOR_ATTACHMENT0=gl.COLOR_ATTACHMENT0;state.bindFramebuffer(gl.FRAMEBUFFER,this._sourceFbo);gl.framebufferTexture2D(gl.FRAMEBUFFER,COLOR_ATTACHMENT0,gl.TEXTURE_2D,source.glHandle,0);state.bindFramebuffer(gl.FRAMEBUFFER,this._targetFbo);gl.framebufferTexture2D(gl.FRAMEBUFFER,COLOR_ATTACHMENT0,gl.TEXTURE_2D,target.glHandle,0);state.bindFramebuffer(gl.READ_FRAMEBUFFER,this._sourceFbo);state.bindFramebuffer(gl.DRAW_FRAMEBUFFER,this._targetFbo);var filter=source.width===source.height&&target.width==target.height?gl.NEAREST:gl.LINEAR;gl.blitFramebuffer(0,0,source.width,source.height,0,0,target.width,target.height,gl.COLOR_BUFFER_BIT,filter);state.bindFramebuffer(gl.FRAMEBUFFER,null);state.bindFramebuffer(gl.READ_FRAMEBUFFER,null);state.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null);}};GLGPURenderer.prototype.resetColorAttachments=function(rp,colors){rp.bind();rp.resetColorTextures(colors);};GLGPURenderer.prototype.createGLRenderBuffer=function(renderbuffer){var rb=this.gl.createRenderbuffer();if(rb){arrAdd(this._renderBuffers,renderbuffer);}return rb};GLGPURenderer.prototype.createPipeline=function(options){throw new Error("Method not implemented.")};GLGPURenderer.prototype.createBuffer=function(options){return new GLGPUBuffer(options,this)};GLGPURenderer.prototype.parseSceneSchema=function(schema){throw new Error("Method not implemented.")};GLGPURenderer.prototype.resize=function(width,height){var gl=this.gl;if(gl&&gl.drawingBufferWidth!==width||gl.drawingBufferHeight!==height){gl.canvas.width=width;gl.canvas.height=height;gl.viewport(0,0,width,height);this._frameBuffers.forEach((function(frameBuffer){var viewport=frameBuffer.viewport;if(!frameBuffer.isCustomViewport){frameBuffer.resize(viewport[0],viewport[1],width*frameBuffer.viewportScale,height*frameBuffer.viewportScale);}}));}};GLGPURenderer.prototype._assignInspectorName=function(obj,name,id){if(name){obj.__SPECTOR_Metadata={name:name};if(obj.__SPECTOR_Object_TAG){obj.__SPECTOR_Object_TAG.displayText=name;if(id){obj.__SPECTOR_Object_TAG.id=id;}}else {obj.__SPECTOR_Object_TAG={displayText:name,id:""};}}};GLGPURenderer.prototype.createGLFrameBuffer=function(frameBuffer,name){var fbo=this.gl.createFramebuffer();if(fbo){arrAdd(this._frameBuffers,frameBuffer);this._assignInspectorName(fbo,name,name);}return fbo};GLGPURenderer.prototype.createGLTexture=function(texture,name){var tex=this.gl.createTexture();if(tex){arrAdd(this._textures,texture);this._assignInspectorName(tex,name);}return tex};GLGPURenderer.prototype.createGLBuffer=function(gpuBuffer,name){var buffer=this.gl.createBuffer();if(buffer){arrAdd(this._buffers,gpuBuffer);this._assignInspectorName(buffer,name);}return buffer};GLGPURenderer.prototype.deleteGLTexture=function(texture){if(texture.glHandle&&!this._isDestroyed){this.gl.deleteTexture(texture.glHandle);arrRemove(this._textures,texture);}};GLGPURenderer.prototype.deleteGPUBuffer=function(buffer){if(buffer&&!this._isDestroyed){arrRemove(this._buffers,buffer);this.gl.deleteBuffer(buffer.glBuffer);}};GLGPURenderer.prototype.deleteGLFrameBuffer=function(frameBuffer){if(frameBuffer&&!this._isDestroyed){this.gl.deleteFramebuffer(frameBuffer.fbo);arrRemove(this._frameBuffers,frameBuffer);}};GLGPURenderer.prototype.deleteGLRenderBuffer=function(renderbuffer){if(renderbuffer&&!this._isDestroyed){this.gl.deleteRenderbuffer(renderbuffer.glHandle);arrRemove(this._renderBuffers,renderbuffer);}};GLGPURenderer.prototype.createVertexArray=function(name){var _a;var vao;if(this.level===2){vao=this.gl.createVertexArray();}if(!vao){vao=(_a=this.gpu.vaoExt)===null||_a===void 0?void 0:_a.createVertexArrayOES();}if(vao){arrAdd(this._vaos,vao);this._assignInspectorName(vao,name);}return vao};GLGPURenderer.prototype._bindVertexArray=function(vao){this.gl.bindVertexArray(vao||null);};GLGPURenderer.prototype._bindVertexArrayOES=function(vao){var _a;(_a=this.gpu.vaoExt)===null||_a===void 0?void 0:_a.bindVertexArrayOES(vao);};GLGPURenderer.prototype.bindVertexArray=function(vao){throw Error("xxx")};GLGPURenderer.prototype.deleteVertexArray=function(vao){var _a;if(!this._isDestroyed){if(this.level===2){this.gl.deleteVertexArray(vao);}else {(_a=this.gpu.vaoExt)===null||_a===void 0?void 0:_a.deleteVertexArrayOES(vao);}arrRemove(this._vaos,vao);}};GLGPURenderer.prototype.destroy=function(haltGL){var _this=this;var gl=this.gl;if(gl){gl.deleteFramebuffer(this._sourceFbo);gl.deleteFramebuffer(this._targetFbo);this._buffers.forEach((function(buffer){return _this.deleteGPUBuffer(buffer)}));this._buffers.length=0;this.state.destroy();this.shaderLibrary.destroy();this._vaos.forEach((function(vao){return _this.deleteVertexArray(vao)}));this.emptyTexture2D.destroy();this.emptyTextureCube.destroy();this._vaos.length=0;this._frameBuffers.forEach((function(fb){return _this.deleteGLFrameBuffer(fb)}));this._frameBuffers.length=0;this._renderBuffers.forEach((function(rb){return _this.deleteGLRenderBuffer(rb)}));this._renderBuffers.length=0;gl.canvas.removeEventListener(GL_LOST_EVENT,this.onContextLose);if(haltGL){var ex=gl.getExtension("WEBGL_lose_context");ex===null||ex===void 0?void 0:ex.loseContext();}this.emptyTexture2D=this.shaderLibrary=this.state=this.gpu=this.gl=null;this.emptyTextureCube=null;}this._isDestroyed=true;};Object.defineProperty(GLGPURenderer.prototype,"height",{get:function(){var _a;return (_a=this.gl)===null||_a===void 0?void 0:_a.drawingBufferHeight},enumerable:false,configurable:true});Object.defineProperty(GLGPURenderer.prototype,"width",{get:function(){var _a;return (_a=this.gl)===null||_a===void 0?void 0:_a.drawingBufferWidth},enumerable:false,configurable:true});Object.defineProperty(GLGPURenderer.prototype,"canvas",{get:function(){return this.gl.canvas},enumerable:false,configurable:true});GLGPURenderer.prototype.createRenderFrame=function(options){throw Error()};return GLGPURenderer}();var g$1;function getDefaultGPUCapability(){if(!g$1){g$1=new GLGPUCapability({});}return g$1}var CanvasEmpty=function(){function CanvasEmpty(){this.width=0;this.height=0;}CanvasEmpty.prototype.addEventListener=function(name,handler){};CanvasEmpty.prototype.removeEventListener=function(name,handler){};return CanvasEmpty}();var GLRenderBuffer=function(){function GLRenderBuffer(renderer,options){this.storageType=options.storageType;this.renderer=renderer;this.glHandle=renderer.createGLRenderBuffer(this);this.internalFormat=this.format=options.format;this.attachment=options.attachment;this.size=[0,0];this.multiSample=1;}GLRenderBuffer.prototype.setSize=function(width,height){if(width!==this.size[0]||height!==this.size[1]){var internalFormat=this.internalFormat;var state=this.renderer.state;var gl=this.renderer.gl;state.bindRenderBuffer(gl.RENDERBUFFER,this.glHandle);if(width&&height){gl.renderbufferStorage(gl.RENDERBUFFER,internalFormat,this.size[0]=width,this.size[1]=height);}else {consoleError("invalid render buffer size ".concat(width,"x").concat(height));}}return this};GLRenderBuffer.prototype.destroy=function(){if(this.renderer){this.renderer.deleteGLRenderBuffer(this);this.renderer=this.glHandle=this.ready=null;}};return GLRenderBuffer}();var seed$5=1;var GLFrameBuffer=function(){function GLFrameBuffer(options,renderer){var _a;this.renderer=renderer;this.depthStencilStorageType=((_a=options.depthStencilAttachment)===null||_a===void 0?void 0:_a.storageType)||RenderPassAttachmentStorageType.none;this.viewport=options.viewport;this.isCustomViewport=!!options.isCustomViewport;this.viewportScale=options.viewportScale||1;this.name=options.name||"GLFrameBuffer"+seed$5++;this.storeAction=options.storeAction;this._attachmentHandles=[];this.checkOptions(options);}Object.defineProperty(GLFrameBuffer.prototype,"stencilStorage",{get:function(){var storageType=this.depthStencilStorageType;if(storageType!==RenderPassAttachmentStorageType.depth_16_opaque){return this.depthStencilRenderBuffer}},enumerable:false,configurable:true});Object.defineProperty(GLFrameBuffer.prototype,"depthStorage",{get:function(){if(this.depthStencilStorageType!==RenderPassAttachmentStorageType.stencil_8_opaque){return this.depthStencilRenderBuffer}},enumerable:false,configurable:true});GLFrameBuffer.prototype._getHandles=function(){var handles=this._attachmentHandles;handles.length=0;this.colorTextures.forEach((function(c){return arrAdd(handles,c.glHandle)}));if(this.stencilTexture){arrAdd(handles,this.stencilTexture.glHandle);}if(this.depthTexture){arrAdd(handles,this.depthTexture.glHandle);}};GLFrameBuffer.prototype.checkOptions=function(options){var _a,_b;var renderer=this.renderer;var capability=renderer.gpu.capability;var depthStencilAttachment=options.depthStencilAttachment||{storageType:RenderPassAttachmentStorageType.none};var willUseFbo=options.attachments.length>0;this.externalStorage=false;var separateDepthStencil=true;if(options.attachments.length>1&&!capability.drawBuffers){throw Error("multiple color attachments not support")}var optDepthStencilTex=(_b=(_a=options.depthStencilAttachment)===null||_a===void 0?void 0:_a.texture)===null||_b===void 0?void 0:_b.internal;var readableDepthStencilTextures=capability.readableDepthStencilTextures;this.colorTextures=options.attachments.slice();if(!willUseFbo&&depthStencilAttachment.storageType!==RenderPassAttachmentStorageType.none){throw Error("use depth stencil attachment without color attachments")}if(willUseFbo){this.fbo=renderer.createGLFrameBuffer(this,this.name);}var storageType=depthStencilAttachment.storageType;if(storageType===RenderPassAttachmentStorageType.depth_stencil_opaque){if(depthStencilAttachment.storage){if(depthStencilAttachment.storage instanceof GLRenderBuffer){this.depthStencilRenderBuffer=depthStencilAttachment.storage;this.externalStorage=true;}else {throw Error("invalid depth stencil attachment storage")}}else {this.depthStencilRenderBuffer=new GLRenderBuffer(renderer,{format:constants.DEPTH_STENCIL,attachment:constants.DEPTH_STENCIL_ATTACHMENT,storageType:storageType});}separateDepthStencil=false;}else if(storageType===RenderPassAttachmentStorageType.depth_16_opaque){if(depthStencilAttachment.storage){if(depthStencilAttachment.storage instanceof GLRenderBuffer){this.depthStencilRenderBuffer=depthStencilAttachment.storage;this.externalStorage=true;}else {throw Error("invalid depth attachment storage")}}else {this.depthStencilRenderBuffer=new GLRenderBuffer(renderer,{attachment:constants.DEPTH_ATTACHMENT,format:constants.DEPTH_COMPONENT16,storageType:storageType});}}else if(storageType===RenderPassAttachmentStorageType.stencil_8_opaque){if(depthStencilAttachment.storage){if(depthStencilAttachment.storage instanceof GLRenderBuffer){this.depthStencilRenderBuffer=depthStencilAttachment.storage;this.externalStorage=true;}else {throw Error("invalid stencil attachment storage")}}else {this.depthStencilRenderBuffer=new GLRenderBuffer(renderer,{attachment:constants.STENCIL_ATTACHMENT,format:constants.STENCIL_INDEX8,storageType:storageType});}}else if(storageType===RenderPassAttachmentStorageType.depth_16_texture){if(!readableDepthStencilTextures){throw Error("depth texture is not support in framebuffer")}this.depthTexture=optDepthStencilTex||new GLTexture({sourceType:TextureSourceType.framebuffer,format:constants.DEPTH_COMPONENT,internalFormat:renderer.gpu.internalFormatDepth16,type:constants.UNSIGNED_SHORT,name:"".concat(this.name,"##depthTex")},renderer);}else if(storageType===RenderPassAttachmentStorageType.depth_24_stencil_8_texture){if(!readableDepthStencilTextures){throw Error("depth stencil texture is not support in framebuffer")}this.depthTexture=this.stencilTexture=optDepthStencilTex||new GLTexture({sourceType:TextureSourceType.framebuffer,format:constants.DEPTH_STENCIL,internalFormat:renderer.gpu.internalFormatDepth24_stencil8,type:renderer.gpu.UNSIGNED_INT_24_8,name:"".concat(this.name,"##dpthStclTex")},renderer);separateDepthStencil=true;}this.storeInvalidAttachments=this.getStoreAttachments(this.storeAction,separateDepthStencil);this._getHandles();};GLFrameBuffer.prototype.getStoreAttachments=function(storeAction,separateDepthStencil){var gl=this.renderer.gl;var colorLen=this.colorTextures.length;if(storeAction&&this.renderer.gpu.level==2&&colorLen>0){var attachments=[];if(storeAction.depthAction===TextureStoreAction.clear&&this.depthStorage){arrAdd(attachments,separateDepthStencil?gl.DEPTH_ATTACHMENT:gl.DEPTH_STENCIL_ATTACHMENT);}if(storeAction.stencilAction===TextureStoreAction.clear&&this.stencilStorage){arrAdd(attachments,separateDepthStencil?gl.STENCIL_ATTACHMENT:gl.DEPTH_STENCIL_ATTACHMENT);}if(storeAction.colorAction===TextureStoreAction.clear){for(var i=0;i<colorLen;i++){arrAdd(attachments,gl["COLOR_ATTACHMENT".concat(i)]);}}return attachments}};GLFrameBuffer.prototype.unbind=function(){var att=this.storeInvalidAttachments;if(att&&att.length){var gl=this.renderer.gl;gl.invalidateFramebuffer(gl.FRAMEBUFFER,att);}var state=this.renderer.state;state.bindSystemFramebuffer();};GLFrameBuffer.prototype.bind=function(){var gl=this.renderer.gl;var state=this.renderer.state;if(this.fbo){var FRAMEBUFFER=gl.FRAMEBUFFER;var viewport=this.viewport;state.bindFramebuffer(FRAMEBUFFER,this.fbo);state.viewport(viewport[0],viewport[1],viewport[2],viewport[3]);var r_1=this.renderer.emptyTexture2D.glHandle;var handles_1=this._attachmentHandles;forEach(state._textureUnitDict,(function(t,unit){if(t!==r_1&&handles_1.includes(t)){state.activeTexture(+unit);state.bindTexture(constants.TEXTURE_2D,r_1,true);}}));if(!this.ready){var _a=this,depthStencilRenderBuffer=_a.depthStencilRenderBuffer,depthTexture=_a.depthTexture,stencilTexture=_a.stencilTexture;state.activeTexture(gl.TEXTURE0);if(depthStencilRenderBuffer){depthStencilRenderBuffer.setSize(viewport[2],viewport[3]);gl.framebufferRenderbuffer(FRAMEBUFFER,depthStencilRenderBuffer.attachment,gl.RENDERBUFFER,depthStencilRenderBuffer.glHandle);}else if(depthTexture){depthTexture.update({data:{width:viewport[2],height:viewport[3],data:new Uint16Array(0)}});var attachment=depthTexture&&stencilTexture?gl.DEPTH_STENCIL_ATTACHMENT:gl.DEPTH_ATTACHMENT;gl.framebufferTexture2D(FRAMEBUFFER,attachment,gl.TEXTURE_2D,depthTexture.glHandle,0);}this.resetColorTextures(this.colorTextures);var status_1=gl.checkFramebufferStatus(FRAMEBUFFER);if(status_1!==gl.FRAMEBUFFER_COMPLETE){var error=gl.getError();throw Error("framebuffer failed status ".concat(status_1," error:").concat(error))}this.ready=true;}}};GLFrameBuffer.prototype.resetColorTextures=function(colors){var gl=this.renderer.gl;var gpu=this.renderer.gpu;var viewport=this.viewport;var data={width:viewport[2],height:viewport[3],data:new Uint8Array(0)};var buffers=[];if(colors){this.colorTextures=colors.slice();}this.renderer.state.activeTexture(gl.TEXTURE0);this.colorTextures.forEach((function(tex,index){tex.update({data:data});gpu.framebufferTexture2D(gl,gl.FRAMEBUFFER,index,gl.TEXTURE_2D,tex.glHandle);buffers.push(true);}));gpu.drawBuffers(gl,buffers);this._getHandles();};GLFrameBuffer.prototype.destroy=function(opt){var _a,_b;var renderer=this.renderer;if(renderer){renderer.deleteGLFrameBuffer(this);delete this.fbo;var clearAttachment=(opt===null||opt===void 0?void 0:opt.depthStencilAttachment)?opt.depthStencilAttachment:RenderPassDestroyAttachmentType.force;if(clearAttachment===RenderPassDestroyAttachmentType.force||clearAttachment===RenderPassDestroyAttachmentType.keepExternal&&!this.externalStorage){(_a=this.depthStencilRenderBuffer)===null||_a===void 0?void 0:_a.destroy();(_b=this.depthTexture)===null||_b===void 0?void 0:_b.destroy();}this.renderer=this.stencilRenderBuffer=this.depthStencilRenderBuffer=null;}};GLFrameBuffer.prototype.resize=function(x,y,width,height){var vp=this.viewport;if(vp[0]!==x||vp[1]!==y||vp[2]!==width||vp[3]!==height){this.viewport=[x,y,width,height];this.ready=false;this.bind();}};return GLFrameBuffer}();var imageBitMapAvailable=false;function requestAsync(url,options){var opt=options||{};return new Promise((function(resolve,reject){var xhr=new XMLHttpRequest;xhr.responseType=opt.responseType||"json";xhr.addEventListener("load",(function(){return resolve(xhr.response)}));xhr.addEventListener("error",reject);xhr.open(opt.method||"get",url);xhr.send(opt.data);}))}function loadImageAsync(imgOrURL,options){var img;var revoke=options===null||options===void 0?void 0:options.revokeURL;if(typeof imgOrURL==="string"){if((options===null||options===void 0?void 0:options.asImageBitMap)&&imageBitMapAvailable){return requestAsync(imgOrURL,{responseType:"blob"}).then((function(blob){return createImageBitmap(blob)}))}var src=imgOrURL;img=new Image;if(!/^data:/.test(src)){img.crossOrigin="*";}img.src=src;}else {img=imgOrURL;if((options===null||options===void 0?void 0:options.asImageBitMap)&&imageBitMapAvailable){return createImageBitmap(img)}if(imgOrURL instanceof Blob){img=new Image;img.src=URL.createObjectURL(imgOrURL);revoke=true;}}if(img.complete){return Promise.resolve(img)}return new Promise((function(resolve,reject){img.onload=function(){img.onload=null;if(revoke){URL.revokeObjectURL(img.src);}return resolve(img)};img.onerror=function(err){img.onerror=null;if(revoke){URL.revokeObjectURL(img.src);}return reject(err)};}))}var HEADER_LEN=12+13*4;var COMPRESSED_2D=0;var TEX_2D=2;var KhronosTextureContainer=function(){function KhronosTextureContainer(arrayBuffer,facesExpected,baseOffset){if(baseOffset===void 0){baseOffset=0;}this.arrayBuffer=arrayBuffer;this.baseOffset=baseOffset;var identifier=new Uint8Array(this.arrayBuffer,this.baseOffset,12);if(identifier[0]!==171||identifier[1]!==75||identifier[2]!==84||identifier[3]!==88||identifier[4]!==32||identifier[5]!==49||identifier[6]!==49||identifier[7]!==187||identifier[8]!==13||identifier[9]!==10||identifier[10]!==26||identifier[11]!==10){throw Error("texture missing KTX identifier")}var dataSize=Uint32Array.BYTES_PER_ELEMENT;var headerDataView=new DataView(this.arrayBuffer,this.baseOffset+12,13*dataSize);var endianness=headerDataView.getUint32(0,true);var littleEndian=endianness===67305985;this.glType=headerDataView.getUint32(1*dataSize,littleEndian);this.glTypeSize=headerDataView.getUint32(2*dataSize,littleEndian);this.glFormat=headerDataView.getUint32(3*dataSize,littleEndian);this.glInternalFormat=headerDataView.getUint32(4*dataSize,littleEndian);this.glBaseInternalFormat=headerDataView.getUint32(5*dataSize,littleEndian);this.pixelWidth=headerDataView.getUint32(6*dataSize,littleEndian);this.pixelHeight=headerDataView.getUint32(7*dataSize,littleEndian);this.pixelDepth=headerDataView.getUint32(8*dataSize,littleEndian);this.numberOfArrayElements=headerDataView.getUint32(9*dataSize,littleEndian);this.numberOfFaces=headerDataView.getUint32(10*dataSize,littleEndian);this.numberOfMipmapLevels=headerDataView.getUint32(11*dataSize,littleEndian);this.bytesOfKeyValueData=headerDataView.getUint32(12*dataSize,littleEndian);this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){consoleWarn("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){consoleWarn("texture arrays not currently supported");return}if(this.numberOfFaces!==facesExpected){consoleWarn("number of faces expected"+facesExpected+", but found "+this.numberOfFaces);return}if(this.glType===0){this.loadType=COMPRESSED_2D;}else {this.loadType=TEX_2D;}}KhronosTextureContainer.prototype.mipmaps=function(loadMipmaps){var mipmaps=[];var dataOffset=HEADER_LEN+this.bytesOfKeyValueData;var width=this.pixelWidth;var height=this.pixelHeight;var mipmapCount=loadMipmaps?this.numberOfMipmapLevels:1;for(var level=0;level<mipmapCount;level++){var imageSize=new Int32Array(this.arrayBuffer,this.baseOffset+dataOffset,1)[0];for(var face=0;face<this.numberOfFaces;face++){var byteArray=new Uint8Array(this.arrayBuffer,this.baseOffset+dataOffset+4,imageSize);mipmaps.push({data:byteArray,width:width,height:height});dataOffset+=imageSize+4;dataOffset+=3-(imageSize+3)%4;}width=Math.max(1,width*.5);height=Math.max(1,height*.5);}return mipmaps};return KhronosTextureContainer}();function getCompressedTextureOptions(data){var ktx=new KhronosTextureContainer(data,1);var useMipmaps=ktx.numberOfMipmapLevels>=Math.floor(Math.log2(Math.max(ktx.pixelWidth,ktx.pixelHeight))+1);return {sourceType:TextureSourceType.compressed,type:ktx.glType,target:ktx.numberOfFaces===6?constants.TEXTURE_CUBE_MAP:constants.TEXTURE_2D,internalFormat:ktx.glInternalFormat,format:ktx.glFormat,mipmaps:ktx.mipmaps(useMipmaps)}}var loadOptions={asImageBitMap:true};var MarsTextureFactory=function(){function MarsTextureFactory(){this.reloadPending={};}MarsTextureFactory.prototype.loadMipmapImagesAsync=function(pointers,bin){return Promise.all(pointers.map((function(pointer){var blob=new Blob([new Uint8Array(bin,pointer[0],pointer[1])]);return loadImageAsync(blob,{asImageBitMap:true})})))};MarsTextureFactory.prototype.loadImageAsync=function(url){return loadImageAsync(url,loadOptions)};MarsTextureFactory.prototype.requestBinaryAsync=function(url){return requestAsync(url,{responseType:"arraybuffer"})};MarsTextureFactory.prototype.loadImageBinaryAsync=function(binary,mime){var blob=binary;if(!(binary instanceof Blob)){blob=new Blob([binary],{type:mime||"image/png"});}if(imageBitMapAvailable$1){return createImageBitmap(blob)}var url=URL.createObjectURL(blob);return loadImageAsync(url,{revokeURL:true})};MarsTextureFactory.prototype.canOffloadTexture=function(texture){var data=texture.options.sourceFrom;if(data){var type=data.type;if(type===TextureSourceType.compressed||type===TextureSourceType.image){if(data.target===constants.TEXTURE_CUBE_MAP){return isObj(data.map)}return isStr(data.url,true)}if(type===TextureSourceType.mipmaps){if(data.bin){return data.mipmaps.length>0}if(data.target===constants.TEXTURE_CUBE_MAP){return data.maps.every((function(map){return isObj(map)}))}return data.urls.every((function(url){return isStr(url,true)}))}}return false};MarsTextureFactory.prototype.loadSourceAsync=function(sourceFrom,config){var _this=this;if(sourceFrom.target===constants.TEXTURE_CUBE_MAP&&sourceFrom.type!==TextureSourceType.mipmaps){return this._loadCubeMapAsync(sourceFrom.map).then((function(cube){return Object.assign({},config,{sourceType:TextureSourceType.image,cube:cube,sourceFrom:{type:TextureSourceType.image,map:Object.assign({},sourceFrom.map),target:constants.TEXTURE_CUBE_MAP},target:constants.TEXTURE_CUBE_MAP})}),catchError)}else if(sourceFrom.type===TextureSourceType.image){return this.loadImageAsync(sourceFrom.url).then((function(image){return Object.assign({},config,{image:image,sourceType:TextureSourceType.image,sourceFrom:{url:sourceFrom.url,type:sourceFrom.type,target:constants.TEXTURE_2D}})}),catchError)}else if(sourceFrom.type===TextureSourceType.video){return this._loadVideoAsync(sourceFrom.url).then((function(video){return Object.assign({},config,{video:video,sourceType:TextureSourceType.video})}),catchError)}else if(sourceFrom.type===TextureSourceType.compressed){return this.requestBinaryAsync(sourceFrom.url).then((function(arrayBuffer){return Object.assign(getCompressedTextureOptions(arrayBuffer),config,{sourceFrom:{url:sourceFrom.url,type:TextureSourceType.compressed}})}),catchError)}else if(sourceFrom.type===TextureSourceType.mipmaps){var target=sourceFrom.target;if(sourceFrom.bin){return requestAsync(sourceFrom.bin,{responseType:"arraybuffer"}).then((function(data){if(sourceFrom.target===constants.TEXTURE_CUBE_MAP){var source=sourceFrom;return Promise.all(source.mipmaps.map((function(mipmaps){return _this.loadMipmapImagesAsync(mipmaps,data)})))}else {var source=sourceFrom;return _this.loadMipmapImagesAsync(source.mipmaps,data)}})).then((function(mipmaps){var target=sourceFrom.target||constants.TEXTURE_2D;var mipmapsSource=sourceFrom.mipmaps;var source={mipmaps:mipmaps,target:target,sourceType:TextureSourceType.mipmaps,sourceFrom:{bin:sourceFrom.bin,mipmaps:target===constants.TEXTURE_2D?mipmapsSource.slice():mipmapsSource.map((function(s){return s.slice()})),target:target,type:TextureSourceType.mipmaps}};return Object.assign({},config,source)}))}if(target===constants.TEXTURE_2D||!target){var urls_1=sourceFrom.urls;return Promise.all(urls_1.map((function(url){return _this.loadImageAsync(url)}))).then((function(mipmaps){return Object.assign({},config,{target:constants.TEXTURE_2D,sourceType:TextureSourceType.mipmaps,mipmaps:mipmaps,sourceFrom:{type:sourceFrom.type,urls:urls_1.slice(),target:constants.TEXTURE_2D}})}),catchError)}else if(target===constants.TEXTURE_CUBE_MAP){var maps=sourceFrom.maps;return Promise.all(maps.map((function(map){return _this._loadCubeMapAsync(map)}))).then((function(mipmaps){return Object.assign({},config,{sourceType:TextureSourceType.mipmaps,target:constants.TEXTURE_CUBE_MAP,mipmaps:mipmaps,sourceFrom:{target:constants.TEXTURE_CUBE_MAP,type:sourceFrom.type,maps:sourceFrom.maps.map((function(map){return Object.assign({},map)}))}})}),catchError)}}return Promise.reject(new Error("invalid resource type:"+sourceFrom.type));function catchError(error){throw Error("loadFail:"+JSON.stringify(config))}};MarsTextureFactory.prototype._loadVideoAsync=function(url){var video=document.createElement("video");video.setAttribute("renderer","standard");if(isObj(url)){video.srcObject=url;}else {video.src=url;}video.crossOrigin="anonymous";video.muted=true;video.setAttribute("playsinline","playsinline");var p=video.play();return p?p.then((function(){return video})):new Promise((function(resolve,reject){video.addEventListener("loadeddata",(function h(){resolve(video);video.removeEventListener("loadeddata",h);}),true);video.addEventListener("error",(function(e){reject(e);}));}))};MarsTextureFactory.prototype._loadCubeMapAsync=function(map){var _this=this;return Promise.all(map.map((function(key){return _this.loadImageAsync(key)})))};MarsTextureFactory.prototype.loadCompressedTextureFromArrayBuffer=function(arrayBuffer,options){return Object.assign(getCompressedTextureOptions(arrayBuffer),options)};MarsTextureFactory.prototype.reloadTextureAsync=function(texture){var _this=this;var id=texture.id;var o=this.reloadPending[id];if(o){return o}if(texture.options.sourceFrom){return this.reloadPending[id]=this.loadSourceAsync(texture.options.sourceFrom).then((function(opt){texture.updateSource(opt);delete _this.reloadPending[id];return texture})).catch((function(ex){delete _this.reloadPending[id];throw ex}))}return Promise.reject("no source from")};return MarsTextureFactory}();var g;function getDefaultTextureFactory(){if(!g){g=new MarsTextureFactory;}return g}function setDefaultTextureFactory(factory){g=factory;}function closeImageBitMap(img){if(imageBitMapAvailable$1){if(img instanceof ImageBitmap){img.close();}else if(img instanceof Array){img.forEach(closeImageBitMap);}else if(isObj(img)){forEach(img,closeImageBitMap);}}}var seed$4$1=1;var MarsTexture=function(){function MarsTexture(options,renderer){this._isDestroyed=false;this.id="Tex"+seed$4$1++;if(options instanceof GLTexture){this.sourceType=options.options.sourceType;this.options=options.options;if(!renderer){throw Error("copy texture should assign renderer")}this.internal=options;this.renderer=renderer;this.name="";}else {var opt=this.checkOptions(options);this.sourceType=opt.sourceType;this.options=opt;this.name=options.name||"";if(renderer){this.assignRenderer(renderer);}}}Object.defineProperty(MarsTexture.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});MarsTexture.prototype.checkOptions=function(options){var opt=Object.assign({minFilter:constants.NEAREST,magFilter:constants.NEAREST,wrapS:constants.CLAMP_TO_EDGE,wrapT:constants.CLAMP_TO_EDGE,target:options.target||constants.TEXTURE_2D,format:constants.RGBA,internalFormat:options.format||constants.RGBA,type:constants.UNSIGNED_BYTE},options);if(!opt.sourceType){if(opt.image){opt.sourceType=TextureSourceType.image;}else if(opt.data){opt.sourceType=TextureSourceType.data;}else if(opt.video){opt.sourceType=TextureSourceType.video;}else {opt.sourceType=TextureSourceType.none;}}if(!opt.sourceType){throw Error("invalid source type")}return opt};Object.defineProperty(MarsTexture.prototype,"width",{get:function(){var _a;return ((_a=this.internal)===null||_a===void 0?void 0:_a.width)||0},enumerable:false,configurable:true});Object.defineProperty(MarsTexture.prototype,"height",{get:function(){var _a;return ((_a=this.internal)===null||_a===void 0?void 0:_a.height)||0},enumerable:false,configurable:true});MarsTexture.prototype.assignRenderer=function(renderer){this["renderer"]=renderer;this._assignRenderer(renderer.internal);return this};MarsTexture.prototype._assignRenderer=function(renderer){if(!this.internal){var option=this.options;this["internal"]=new GLTexture(option,renderer);var releaseImageSource=!option.keepImageSource;if(option.sourceType===TextureSourceType.image){if(releaseImageSource){closeImageBitMap(option.image);closeImageBitMap(option.cube);}delete option.image;delete option.cube;}else if(option.sourceType===TextureSourceType.data){delete option.data;}else if(option.sourceType===TextureSourceType.compressed){delete option.mipmaps;}else if(option.sourceType===TextureSourceType.mipmaps){delete option.mipmaps;if(releaseImageSource){closeImageBitMap(option.mipmaps);}}}};MarsTexture.prototype.uploadCurrentVideoFrame=function(){if(this.options.sourceType===TextureSourceType.video&&this.options.video&&this.internal){this.internal.update({video:this.options.video});return true}return false};MarsTexture.prototype.destroy=function(){var _a;if(this.internal){(_a=this.internal)===null||_a===void 0?void 0:_a.destroy();this["internal"]=this["renderer"]=undefined;}this._isDestroyed=true;this._assignRenderer=throwDestroyedError;};MarsTexture.prototype.reloadDataAsync=function(){if(this._offloaded){return getDefaultTextureFactory().reloadTextureAsync(this)}return Promise.resolve(this)};MarsTexture.prototype.offloadData=function(){var _a;if(this.internal&&getDefaultTextureFactory().canOffloadTexture(this)){(_a=this.internal)===null||_a===void 0?void 0:_a.offloadData();this._offloaded=true;}};MarsTexture.prototype.updateSource=function(options){var _a;this["options"]=this.checkOptions(Object.assign(this.options,options));this["sourceType"]=this.options.sourceType;(_a=this.internal)===null||_a===void 0?void 0:_a.update(this.options);};return MarsTexture}();var MarsRenderPassColorAttachment=function(){function MarsRenderPassColorAttachment(options){if(options.texture instanceof MarsTexture){this.texture=options.texture;this.externalTexture=true;}else if(options.texture){var texOpt=options.texture;this.externalTexture=false;this.textureOptions={size:options.size,format:texOpt.format||constants.RGBA,type:texOpt.type||constants.UNSIGNED_BYTE,internalFormat:texOpt.internalFormat||texOpt.format||constants.RGBA,wrapT:texOpt.wrapT,wrapS:texOpt.wrapS,minFilter:texOpt.minFilter,magFilter:texOpt.magFilter,name:options.name};}else {throw Error("color attachment must use texture")}this._isDestroyed=false;this.readable=true;}Object.defineProperty(MarsRenderPassColorAttachment.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPassColorAttachment.prototype,"storageType",{get:function(){return RenderPassAttachmentStorageType.color},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPassColorAttachment.prototype,"size",{get:function(){var tex=this.texture;return tex?[tex.width,tex.height]:[0,0]},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPassColorAttachment.prototype,"width",{get:function(){var _a;return ((_a=this.texture)===null||_a===void 0?void 0:_a.width)||0},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPassColorAttachment.prototype,"height",{get:function(){var _a;return ((_a=this.texture)===null||_a===void 0?void 0:_a.height)||0},enumerable:false,configurable:true});MarsRenderPassColorAttachment.prototype.assignRenderer=function(renderer){if(this.textureOptions){var size=this.textureOptions.size||[renderer.width,renderer.height];this.texture=new MarsTexture(__assign(__assign({},this.textureOptions),{sourceType:TextureSourceType.framebuffer,data:{width:size[0],height:size[1]}}));}if(this.texture){this.texture.assignRenderer(renderer);}return this};MarsRenderPassColorAttachment.prototype.destroy=function(){var _a;(_a=this.texture)===null||_a===void 0?void 0:_a.destroy();this.assignRenderer=throwDestroyedError;this._isDestroyed=true;};return MarsRenderPassColorAttachment}();var seed$3$1=1;var MarsRenderPass=function(){function MarsRenderPass(options,renderer){var _a;this._isDestroyed=false;this.name=options.name||"MarsRenderPass_"+seed$3$1++;this.priority=options.priority||0;this.meshOrder=options.meshOrder||RenderPassMeshOrder.ascending;this.meshes=(options.meshes||[]).slice();sortByOrder(this.meshes,this.meshOrder);this.camera=options.camera;this.options=options;this.clearAction=Object.assign({},options.clearAction);this._attachments=[];this.semantics=new MarsSemanticMap(options.semantics);this.depthStencilType=((_a=options.depthStencilAttachment)===null||_a===void 0?void 0:_a.storageType)||RenderPassAttachmentStorageType.none;this._setViewportOptions(options);if(renderer){this.assignRenderer(renderer);}this.delegate=options.delegate||{};var defStoreAction={colorAction:TextureStoreAction.store,depthAction:TextureStoreAction.store,stencilAction:TextureStoreAction.store};this.storeAction=Object.assign(defStoreAction,options.storeAction);}Object.defineProperty(MarsRenderPass.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPass.prototype,"attachments",{get:function(){return this._attachments},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPass.prototype,"viewport",{get:function(){var _a;var ret=((_a=this.frameBuffer)===null||_a===void 0?void 0:_a.viewport)||this._customViewport;if(ret){return ret}var renderer=this.renderer;var vs=this.viewportScale;return renderer?[0,0,renderer.width*vs,renderer.height*vs]:[0,0,0,0]},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPass.prototype,"stencilAttachment",{get:function(){var frameBuffer=this.frameBuffer;if(frameBuffer){return {storageType:frameBuffer.depthStencilStorageType,storage:frameBuffer.stencilStorage,texture:frameBuffer.stencilTexture?this._getStencilTexture(frameBuffer.stencilTexture,frameBuffer.externalStorage):undefined}}},enumerable:false,configurable:true});Object.defineProperty(MarsRenderPass.prototype,"depthAttachment",{get:function(){var frameBuffer=this.frameBuffer;if(frameBuffer){return {storageType:frameBuffer.depthStencilStorageType,storage:frameBuffer.depthStorage,texture:frameBuffer.depthTexture?this._getDepthTexture(frameBuffer.depthTexture,frameBuffer.externalStorage):undefined}}},enumerable:false,configurable:true});MarsRenderPass.prototype.bind=function(){if(this.frameBuffer){this.frameBuffer.bind();}else {var state=this.renderer.internal.state;var vp=this.viewport;state.viewport(vp[0],vp[1],vp[2],vp[3]);}};MarsRenderPass.prototype._getDepthTexture=function(texture,external){var _a;if(!this._depthTexture){var outTex=(_a=this.options.depthStencilAttachment)===null||_a===void 0?void 0:_a.texture;var tex=texture===(outTex===null||outTex===void 0?void 0:outTex.internal)?outTex:new MarsTexture(texture,this.renderer);if(!external){this._depthTexture=tex;}return tex}return this._depthTexture};MarsRenderPass.prototype._getStencilTexture=function(texture,external){var _a;if(!this._stencilTexture){var outTex=(_a=this.options.depthStencilAttachment)===null||_a===void 0?void 0:_a.texture;var tex=texture===(outTex===null||outTex===void 0?void 0:outTex.internal)?outTex:new MarsTexture(texture,this.renderer);if(!external){this._stencilTexture=tex;}return tex}return this._stencilTexture};MarsRenderPass.prototype._setViewportOptions=function(options){if(options.viewport){this._isCustomViewport=true;this.viewportScale=1;this._customViewport=options.viewport.slice(0,4);if(this.frameBuffer){var vp=this._customViewport;this.frameBuffer.isCustomViewport=false;this.frameBuffer.resize(vp[0],vp[1],vp[2],vp[3]);}}else {this._isCustomViewport=false;this.viewportScale=options.viewportScale||1;if(this.frameBuffer){this.frameBuffer.isCustomViewport=true;this.frameBuffer.viewportScale=this.viewportScale;}}};MarsRenderPass.prototype.resetColorAttachments=function(colors){var _this=this;if(!colors.length){this.resetAttachments({attachments:[]});}if(!this.attachments.length){this.resetAttachments({attachments:colors.map((function(t){return {texture:t}}))});}else {var attachments=colors.map((function(texture){texture.updateSource({sourceType:TextureSourceType.framebuffer});return new MarsRenderPassColorAttachment({texture:texture.assignRenderer(_this.renderer)})}));this._attachments.forEach((function(att){return !att.externalTexture&&att.destroy()}));this._attachments=attachments;if(this.frameBuffer){this.frameBuffer.bind();this.frameBuffer.resetColorTextures(colors.map((function(color){return color.internal})));}}};MarsRenderPass.prototype.resetAttachments=function(options){var ret=this.options;this.options=options;this._setViewportOptions(options);if(this.renderer){this._resetAttachments();}return ret};MarsRenderPass.prototype._resetAttachments=function(){var _a,_b;var renderer=this.renderer;var options=this.options;if(this._attachments.length){this._attachments.forEach((function(att){return !att.externalTexture&&att.destroy()}));this._attachments.length=0;(_a=this.frameBuffer)===null||_a===void 0?void 0:_a.destroy({depthStencilAttachment:RenderPassDestroyAttachmentType.keepExternal});this.frameBuffer=null;}var vs=this.viewportScale;var viewport=this._isCustomViewport?this._customViewport:[0,0,renderer.width*vs,renderer.height*vs];var size=[viewport[2],viewport[3]];var name=this.name;if((_b=options.attachments)===null||_b===void 0?void 0:_b.length){var attachments=options.attachments.map((function(att,index){var _a;return new MarsRenderPassColorAttachment(Object.assign({size:size,name:((_a=att.texture)===null||_a===void 0?void 0:_a.name)||"".concat(name,"##color_").concat(index)},att)).assignRenderer(renderer)}));this._attachments=attachments;var framebuffer=new GLFrameBuffer({storeAction:this.storeAction,name:name,viewport:viewport,viewportScale:this.viewportScale,isCustomViewport:this._isCustomViewport,attachments:attachments.map((function(att){return att.texture.internal})),depthStencilAttachment:options.depthStencilAttachment||{storageType:RenderPassAttachmentStorageType.none}},renderer.internal);framebuffer.bind();framebuffer.unbind();this.frameBuffer=framebuffer;}else {this._attachments.length=0;}};MarsRenderPass.prototype.unbind=function(){var state=this.renderer.internal.state;if(this.frameBuffer){this.frameBuffer.unbind();}else {state.bindSystemFramebuffer();}};MarsRenderPass.prototype.assignRenderer=function(renderer){if(!this.renderer){this.renderer=renderer;this._resetAttachments();}return this};MarsRenderPass.prototype.destroy=function(options){var _a,_b;var destroyMeshOption=(options===null||options===void 0?void 0:options.meshes)||undefined;if(destroyMeshOption!==DestroyOptions.keep){this.meshes.forEach((function(mesh){mesh.destroy(destroyMeshOption);}));}this.meshes.length=0;var colorOpt=(options===null||options===void 0?void 0:options.colorAttachment)?options.colorAttachment:RenderPassDestroyAttachmentType.force;this._attachments.forEach((function(att){var keep=att.externalTexture&&colorOpt===RenderPassDestroyAttachmentType.keepExternal||colorOpt===RenderPassDestroyAttachmentType.keep;if(!keep){att.destroy();}}));this._attachments.length=0;if((options===null||options===void 0?void 0:options.semantics)!==DestroyOptions.keep){this.semantics.destroy();}var depthStencilOpt=(options===null||options===void 0?void 0:options.depthStencilAttachment)?options.depthStencilAttachment:RenderPassDestroyAttachmentType.force;var fbo=this.frameBuffer;if(fbo){fbo.destroy({depthStencilAttachment:depthStencilOpt});var keep=fbo.externalStorage&&depthStencilOpt===RenderPassDestroyAttachmentType.keepExternal||depthStencilOpt===RenderPassDestroyAttachmentType.keep;if(!keep){(_a=this._stencilTexture)===null||_a===void 0?void 0:_a.destroy();(_b=this._depthTexture)===null||_b===void 0?void 0:_b.destroy();}}this.options=this.renderer=null;this.assignRenderer=throwDestroyedError;this._isDestroyed=true;};MarsRenderPass.prototype.addMesh=function(mesh){arrAddByOrder(this.meshes,mesh,this.meshOrder);};MarsRenderPass.prototype.removeMesh=function(mesh){arrRemove(this.meshes,mesh);};MarsRenderPass.prototype.setMeshes=function(meshes){var _a;this.meshes.length=0;(_a=this.meshes).splice.apply(_a,__spreadArray([0,0],meshes,false));return sortByOrder(this.meshes,this.meshOrder)};return MarsRenderPass}();var GLMaterial=function(){function GLMaterial(renderer,material){this.renderer=renderer;this.shaderCacheId=material.shaderCacheId;this.states=material.states;this.material=material;}GLMaterial.prototype.setupStates=function(){var _a,_b;var webGLState=this.renderer.state;var currentState=this.states;webGLState.toggle(constants.SAMPLE_ALPHA_TO_COVERAGE,currentState.sampleAlphaToCoverage);webGLState.toggle(constants.BLEND,currentState.blending);webGLState.toggle(constants.DEPTH_TEST,currentState.depthTest);webGLState.toggle(constants.STENCIL_TEST,currentState.stencilTest);webGLState.toggle(constants.CULL_FACE,currentState.cullFaceEnabled);webGLState.toggle(constants.POLYGON_OFFSET_FILL,currentState.polygonOffsetFill);if(currentState.stencilTest){webGLState.stencilMaskSeparate(constants.BACK,currentState.stencilMaskBack);webGLState.stencilMaskSeparate(constants.FRONT,currentState.stencilMaskFront);var stencilBackFunc=currentState.stencilFuncBack;webGLState.stencilFuncSeparate(constants.BACK,stencilBackFunc[0],stencilBackFunc[1],stencilBackFunc[2]);var stencilFrontFunc=currentState.stencilFuncFront;webGLState.stencilFuncSeparate(constants.FRONT,stencilFrontFunc[0],stencilFrontFunc[1],stencilFrontFunc[2]);var stencilOpBack=currentState.stencilOpBack;webGLState.stencilOpSeparate(constants.BACK,stencilOpBack[0],stencilOpBack[1],stencilOpBack[2]);var stencilOpFront=currentState.stencilOpFront;webGLState.stencilOpSeparate(constants.FRONT,stencilOpFront[0],stencilOpFront[1],stencilOpFront[2]);}if(currentState.blending){var blendColor=currentState.blendColor;webGLState.blendColor(blendColor[0],blendColor[1],blendColor[2],blendColor[3]);webGLState.blendEquationSeparate(currentState.blendEquationRGB,currentState.blendEquationAlpha);webGLState.blendFuncSeparate(currentState.blendSrc,currentState.blendDst,currentState.blendSrcAlpha,currentState.blendDstAlpha);}var colorMask=currentState.colorMask;webGLState.colorMask(colorMask[0],colorMask[1],colorMask[2],colorMask[3]);if(currentState.depthTest){webGLState.depthMask(currentState.depthMask);webGLState.depthFunc(currentState.depthFunc);webGLState.depthRange((_a=currentState.depthRange)===null||_a===void 0?void 0:_a[0],(_b=currentState.depthRange)===null||_b===void 0?void 0:_b[1]);}if(currentState.cullFaceEnabled){webGLState.cullFace(currentState.cullFace);webGLState.frontFace(currentState.frontFace);}if(currentState.polygonOffsetFill){var polygonOffset=currentState.polygonOffset||[0,0];webGLState.polygonOffset(polygonOffset[0],polygonOffset[1]);}};GLMaterial.prototype.getProgram=function(){return this.renderer.shaderLibrary.getProgram(this.shaderCacheId)};GLMaterial.prototype.destroy=function(){var _a;var lib=(_a=this.renderer)===null||_a===void 0?void 0:_a.shaderLibrary;if(lib&&lib.shaderResults){var shader=lib.shaderResults[this.shaderCacheId];if(shader&&!shader.shared){lib.deleteShader(this.shaderCacheId);}}this.renderer=null;};return GLMaterial}();function isUniformStruct(value){return isObj(value)&&value.length===undefined&&value.assignRenderer===undefined}function isUniformStructArray(value){return value&&value.length!==undefined&&isUniformStruct(value[0])}var MarsMaterialDataBlock=function(){function MarsMaterialDataBlock(props,renderer){this._isDestroyed=false;this._isDestroyed=false;this.name=props.name||"defDataBlock";this._uniformValues={};this._uniformFlags={};this.uboBufferMap={};this._uniformValueRanges={};this._keepUboData=!!props.keepUboData;if(props.uniformValues){this.setUniformValues(props.uniformValues);}if(renderer){this.assignRenderer(renderer);}}MarsMaterialDataBlock.prototype._assignUniformValueRenderer=function(value,renderer){if(renderer){var assign=function(value){return isObj(value)&&value.assignRenderer&&value.assignRenderer(renderer)};if(value instanceof Array){value.forEach(assign);}else {assign(value);}}};MarsMaterialDataBlock.prototype.invalidAllFlags=function(){var f=this._uniformFlags;var range=this._uniformValueRanges;forEach(this._uniformValues,(function(val,key){f[key]=true;range[key]=[0,0];}));};MarsMaterialDataBlock.prototype.clearFlags=function(){this._uniformFlags={};};MarsMaterialDataBlock.prototype.isDirty=function(shaderCacheId,name){return this._uniformFlags[name]===true};Object.defineProperty(MarsMaterialDataBlock.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});MarsMaterialDataBlock.prototype.assignRenderer=function(renderer){var _this=this;if(renderer&&!this.renderer){this.renderer=renderer;forEach(this._uniformValues,(function(value){_this._assignUniformValueRenderer(value,renderer);}));}return this};MarsMaterialDataBlock.prototype.createUboBuffer=function(spec){if(!this.uboBufferMap[spec.id]&&this.renderer&&this.name===spec.name){var ubo=this.uboBufferMap[spec.id]=new UniformBlockBuffer(this.renderer.internal,spec);ubo.keepData=this._keepUboData;}return this.uboBufferMap[spec.id]};MarsMaterialDataBlock.prototype.setUboBuffer=function(uboBuffer){uboBuffer.setValues(this._uniformValues,this._uniformFlags,this._uniformValueRanges);};MarsMaterialDataBlock.prototype.updateUniformSubData=function(name,start,count){var range=this._uniformValueRanges[name];if(!this._uniformValueRanges[name]){this._uniformValueRanges[name]=[start,count];}else {var end=Math.max(range[0]+range[1],start+count);var s=Math.min(start,range[0]);this._uniformValueRanges[name]=[s,end-s];}this._uniformFlags[name]=true;};MarsMaterialDataBlock.prototype.hasUniformValue=function(name){return name in this._uniformValues};MarsMaterialDataBlock.prototype.destroy=function(options){if((options===null||options===void 0?void 0:options.textures)!==DestroyOptions.keep){forEach(this._uniformValues,(function(uniform){if(uniform instanceof MarsTexture){uniform.destroy();}}));}forEach(this.uboBufferMap,(function(ubo){if(ubo!==undefined){ubo.destroy();}}));this.uboBufferMap={};this._uniformFlags={};this._uniformValues={};this.assignRenderer=throwDestroyedError;this._isDestroyed=true;};MarsMaterialDataBlock.prototype.getUniformValue=function(name){return this._uniformValues[name]};MarsMaterialDataBlock.prototype.getUniformValues=function(){return this._uniformValues};MarsMaterialDataBlock.prototype.setUniformValue=function(name,value){var _this=this;if(value===undefined){delete this._uniformValues[name];this._uniformFlags[name]=false;}else {if(isUniformStruct(value)){forEach(value,(function(data,key){var nameInStruct=name+"."+key;var valueInStruct=data;_this._uniformValues[nameInStruct]=valueInStruct;_this._uniformFlags[nameInStruct]=true;_this._assignUniformValueRenderer(valueInStruct,_this.renderer);}));this._uniformValues[name]=value;this._uniformFlags[name]=false;}else if(isUniformStructArray(value)){value.forEach((function(valueData,i){forEach(valueData,(function(valueInStruct,key){var nameInStruct=name+"["+i+"]"+"."+key;_this._uniformValues[nameInStruct]=valueInStruct;_this._uniformFlags[nameInStruct]=true;_this._assignUniformValueRenderer(valueInStruct,_this.renderer);}));}));this._uniformValues[name]=value;this._uniformFlags[name]=false;}else {this._uniformValues[name]=value;this._uniformFlags[name]=true;this._assignUniformValueRenderer(value,this.renderer);}}return true};MarsMaterialDataBlock.prototype.setUniformValues=function(map){var _this=this;forEach(map,(function(val,key){_this.setUniformValue(key,val);}));};MarsMaterialDataBlock.prototype.clone=function(name){return new MarsMaterialDataBlock({name:name,uniformValues:this._uniformValues},this.renderer)};return MarsMaterialDataBlock}();var seed$2$1=1;var MarsMaterial=function(){function MarsMaterial(options){this._isDestroyed=false;this.name=options.name||"Material"+seed$2$1++;this._dataBlocks=(options.dataBlocks||[]).map((function(b){return b instanceof MarsMaterialDataBlock?b:new MarsMaterialDataBlock(b)}));this.renderType=options.renderType||0;this.states=this.createMaterialStates(options.states);this.options=options;if(!this._dataBlocks.length){this._dataBlocks[0]=new MarsMaterialDataBlock({name:""});}if(options.uniformValues){this.defaultDataBlock.setUniformValues(options.uniformValues);}this.uniformSemantics=Object.assign({},options.uniformSemantics);}Object.defineProperty(MarsMaterial.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});Object.defineProperty(MarsMaterial.prototype,"dataBlocks",{get:function(){return this._dataBlocks.slice()},enumerable:false,configurable:true});Object.defineProperty(MarsMaterial.prototype,"defaultDataBlock",{get:function(){return this._dataBlocks[0]},enumerable:false,configurable:true});MarsMaterial.prototype.createMaterialStates=function(states){var ret={blending:!!states.blending,sampleAlphaToCoverage:!!states.sampleAlphaToCoverage,depthTest:!!states.depthTest,stencilTest:!!states.stencilTest,cullFaceEnabled:!!states.cullFaceEnabled,polygonOffsetFill:!!states.polygonOffsetFill};if(states.stencilMask===undefined||states.stencilMask===null){ret.stencilMaskBack=valIfUndefined(states.stencilMaskBack,255);ret.stencilMaskFront=valIfUndefined(states.stencilMaskFront,255);}else {var stencilMaskBack=valIfUndefined(states.stencilMaskBack,states.stencilMask);ret.stencilMaskBack=valIfUndefined(stencilMaskBack,255);var stencilMaskFront=valIfUndefined(states.stencilMaskFront,states.stencilMask);ret.stencilMaskFront=valIfUndefined(stencilMaskFront,255);}if(states.stencilFunc===undefined||states.stencilFunc===null){ret.stencilFuncBack=valIfUndefined(states.stencilFuncBack,[constants.ALWAYS,0,255]);ret.stencilFuncFront=valIfUndefined(states.stencilFuncFront,[constants.ALWAYS,0,255]);}else {var stencilFuncFront=valIfUndefined(states.stencilFuncFront,states.stencilFunc);ret.stencilFuncFront=valIfUndefined(stencilFuncFront,[constants.ALWAYS,0,255]);var stencilFuncBack=valIfUndefined(states.stencilFuncBack,states.stencilFunc);ret.stencilFuncBack=valIfUndefined(stencilFuncBack,[constants.ALWAYS,0,255]);}if(states.stencilOp===undefined||states.stencilOp===null){ret.stencilOpFront=valIfUndefined(states.stencilOpFront,[constants.KEEP,constants.KEEP,constants.KEEP]);ret.stencilOpBack=valIfUndefined(states.stencilOpBack,[constants.KEEP,constants.KEEP,constants.KEEP]);}else {var stencilOpFront=valIfUndefined(states.stencilOpFront,states.stencilOp);ret.stencilOpFront=valIfUndefined(stencilOpFront,[constants.KEEP,constants.KEEP,constants.KEEP]);var stencilOpBack=valIfUndefined(states.stencilOpBack,states.stencilOp);ret.stencilOpBack=valIfUndefined(stencilOpBack,[constants.KEEP,constants.KEEP,constants.KEEP]);}ret.blendSrc=valIfUndefined(states.blendSrc,constants.ONE);ret.blendSrcAlpha=valIfUndefined(states.blendSrcAlpha,ret.blendSrc);ret.blendDst=valIfUndefined(states.blendDst,constants.ZERO);ret.blendDstAlpha=valIfUndefined(states.blendDstAlpha,ret.blendDst);ret.blendEquationRGB=valIfUndefined(states.blendEquationRGB,constants.FUNC_ADD);ret.blendEquationAlpha=valIfUndefined(states.blendEquationAlpha,ret.blendEquationRGB);ret.blendColor=valIfUndefined(states.blendColor,[0,0,0,0]);ret.colorMask=valIfUndefined(states.colorMask,[true,true,true,true]);ret.depthMask=valIfUndefined(states.depthMask,true);ret.depthFunc=valIfUndefined(states.depthFunc,constants.LESS);ret.depthRange=valIfUndefined(states.depthRange,[0,1]);ret.cullFace=valIfUndefined(states.cullFace,constants.BACK);ret.frontFace=valIfUndefined(states.frontFace,constants.CCW);ret.polygonOffset=states.polygonOffset||[0,0];return Object.freeze(ret)};MarsMaterial.prototype.addDataBlock=function(b){if(arrAdd(this._dataBlocks,b)){b.invalidAllFlags();}};MarsMaterial.prototype.removeDataBlock=function(b){arrRemove(this._dataBlocks,b);};MarsMaterial.prototype.setUniformSemantic=function(uniformName,semantic){if(semantic===undefined){delete this.uniformSemantics[uniformName];}else {this.uniformSemantics[uniformName]=semantic;}};MarsMaterial.prototype.assignRenderer=function(renderer){if(!this.materialInternal){var shader=this.options.shader;this.shaderCacheId=renderer.internal.shaderLibrary.addShader(shader);this.materialInternal=new GLMaterial(renderer.internal,this);this["renderer"]=renderer;this._dataBlocks.forEach((function(d){return d.assignRenderer(renderer)}));}return this};MarsMaterial.prototype.destroy=function(options){var _a;if((options===null||options===void 0?void 0:options.blocks)!==DestroyOptions.keep){this._dataBlocks.forEach((function(b){return b.destroy({textures:options===null||options===void 0?void 0:options.textures})}));}(_a=this.materialInternal)===null||_a===void 0?void 0:_a.destroy();this.assignRenderer=throwDestroyedError;this._isDestroyed=true;};return MarsMaterial}();function valIfUndefined(val,def){if(val===undefined||val===null){return def}return val}function createVAO(renderer,name){if(renderer.gpu.capability.vao){var ret=new GLVertexArrayObject(renderer,name);if(ret.vao){return ret}}}var GLVertexArrayObject=function(){function GLVertexArrayObject(renderer,name){this.ready=false;this.renderer=renderer;this.vao=renderer.createVertexArray(name);}GLVertexArrayObject.prototype.destroy=function(){if(this.vao){var renderer=this.renderer;if(renderer.state.bindingVAO==this.vao){renderer.state.bindingVAO=undefined;renderer.bindVertexArray(null);}renderer.deleteVertexArray(this.vao);this.vao=this.renderer=null;}};GLVertexArrayObject.prototype.bind=function(){var renderer=this.renderer;if(this.vao&&renderer.state.bindingVAO!==this.vao){renderer.state.bindingVAO=this.vao;renderer.bindVertexArray(this.vao);}};GLVertexArrayObject.prototype.unbind=function(){var renderer=this.renderer;renderer.bindVertexArray(null);renderer.state.bindingVAO=undefined;};return GLVertexArrayObject}();var _a$1;var INDEX_TYPE_MAP=(_a$1={},_a$1[Uint8Array.BYTES_PER_ELEMENT]=constants.UNSIGNED_BYTE,_a$1[Uint16Array.BYTES_PER_ELEMENT]=constants.UNSIGNED_SHORT,_a$1[Uint32Array.BYTES_PER_ELEMENT]=constants.UNSIGNED_INT,_a$1);var GLGeometry=function(){function GLGeometry(option,renderer){this.renderer=renderer;this.drawStart=option.drawStart;this.drawCount=option.drawCount;this.mode=isNaN(option.mode)?constants.TRIANGLES:option.mode;this.name=option.name;var buffers={};var inAttributes=option.attributes;var attributes={};if(option instanceof GLGeometry){forEach(option._buffersMap,(function(buffer,name){buffers[name]=buffer;}));}else {forEach(option.buffers,(function(opt,name){buffers[name]=new GLGPUBuffer(opt,renderer);}));if(option.index&&option.index.data){this._indexBuffer=this.createIndexBuffer(option.index.data,renderer);}}this._buffersMap=buffers;forEach(inAttributes,(function(attribute,name){attributes[name]=attribute;}));this.attributes=attributes;this.vaoMap={};}GLGeometry.prototype.createVao=function(name){if(!this.vaoMap[name]){this.vaoMap[name]=createVAO(this.renderer,"".concat(this.name,"-").concat(name));}return this.vaoMap[name]};GLGeometry.prototype.destroyVao=function(name){var _a;(_a=this.vaoMap[name])===null||_a===void 0?void 0:_a.destroy();this.vaoMap[name]=undefined;};GLGeometry.prototype.setIndexBuffer=function(buffer){this._indexBuffer=buffer;};GLGeometry.prototype.createIndexBuffer=function(data,renderer){var type=INDEX_TYPE_MAP[data.BYTES_PER_ELEMENT];var indexOption={data:data,target:constants.ELEMENT_ARRAY_BUFFER,type:type,name:"".concat(this.name,"##index")};return new GLGPUBuffer(indexOption,renderer)};GLGeometry.prototype.getGPUBuffer=function(name){return this._buffersMap[name]};GLGeometry.prototype.destroy=function(){var _a;if(this.renderer){forEach(this._buffersMap,(function(buffer){buffer.destroy();}));this._buffersMap={};(_a=this._indexBuffer)===null||_a===void 0?void 0:_a.destroy();var m_1=this.vaoMap;forEach(m_1,(function(vao,key){vao===null||vao===void 0?void 0:vao.destroy();m_1[key]=undefined;}));}this.attributes={};this._indexBuffer=undefined;this.renderer=undefined;};GLGeometry.prototype.setAttributeBuffer=function(name,buffer){this._buffersMap[name]=buffer;};GLGeometry.prototype.getAttributeBuffer=function(name){if(this._buffersMap!=undefined){return this._buffersMap[name]}return null};GLGeometry.prototype.draw=function(state){var _a;var index=this._indexBuffer;var gl=(_a=this.renderer)===null||_a===void 0?void 0:_a.gl;if(gl){var drawCount=this.drawCount;if(index){var type=index.type;var dc=isNaN(drawCount)?index.elementCount:drawCount;if(dc>0){gl.drawElements(this.mode,dc,type,this.drawStart||0);}}else if(drawCount>0){gl.drawArrays(this.mode,this.drawStart,this.drawCount);}}};return GLGeometry}();var _a;var BYTES_TYPE_MAP=(_a={},_a[constants.FLOAT]=Float32Array.BYTES_PER_ELEMENT,_a[constants.INT]=Int32Array.BYTES_PER_ELEMENT,_a[constants.SHORT]=Int16Array.BYTES_PER_ELEMENT,_a[constants.BYTE]=Int8Array.BYTES_PER_ELEMENT,_a);function isIndexDataType(data){var result=data instanceof Uint8Array||data instanceof Uint16Array||data instanceof Uint32Array;return result}function attributeData2GLType(data){if(data instanceof Float32Array){return constants.FLOAT}else {return constants.INT}}function emptyTypedArrayByGLType(type){if(type===constants.INT){return new Int32Array(0)}if(type===constants.SHORT){return new Int16Array(0)}return new Float32Array(0)}function getAttributeBufferOption(geom,name){var attribute=geom._attributes[name];if(attribute){return geom._buffers[attribute.dataSource]}return undefined}var seed$1$1=1;var MarsGeometry=function(){function MarsGeometry(option){var _a,_b;this._attributesName=[];this._indexReleasable=false;this._isDestroyed=false;this._drawStart=option.drawStart?option.drawStart:0;this._drawCount=isNaN(+option.drawCount)?NaN:option.drawCount;this._mode=isNaN(option.mode)?constants.TRIANGLES:option.mode;this.name=option.name||"MarsGeometry:"+seed$1$1++;var usage=option.bufferUsage||constants.STATIC_DRAW;this.options=option;var buffers={};var attributesName=[];var attributes={};var dirtyFlags={};var attributesReleasable={};forEach(option.attributes,(function(attr,name){var data=attr.data;var type=attr.type||constants.FLOAT;var releasable=attr.releasable;if(type&&!attr.dataSource&&!data){data=emptyTypedArrayByGLType(type);}if(data){buffers[name]={data:data,usage:usage,target:constants.ARRAY_BUFFER,name:name};var gltype=attributeData2GLType(data);attributes[name]={size:attr.size,stride:attr.stride,offset:attr.offset,type:type||gltype,normalize:!!attr.normalize,dataSource:name};attributesReleasable[name]=releasable||false;dirtyFlags[name]={dirty:true,discard:true,start:Number.POSITIVE_INFINITY,end:0};}else {var datasource=attr.dataSource;if(datasource){attributes[name]={size:attr.size,stride:attr.stride,offset:attr.offset,type:type,dataSource:datasource,normalize:!!attr.normalize};}}attributesName.push(name);}));this._index=(_a=option.index)===null||_a===void 0?void 0:_a.data;dirtyFlags["index"]={dirty:true,discard:true,start:Number.POSITIVE_INFINITY,end:0};this._indexReleasable=((_b=option.index)===null||_b===void 0?void 0:_b.releasable)===true;this._buffers=buffers;this._attributes=attributes;this._attributesName=attributesName;this._attributesReleasable=attributesReleasable;this._dirtyFlags=dirtyFlags;}Object.defineProperty(MarsGeometry.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});Object.defineProperty(MarsGeometry.prototype,"mode",{get:function(){return this._mode},set:function(n){this._mode=n;if(this.internal){this.internal.mode=n;}},enumerable:false,configurable:true});Object.defineProperty(MarsGeometry.prototype,"attributes",{get:function(){return this._attributes},enumerable:false,configurable:true});Object.defineProperty(MarsGeometry.prototype,"drawCount",{get:function(){return this._drawCount},set:function(n){this._drawCount=+n;if(this.internal){this.internal.drawCount=+n;}},enumerable:false,configurable:true});Object.defineProperty(MarsGeometry.prototype,"drawStart",{get:function(){return this._drawStart},set:function(n){this._drawStart=n;if(this.internal){this.internal.drawStart=n;}},enumerable:false,configurable:true});MarsGeometry.prototype.destroy=function(){this.drawStart=0;this.drawCount=NaN;this._buffers=undefined;this.options=undefined;this._attributes={};this._attributesName=[];if(this.internal){this.internal.destroy();this["internal"]=undefined;this.renderer=undefined;}this.assignRenderer=throwDestroyedError;this._isDestroyed=true;};MarsGeometry.prototype.setAttributeBuffer=function(name,buffer){if(this.internal==undefined){return}var gpuBuffers=this.internal._buffersMap;var gpuBufferName=this._attributes[name].dataSource;if(gpuBuffers[gpuBufferName]){gpuBuffers[gpuBufferName]=buffer;}};MarsGeometry.prototype.getAttributeBuffer=function(name){if(this.internal==undefined){return undefined}var gpuBuffers=this.internal._buffersMap;var gpuBufferName=this._attributes[name].dataSource;return gpuBuffers[gpuBufferName]};MarsGeometry.prototype.setAttributeData=function(name,data){var buffers=this._buffers;if(buffers==undefined){return}var gpuBufferOption=getAttributeBufferOption(this,name);var gpuBufferName=this._attributes[name].dataSource;if(gpuBufferOption){var option={data:data,usage:gpuBufferOption.usage,target:gpuBufferOption.target,elementCount:data.length};buffers[gpuBufferName]=option;this._dirtyFlags[gpuBufferName].discard=true;this._dirtyFlags[gpuBufferName].dirty=true;}};MarsGeometry.prototype.getAttributeData=function(name){var buffers=this._buffers;if(buffers==undefined){return}var gpuBufferOption=getAttributeBufferOption(this,name);if(gpuBufferOption){return gpuBufferOption.data}return undefined};MarsGeometry.prototype.setAttributeSubData=function(name,offset,data){var buffers=this._buffers;if(buffers==undefined){return}var gpuBufferOption=getAttributeBufferOption(this,name);if(gpuBufferOption){var attribute=gpuBufferOption;if(attribute.data!=undefined){var start=offset;var length_1=offset+data.length;if(attribute.data.length<length_1){var newData=new data.constructor(length_1);newData.set(attribute.data);attribute.data=newData;this._dirtyFlags[name].discard=true;}else if(!this._dirtyFlags[name].discard){var dirtyFlag=this._dirtyFlags[name];dirtyFlag.start=Math.min(dirtyFlag.start,start);dirtyFlag.end=Math.max(dirtyFlag.end,length_1-1);}attribute.data.set(data,start);this._dirtyFlags[name].dirty=true;}}};MarsGeometry.prototype.getIndexData=function(){return this._index};MarsGeometry.prototype.setIndexData=function(data){if(isIndexDataType(data)){this._index=data;this._dirtyFlags["index"].discard=true;this._dirtyFlags["index"].dirty=true;}};MarsGeometry.prototype.setIndexSubData=function(offset,data){var _a;if(this._index){var start=offset;var length_2=offset+data.length;if(this._index.length<length_2){var newData=new data.constructor(end);newData.set(this._index);this._index=newData;this._dirtyFlags["index"].discard=true;}else if(!this._dirtyFlags["index"].discard){var dirtyFlag=this._dirtyFlags["index"];dirtyFlag.start=Math.min(dirtyFlag.start,start);dirtyFlag.end=Math.max(dirtyFlag.end,length_2-1);}(_a=this._index)===null||_a===void 0?void 0:_a.set(data,start);this._dirtyFlags["index"].dirty=true;}};MarsGeometry.prototype.getAttributeStride=function(name){var attr=this._attributes[name];if(attr.stride){return attr.stride}return attr.size*BYTES_TYPE_MAP[attr.type]};MarsGeometry.prototype.getAttributeDataLength=function(name){var _a;if(this._buffers){var gpuBufferOption=getAttributeBufferOption(this,name);if(gpuBufferOption){return (_a=gpuBufferOption.data)===null||_a===void 0?void 0:_a.length}}return 0};MarsGeometry.prototype.getAttributeNames=function(){return this._attributesName};MarsGeometry.prototype.assignRenderer=function(renderer){var _a;if(!this.internal){var indexBufferOption=undefined;if(this._index){var type=INDEX_TYPE_MAP[(_a=this._index)===null||_a===void 0?void 0:_a.BYTES_PER_ELEMENT];var data=this._index;indexBufferOption={target:constants.ELEMENT_ARRAY_BUFFER,type:type,data:data,usage:constants.STATIC_DRAW};}var options={drawStart:this.drawStart,drawCount:this.drawCount,attributes:this._attributes,buffers:this._buffers,mode:this.mode,index:indexBufferOption,name:this.name};this["internal"]=new GLGeometry(options,renderer.internal);this.renderer=renderer;this.flush();this.options=undefined;}return this};MarsGeometry.prototype.flush=function(){var internal=this.internal;if(internal){var attributes_1=this._attributes;var attributesBuffer_1=this._buffers;var indexBuffer_1=this._index;forEach(this._dirtyFlags,(function(flag,name){var gpuBuffer;var data;if(name=="index"){gpuBuffer=internal._indexBuffer;data=indexBuffer_1;}else {var bufferName=attributes_1[name].dataSource;gpuBuffer=internal.getGPUBuffer(bufferName);data=attributesBuffer_1[bufferName].data;}if((flag.dirty||flag.discard)&&gpuBuffer&&data){if(flag.discard){gpuBuffer.bufferData(data);}else {var offset=flag.start*data.BYTES_PER_ELEMENT+data.byteOffset;var length_3=flag.end-flag.start+1;var subData=new data.constructor(data.buffer,offset,length_3);gpuBuffer.bufferSubData(flag.start,subData);}flag.start=Number.POSITIVE_INFINITY;flag.end=0;flag.dirty=flag.discard=false;}}));forEach(this._attributesReleasable,(function(releasable,name){var bufferName=attributes_1[name].dataSource;if(attributesBuffer_1[bufferName]&&releasable){attributesBuffer_1[bufferName].data=undefined;}}));if(this._indexReleasable){this._index=undefined;}}return false};return MarsGeometry}();var seed$6=1;var MarsMesh=function(){function MarsMesh(options){this._isDestroyed=false;this.material=options.material instanceof MarsMaterial?options.material:new MarsMaterial(options.material);var geo=options.geometry;if(geo){this.geometries=[geo instanceof MarsGeometry?geo:new MarsGeometry(geo)];}else if(options.geometries){this.geometries=options.geometries.map((function(geo){return geo instanceof MarsGeometry?geo:new MarsGeometry(geo)}));}else {this.geometries=[];}this.name=options.name||"MarsMesh_"+seed$6++;this.priority=options.priority||0;this.hide=false;this.worldMatrix=options.worldMatrix||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];}Object.defineProperty(MarsMesh.prototype,"isDestroyed",{get:function(){return this._isDestroyed},enumerable:false,configurable:true});Object.defineProperty(MarsMesh.prototype,"geometry",{get:function(){return this.geometries[0]},enumerable:false,configurable:true});MarsMesh.prototype.setMaterial=function(mtl,destroyMtl){if(destroyMtl!==DestroyOptions.keep){this.material.destroy(destroyMtl);}this.material=mtl instanceof MarsMaterial?mtl:new MarsMaterial(mtl);if(this.renderer){this.material.assignRenderer(this.renderer);}};MarsMesh.prototype.setGeometries=function(geos,destroyGeometries){var arr=this.geometries;if(destroyGeometries!==DestroyOptions.keep){arr.forEach((function(g){return g.destroy()}));}arr.length=0;var r=this.renderer;geos.forEach((function(g){if(r){g.assignRenderer(r);}arr.push(g);}));};MarsMesh.prototype.destroy=function(options){if(this._isDestroyed){consoleError("call mesh.destroy multiple times",this);}if((options===null||options===void 0?void 0:options.geometries)!==DestroyOptions.keep){this.geometries.forEach((function(element){element.destroy();}));}this.geometries.length=0;var materialDestroyOption=options===null||options===void 0?void 0:options.material;if(materialDestroyOption!==DestroyOptions.keep&&this.material){this.material.destroy(materialDestroyOption);this["material"]=undefined;}this.assignRenderer=throwDestroyedError;this._isDestroyed=true;};MarsMesh.prototype.assignRenderer=function(renderer){this.geometries.forEach((function(element){element.assignRenderer(renderer);}));if(!this.material.materialInternal){this.material.assignRenderer(renderer);}this.renderer=renderer;return this};return MarsMesh}();var MarsExtWrap=function(){function MarsExtWrap(renderer){this.renderer=renderer;if((renderer===null||renderer===void 0?void 0:renderer.gpu.level)===1){this._copyRenderPass=this._createCopyRenderPass().assignRenderer(renderer);}}MarsExtWrap.prototype.resetColorAttachments=function(rp,colorTextures){var r=this.renderer;if(r){rp.resetColorAttachments(colorTextures);}};MarsExtWrap.prototype.copyTexture=function(source,tex){var renderer=this.renderer;if(renderer){source.assignRenderer(renderer);tex.assignRenderer(renderer);tex.updateSource({sourceType:TextureSourceType.framebuffer,data:{width:tex.width||source.width,height:tex.height||source.height}});if(renderer.gpu.level===2){this.copy2(source,tex);}else {this.copy1(source,tex);}}};MarsExtWrap.prototype.copy2=function(source,target){var _a;(_a=this.renderer)===null||_a===void 0?void 0:_a.internal.copy2(source.internal,target.internal);};MarsExtWrap.prototype.copy1=function(source,target){var rp=this._copyRenderPass;if(rp){var renderer=this.renderer;if(renderer){var fb=rp.frameBuffer;fb.viewport[2]=target.width||source.width;fb.viewport[3]=target.height||source.height;renderer.internal.resetColorAttachments(fb,[target.internal]);var mesh=rp.meshes[0];mesh.material.defaultDataBlock.setUniformValue("uTex",source);RenderFrameInternal.renderRenderPass(renderer,rp,{currentFrame:{}});}}};MarsExtWrap.prototype._createCopyRenderPass=function(){var name="mri-copy-mesh";return new MarsRenderPass({name:"mri-copy-rp",clearAction:{colorAction:TextureLoadAction.whatever},attachments:[{texture:{format:constants.RGBA}}],meshes:[new MarsMesh({name:name,priority:0,geometry:{name:name,mode:constants.TRIANGLE_STRIP,attributes:{aPos:{type:constants.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4},material:{states:{depthTest:false,cullFaceEnabled:false,stencilTest:false},name:name,shader:{name:name,vertex:"precision highp float;\n          attribute vec2 aPos;varying vec2 vTex;\n          void main(){\n             gl_Position = vec4(aPos,0.,1.0);\n             vTex = (aPos + vec2(1.))/2.;\n           }\n          ",fragment:" precision highp float;\n          varying vec2 vTex;\n          uniform sampler2D uTex;\n          void main(){gl_FragColor = texture2D(uTex,vTex);}\n          "}}})]})};MarsExtWrap.prototype.destroy=function(){var _a,_b;if(this.renderer){(_a=this._copyRenderPass)===null||_a===void 0?void 0:_a.meshes[0].material.defaultDataBlock.setUniformValue("uTex",undefined);(_b=this._copyRenderPass)===null||_b===void 0?void 0:_b.destroy();this.renderer=undefined;}};return MarsExtWrap}();var ERR_EXP="WebGL not available";var MarsRenderer=function(){function MarsRenderer(options){var gl=options.gl;if(!gl){var webglOptions={preserveDrawingBuffer:options.willCaptureImage,alpha:true,stencil:true,antialias:true,depth:true,premultipliedAlpha:true};var canvas=options.canvas;if(canvas){var frameworks=options.frameworks||[getDefaultGPUCapability().type];for(var i=0;i<frameworks.length;i++){gl=canvas===null||canvas===void 0?void 0:canvas.getContext(frameworks[i],webglOptions);if(gl){break}}}}if(gl){this.gpu=new GLGPUCapability({gl:gl});this.internal=new GLGPURenderer(gl);this.shaderLibrary=this.internal.shaderLibrary;this.canvas=gl.canvas;}else {this.gpu=new GPUCapabilityEmpty;this.shaderLibrary=new ShaderLibraryEmpty;this.canvas=new CanvasEmpty;consoleError(ERR_EXP);}this.extension=new MarsExtWrap(this);}Object.defineProperty(MarsRenderer.prototype,"isDestroyed",{get:function(){var internal=this.internal;return internal?internal.isDestroyed:true},enumerable:false,configurable:true});Object.defineProperty(MarsRenderer.prototype,"height",{get:function(){var _a;return ((_a=this.internal)===null||_a===void 0?void 0:_a.height)||0},enumerable:false,configurable:true});Object.defineProperty(MarsRenderer.prototype,"width",{get:function(){var _a;return ((_a=this.internal)===null||_a===void 0?void 0:_a.width)||0},enumerable:false,configurable:true});MarsRenderer.prototype.createBuffer=function(options){var internal=this.internal;if(!internal){throw Error(ERR_EXP)}return new GLGPUBuffer(options,internal)};MarsRenderer.prototype.createRenderFrame=function(options){return new MarsRenderFrame(options||{},this)};MarsRenderer.prototype.destroy=function(haltGL){var _a;this.extension.destroy();(_a=this.internal)===null||_a===void 0?void 0:_a.destroy(haltGL);this.gpu=new GPUCapabilityEmpty;this.shaderLibrary=new ShaderLibraryEmpty;};MarsRenderer.prototype.resize=function(width,height){var internal=this.internal;if(internal){if(this.width!==width||this.height!==height){internal.resize(width,height);}}};return MarsRenderer}();var MarsSharedGeometry=function(_super){__extends(MarsSharedGeometry,_super);function MarsSharedGeometry(opt,renderer){var _this=_super.call(this,Object.assign({attributes:{}},opt))||this;var indexData=opt.index?opt.index.data:opt.geometry.getIndexData();if(indexData){indexData=new indexData.constructor(indexData);}_this._index=indexData;_this._source=opt.geometry;_this._drawCount=opt.drawCount||0;_this._drawStart=opt.drawStart||0;_this._mode=opt.mode||0;forEach(_this._source._attributes,(function(attr,name){_this._attributes[name]=Object.assign({},attr);}));if(renderer){_this.assignRenderer(renderer);}return _this}MarsSharedGeometry.prototype.assignRenderer=function(renderer){if(!this.renderer){var geometry=this._source;geometry.assignRenderer(renderer);var internal=geometry.internal;var glgeo=new GLGeometry(internal,renderer.internal);glgeo.drawCount=this.drawCount;glgeo.drawStart=this.drawStart;glgeo.mode=this.mode;if(this._index){glgeo._indexBuffer=glgeo.createIndexBuffer(this._index,renderer.internal);}this.internal=glgeo;this.renderer=geometry.renderer;}return this};MarsSharedGeometry.prototype.getAttributeNames=function(){return this._source.getAttributeNames()};MarsSharedGeometry.prototype.getAttributeDataLength=function(name){if(this._buffers[name]){return _super.prototype.getAttributeDataLength.call(this,name)}return this._source.getAttributeDataLength(name)};MarsSharedGeometry.prototype.flush=function(){this._source.flush();return _super.prototype.flush.call(this)};MarsSharedGeometry.prototype.destroy=function(){if(this.internal){this.internal.vaoMap={};}_super.prototype.destroy.call(this);};return MarsSharedGeometry}(MarsGeometry);consoleLog("version: "+"0.0.6");var index=Object.freeze({__proto__:null,get DestroyOptions(){return DestroyOptions},Geometry:MarsGeometry,MarsTextureFactory:MarsTextureFactory,Material:MarsMaterial,MaterialDataBlock:MarsMaterialDataBlock,Mesh:MarsMesh,RenderFrame:MarsRenderFrame,RenderPass:MarsRenderPass,get RenderPassAttachmentStorageType(){return RenderPassAttachmentStorageType},get RenderPassDestroyAttachmentType(){return RenderPassDestroyAttachmentType},get RenderPassMeshOrder(){return RenderPassMeshOrder},RenderPassPriorityNormal:RenderPassPriorityNormal,RenderPassPriorityPostprocess:RenderPassPriorityPostprocess,RenderPassPriorityPrepare:RenderPassPriorityPrepare,Renderer:MarsRenderer,get ShaderCompileResultStatus(){return ShaderCompileResultStatus},ShaderLibraryEmpty:ShaderLibraryEmpty,SharedGeometry:MarsSharedGeometry,Texture:MarsTexture,get TextureLoadAction(){return TextureLoadAction},get TextureSourceType(){return TextureSourceType},get TextureStoreAction(){return TextureStoreAction},constants:constants,getDefaultGPUCapability:getDefaultGPUCapability,getDefaultTextureFactory:getDefaultTextureFactory,setDefaultTextureFactory:setDefaultTextureFactory});var Node$1=function(){function Node(content){this.content=content;this.children=[];}Node.removeContent=function removeContent(nodes,content){var opt={stopped:false,stop(){opt.stopped=true;}};traverse(nodes,(function(node,nodes,index,stop){if(node.content===content){nodes.splice(index,1);stop();}}),opt);function traverse(nodes,func,opt){for(var i=0;i<nodes.length&&!opt.stopped;i++){var _node=nodes[i];func(_node,nodes,i,opt.stop);if(!opt.stopped){traverse(_node.children,func,opt);}}}};return Node}();var CalculateGroup=function(){function CalculateGroup(){this._nodes=[];this._items=[];this.time=0;}CalculateGroup.combineRenderData=function combineRenderData(data,parentData){if(parentData){data.transform.update();vecMulCombine(data.color,data.color,parentData.color);if(parentData.hide){data.hide=true;}}return data};var _proto=CalculateGroup.prototype;_proto.getRenderData=function getRenderData(id){var p=this._itemMap[id];if(p){return p.renderData}return null};_proto.combineRenderData=function combineRenderData(data,parentData){var clone={transform:new Transform({position:data.pos,rotation:data.rot,scale:data.size}),color:data.color.slice(),life:0};return CalculateGroup.combineRenderData(clone,parentData)};_proto.buildTree=function buildTree(refCountMap){var nodeMap={};var itemMap={};var nodes=this._items.map((function(c){return nodeMap[c.id]=new Node$1(itemMap[c.id]=c)}));var ret=[];nodes.forEach((function(node){var item=node.content;if(item.parentId){var parentNode=nodeMap[item.parentId];if(parentNode){parentNode.children.push(node);}else {ret.push(node);}}else {ret.push(node);}}));forEach$1(nodeMap,(function(node){node.content.refCount=node.children.length+1+(refCountMap[node.content.id]||0);}));this._itemMap=itemMap;this._nodes=ret;this._items=[];};_proto._onUpdate=function _onUpdate(dt){var self=this;this.time+=dt/1e3;this._nodes.forEach(updateNode);function updateNode(node){var item=node.content;item._transform.invalid();item._onUpdate(dt,self);if(node.children){node.children.forEach(updateNode);}}};_proto.addItem=function addItem(item){arrAdd$1(this._items,item);};_proto._removeItemRef=function _removeItemRef(id){var item=this._itemMap[id];if(item){var c=--item.refCount;if(c===0){delete this._itemMap[id];Node$1.removeContent(this._nodes,item);return item}}};_proto.removeItemRef=function removeItemRef(id){var item=this._removeItemRef(id);if(item&&item.parentId){this._removeItemRef(item.parentId);}};return CalculateGroup}();var HitTestType;(function(HitTestType){HitTestType[HitTestType["triangle"]=1]="triangle";HitTestType[HitTestType["box"]=2]="box";HitTestType[HitTestType["sphere"]=3]="sphere";HitTestType[HitTestType["custom"]=4]="custom";})(HitTestType||(HitTestType={}));var HitTestBehavior;(function(HitTestBehavior){HitTestBehavior[HitTestBehavior["notify"]=InteractBehavior.NOTIFY]="notify";HitTestBehavior[HitTestBehavior["resume"]=InteractBehavior.RESUME_PLAYER]="resume";HitTestBehavior[HitTestBehavior["none"]=InteractBehavior.NONE]="none";})(HitTestBehavior||(HitTestBehavior={}));function setMtlBlending(blending,mtl){mtl.blendEquationAlpha=mtl.blendEquationRGB=constants.FUNC_ADD;mtl.blending=true;if(blending===1||blending===4){mtl.blendSrc=constants.ONE;mtl.blendDst=constants.ONE;mtl.blendSrcAlpha=constants.ONE;mtl.blendDstAlpha=constants.ONE;if(blending===4){mtl.blendEquationAlpha=mtl.blendEquationRGB=constants.FUNC_REVERSE_SUBTRACT;mtl.blendSrcAlpha=constants.ZERO;return 1}return 1}else if(blending===7){mtl.blendSrcAlpha=mtl.blendSrc=mtl.blendDstAlpha=mtl.blendDst=constants.ONE;return 2}else if(blending===2){mtl.blendSrc=constants.DST_COLOR;mtl.blendDst=constants.ONE_MINUS_SRC_ALPHA;}else if(blending===5){mtl.blendSrc=constants.DST_COLOR;mtl.blendDst=constants.DST_ALPHA;mtl.blendSrcAlpha=constants.ZERO;mtl.blendDstAlpha=constants.ONE;return 1}else if(blending===6){mtl.blendSrc=constants.DST_COLOR;mtl.blendDst=constants.ZERO;mtl.blendSrcAlpha=constants.ZERO;mtl.blendDstAlpha=constants.ONE;return 1}else {mtl.blendSrc=constants.ONE;mtl.blendDst=constants.ONE_MINUS_SRC_ALPHA;mtl.blendSrcAlpha=constants.ONE;mtl.blendDstAlpha=constants.ONE_MINUS_SRC_ALPHA;if(blending===3){return 3}return 1}return 0}function setMtlStencil(maskMode,maskOrder,mtl){if(maskMode===0||!maskMode){mtl.stencilTest=false;}else {mtl.stencilTest=true;mtl.stencilOp=[constants.KEEP,constants.KEEP,constants.KEEP];mtl.stencilFunc=[constants.ALWAYS,maskOrder,255];mtl.stencilMask=255;if(maskMode===1){mtl.stencilFunc[0]=constants.ALWAYS;mtl.stencilOp[2]=constants.REPLACE;}else if(maskMode===3){mtl.stencilFunc[0]=constants.NOTEQUAL;}else if(maskMode===2){mtl.stencilFunc[0]=constants.EQUAL;}}}function enlargeBuffer(typeArray,length,increase,maxSize){if(increase===void 0){increase=1;}var buffer=typeArray.buffer;if(buffer.byteLength<typeArray.BYTES_PER_ELEMENT*length){var size=Math.ceil(length*increase);if(!isNaN(maxSize)){size=Math.min(size,maxSize);}var nbuffer=new ArrayBuffer(typeArray.BYTES_PER_ELEMENT*size);var nArr=new typeArray.constructor(nbuffer);nArr.set(typeArray);return nArr}return typeArray}var buffer;function createEmptyTextureContainer(renderer){if(!buffer){buffer=new Uint8Array([255,255,255,255]);}return createDataTexture({width:1,height:1,data:buffer},{},renderer)}var SIDE_BOTH_STATES={cullFaceEnabled:false};var SIDE_BACK_STATES={cullFace:constants.BACK,frontFace:constants.CW,cullFaceEnabled:true};var SIDE_FRONT_STATES={cullFace:constants.FRONT,frontFace:constants.CW,cullFaceEnabled:true};function sideToMtlStates(side){if(side===1032){return SIDE_BOTH_STATES}if(side===1029){return SIDE_BACK_STATES}if(side===1028){return SIDE_FRONT_STATES}}function createDataTexture(imageData,opt,renderer){opt=opt||{};var data=imageData||imageDataFromColor("#fff");var tex=new MarsTexture({data:data,type:opt.type||constants.UNSIGNED_BYTE,sourceType:TextureSourceType.data,format:opt.format||constants.RGBA,internalFormat:opt.internalFormat||opt.format||constants.RGBA,wrapS:opt.wrapS||constants.MIRRORED_REPEAT,wrapT:opt.wrapT||constants.MIRRORED_REPEAT,minFilter:opt.minFilter||constants.NEAREST,magFilter:opt.magFilter||constants.NEAREST});if(renderer){tex.assignRenderer(renderer);}return tex}function createGradientTexture(gradient){return createDataTexture(imageDataFromGradient(gradient))}function createHalfFloatTexture(data,width,height){var channel=data.length/width/height;var format;var internalFormat;if(channel===4||channel===0){internalFormat=format=constants.RGBA;}else if(channel===3){internalFormat=format=constants.RGB;}else if(channel===2){internalFormat=format=constants.LUMINANCE_ALPHA;}else {internalFormat=format=constants.LUMINANCE;}return createDataTexture({data:data,width:width,height:height},{type:constants.HALF_FLOAT,format:format,internalFormat:internalFormat,wrapS:constants.CLAMP_TO_EDGE,wrapT:constants.CLAMP_TO_EDGE})}var def={format:constants.RGBA,type:constants.UNSIGNED_BYTE,minFilter:constants.LINEAR,magFilter:constants.LINEAR,wrapS:constants.CLAMP_TO_EDGE,wrapT:constants.CLAMP_TO_EDGE};var desSymbol=Symbol("destroy");var PassTextureCache=function(){function PassTextureCache(renderer){this.renderer=renderer;this.textureCache={};this.textureRef={};}var _proto=PassTextureCache.prototype;_proto.requestColorAttachmentTexture=function requestColorAttachmentTexture(request){var _this=this;var options={sourceType:TextureSourceType.framebuffer,data:{width:request.width,height:request.height},name:request.name};var keys=[request.name];Object.getOwnPropertyNames(def).forEach((function(name){keys.push(name,options[name]=request[name]||def[name]);}));var cacheId=keys.join(":");var tex=this.textureCache[cacheId];if(tex){this.textureRef[cacheId]++;}else {tex=this.textureCache[cacheId]=new MarsTexture(options,this.renderer);this.textureRef[cacheId]=1;tex[desSymbol]=tex.destroy;tex.destroy=function(){return _this.removeTexture(cacheId)};}return tex};_proto.removeTexture=function removeTexture(id){var refCount=this.textureRef[id];if(refCount<=1){if(refCount<0){consoleError$1("ref count<0");}var tex=this.textureCache[id];if(tex){tex[desSymbol]();tex.destroy=tex[desSymbol];}delete this.textureCache[id];delete this.textureRef[id];}else {this.textureRef[id]=refCount-1;}};_proto.destroy=function destroy(){Object.values(this.textureCache).forEach((function(tex){tex[desSymbol]();tex.destroy=tex[desSymbol];}));this.textureCache={};this.textureRef={};};return PassTextureCache}();var copy="uniform vec2 uFilterSourceSize;uniform sampler2D uFilterSource;\n#define INTERPOLATION 1\nvec4 filterMain(vec2 texCoord,sampler2D a){\n#ifdef INTERPOLATION\nvec2 b=texCoord*uFilterSourceSize;vec2 c=floor(b);vec2 d=b-c;vec4 e=vec4(c/uFilterSourceSize,(c+vec2(1.))/uFilterSourceSize);vec4 f=texture2D(uFilterSource,vec2(e.x,e.w));vec4 g=texture2D(uFilterSource,vec2(e.x,e.y));vec4 h=texture2D(uFilterSource,vec2(e.z,e.w));vec4 i=texture2D(uFilterSource,vec2(e.z,e.y));return mix(mix(g,i,d.x),mix(f,h,d.x),d.y);\n#else\nreturn texture2D(uFilterSource,texCoord);\n#endif\n}";var DEF_NAME="_mars_default_";var MARS_COPY_MESH_NAME="mars-internal-copy";var COPY_MESH_SHADER_ID="mars-internal-copy-mesh";function createCopyShader(webgl2,writeDepth){var version=webgl2?"#version 300 es":"";return {name:MARS_COPY_MESH_NAME,vertex:"\n    "+version+"\n#ifdef WEBGL2\n#define vsIn in\n#define vsOut out\n#else\n#define vsIn attribute\n#define vsOut varying\n#endif\nprecision highp float;\nvsIn vec2 aPos;\nvsOut vec2 vTex;\nvoid main(){\n    gl_Position = vec4(aPos,0.,1.0);\n    vTex = (aPos + vec2(1.0))/2.;\n}",fragment:version+"\nprecision mediump float;\n#ifdef WEBGL2\n#define fsIn in\n#define fsOut out\n#define texture2D texture\n#else\n#define fsIn varying\n#endif\n"+copy+"\nfsIn vec2 vTex;\n#ifdef WEBGL2\nlayout (location = 0) out vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\n\n#ifdef DEPTH_TEXTURE\nuniform sampler2D uDepth;\n#ifndef WEBGL2\n#extension GL_EXT_frag_depth : enable\n#define gl_FragDepth gl_FragDepthEXT\n#endif\n#endif\nvoid main(){\n    fragColor = filterMain(vTex,uFilterSource);\n    #ifdef DEPTH_TEXTURE\n    gl_FragDepth = texture2D(uDepth,vTex).r;\n    #endif\n}\n    ",marcos:[["WEBGL2",!!webgl2],["DEPTH_TEXTURE",!!writeDepth]],cacheId:COPY_MESH_SHADER_ID}}var MarsPlayerRenderFrame=function(_RenderFrame){_inheritsLoose(MarsPlayerRenderFrame,_RenderFrame);function MarsPlayerRenderFrame(opt){var _this;var tex=createEmptyTextureContainer(opt.renderer);var camera=opt.camera;_this=_RenderFrame.call(this,{semantics:{VIEW:function VIEW(){return camera.view},VIEWINVERSE:function VIEWINVERSE(){return camera.inverseView},PROJECTION:function PROJECTION(){return camera.projection},VIEWPROJECTION:function VIEWPROJECTION(){return camera.viewProjection},EDITOR_TRANSFORM:function EDITOR_TRANSFORM(){return _this._editorTransform},MODEL:function MODEL(state){return state.currentMesh.worldMatrix},["PRE_COLOR_ATTACHMENT_0"]:function PRE_COLOR_ATTACHMENT_0(state){var _rp$attachments$;var rp=_this.findPreviousRenderPass(state.currentPass);if(!rp){return _this.transparentTexture}return (_rp$attachments$=rp.attachments[0])==null?void 0:_rp$attachments$.texture},["PRE_COLOR_ATTACHMENT_SIZE_0"]:function PRE_COLOR_ATTACHMENT_SIZE_0(state){var _this$findPreviousRen,_this$findPreviousRen2;return getTextureSize((_this$findPreviousRen=_this.findPreviousRenderPass(state.currentPass))==null?void 0:(_this$findPreviousRen2=_this$findPreviousRen.attachments[0])==null?void 0:_this$findPreviousRen2.texture)},["PRE_MAIN_COLOR_0"]:function PRE_MAIN_COLOR_0(state){var _rp$attachments$2;var rp=_this.findPreviousDefaultRenderPass(state.currentPass);if(!rp){return _this.transparentTexture}return (_rp$attachments$2=rp.attachments[0])==null?void 0:_rp$attachments$2.texture},["PRE_MAIN_COLOR_SIZE_0"]:function PRE_MAIN_COLOR_SIZE_0(state){var _this$findPreviousDef,_this$findPreviousDef2;return getTextureSize((_this$findPreviousDef=_this.findPreviousDefaultRenderPass(state.currentPass))==null?void 0:(_this$findPreviousDef2=_this$findPreviousDef.attachments[0])==null?void 0:_this$findPreviousDef2.texture)}},clearAction:{colorAction:TextureLoadAction.whatever,stencilAction:TextureLoadAction.clear,depthAction:TextureLoadAction.whatever},renderPasses:[new MarsRenderPass({name:DEF_NAME,priority:RenderPassPriorityNormal,camera:camera,meshOrder:RenderPassMeshOrder.ascending})]},opt.renderer)||this;_this.env=opt.env||"";_this.keepColorBuffer=opt.keepColorBuffer;_this.transparentTexture=createDataTexture({width:1,height:1,data:new Uint8Array([0,0,0,0])}).assignRenderer(_this.renderer);_this._renderPassInfoMap=new WeakMap;_this._camera=camera;_this.emptyTexture=tex;var firstRP=_this.renderPasses[0];_this._defRenderPasses=[firstRP];_this._renderPassInfoMap.set(firstRP,{listStart:0,listEnd:0,renderPass:firstRP,intermedia:false});_this.editorTransform=opt.editorTransform||[1,1,0,0];var capability=_this.renderer.gpu.capability;var writeDepth=capability.readableDepthStencilTextures&&capability.writableFragDepth;var shader=createCopyShader(_this.renderer.gpu.type==="webgl2",writeDepth);_this.renderer.shaderLibrary.addShader(shader);_this.renderer.shaderLibrary.compileShader(COPY_MESH_SHADER_ID);_this.passTextureCache=new PassTextureCache(_this.renderer);_this.resetClearActions();return _this}var _proto=MarsPlayerRenderFrame.prototype;_proto._createResource=function _createResource(){if(!this._resource){var _resRP$depthAttachmen;var r=this.renderer;var filter=r.gpu.level===2?constants.LINEAR:constants.NEAREST;var texA=new MarsTexture({sourceType:TextureSourceType.framebuffer,format:constants.RGBA,name:"frame_a",minFilter:filter,magFilter:filter});var texB=new MarsTexture({sourceType:TextureSourceType.framebuffer,format:constants.RGBA,data:{width:r.width,height:r.height},minFilter:filter,magFilter:filter,name:"frame_b"}).assignRenderer(r);var g=this.renderer.gpu.capability;var depthStencilType=g.readableDepthStencilTextures&&g.writableFragDepth?RenderPassAttachmentStorageType.depth_24_stencil_8_texture:RenderPassAttachmentStorageType.depth_stencil_opaque;var resRP=new MarsRenderPass({depthStencilAttachment:{storageType:depthStencilType},attachments:[{texture:texA}]}).assignRenderer(this.renderer);var finalCopyRP=new MarsRenderPass({name:"mars-final-copy",priority:RenderPassPriorityNormal+600,clearAction:{depthAction:TextureLoadAction.clear,stencilAction:TextureLoadAction.clear,colorAction:TextureLoadAction.whatever},camera:this._camera,meshOrder:RenderPassMeshOrder.ascending,meshes:[this.createCopyMesh({blend:true,depthTexture:(_resRP$depthAttachmen=resRP.depthAttachment)==null?void 0:_resRP$depthAttachmen.texture})]});this._resource={color_a:resRP.attachments[0].texture,color_b:texB,finalCopyRP:finalCopyRP,depthStencil:resRP.depthAttachment,resRP:resRP};}};_proto.getRPAttachments=function getRPAttachments(attachments,preRP){if((attachments==null?void 0:attachments.length)===1){var fistColor=attachments[0];if(fistColor.texture.format===constants.RGBA&&!fistColor.persistent){var texA=this._resource.color_a;if(!preRP||preRP.attachments.length===0){return [{texture:texA}]}var texture=preRP.attachments[0].texture===texA?this._resource.color_b:texA;return [{texture:texture}]}}return attachments};_proto.splitDefaultRenderPassByMesh=function splitDefaultRenderPassByMesh(mesh,options){var _this2=this;var index=this.findMeshRenderPassIndex(mesh);var renderPass=this.renderPasses[index];this._createResource();var meshIndex=renderPass.meshes.indexOf(mesh);var ms0=renderPass.meshes.slice(0,meshIndex);var ms1=renderPass.meshes.slice(meshIndex);var infoMap=this._renderPassInfoMap;if(renderPass.attachments[0]&&this.renderPasses[index+1]!==this._resource.finalCopyRP){throw Error("not implement")}else {var _options$prePasses,_options$prePasses2;if(!options.attachments.length){throw Error("should include at least one color attachment")}var defRPS=this._defRenderPasses;var defIndex=defRPS.indexOf(renderPass);var lastDefRP=defRPS[defIndex-1];arrRemove$1(defRPS,renderPass);var lastInfo=infoMap.get(renderPass);infoMap.delete(renderPass);var rp0=new MarsRenderPass({name:DEF_NAME+defIndex,priority:renderPass.priority,attachments:this.getRPAttachments(options.attachments,lastDefRP),clearAction:renderPass.clearAction||{colorAction:TextureLoadAction.clear},storeAction:renderPass.storeAction,depthStencilAttachment:this._resource.depthStencil,semantics:_extends({},renderPass.semantics.toObject(),{EDITOR_TRANSFORM:function EDITOR_TRANSFORM(){return new Float32Array(_this2._editorTransform)}}),meshes:ms0,meshOrder:RenderPassMeshOrder.ascending}).assignRenderer(this.renderer);ms1.unshift(this.createCopyMesh());var rps=this.renderPasses;rps[index]=rp0;var prePasses=[];if(options.prePasses){options.prePasses.forEach((function(p,i){var meshes=p.setMeshes?p.setMeshes(ms1):p.pass.meshes||[];var rp=new MarsRenderPass(_extends({},p.pass,{meshes:meshes,priority:renderPass.priority+1+i,depthStencilAttachment:p.pass.viewport?undefined:_this2._resource.depthStencil,attachments:p.pass.attachments})).assignRenderer(_this2.renderer);prePasses.push(rp);}));rps.splice.apply(rps,[index+1,0].concat(prePasses));}var copyRP=this._resource.finalCopyRP;if(!rps.includes(copyRP)){rps.push(copyRP);}var rp1=new MarsRenderPass({name:DEF_NAME+(defIndex+1),priority:renderPass.priority+1+(((_options$prePasses=options.prePasses)==null?void 0:_options$prePasses.length)||0),meshes:ms1,meshOrder:RenderPassMeshOrder.ascending,depthStencilAttachment:this._resource.depthStencil,storeAction:options.storeAction,attachments:this.getRPAttachments(options.attachments,rp0)}).assignRenderer(this.renderer);rps.splice(index+1+(((_options$prePasses2=options.prePasses)==null?void 0:_options$prePasses2.length)||0),0,rp1);arrAdd$1(this._defRenderPasses,rp0);arrAdd$1(this._defRenderPasses,rp1);this.setRenderPasses(rps);this.updateRenderInfo(rp0);this.updateRenderInfo(rp1);infoMap.get(rp0).prePasses=lastInfo.prePasses;infoMap.get(rp1).prePasses=prePasses.map((function(pass,i){var _options$prePasses$i;return {pass:pass,destroyOptions:(_options$prePasses$i=options.prePasses[i])==null?void 0:_options$prePasses$i.destroyOptions}}));this.resetClearActions();return rp1}};_proto.resetClearActions=function resetClearActions(){var action=this._defRenderPasses.length>1?TextureLoadAction.clear:TextureLoadAction.whatever;var ac=this.clearAction;ac.stencilAction=ac.depthAction=ac.colorAction=action;if(this.keepColorBuffer){ac.colorAction=TextureLoadAction.whatever;}};_proto.findMeshRenderPassIndex=function findMeshRenderPassIndex(mesh){var ps=this.renderPasses;for(var i=0;i<ps.length;i++){var renderPass=ps[i];if(renderPass.name.startsWith(DEF_NAME)){if(renderPass.meshes.includes(mesh)){return i}}}return -1};_proto.createCopyMesh=function createCopyMesh(semantics){var name=MARS_COPY_MESH_NAME;var states={depthTest:false,cullFaceEnabled:false,stencilTest:false};if(semantics!=null&&semantics.blend){objAssign(states,{blending:true,blendSrc:constants.SRC_ALPHA,blendSrcAlpha:constants.SRC_ALPHA,blendDst:constants.ONE_MINUS_SRC_ALPHA,blendDstAlpha:constants.ONE_MINUS_SRC_ALPHA});}return new MarsMesh({name:name,priority:0,geometry:{name:name,mode:constants.TRIANGLE_STRIP,attributes:{aPos:{type:constants.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4},material:{uniformValues:{uDepth:semantics==null?void 0:semantics.depthTexture},uniformSemantics:{uFilterSource:(semantics==null?void 0:semantics.tex)||"PRE_MAIN_COLOR_0",uFilterSourceSize:(semantics==null?void 0:semantics.size)||"PRE_MAIN_COLOR_SIZE_0"},states:states,name:name,shader:createCopyShader(this.renderer.gpu.type==="webgl2",!!(semantics!=null&&semantics.depthTexture))}})};_proto._addToRenderPass=function _addToRenderPass(renderPass,mesh){var infoMap=this._renderPassInfoMap;var info=infoMap.get(renderPass);if(renderPass.meshes.length===0){info.listStart=info.listEnd=mesh.priority;}else {if(mesh.priority<info.listStart){info.listStart=mesh.priority;}else if(mesh.priority>info.listEnd){info.listEnd=mesh.priority;}}renderPass.addMesh(mesh);mesh.material.setUniformSemantic("uEditorTransform","EDITOR_TRANSFORM");};_proto.addMeshToDefaultRenderPass=function addMeshToDefaultRenderPass(mesh){var renderPasses=this._defRenderPasses;var infoMap=this._renderPassInfoMap;for(var i=1;i<renderPasses.length;i++){var renderPass=renderPasses[i-1];var info=infoMap.get(renderPasses[i]);if(info.listStart>mesh.priority&&(mesh.priority>infoMap.get(renderPass).listEnd||i===1)){return this._addToRenderPass(renderPass,mesh)}}var last=renderPasses[renderPasses.length-1];if(mesh.priority>infoMap.get(last).listStart||renderPasses.length===1){return this._addToRenderPass(last,mesh)}};_proto.destroy=function destroy(options){_RenderFrame.prototype.destroy.call(this,options);forEach$1(this._resource,(function(glRes){if(glRes.destroy){glRes.destroy();}}));this.passTextureCache.destroy();this.transparentTexture.destroy();this.emptyTexture.destroy();};_proto.removeMeshFromDefaultRenderPass=function removeMeshFromDefaultRenderPass(mesh){var _this3=this;var renderPasses=this._defRenderPasses;var infoMap=this._renderPassInfoMap;for(var i=renderPasses.length-1;i>=0;i--){var renderPass=renderPasses[i];var info=infoMap.get(renderPass);if(info.listStart<=mesh.priority&&info.listEnd>=mesh.priority){var idx=renderPass.meshes.indexOf(mesh);if(idx===-1){return consoleError$1("Mesh not in pass.")}var shouldRestoreRenderPass=idx===1&&renderPass.meshes[0].name===MARS_COPY_MESH_NAME;renderPass.removeMesh(mesh);if(shouldRestoreRenderPass){var _renderPass$attachmen;var nextRenderPass=renderPasses[i+1];if(!info.intermedia){this.renderer.extension.resetColorAttachments(info.preRenderPass,[]);}var _meshes=renderPass.meshes;for(var j=1;j<_meshes.length;j++){info.preRenderPass.addMesh(_meshes[j]);}var cp=(_renderPass$attachmen=renderPass.attachments[0])==null?void 0:_renderPass$attachmen.texture;var keepColor=cp===this._resource.color_a||cp===this._resource.color_b;renderPass.destroy({meshes:DestroyOptions.keep,colorAttachment:keepColor?RenderPassDestroyAttachmentType.keep:RenderPassDestroyAttachmentType.destroy,depthStencilAttachment:RenderPassDestroyAttachmentType.keep});arrRemove$1(renderPasses,renderPass);this.removeRenderPass(renderPass);infoMap.delete(renderPass);if(nextRenderPass){this.updateRenderInfo(nextRenderPass);}if(info.preRenderPass){this.updateRenderInfo(info.preRenderPass);}if(info.prePasses){info.prePasses.forEach((function(rp){_this3.removeRenderPass(rp.pass);if((rp==null?void 0:rp.destroyOptions)!==false){rp.pass.attachments.forEach((function(c){if(c.texture!==_this3._resource.color_b||c.texture!==_this3._resource.color_a){c.texture.destroy();}}));var options=Object.assign(rp!=null&&rp.destroyOptions?rp.destroyOptions:{},{depthStencilAttachment:RenderPassDestroyAttachmentType.keep});rp.pass.destroy(options);}}));}this.resetRenderPassDefaultAttachment(renderPasses,Math.max(i-1,0));if(renderPasses.length===1){this.renderer.extension.resetColorAttachments(renderPasses[0],[]);this.removeRenderPass(this._resource.finalCopyRP);}}return this.resetClearActions()}}};_proto.resetRenderPassDefaultAttachment=function resetRenderPassDefaultAttachment(renderPasses,startIndex){var pre;var _this$_resource=this._resource,color_a=_this$_resource.color_a,color_b=_this$_resource.color_b;for(var i=startIndex;i<renderPasses.length;i++){var _rp$attachments$3,_rp$attachments$4;var rp=renderPasses[i];var tex=(_rp$attachments$3=rp.attachments[0])==null?void 0:_rp$attachments$3.texture;if(tex&&pre===tex){var next=tex===color_a?color_b:color_a;this.renderer.extension.resetColorAttachments(rp,[next]);}tex=(_rp$attachments$4=rp.attachments[0])==null?void 0:_rp$attachments$4.texture;if(tex){pre=tex;}}};_proto.findPreviousDefaultRenderPass=function findPreviousDefaultRenderPass(renderPass){var _this$_resource2;var rps=this._defRenderPasses;var defPass=renderPass;if(defPass===((_this$_resource2=this._resource)==null?void 0:_this$_resource2.finalCopyRP)){return rps[rps.length-1]}if(!rps.includes(renderPass)){for(var i=this.renderPasses.indexOf(renderPass)-1;i>=0;i--){var rp=this.renderPasses[i];if(rps.includes(rp)){return rp}}}return _findPreviousRenderPass(rps,defPass)};_proto.findPreviousRenderPass=function findPreviousRenderPass(renderPass){return _findPreviousRenderPass(this.renderPasses,renderPass)};_proto.updateRenderInfo=function updateRenderInfo(renderPass){var _this4=this;var map=this._renderPassInfoMap;var passes=this._defRenderPasses;var info;if(!map.has(renderPass)){info={intermedia:false,renderPass:renderPass,listStart:0,listEnd:0};map.set(renderPass,info);}else {info=map.get(renderPass);}info.intermedia=renderPass.attachments.length>0;var meshes=renderPass.meshes;if(meshes[0]){info.listStart=(meshes[0].name===MARS_COPY_MESH_NAME?meshes[1]:meshes[0]).priority;info.listEnd=meshes[meshes.length-1].priority;}else {info.listStart=0;info.listEnd=0;}var index=passes.indexOf(renderPass);var depthStencilActon=index===0?TextureLoadAction.clear:TextureLoadAction.whatever;if(index===0){renderPass.clearAction.colorAction=TextureLoadAction.clear;}renderPass.clearAction.depthAction=depthStencilActon;renderPass.clearAction.stencilAction=depthStencilActon;if(index>-1){renderPass.semantics.setSemantic("EDITOR_TRANSFORM",(function(){return _this4.editorTransform}));}else {renderPass.semantics.setSemantic("EDITOR_TRANSFORM",undefined);}info.preRenderPass=passes[index-1];return info};_createClass(MarsPlayerRenderFrame,[{key:"editorTransform",get:function get(){return this._editorTransform},set:function set(v){this._editorTransform=v;this._defRenderPasses.forEach((function(p,i){return p.semantics.setSemantic("EDITOR_TRANSFORM",new Float32Array(v))}));}}]);return MarsPlayerRenderFrame}(MarsRenderFrame);function getTextureSize(tex){return tex?[tex.width,tex.height]:[0,0]}function _findPreviousRenderPass(renderPasses,renderPass){var index=renderPasses.indexOf(renderPass);return renderPasses[index-1]}function createVFXItem(item,composition){var pluginName=item.pluginName;if(!pluginName){var type=item.type;if(type===ItemType.null||type===ItemType.base){pluginName="cal";}else if(type===ItemType.sprite){pluginName="sprite";}else if(type===ItemType.particle){pluginName="particle";}else if(type===ItemType.interact){pluginName="interact";}else if(type===ItemType.camera){pluginName="camera";}else if(type===ItemType.filter){pluginName="filter";}else if(type==="tree"){pluginName="tree";}}if(!pluginName){throw Error("invalid vfx item type")}return composition.pluginSystem.createPluginItem(pluginName,item,composition)}var round=Math.round;var CompVFXItem=function(_VFXItem){_inheritsLoose(CompVFXItem,_VFXItem);function CompVFXItem(){return _VFXItem.apply(this,arguments)||this}var _proto=CompVFXItem.prototype;_proto.getItemById=function getItemById(id){var ret=this._itemCacheMap[id];if(!ret){var item=this._items.find((function(item){return item.id===id}));if(item){ret=this._itemCacheMap[id]=item;}}return ret};_proto.onConstructed=function onConstructed(options){this._itemCacheMap={};this.items=options.items||[];var endBehavior=this.endBehavior;if(endBehavior===5||endBehavior===1||endBehavior===3){this._freezeOnEnd=true;}this.startTime=options.startTime||0;this._startTimeInms=round(this.startTime*1e3);this._itemsToRemove=[];};_proto.getUpdateTime=function getUpdateTime(t){var startTime=this._startTimeInms;var now=this._timeInms;if(t<0&&now+t<startTime){return startTime-now}if(this._freezeOnEnd){var remain=this._durInms-now;if(remain<t){return remain}}return round(t)};_proto.onUpdate=function onUpdate(dt){this._onUpdate(dt);};_proto.onItemUpdate=function onItemUpdate(dt,lifetime){var items=this._items;if(items){this.composition.updatePluginLoaders(dt);for(var i=0;i<items.length;i++){var item=items[i];if(item){item._onUpdate(dt);if(!item.composition){arrAdd$1(this._itemsToRemove,item);}}}if(this._itemsToRemove.length){this._itemsToRemove.forEach((function(item){arrRemove$1(items,item);}));this._itemsToRemove.length=0;}}};_proto._stop=function _stop(){if(this._items){this._items.forEach((function(item){return item.stop()}));}};_proto.onItemRemoved=function onItemRemoved(renderer){if(this._items){this._items.forEach((function(item){return item.destroy()}));this._items=null;}};_proto.createContent=function createContent(){if(!this._items){this._items=this._createItemsWidthOrder(this.composition);}};_proto.onLifetimeBegin=function onLifetimeBegin(renderer,content){this._items.forEach((function(item){return item.start()}));};_proto._createItemsWidthOrder=function _createItemsWidthOrder(renderer){var ret=[];var items=this.items;for(var i=0;i<items.length;i++){var item=createVFXItem(items[i],renderer);arrAddWithOrder(ret,item,"_v_priority");}return ret};_proto.removeItem=function removeItem(item){var _this$_items;var itemIndex=(_this$_items=this._items)==null?void 0:_this$_items.indexOf(item);if(itemIndex>-1){delete this._itemCacheMap[item.id];arrAdd$1(this._itemsToRemove,item);return true}};_proto._isEnded=function _isEnded(now){return now>=this._durInms};_createClass(CompVFXItem,[{key:"type",get:function get(){return "7"}}]);return CompVFXItem}(VFXItem);var tmpScale=[1,1,1];var tmpPos=[0,0,0];var tmpQuat=[];var Camera=function(){function Camera(name){this.projection=mat4create();this.view=mat4create();this.viewProjection=mat4create();this._invView=mat4create();this.params={near:.1,far:20,fov:60,aspect:1,position:[0,0,0],rotation:[0,0,0],clipMode:0};this.name=name||"camera";this._dirty=true;}var _proto=Camera.prototype;_proto.setParams=function setParams(params){var _this=this;forEach$1(params,(function(val,key){if(val||val===0){_this.params[key]=val;}}));this._dirty=true;};_proto.updateMatrix=function updateMatrix(){if(this._dirty){var params=this.params;mat4perspective(this.projection,params.fov,params.aspect,params.near,params.far,params.clipMode===1);mat4fromRotationTranslationScale(this._invView,this.quat,params.position||tmpPos,tmpScale);mat4invert(this.view,this._invView);mat4multiply(this.viewProjection,this.projection,this.view);this._invVP=this._invProjection=null;this._dirty=false;}};_proto.projectVec3=function projectVec3(out,point,vpMat){return vec3MulMat4(out,point,vpMat||this.viewProjection)};_proto.getModelView=function getModelView(out,model){return mat4multiply(out,this.view,model)};_proto.getModelViewProjection=function getModelViewProjection(out,model){return mat4multiply(out,this.viewProjection,model)};_createClass(Camera,[{key:"inverseProjection",get:function get(){if(!this._invProjection){this._invProjection=mat4invert(mat4create(),this.projection);}return this._invProjection}},{key:"inverseViewProjection",get:function get(){if(!this._invVP){this._invVP=mat4invert(mat4create(),this.viewProjection);}return this._invVP}},{key:"inverseView",get:function get(){return this._invView}},{key:"quat",get:function get(){var params=this.params;var quat=params.quat;if(!quat){quat=params.rotation?quatFromRotation(tmpQuat,params.rotation[0],params.rotation[1],params.rotation[2]):[0,0,0,1];}return quat}}]);return Camera}();var tmp=[0,0,0];function setRayFromCamera(x,y,camera){var origin=camera.params.position,direction=[x,y,0],dir=[0,0,0];vec3MulMat4(dir,direction,camera.inverseViewProjection);vecMinus(dir,dir,origin);return {center:origin,direction:vecNormalize([],dir)}}function intersectRaySphere(out,origin,direction,center,radius){vecMinus(tmp,center,origin);var len=vecDot(direction,tmp);if(len<0){return null}vecMulScalar(tmp,direction,len);vecAdd(tmp,origin,tmp);var dSq=vecSquareDistance(center,tmp);var rSq=radius*radius;if(dSq>rSq){return null}vecMulScalar(out,direction,len-Math.sqrt(rSq-dSq));return vecAdd(out,out,origin)}function intersectRayBox(out,origin,direction,center,size){var dx=direction[0],dy=direction[1],dz=direction[2];var ox=origin[0],oy=origin[1],oz=origin[2];var bxmin=center[0]-size[0]/2,bxmax=center[0]+size[0]/2,bymin=center[1]-size[1]/2,bymax=center[1]+size[1]/2,bzmin=center[2]-size[2]/2,bzmax=center[2]+size[2]/2;var tmin,tmax,tymin,tymax,tzmin,tzmax;var invdirx=1/dx,invdiry=1/dy,invdirz=1/dz;if(invdirx>=0){tmin=(bxmin-ox)*invdirx;tmax=(bxmax-ox)*invdirx;}else {tmin=(bxmax-ox)*invdirx;tmax=(bxmin-ox)*invdirx;}if(invdiry>=0){tymin=(bymin-oy)*invdiry;tymax=(bymax-oy)*invdiry;}else {tymin=(bymax-oy)*invdiry;tymax=(bymin-oy)*invdiry;}if(tmin>tymax||tymin>tmax){return null}if(tymin>tmin||tmin!==tmin){tmin=tymin;}if(tymax<tmax||tmax!==tmax){tmax=tymax;}if(tymin>tmin||tmin!==tmin){tmin=tymin;}if(tymax<tmax||tmax!==tmax){tmax=tymax;}if(invdirz>=0){tzmin=(bzmin-oz)*invdirz;tzmax=(bzmax-oz)*invdirz;}else {tzmin=(bzmax-oz)*invdirz;tzmax=(bzmin-oz)*invdirz;}if(tmin>tzmax||tzmin>tmax){return null}if(tzmin>tmin||tmin!==tmin){tmin=tzmin;}if(tzmax<tmax||tmax!==tmax){tmax=tzmax;}if(tmax<0){return null}tmin>=0?vecMulScalar(out,origin,tmin):vecMulScalar(out,origin,tmax);return vecAdd(out,out,origin)}var edge1=[0,0,0],edge2=[0,0,0],normal=[0,0,0],diff=[0,0,0];function trianglesFromRect(position,halfWidth,halfHeight){var x=position[0],y=position[1],z=position[2];var p0=[x-halfWidth,y+halfHeight,z];var p1=[x-halfWidth,y-halfHeight,z];var p2=[x+halfWidth,y-halfHeight,z];var p3=[x+halfWidth,y+halfHeight,z];return [[p0,p1,p2],[p0.slice(),p2.slice(),p3]]}function intersectRayTriangle(out,origin,direction,triangle,backfaceCulling){var sign,DdN,DdQxE2,DdE1xQ,QdN;var temp=direction;vecMinus(edge1,triangle[1],triangle[0]);vecMinus(edge2,triangle[2],triangle[0]);vecMinus(diff,origin,triangle[0]);vec3Cross(normal,edge1,edge2);DdN=vecDot(temp,normal);if(DdN>0){if(backfaceCulling){return null}sign=1;}else if(DdN<0){sign=-1;DdN=-DdN;}else {return null}vec3Cross(edge2,diff,edge2);temp=direction;DdQxE2=vecDot(temp,edge2);DdQxE2=sign*DdQxE2;if(DdQxE2<0){return null}vec3Cross(edge1,edge1,diff);temp=direction;DdE1xQ=vecDot(temp,edge1);DdE1xQ=sign*DdE1xQ;if(DdE1xQ<0){return null}if(DdQxE2+DdE1xQ>DdN){return null}QdN=vecDot(diff,normal);QdN=-sign*QdN;if(QdN<0){return null}vecMulScalar(out,direction,QdN/DdN);return vecAdd(out,out,origin)}var e0=[0,0],e1=[0,0],e2=[0,0];function dotInTriangle(out,dot,triangle){var p0=triangle[0],p1=triangle[1],p2=triangle[2];var a=[p0[0],p0[1]],b=[p1[0],p1[1]],c=[p2[0],p2[1]];vecMinus(e0,c,a);vecMinus(e1,b,a);vecMinus(e2,dot,a);var dot00=vecDot(e0,e0);var dot01=vecDot(e0,e1);var dot02=vecDot(e0,e2);var dot11=vecDot(e1,e1);var dot12=vecDot(e1,e2);var denom=dot00*dot11-dot01*dot01;if(denom===0){out=false;return out}var invDenom=1/denom;var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;out=1-u-v>=0&&v>=0&&1-u<=1;return out}var idSeed=1;var Composition=function(){function Composition(props,player){this._forwarding=false;this.renderer=props.renderer;this.renderOrder=props.baseRenderOrder||0;this.id=idSeed++;this.speed=props.speed||1;this.pluginSystem=props.pluginSystem;this._texInfo=props.imageUsage||{};this.textures=props.textures;this.keepCompiled=props.keepCompiled||props.keepResource;this.event=props.event;this.env=props.env;this.loaderData={};this.willReverseTime=props.willReverseTime;var vfxItem=new CompVFXItem(props.content,this);this.rootTransform=vfxItem.transform=props.rootTransform||new Transform;this.keepResource=props.keepResource;if(isFunc$1(props.pausePlayer)){this.pausePlayer=props.pausePlayer;}this.onMessageItem=props.onMessageItem||noop;this.autoRefTex=!props.keepResource&&props.imageUsage&&vfxItem.endBehavior!==5;this._content=vfxItem;this.name=this._content.name;this.player=player;var func=props.onEnd;if(isFunc$1(func)){var self=this;this.onEnd=function(){setTimeout((function(){func(self);}),0);};}this.keepColorBuffer=props.keepColorBuffer;this._camera=new Camera(this.name);this.camera=props.camera;this.pluginSystem.initializeComposition(this,props.scene);this._reset();this._precompile();this.renderLevel=props.renderLevel;this.rootTransform.name=this.name;this._postLoaders=[];this.lastVideoUpdateTime=0;}var _proto=Composition.prototype;_proto.setEditorTransform=function setEditorTransform(scale,dx,dy){this.renderFrame.editorTransform=[scale,scale,dx,dy];};_proto._reset=function _reset(){var _this=this;var renderFrame=this.renderFrame;var editorTransform;if(renderFrame){editorTransform=renderFrame.editorTransform;this._rendererOptions=null;this.pluginSystem.plugins.forEach((function(p){return p.onCompositionWillReset(_this,renderFrame)}));renderFrame.destroy();}this.renderFrame=new MarsPlayerRenderFrame({camera:this._camera,renderer:this.renderer,editorTransform:editorTransform,env:this.env,keepColorBuffer:this.keepColorBuffer});this.calculateGroup=new CalculateGroup;this._content.createContent();this._content.onEnd=this.onEnd||noop;this.pluginSystem.resetComposition(this,this.renderFrame);};_proto.forwardTime=function forwardTime(currentTime){var time=Math.round(currentTime*1e3);if(time){var reverse=time<0;var t=Math.abs(time);var step=15;this._forwarding=true;for(var ss=reverse?-step:step;t>step;t-=step){if(t<0){this._forwarding=false;}this.tick(ss);}this._forwarding=false;if(t>0){var _ss=reverse?-t:t;this.tick(_ss);}}};_proto._precompile=function _precompile(){var _this2=this;var items=this.items;var shaderLib=this.renderer.shaderLibrary;this.pluginSystem.plugins.forEach((function(l){return l.onCompositionPrecompile(_this2,shaderLib)}));for(var i=0;i<items.length;i++){var _item=items[i];_item.precompile(shaderLib);}};_proto.restart=function restart(){if(this._content){this._content.reset();}this._prepareRender();this._reset();this._content.start();this.forwardTime(this.startTime);this._content.onUpdate(0);this.calculateGroup._onUpdate(0);};_proto.start=function start(){this._startContent();};_proto._startContent=function _startContent(){this._content.start();};_proto._prepareRender=function _prepareRender(){var frame=this.renderFrame;var loaders=this.pluginSystem.plugins;var post=this._postLoaders;post.length=0;for(var i=0;i<loaders.length;i++){var loader=loaders[i];if(loader.prepareRenderFrame(this,frame)){post.push(loader);}}for(var _i2=0;_i2<post.length;_i2++){var _loader=post[_i2];_loader.postProcessFrame(this,frame);}};_proto.tick=function tick(time){if(this.renderer){var content=this._content;if(this.shouldRestart){this.restart();}var t=content.getUpdateTime(time*this.speed);var textures=this.textures||[];var now=Date.now();if(now-this.lastVideoUpdateTime>33){textures.forEach((function(tex){return tex&&tex.uploadCurrentVideoFrame()}));this.lastVideoUpdateTime=now;}this.calculateGroup._onUpdate(t);content.onUpdate(t);this._camera.updateMatrix();if(this.shouldDestroy){this.destroy();}else {this._prepareRender();}}};_proto.getParticleOptions=function getParticleOptions(){if(!this._rendererOptions){this._rendererOptions={renderer:this.renderer,emptyTexture:this.renderFrame.emptyTexture,cachePrefix:"-",env:this.env,composition:this};}return this._rendererOptions};_proto.getItemByName=function getItemByName(name,type){var items=this._content&&this._content._items;if(items){return items.find((function(item){return item.name===name&&(!type||type===item.type)}))}};_proto.hitTest=function hitTest(x,y,force,opt){return this._hitTest(x,y,force,opt).regions};_proto._hitTest=function _hitTest(x,y,force,opt){var renderer=this.renderer;var hitPositions=[];var ret=[];var ts=this.renderFrame.editorTransform;var ray=setRayFromCamera((x-ts[2])/ts[0],(y-ts[3])/ts[1],this._camera);var stop=(opt==null?void 0:opt.stop)||noop;var skip=(opt==null?void 0:opt.skip)||noop;if(renderer){var items=this.items;var maxCount=(opt==null?void 0:opt.maxCount)||items.length;for(var i=0;i<items.length&&ret.length<maxCount;i++){var _item2=items[i];if(_item2.lifetime>=0&&_item2.lifetime<=1&&!skip(_item2)){var hitParams=_item2.getHitTestParams(force);if(hitParams){var success=false;var intersectPoint=[];if(hitParams.type===HitTestType.triangle){var triangles=hitParams.triangles,backfaceCulling=hitParams.backfaceCulling;for(var j=0;j<triangles.length;j++){var triangle=triangles[j];intersectRayTriangle(intersectPoint,ray.center,ray.direction,triangle,backfaceCulling);if(intersectPoint.length){success=true;hitPositions.push(intersectPoint);break}}}else if(hitParams.type===HitTestType.box){var center=hitParams.center,size=hitParams.size;intersectRayBox(intersectPoint,ray.center,ray.direction,center,size);if(intersectPoint.length){success=true;hitPositions.push(intersectPoint);}}else if(hitParams.type===HitTestType.sphere){var _center=hitParams.center,radius=hitParams.radius;intersectRaySphere(intersectPoint,ray.center,ray.direction,_center,radius);if(intersectPoint.length){success=true;hitPositions.push(intersectPoint);}}else if(hitParams.type===HitTestType.custom){var tempPosition=hitParams.collect(ray,[x,y]);if(tempPosition&&tempPosition.length>0){hitPositions.push.apply(hitPositions,tempPosition);success=true;}}if(success){var _region={id:_item2.id,name:_item2.name,position:hitPositions[hitPositions.length-1],parentId:_item2.parentId,hitPositions:hitPositions,behavior:hitParams.behavior};ret.push(_region);if(stop(_region)){return {regions:ret,ray:ray}}}}}}}return {regions:ret,ray:ray}};_proto.addInteractiveItem=function addInteractiveItem(item,cfg){if(cfg.type===InteractType.MESSAGE){this.onMessageItem({name:item.name,phrase:2,id:item.id,compositionId:this.id});return item.id}};_proto.removeInteractiveItem=function removeInteractiveItem(item,type){if(type===InteractType.MESSAGE){this.onMessageItem({name:item.name,phrase:1,id:item.id,compositionId:this.id});}};_proto.pausePlayer=function pausePlayer(vfxItem){};_proto.destroyTextures=function destroyTextures(textures){for(var i=0;i<textures.length;i++){var texture=textures[i];if(texture){if(texture.sourceType===TextureSourceType.data){if(texture!==this._rendererOptions.emptyTexture&&texture!==this.renderFrame.transparentTexture&&!this._texInfo[texture.id]){texture.destroy();}continue}if(this.autoRefTex){var c=--this._texInfo[texture.id];if(!c){if(isNaN(c)&&false){consoleError$1("Texture "+texture.id+" not found usage.");}texture.destroy();}}}}};_proto.updatePluginLoaders=function updatePluginLoaders(dt){var _this3=this;this.pluginSystem.plugins.forEach((function(loader){return loader.onCompositionUpdate(_this3,dt)}));};_proto.itemLifetimeEvent=function itemLifetimeEvent(item,start){var _this4=this;var func=start?function(p){return p.onCompositionItemLifeBegin(_this4,item)}:function(p){return p.onCompositionItemLifeEnd(_this4,item)};this.pluginSystem.plugins.forEach(func);};_proto.destroyItem=function destroyItem(item){var _this5=this;if(this._content.removeItem(item)){this.pluginSystem.plugins.forEach((function(loader){return loader.onCompositionItemRemoved(_this5,item)}));}};_proto.offloadTexture=function offloadTexture(){if(!this._textureOffloaded){this._textureOffloaded=true;this.textures.forEach((function(tex){return tex&&tex.offloadData()}));}};_proto.reloadTextureAsync=function reloadTextureAsync(){var _this6=this;if(this._textureOffloaded){var pendings=[];this.textures.forEach((function(tex){if(tex){pendings.push(tex.reloadDataAsync());}}));return Promise.all(pendings).then((function(){return _this6._textureOffloaded=false}))}return Promise.resolve()};_proto.destroy=function destroy(){var renderer=this.renderer;if(renderer){var textures=this.textures;if(textures){if(this.keepResource){textures.forEach(hookDestroy);}else {textures.forEach((function(tex){return tex&&tex.destroy()}));}}this._content.destroy();this.textures=[];this.player=undefined;if(!this.keepCompiled);if(this._rendererOptions){this._rendererOptions.emptyTexture.destroy();}if(this.pluginSystem){this.pluginSystem.destroyComposition(this);}this.tick=error;this.pausePlayer=noop;this.event=this.renderer=null;this.destroy=noop;if(textures&&this.keepResource){textures.forEach((function(tex){return tex&&(tex.destroy=tex[destroySym])}));}}};_createClass(Composition,[{key:"forwarding",get:function get(){return this._forwarding}},{key:"camera",get:function get(){return this._camera.params},set:function set(camera){var p=deepClone(camera);if(!p.aspect){p.aspect=this.renderer.width/this.renderer.height;}this._camera.setParams(p);}},{key:"duration",get:function get(){var _this$_content;return ((_this$_content=this._content)==null?void 0:_this$_content.duration)||0}},{key:"items",get:function get(){return this._content._items}},{key:"time",get:function get(){return this._content._timeInms/1e3}},{key:"startTime",get:function get(){return this._content.startTime||0}},{key:"shouldRestart",get:function get(){var content=this._content;return content.ended&&content.endBehavior===5}},{key:"shouldDestroy",get:function get(){var content=this._content;return content.ended&&(!content.endBehavior||content.endBehavior===3)}}]);return Composition}();var destroySym=Symbol("destroy");function hookDestroy(obj){if(obj&&obj.destroy){obj[destroySym]=obj.destroy;obj.destroy=noop;}}function error(){consoleError$1("Update disposed composition: "+this.name+".");}var Tree=function(){function Tree(props,rootTransform){this.transform=rootTransform;this.build(props);}var _proto=Tree.prototype;_proto.getNodeById=function getNodeById(indexOrInd){var cache=this.cacheMap;if(!cache[indexOrInd]){var index="^"+indexOrInd;cache[indexOrInd]=this._allNodes.find((function(node){return node.id===index}));}return cache[indexOrInd]};_proto.getNodeTransform=function getNodeTransform(indexOrInd){var node=this.getNodeById(indexOrInd);return node?node.transform:this.transform};_proto.build=function build(props){var _this=this;var topTransform=this.transform;var nodes=props.nodes.map((function(node,i){return {name:node.name||node.id||i+"",transform:new Transform(node.transform,topTransform),id:"^"+(node.id||i),children:[],tree:_this}}));this.cacheMap={};nodes.forEach((function(node,i){var children=props.nodes[i].children;node.transform.name=node.name;if(children){children.forEach((function(index){var child=nodes[index];if(child&&child!==node){if(child.transform.parentTransform!==topTransform){consoleError$1("Node parent has been set.");}child.transform.parentTransform=node.transform;node.children.push(child);}}));}}));this._allNodes=nodes;this._nodes=props.children.map((function(i){return nodes[i]}));return this};_createClass(Tree,[{key:"nodes",get:function get(){return this._nodes}}]);return Tree}();var TreeVFXItem=function(_VFXItem){_inheritsLoose(TreeVFXItem,_VFXItem);function TreeVFXItem(){return _VFXItem.apply(this,arguments)||this}var _proto=TreeVFXItem.prototype;_proto.onConstructed=function onConstructed(options){this.options=options.content.options;this.onUpdateByLoader=this._onUpdate;this._onUpdate=noop;};_proto._createContent=function _createContent(arg){return new Tree(this.options.tree,this.transform)};_proto.onItemUpdate=function onItemUpdate(dt,lifetime){};_createClass(TreeVFXItem,[{key:"type",get:function get(){return "tree"}}]);return TreeVFXItem}(VFXItem);function isiOS(){{return !!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)}}function getPixelRatio(){{if(typeof screen==="object"&&typeof document==="object"){var viewportWidth=Math.max(document.documentElement.clientWidth,window.innerWidth||0);var screenWidth=screen.width;var viewportScale=screenWidth/viewportWidth;return Math.min(2*viewportScale,2)}}return 1}function isSimulatorCellPhone(){{return /\b[Aa]ndroid\b/.test(navigator.userAgent)||/\b(iPad|iPhone|iPod)\b/.test(navigator.userAgent)}}function isMac(){return "MacIntel"===navigator.platform}function isAndroid(){{return /\b[Aa]ndroid\b/.test(navigator.userAgent)}}var filterFuncMap={};var helpLink$1="https://yuque.antfin.com/huoxing/knaszl/qtnsf2g9ofigggor#n4Y1K";function registerFilter(name,func){if(name in filterFuncMap){consoleError$1("Filter "+name+" registered twice.");}filterFuncMap[name]=func;}function registerFilters(filters){forEach$1(filters,(function(func,name){registerFilter(name,func);}));}function createFilter(filter,composition){var func=filterFuncMap[filter.name];if(!func){throw Error("Filter "+filter.name+" not imported, see "+helpLink$1)}var ret=func(composition,filter);if(!ret.passSplitOptions){ret.passSplitOptions={attachments:[{texture:{format:constants.RGBA}}]};}return ret}var TextMetrics=function(){function TextMetrics(){}TextMetrics.measureFont=function measureFont(font){if(TextMetrics._fonts[font]){return TextMetrics._fonts[font]}var properties={ascent:0,descent:0,fontSize:0};var canvas=TextMetrics._canvas;var context=canvas.getContext("2d",{willReadFrequently:true});context.font=font;var metricsString=TextMetrics.METRICS_STRING+TextMetrics.BASELINE_SYMBOL;var width=Math.ceil(context.measureText(metricsString).width);var baseline=Math.ceil(context.measureText(TextMetrics.BASELINE_SYMBOL).width);var height=Math.ceil(TextMetrics.HEIGHT_MULTIPLIER*baseline);baseline=baseline*TextMetrics.BASELINE_MULTIPLIER|0;canvas.width=width;canvas.height=height;context.fillStyle="#f00";context.fillRect(0,0,width,height);context.font=font;context.textBaseline="alphabetic";context.fillStyle="#000";context.fillText(metricsString,0,baseline);var imagedata=context.getImageData(0,0,width,height).data;var pixels=imagedata.length;var line=width*4;var i=0;var idx=0;var stop=false;for(i=0;i<baseline;++i){for(var j=0;j<line;j+=4){if(imagedata[idx+j]!==255){stop=true;break}}if(!stop){idx+=line;}else {break}}properties.ascent=baseline-i;idx=pixels-line;stop=false;for(i=height;i>baseline;--i){for(var _j2=0;_j2<line;_j2+=4){if(imagedata[idx+_j2]!==255){stop=true;break}}if(!stop){idx-=line;}else {break}}properties.descent=i-baseline;properties.fontSize=properties.ascent+properties.descent;TextMetrics._fonts[font]=properties;return properties};_createClass(TextMetrics,null,[{key:"_canvas",get:function get(){var canvas;if(getConfig(TEMPLATE_USE_OFFSCREEN_CANVAS)){canvas=window._createOffscreenCanvas(10,10);TextMetrics.__canvas=canvas;}else if(!TextMetrics.__canvas){canvas=document.createElement("canvas");canvas.width=canvas.height=10;TextMetrics.__canvas=canvas;}return TextMetrics.__canvas}}]);return TextMetrics}();TextMetrics._fonts={};TextMetrics.METRICS_STRING="|ÉqÅ";TextMetrics.BASELINE_SYMBOL="M";TextMetrics.BASELINE_MULTIPLIER=1.4;TextMetrics.HEIGHT_MULTIPLIER=2;var genericFontFamilies=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];var QTextWrapMode;(function(QTextWrapMode){QTextWrapMode[QTextWrapMode["Default"]=0]="Default";QTextWrapMode[QTextWrapMode["Clip"]=1]="Clip";QTextWrapMode[QTextWrapMode["Ellipsis"]=2]="Ellipsis";})(QTextWrapMode||(QTextWrapMode={}));var QText=function(){function QText(text,options){var _options$left,_options$top,_options$letterSpacin,_options$color,_options$fontFamily,_options$fontSize,_options$wrap,_options$fontStyle,_options$angle;this.left=0;this.top=0;this.fontSize=48;this.fontFamily="Arial";this.color="black";this.letterSpacing=0;this.maxLineWidth=0;this.wrap=QTextWrapMode.Clip;this.scaleX=1;this.scaleY=1;this.angle=0;this.active=true;this.padding=0;this.borderColor="#ffffffff";this.borderWidth=1;this.fontProperties={ascent:0,descent:0,fontSize:0};this.fontVariant="normal";this.originX="left";this.originY="top";this.ellipsis="…";this.text=text;this.left=(_options$left=options.left)!=null?_options$left:0;this.top=(_options$top=options.top)!=null?_options$top:0;this.maxLineWidth=options.maxWidth;this.letterSpacing=(_options$letterSpacin=options.letterSpacing)!=null?_options$letterSpacin:0;this.originX="left";this.originY="top";this.color=(_options$color=options.color)!=null?_options$color:"black";this.fontFamily=(_options$fontFamily=options.fontFamily)!=null?_options$fontFamily:"Arial";this.fontSize=(_options$fontSize=options.fontSize)!=null?_options$fontSize:48;this.wrap=(_options$wrap=options.wrap)!=null?_options$wrap:QTextWrapMode.Clip;this.fontStyle=(_options$fontStyle=options.fontStyle)!=null?_options$fontStyle:"normal";this.textAlign="left";this.textBaseline="alphabetic";this.fontWeight="normal";this.angle=(_options$angle=options.angle)!=null?_options$angle:0;this.name=options.name||"";}var _proto=QText.prototype;_proto.update=function update(){this.updateDimension();};_proto.render=function render(){if(this.viewer===undefined){return}var ctx=this.viewer.renderContext;if(ctx===undefined){return}ctx.save();this.setRenderTransform(ctx);this.renderText(ctx);if(this.active){this.drawBorders(ctx);}ctx.restore();};_proto.init=function init(viewer){this.viewer=viewer;this.updateDimension();};_proto.getLayout=function getLayout(){var scaleX=this.viewer.scaleX;var scaleY=this.viewer.scaleY;return {x:this.left*scaleX,y:this.top*scaleY,width:this.width*scaleX,height:this.height*scaleY}};_proto.updateDimension=function updateDimension(){var viewer=this.viewer;var ctx=viewer.renderContext;this.configTextStyle(ctx);this.configTextLayout(ctx);var font=this.getFontDesc();this.fontProperties=TextMetrics.measureFont(font);if(this.fontProperties.fontSize===0){this.fontProperties.fontSize=this.fontSize;this.fontProperties.ascent=this.fontSize;}var qChars=this.createCharsFromText(ctx,this.text);var textWithLetterSpaceWidth=0;if(qChars.length>0){var lastChar=qChars[qChars.length-1];textWithLetterSpaceWidth=lastChar.left+lastChar.width;}this.chars=qChars;this.maxLineWidth=textWithLetterSpaceWidth;if(this.height===undefined){this.height=this.fontProperties.fontSize;}if(this.width===undefined){this.width=this.maxLineWidth;}};_proto.configTextStyle=function configTextStyle(ctx){ctx.font=this.getFontDesc();ctx.fillStyle=this.color;};_proto.getFontDesc=function getFontDesc(){var fontSizeString=typeof this.fontSize==="number"?this.fontSize+"px":this.fontSize;var fontFamilies=this.fontFamily.split(",");for(var i=fontFamilies.length-1;i>=0;i--){var fontFamily=fontFamilies[i].trim();if(!/([\"\'])[^\'\"]+\1/.test(fontFamily)&&!genericFontFamilies.includes(fontFamily)){fontFamily='"'+fontFamily+'"';}fontFamilies[i]=fontFamily;}fontFamilies.push("Arial, Helvetica, sans-serif");return this.fontStyle+" "+this.fontVariant+" "+this.fontWeight+" "+fontSizeString+" "+fontFamilies.join(",")};_proto.configTextLayout=function configTextLayout(ctx){ctx.textBaseline=this.textBaseline;ctx.textAlign=this.textAlign;};_proto.setRenderTransform=function setRenderTransform(ctx){ctx.scale(this.scaleX,this.scaleY);ctx.translate(this.left,this.top);};_proto.renderText=function renderText(ctx){var x=0;var y=0;this.drawCharsInTextBox(ctx,{min:[x,y],max:[x+this.width,y+this.height]});};_proto.drawCharsInTextBox=function drawCharsInTextBox(ctx,textBox){var qChars=this.chars;var textWithLetterSpaceWidth=0;if(qChars.length>0){var lastChar=qChars[qChars.length-1];textWithLetterSpaceWidth=lastChar.left+lastChar.width;}var textBoxWidth=textBox.max[0]-textBox.min[0];var charOffset=0;if("left"===this.textAlign){charOffset=0;}else if("center"===this.textAlign){charOffset=.5*(textBoxWidth-textWithLetterSpaceWidth);}else if("right"===this.textAlign){charOffset=textBoxWidth-textWithLetterSpaceWidth;}this.addOffsetToChars(qChars,charOffset);var charsInTextBox=this.cloneChars(this.clipCharsWithTextBox(qChars,textBox));var needDrawChars=charsInTextBox;if(this.wrap===QTextWrapMode.Ellipsis){needDrawChars=this.replaceCharWithEllipsis(ctx,charsInTextBox,textBox);if(needDrawChars.length===0&&qChars.length!==0){this.addEllipsisToChars(ctx,needDrawChars,textBox);}}this.drawCharsFromLeft(ctx,needDrawChars);};_proto.addEllipsisToChars=function addEllipsisToChars(ctx,needDrawChars,textBox){var ellipsisWidth=ctx.measureText(this.ellipsis).width;if(this.textAlign==="left"){var _this$height;needDrawChars.push({char:this.ellipsis,left:textBox.min[0],top:0,width:ellipsisWidth,heigh:(_this$height=this.height)!=null?_this$height:0,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:true,scale:1,index:0});}else if(this.textAlign==="right"){var _this$height2;needDrawChars.push({char:this.ellipsis,left:textBox.max[0]-ellipsisWidth,top:0,width:ellipsisWidth,heigh:(_this$height2=this.height)!=null?_this$height2:0,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:true,scale:1,index:0});}else {var _this$height3;var _x=(textBox.max[0]+textBox.min[0])*.5;needDrawChars.push({char:this.ellipsis,left:_x-ellipsisWidth*.5,top:0,width:ellipsisWidth,heigh:(_this$height3=this.height)!=null?_this$height3:0,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:true,scale:1,index:0});}};_proto.createCharsFromText=function createCharsFromText(ctx,text){var chars=text.split("");var x=0;var y=0;if(this.textBaseline==="top"){y=0;}else if(this.textBaseline==="middle"){y+=this.fontProperties.ascent*.5;}else if(this.textBaseline==="alphabetic"){y+=this.fontProperties.ascent;}var qChars=[];for(var i=0;i<chars.length;++i){var char=chars[i];var charWidth=ctx.measureText(char).width;var charHeight=this.fontSize;var qChar={left:x,top:y,width:charWidth,heigh:charHeight,char:char,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:false,scale:1,index:i};qChars.push(qChar);x+=charWidth+this.letterSpacing;}return qChars};_proto.addOffsetToChars=function addOffsetToChars(chars,offset){chars.forEach((function(qChar){qChar.left+=offset;}));return chars};_proto.clipCharsWithTextBox=function clipCharsWithTextBox(chars,textBox){var charsInTextBox=[];var error=.5;for(var i=0;i<chars.length;++i){var qChar=chars[i];if(qChar.left>=textBox.min[0]&&qChar.left+qChar.width<textBox.max[0]+error){charsInTextBox.push(qChar);}}return charsInTextBox};_proto.cloneChars=function cloneChars(chars){return chars.map((function(qChar){return Object.assign({},qChar)}))};_proto.replaceCharWithEllipsis=function replaceCharWithEllipsis(ctx,qCharsInTextBox,textBox){var ellipsisWidth=ctx.measureText(this.ellipsis).width;if(qCharsInTextBox.length>0){if(qCharsInTextBox[0].index!==0){var ellipsisChar=Object.assign({},qCharsInTextBox[0]);ellipsisChar.char=this.ellipsis;ellipsisChar.isEllipsis=true;ellipsisChar.width=ellipsisWidth;qCharsInTextBox=this.findEllipsisPositionAndReplaceCharsFromLeft(qCharsInTextBox,ellipsisChar,textBox);}var qCharsInTextBoxLastIndex=qCharsInTextBox.length-1;var qCharsLength=this.chars.length;if(qCharsInTextBox[qCharsInTextBoxLastIndex].index!==qCharsLength-1){var _ellipsisChar=Object.assign({},qCharsInTextBox[0]);_ellipsisChar.char=this.ellipsis;_ellipsisChar.isEllipsis=true;_ellipsisChar.width=ellipsisWidth;qCharsInTextBox=this.findEllipsisPositionAndReplaceCharsFromRight(qCharsInTextBox,_ellipsisChar,textBox);}}return qCharsInTextBox};_proto.findEllipsisPositionAndReplaceCharsFromLeft=function findEllipsisPositionAndReplaceCharsFromLeft(qCharsInTextBox,ellipsis,textBox){var replaceIndex=0;for(var i=0;i<qCharsInTextBox.length;++i){var qChar=qCharsInTextBox[i];var qCharRight=qChar.left+qChar.width;replaceIndex=i;if(qCharRight-ellipsis.width>=textBox.min[0]){break}}var replacedChar=qCharsInTextBox[replaceIndex];ellipsis.left=replacedChar.left+replacedChar.width-ellipsis.width;for(var _i2=0;_i2<replaceIndex+1;++_i2){qCharsInTextBox.shift();}return [ellipsis].concat(qCharsInTextBox)};_proto.findEllipsisPositionAndReplaceCharsFromRight=function findEllipsisPositionAndReplaceCharsFromRight(qCharsInTextBox,ellipsis,textBox){var replaceIndex=qCharsInTextBox.length-1;for(var i=replaceIndex;i>=0;--i){var qChar=qCharsInTextBox[i];var ellipsisCharRight=qChar.left+ellipsis.width;replaceIndex=i;if(ellipsisCharRight<=textBox.max[0]){break}}ellipsis.left=qCharsInTextBox[replaceIndex].left;var qCharsLength=qCharsInTextBox.length;for(var _i4=qCharsLength-1;_i4>=replaceIndex;--_i4){qCharsInTextBox.pop();}return qCharsInTextBox.concat([ellipsis])};_proto.drawCharsFromLeft=function drawCharsFromLeft(ctx,chars){var align=ctx.textAlign||"left";ctx.textAlign="left";for(var i=0;i<chars.length;++i){var qChar=chars[i];ctx.fillText(qChar.char,qChar.left,qChar.top);}ctx.textAlign=align;};_proto.drawBorders=function drawBorders(ctx){this.padding;var strokeWidth=this.borderWidth;ctx.strokeStyle=this.borderColor;ctx.lineWidth=strokeWidth;var w=this.width;var h=this.height;var x=0;var y=0;if(this.originX==="center"){x-=this.width/2;}else if(this.originX==="right"){x-=this.width;}if(this.originY==="center"){y-=this.height/2;}else if(this.originY==="bottom"){y-=this.height;}ctx.strokeRect(x+strokeWidth/2,y+strokeWidth/2,w-strokeWidth,h-strokeWidth);};return QText}();var QCanvasViewer=function(){function QCanvasViewer(canvas,width,height,scaleX,scaleY,flipY){this.textList=[];var renderCanvas;if(typeof canvas==="string"){renderCanvas=document.getElementById(canvas);}else {renderCanvas=canvas;}this.scaleX=scaleX!=null?scaleX:1;this.scaleY=scaleY!=null?scaleY:1;this.flipY=flipY!=null?flipY:false;this.width=width;this.height=height;renderCanvas.style.width=width*this.scaleX+"px";renderCanvas.style.height=height*this.scaleY+"px";var devicePixelRatio=1;this.devicePixelRatio=devicePixelRatio;renderCanvas.width=devicePixelRatio*width*this.scaleX;renderCanvas.height=devicePixelRatio*height*this.scaleY;renderCanvas.className="lower-canvas";this.renderCanvas=renderCanvas;this.renderContext=this.renderCanvas.getContext("2d");this.renderContext.scale(devicePixelRatio*this.scaleX,devicePixelRatio*this.scaleY);}var _proto=QCanvasViewer.prototype;_proto.initDimension=function initDimension(width,height,scaleX,scaleY){this.width=width;this.height=height;this.scaleX=scaleX!=null?scaleX:1;this.scaleY=scaleY!=null?scaleY:1;this.renderCanvas.style.width=width*this.scaleX+"px";this.renderCanvas.style.height=height*this.scaleY+"px";var devicePixelRatio=this.devicePixelRatio;this.renderCanvas.width=devicePixelRatio*width*this.scaleX;this.renderCanvas.height=devicePixelRatio*height*this.scaleY;if(this.flipY){this.renderContext.translate(0,this.height);this.renderContext.scale(1,-1);}this.renderContext.scale(devicePixelRatio*this.scaleX,devicePixelRatio*this.scaleY);};_proto.clearText=function clearText(){this.textList=[];};_proto.clearCanvasWithContext=function clearCanvasWithContext(ctx){ctx.clearRect(0,0,this.width,this.height);};_proto.clearCanvas=function clearCanvas(){this.clearCanvasWithContext(this.renderContext);};_proto.addObject=function addObject(text){text.init(this);this.textList.push(text);};_proto.render=function render(){this.clearCanvasWithContext(this.renderContext);this.renderContext.fillStyle="rgba(255, 255, 255, 0.0039)";this.renderContext.fillRect(0,0,this.width,this.height);var image=this.background;if(image&&image.width!==undefined&&image.height!==undefined){this.renderContext.drawImage(image,0,0,image.width,image.height,0,0,this.width,this.height);}for(var i=0;i<this.textList.length;++i){this.renderContext.save();var text=this.textList[i];text.update();text.render();this.renderContext.restore();}};return QCanvasViewer}();var DEFAULT_FONTS=["serif","sans-serif","monospace","courier"];var defaultWidth=800;var defaultHeight=600;var viewerCanvasMap=new Map;var CanvasPool=function(){function CanvasPool(){this.elements=[];}var _proto=CanvasPool.prototype;_proto.getCanvas=function getCanvas(){if(this.elements.length){return this.elements.shift()}if(getConfig(TEMPLATE_USE_OFFSCREEN_CANVAS)){return window._createOffscreenCanvas(10,10)}else {var defCanvas=document.createElement("canvas");defCanvas.getContext("2d",{willReadFrequently:true});return defCanvas}};_proto.saveCanvas=function saveCanvas(cvs){cvs.width=cvs.height=1;if(this.elements.length<3){arrAdd$1(this.elements,cvs);}};return CanvasPool}();var canvasPool=new CanvasPool;function getCanvasViewer(width,height,opt){var viewer;var scale=(opt==null?void 0:opt.templateScale)||1;var flipY=(opt==null?void 0:opt.flipY)||false;if(opt!=null&&opt.canvas){viewer=viewerCanvasMap.get(opt.canvas);if(!viewer){var newViewer=new QCanvasViewer(opt.canvas,width,height,scale,scale,flipY);viewerCanvasMap.set(opt.canvas,newViewer);viewer=newViewer;}}else {viewer=new QCanvasViewer(canvasPool.getCanvas(),defaultWidth,defaultHeight,scale,scale,flipY);}return viewer}function convert2QTextList(stringTemplateContent,variables,opt){var fonts=stringTemplateContent.fonts;var qTextList=[];stringTemplateContent.texts.forEach((function(text){var _opt$debug;var textString=text.t;var left=text.x;var top=text.y;var font={weight:400,family:"serif",size:48,style:FontStyle.normal};if(text.f!==undefined){font=fonts[text.f];}var name=text.n;if(name&&variables&&variables.hasOwnProperty(name)){textString=""+variables[name];}var qtext=new QText(textString,{left:left,top:top,fontSize:font.size,fontFamily:font.family,fontWeight:""+font.weight,fontStyle:"normal",name:name});if(text.r!==undefined){qtext.angle=text.r*Math.PI/180;}qtext.active=(_opt$debug=opt.debug)!=null?_opt$debug:false;if(text.w!==undefined){qtext.width=text.w;}if(font.letterSpace!==undefined){qtext.letterSpacing=font.letterSpace;}if(text.of===0){qtext.wrap=QTextWrapMode.Default;}else if(text.of===1){qtext.wrap=QTextWrapMode.Clip;}else if(text.of===2){qtext.wrap=QTextWrapMode.Ellipsis;}if(text.c!==undefined){var textColor=stringTemplateContent.colors[text.c][1];var alpha=1;if(textColor[3]!==undefined){alpha=textColor[3]/255;}qtext.color="rgba("+textColor[0]+", "+textColor[1]+", "+textColor[2]+", "+alpha+")";}if(text.a===TextAlignment.left){qtext.textAlign="left";}else if(text.a===TextAlignment.middle){qtext.textAlign="center";}else if(text.a===TextAlignment.right){qtext.textAlign="right";}if(font.style===0){qtext.fontStyle="normal";}else if(font.style===1){qtext.fontStyle="italic";}else if(font.style===2){qtext.fontStyle="oblique";}if(font.weight!==undefined){qtext.fontWeight=String(font.weight);}if(opt.borderColor){qtext.borderColor=opt.borderColor;}if(opt.borderWidth!==undefined){qtext.borderWidth=opt.borderWidth;}qTextList.push(qtext);}));return qTextList}function getBackgroundImage(template,variables){var _template$background;var templateBackground;if(template!=null&&(_template$background=template.background)!=null&&_template$background.name){var _template$background2;var name=template.background.name;if(variables&&variables[name]){templateBackground=variables[name];}else if((_template$background2=template.background)!=null&&_template$background2.url){templateBackground=template.background.url;}}return templateBackground}function drawImageAndTemplate(_x,_x2,_x3,_x4,_x5){return _drawImageAndTemplate.apply(this,arguments)}function _drawImageAndTemplate(){_drawImageAndTemplate=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(viewer,image,template,variables,opt){var _opt$flipY;var templateScale,scaleX,scaleY,drawImage,width,height,templateBackground,stringTemplateContent,qTextList,textLayouts;return _regeneratorRuntime().wrap((function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:if(image){_context.next=2;break}throw Error("image not provided");case 2:templateScale=(opt==null?void 0:opt.templateScale)||1;scaleX=templateScale;scaleY=templateScale;drawImage=image;width=image.width;height=image.height;if(!template){_context.next=24;break}width=template.width;height=template.height;if(image.width!==width||image.height!==height){scaleX*=image.width/template.width;scaleY*=image.height/template.height;}templateBackground=getBackgroundImage(template,variables);if(!(templateBackground&&templateBackground!==image.src)){_context.next=22;break}if(!isStr$1(templateBackground)){_context.next=20;break}_context.next=17;return loadImageAsync$1(templateBackground);case 17:_context.t0=_context.sent;_context.next=21;break;case 20:_context.t0=templateBackground;case 21:drawImage=_context.t0;case 22:stringTemplateContent=template.content;if(stringTemplateContent){qTextList=convert2QTextList(stringTemplateContent,variables,objAssign({},opt,{scaleX:scaleX,scaleY:scaleY}));qTextList.forEach((function(qText){viewer.addObject(qText);}));}case 24:viewer.flipY=(_opt$flipY=opt.flipY)!=null?_opt$flipY:false;viewer.initDimension(width,height,scaleX,scaleY);viewer.background=drawImage;viewer.render();textLayouts=opt==null?void 0:opt.textLayouts;if(textLayouts){textLayouts.length=0;viewer.textList.forEach((function(qText){var layout=qText.getLayout();var textLayout={x:layout.x,y:layout.y,width:layout.width,height:layout.height};textLayouts.push(textLayout);}));}case 30:case"end":return _context.stop()}}),_callee)})));return _drawImageAndTemplate.apply(this,arguments)}function prepareFontResources(_x6){return _prepareFontResources.apply(this,arguments)}function _prepareFontResources(){_prepareFontResources=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(template){var fontDescList,_loop,i;return _regeneratorRuntime().wrap((function _callee2$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:if(!(template.content&&template.content.fonts)){_context3.next=9;break}fontDescList=template.content.fonts;_loop=_regeneratorRuntime().mark((function _loop(){var name,url,hasFontAdd,source,fontFace;return _regeneratorRuntime().wrap((function _loop$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:name=fontDescList[i].family;url=fontDescList[i].url;hasFontAdd=false;if(DEFAULT_FONTS.includes(name)){hasFontAdd=true;}else {if(document.fonts!==undefined){document.fonts.forEach((function(fontFace){if(fontFace.family===name){hasFontAdd=true;}}));}}if(!(!hasFontAdd&&url!==undefined&&url!=="")){_context2.next=11;break}source="url("+url+")";if(!(document.fonts!==undefined)){_context2.next=11;break}fontFace=new FontFace(""+name,source);_context2.next=10;return fontFace.load();case 10:document.fonts.add(fontFace);case 11:case"end":return _context2.stop()}}),_loop)}));i=0;case 4:if(!(i<fontDescList.length)){_context3.next=9;break}return _context3.delegateYield(_loop(),"t0",6);case 6:++i;_context3.next=4;break;case 9:case"end":return _context3.stop()}}),_callee2)})));return _prepareFontResources.apply(this,arguments)}function combineImageTemplate2Async(_x7,_x8,_x9,_x10,_x11){return _combineImageTemplate2Async.apply(this,arguments)}function _combineImageTemplate2Async(){_combineImageTemplate2Async=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(url,template,variables,opt,flipY){var templateOption,viewer;return _regeneratorRuntime().wrap((function _callee4$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:templateOption=objAssign({},opt,{flipY:flipY});viewer=getCanvasViewer(defaultWidth,defaultWidth,templateOption);if(!(template!==undefined)){_context5.next=5;break}_context5.next=5;return prepareFontResources(template);case 5:viewer.clearText();if(!(typeof url==="string")){_context5.next=10;break}return _context5.abrupt("return",loadImageAsync$1(url).then(function(){var _ref=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(image){return _regeneratorRuntime().wrap((function _callee3$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:_context4.next=2;return drawImageAndTemplate(viewer,image,template,variables,templateOption);case 2:return _context4.abrupt("return",getResult(viewer.renderCanvas,opt==null?void 0:opt.toData));case 3:case"end":return _context4.stop()}}),_callee3)})));return function(_x12){return _ref.apply(this,arguments)}}()));case 10:_context5.next=12;return drawImageAndTemplate(viewer,url,template,variables,templateOption);case 12:return _context5.abrupt("return",getResult(viewer.renderCanvas,opt==null?void 0:opt.toData));case 13:case"end":return _context5.stop()}}),_callee4)})));return _combineImageTemplate2Async.apply(this,arguments)}function getResult(cvs,toData){if(toData){return new Promise((function(resolve,reject){if(cvs.toBlob){cvs.toBlob((function(blob){if(blob){resolve(loadImageAsync$1(blob));}else {reject("no blob");}}));}else {resolve(loadImageAsync$1(cvs.toDataURL()));}})).then((function(image){canvasPool.saveCanvas(cvs);return image}))}return Promise.resolve(cvs)}function combineImageTemplate1Async(url,template,variables,opt,flipY){var replacedVariables={};var pendings=[];opt=opt||{};variables=variables||{};if(template.asImage){var name=template.content.replace(/\$/g,"");var replaceURL=variables[name]||template.variables[name];var onImage=function onImage(image){var canvas=opt.canvas||document.createElement("canvas");var width=canvas.width=template.backgroundWidth;var height=canvas.height=template.backgroundHeight;var ctx=canvas.getContext("2d");ctx.clearRect(0,0,width,height);if(flipY){ctx.translate(0,height);ctx.scale(1,-1);}ctx.drawImage(image,0,0,image.width,image.height,0,0,width,height);return canvas};if(replaceURL){return loadImageAsync$1(replaceURL).then(onImage)}return loadURLAsync(url).then(onImage)}var imageScale=opt.templateScale||1;forEach$1(template.variables,(function(val,name){if(variables.hasOwnProperty(name)){val=variables[name];}if(/^image_/.test(name)){var isArr=val instanceof Array;var first=isArr?val[0]:val;pendings.push(requestImageBase64Async(first,isArr&&val[1]).then((function(dataURL){return replacedVariables[name]=dataURL})));}else {replacedVariables[name]=val;}}));return Promise.all(pendings).then((function(){return loadImageAsync$1(url).then((function(bg){var content=template.content.replace(/\$([\w_]+)\$/g,(function(str,name){return replacedVariables[name]})).replace('width="'+template.width+'px"','width="'+template.width*imageScale+'px"').replace('height="'+template.height+'px"','height="'+template.height*imageScale+'px"');return loadImageAsync$1("data:image/svg+xml,"+encodeURIComponent(content),true).then((function(fg){var canvas=opt.canvas||document.createElement("canvas");canvas.width=bg.width*imageScale;canvas.height=bg.height*imageScale;return new Promise((function(resolve){setTimeout((function(){var ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);if(flipY){ctx.translate(0,canvas.height);ctx.scale(1,-1);}ctx.drawImage(bg,0,0,bg.width,bg.height,0,0,canvas.width,canvas.height);ctx.drawImage(fg,0,0,fg.width,fg.height,(template.x||0)*imageScale,(template.y||0)*imageScale,template.width*imageScale/template.backgroundWidth*bg.width,template.height*imageScale/template.backgroundHeight*bg.height);resolve(canvas);}),0);}))}))}))}));function loadURLAsync(url){return isStr$1(url)?loadImageAsync$1(url):Promise.resolve(url)}}function requestImageBase64Async(first,alt){return req(first,(function(ex){return alt?req(alt,(function(){return first})):first}));function req(val,onError){if(/^(https?:)?\/\//.test(val)){return requestAsync$1(val,{responseType:"blob"}).then(blobToBase64,onError)}return Promise.resolve(val)}}function blobToBase64(blob){return new Promise((function(resolve,reject){var reader=new FileReader;reader.readAsDataURL(blob);reader.onload=function(){resolve(reader.result);};reader.onerror=reject;}))}var webpFailed=false;function loadWebpOptional(_x,_x2){return _loadWebpOptional.apply(this,arguments)}function _loadWebpOptional(){_loadWebpOptional=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(png,webp){var image,url;return _regeneratorRuntime().wrap((function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.prev=0;if(!(webpFailed||!webp)){_context.next=8;break}_context.next=4;return loadImageAsync$1(png);case 4:image=_context.sent;url=png;_context.next=12;break;case 8:_context.next=10;return loadImageAsync$1(webp);case 10:image=_context.sent;url=webp;case 12:_context.next=21;break;case 14:_context.prev=14;_context.t0=_context["catch"](0);webpFailed=true;_context.next=19;return loadImageAsync$1(png);case 19:image=_context.sent;url=png;case 21:return _context.abrupt("return",{image:image,url:url});case 22:case"end":return _context.stop()}}),_callee,null,[[0,14]])})));return _loadWebpOptional.apply(this,arguments)}function deserializeMipmapTextureAsync(tex,bins,files){return new Promise((function(resolve,reject){try{if(tex.target===34067){resolve(Promise.all(tex.mipmaps.map((function(mipmap){return Promise.all(mipmap.map((function(p){return loadMipmapImageAsync(p,bins)})))}))).then((function(mipmaps){var bin=files[tex.mipmaps[0][0][1][0]].url;var ret=objAssign({keepImageSource:false},tex,{mipmaps:mipmaps,sourceFrom:{target:tex.target,bin:bin,type:TextureSourceType.mipmaps,mipmaps:tex.mipmaps.map((function(mipmap){return mipmap.map((function(pointer){return [pointer[1][1],pointer[1][2]]}))}))}});return ret})));}else {resolve(Promise.all(tex.mipmaps.map((function(p){return loadMipmapImageAsync(p,bins)}))).then((function(mipmaps){var bin=files[tex.mipmaps[0][1][0]].url;var ret=objAssign({keepImageSource:false},tex,{mipmaps:mipmaps,sourceType:TextureSourceType.mipmaps,sourceFrom:{target:tex.target,bin:bin,type:TextureSourceType.mipmaps,mipmaps:tex.mipmaps.map((function(pointer){return [pointer[1][1],pointer[1][2]]}))}});return ret})));}}catch(ex){reject(ex);}}))}function loadMipmapImageAsync(pointer,bins){var _pointer$=pointer[1],index=_pointer$[0],start=_pointer$[1],length=_pointer$[2];var bin=bins[index];if(!bin){return Promise.reject("invalid bin pointer:"+JSON.stringify(pointer))}var blob=new Blob([new Uint8Array(bin,start,length)]);return loadImageAsync$1(blob)}function combineImageTemplateAsync(url,template,variables,opt,flipY){if(template.v===2){return combineImageTemplate2Async(url,template,variables,{templateScale:opt==null?void 0:opt.templateScale,toData:true},flipY)}return combineImageTemplate1Async(url,template,variables,opt,flipY)}var renderLevelPassSet={["S"]:["S","B+","A+"],["A"]:["A","B+","A+"],["B"]:["B","B+"]};function passRenderLevel(l,renderLevel){if(!l||!renderLevel){return true}var arr=renderLevelPassSet[renderLevel];if(arr){return arr.indexOf(l)>-1}return false}var _indexBase=0;function earcut(data,holeIndices,dim,indexBase){dim=dim||2;_indexBase=indexBase||0;var hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,outerNode=linkedList(data,0,outerLen,dim,true),triangles=[];if(!outerNode||outerNode.next===outerNode.prev){return triangles}var minX,minY,maxX,maxY,x,y,invSize;if(hasHoles){outerNode=eliminateHoles(data,holeIndices,outerNode,dim);}if(data.length>80*dim){minX=maxX=data[0];minY=maxY=data[1];for(var i=dim;i<outerLen;i+=dim){x=data[i];y=data[i+1];if(x<minX){minX=x;}if(y<minY){minY=y;}if(x>maxX){maxX=x;}if(y>maxY){maxY=y;}}invSize=Math.max(maxX-minX,maxY-minY);invSize=invSize!==0?1/invSize:0;}earcutLinked(outerNode,triangles,dim,minX,minY,invSize);return triangles}function linkedList(data,start,end,dim,clockwise){var i,last;if(clockwise===signedArea(data,start,end,dim)>0){for(i=start;i<end;i+=dim)last=insertNode(i,data[i],data[i+1],last);}else {for(i=end-dim;i>=start;i-=dim)last=insertNode(i,data[i],data[i+1],last);}if(last&&equals(last,last.next)){removeNode(last);last=last.next;}return last}function filterPoints(start,end){if(!start){return start}if(!end){end=start;}var p=start,again;do{again=false;if(!p.steiner&&(equals(p,p.next)||area(p.prev,p,p.next)===0)){removeNode(p);p=end=p.prev;if(p===p.next){break}again=true;}else {p=p.next;}}while(again||p!==end);return end}function earcutLinked(ear,triangles,dim,minX,minY,invSize,pass){if(!ear){return}if(!pass&&invSize){indexCurve(ear,minX,minY,invSize);}var stop=ear,prev,next;while(ear.prev!==ear.next){prev=ear.prev;next=ear.next;if(invSize?isEarHashed(ear,minX,minY,invSize):isEar(ear)){triangles.push(prev.i/dim+_indexBase);triangles.push(ear.i/dim+_indexBase);triangles.push(next.i/dim+_indexBase);removeNode(ear);ear=next.next;stop=next.next;continue}ear=next;if(ear===stop){if(!pass){earcutLinked(filterPoints(ear),triangles,dim,minX,minY,invSize,1);}else if(pass===1){ear=cureLocalIntersections(filterPoints(ear),triangles,dim);earcutLinked(ear,triangles,dim,minX,minY,invSize,2);}else if(pass===2){splitEarcut(ear,triangles,dim,minX,minY,invSize);}break}}}function isEar(ear){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0){return false}var p=ear.next.next;while(p!==ear.prev){if(pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0){return false}p=p.next;}return true}function isEarHashed(ear,minX,minY,invSize){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0){return false}var minTX=a.x<b.x?a.x<c.x?a.x:c.x:b.x<c.x?b.x:c.x,minTY=a.y<b.y?a.y<c.y?a.y:c.y:b.y<c.y?b.y:c.y,maxTX=a.x>b.x?a.x>c.x?a.x:c.x:b.x>c.x?b.x:c.x,maxTY=a.y>b.y?a.y>c.y?a.y:c.y:b.y>c.y?b.y:c.y;var minZ=zOrder(minTX,minTY,minX,minY,invSize),maxZ=zOrder(maxTX,maxTY,minX,minY,invSize);var p=ear.prevZ,n=ear.nextZ;while(p&&p.z>=minZ&&n&&n.z<=maxZ){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0){return false}p=p.prevZ;if(n!==ear.prev&&n!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,n.x,n.y)&&area(n.prev,n,n.next)>=0){return false}n=n.nextZ;}while(p&&p.z>=minZ){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0){return false}p=p.prevZ;}while(n&&n.z<=maxZ){if(n!==ear.prev&&n!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,n.x,n.y)&&area(n.prev,n,n.next)>=0){return false}n=n.nextZ;}return true}function cureLocalIntersections(start,triangles,dim){var p=start;do{var a=p.prev,b=p.next.next;if(!equals(a,b)&&intersects(a,p,p.next,b)&&locallyInside(a,b)&&locallyInside(b,a)){triangles.push(a.i/dim+_indexBase);triangles.push(p.i/dim+_indexBase);triangles.push(b.i/dim+_indexBase);removeNode(p);removeNode(p.next);p=start=b;}p=p.next;}while(p!==start);return filterPoints(p)}function splitEarcut(start,triangles,dim,minX,minY,invSize){var a=start;do{var b=a.next.next;while(b!==a.prev){if(a.i!==b.i&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);a=filterPoints(a,a.next);c=filterPoints(c,c.next);earcutLinked(a,triangles,dim,minX,minY,invSize);earcutLinked(c,triangles,dim,minX,minY,invSize);return}b=b.next;}a=a.next;}while(a!==start)}function eliminateHoles(data,holeIndices,outerNode,dim){var queue=[],i,len,start,end,list;for(i=0,len=holeIndices.length;i<len;i++){start=holeIndices[i]*dim;end=i<len-1?holeIndices[i+1]*dim:data.length;list=linkedList(data,start,end,dim,false);if(list===list.next){list.steiner=true;}queue.push(getLeftmost(list));}queue.sort(compareX);for(i=0;i<queue.length;i++){eliminateHole(queue[i],outerNode);outerNode=filterPoints(outerNode,outerNode.next);}return outerNode}function compareX(a,b){return a.x-b.x}function eliminateHole(hole,outerNode){outerNode=findHoleBridge(hole,outerNode);if(outerNode){var b=splitPolygon(outerNode,hole);filterPoints(outerNode,outerNode.next);filterPoints(b,b.next);}}function findHoleBridge(hole,outerNode){var p=outerNode,hx=hole.x,hy=hole.y,qx=-Infinity,m;do{if(hy<=p.y&&hy>=p.next.y&&p.next.y!==p.y){var x=p.x+(hy-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(x<=hx&&x>qx){qx=x;if(x===hx){if(hy===p.y){return p}if(hy===p.next.y){return p.next}}m=p.x<p.next.x?p:p.next;}}p=p.next;}while(p!==outerNode);if(!m){return null}if(hx===qx){return m}var stop=m,mx=m.x,my=m.y,tanMin=Infinity,tan;p=m;do{if(hx>=p.x&&p.x>=mx&&hx!==p.x&&pointInTriangle(hy<my?hx:qx,hy,mx,my,hy<my?qx:hx,hy,p.x,p.y)){tan=Math.abs(hy-p.y)/(hx-p.x);if(locallyInside(p,hole)&&(tan<tanMin||tan===tanMin&&(p.x>m.x||p.x===m.x&&sectorContainsSector(m,p)))){m=p;tanMin=tan;}}p=p.next;}while(p!==stop);return m}function sectorContainsSector(m,p){return area(m.prev,m,p.prev)<0&&area(p.next,m,m.next)<0}function indexCurve(start,minX,minY,invSize){var p=start;do{if(p.z===null){p.z=zOrder(p.x,p.y,minX,minY,invSize);}p.prevZ=p.prev;p.nextZ=p.next;p=p.next;}while(p!==start);p.prevZ.nextZ=null;p.prevZ=null;sortLinked(p);}function sortLinked(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;do{p=list;list=null;tail=null;numMerges=0;while(p){numMerges++;q=p;pSize=0;for(i=0;i<inSize;i++){pSize++;q=q.nextZ;if(!q){break}}qSize=inSize;while(pSize>0||qSize>0&&q){if(pSize!==0&&(qSize===0||!q||p.z<=q.z)){e=p;p=p.nextZ;pSize--;}else {e=q;q=q.nextZ;qSize--;}if(tail){tail.nextZ=e;}else {list=e;}e.prevZ=tail;tail=e;}p=q;}tail.nextZ=null;inSize*=2;}while(numMerges>1);return list}function zOrder(x,y,minX,minY,invSize){x=32767*(x-minX)*invSize;y=32767*(y-minY)*invSize;x=(x|x<<8)&16711935;x=(x|x<<4)&252645135;x=(x|x<<2)&858993459;x=(x|x<<1)&1431655765;y=(y|y<<8)&16711935;y=(y|y<<4)&252645135;y=(y|y<<2)&858993459;y=(y|y<<1)&1431655765;return x|y<<1}function getLeftmost(start){var p=start,leftmost=start;do{if(p.x<leftmost.x||p.x===leftmost.x&&p.y<leftmost.y){leftmost=p;}p=p.next;}while(p!==start);return leftmost}function pointInTriangle(ax,ay,bx,by,cx,cy,px,py){return (cx-px)*(ay-py)-(ax-px)*(cy-py)>=0&&(ax-px)*(by-py)-(bx-px)*(ay-py)>=0&&(bx-px)*(cy-py)-(cx-px)*(by-py)>=0}function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!intersectsPolygon(a,b)&&(locallyInside(a,b)&&locallyInside(b,a)&&middleInside(a,b)&&(area(a.prev,a,b.prev)||area(a,b.prev,b))||equals(a,b)&&area(a.prev,a,a.next)>0&&area(b.prev,b,b.next)>0)}function area(p,q,r){return (q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y)}function equals(p1,p2){return p1.x===p2.x&&p1.y===p2.y}function intersects(p1,q1,p2,q2){var o1=sign(area(p1,q1,p2));var o2=sign(area(p1,q1,q2));var o3=sign(area(p2,q2,p1));var o4=sign(area(p2,q2,q1));if(o1!==o2&&o3!==o4){return true}if(o1===0&&onSegment(p1,p2,q1)){return true}if(o2===0&&onSegment(p1,q2,q1)){return true}if(o3===0&&onSegment(p2,p1,q2)){return true}if(o4===0&&onSegment(p2,q1,q2)){return true}return false}function onSegment(p,q,r){return q.x<=Math.max(p.x,r.x)&&q.x>=Math.min(p.x,r.x)&&q.y<=Math.max(p.y,r.y)&&q.y>=Math.min(p.y,r.y)}function sign(num){return num>0?1:num<0?-1:0}function intersectsPolygon(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&intersects(p,p.next,a,b)){return true}p=p.next;}while(p!==a);return false}function locallyInside(a,b){return area(a.prev,a,a.next)<0?area(a,b,a.next)>=0&&area(a,a.prev,b)>=0:area(a,b,a.prev)<0||area(a,a.next,b)<0}function middleInside(a,b){var p=a,inside=false,px=(a.x+b.x)/2,py=(a.y+b.y)/2;do{if(p.y>py!==p.next.y>py&&p.next.y!==p.y&&px<(p.next.x-p.x)*(py-p.y)/(p.next.y-p.y)+p.x){inside=!inside;}p=p.next;}while(p!==a);return inside}function splitPolygon(a,b){var a2=new Node(a.i,a.x,a.y),b2=new Node(b.i,b.x,b.y),an=a.next,bp=b.prev;a.next=b;b.prev=a;a2.next=an;an.prev=a2;b2.next=a2;a2.prev=b2;bp.next=b2;b2.prev=bp;return b2}function insertNode(i,x,y,last){var p=new Node(i,x,y);if(!last){p.prev=p;p.next=p;}else {p.next=last.next;p.prev=last;last.next.prev=p;last.next=p;}return p}function removeNode(p){p.next.prev=p.prev;p.prev.next=p.next;if(p.prevZ){p.prevZ.nextZ=p.nextZ;}if(p.nextZ){p.nextZ.prevZ=p.prevZ;}}function Node(i,x,y){this.i=i;this.x=x;this.y=y;this.prev=null;this.next=null;this.z=null;this.prevZ=null;this.nextZ=null;this.steiner=false;}function signedArea(data,start,end,dim){var sum=0;for(var i=start,j=end-dim;i<end;i+=dim){sum+=(data[j]-data[i])*(data[i+1]+data[j+1]);j=i;}return sum}var POINT_INDEX=2;function getGeometry2DTriangles(geometry,options){var pointCount=0;var segments=geometry.s;for(var i=0;i<segments.length;i++){var segment=segments[i];pointCount+=segment.length-1;}var pointData=new Float32Array(pointCount*6);var index=0;var indexBase=options.indexBase||0;var uvTransform=options.uvTransform;var dx=0,dy=0,sw=1,sh=1,r;if(uvTransform){dx=uvTransform[0];dy=uvTransform[1];r=uvTransform[4];sw=r?uvTransform[3]:uvTransform[2];sh=r?uvTransform[2]:uvTransform[3];}var temp=[];var angle=r===0?0:-Math.PI/2;var points=geometry.p;for(var _i2=0;_i2<segments.length;_i2++){var _segment=segments[_i2];var p0=points[_i2];var p1=points[_i2+1]||points[0];var keys=_segment;var point=[];for(var j=0;j<keys.length-1;j++){var key=keys[j];getBezier2DValue(point,key,p0,p1,p0[4],p0[5],p1[2],p1[3]);setPoint(point[0],point[1]);}}var indices=earcut(pointData,null,6,indexBase);return {aPoint:pointData,index:new Uint16Array(indices)};function setPoint(x,y){pointData[index++]=x/2;pointData[index++]=y/2;if(uvTransform){temp[0]=x;temp[1]=y;rotateVec2(temp,temp,angle);pointData[index++]=dx+(temp[0]+1)/2*sw;pointData[index++]=dy+(temp[1]+1)/2*sh;}else {pointData[index++]=(x+1)/2;pointData[index++]=(y+1)/2;}index+=POINT_INDEX;}}function getBezier2DValue(out,t,p0,p1,cpx0,cpy0,cpx1,cpy1){var ddt=1-t;var a=ddt*ddt*ddt;var b=3*t*ddt*ddt;var c=3*t*t*ddt;var d=t*t*t;out[0]=a*p0[0]+b*cpx0+c*cpx1+d*p1[0];out[1]=a*p0[1]+b*cpy0+c*cpy1+d*p1[1];return out}function createCommonjsModule(fn,basedir,module){return module={path:basedir,exports:{},require:function(path,base){return commonjsRequire(path,base===undefined||base===null?module.path:base)}},fn(module,module.exports),module.exports}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var fallback=createCommonjsModule((function(module,exports){Object.defineProperty(exports,"__esModule",{value:true});var RenderLevel;(function(RenderLevel){RenderLevel["S"]="S";RenderLevel["APlus"]="A+";RenderLevel["A"]="A";RenderLevel["BPlus"]="B+";RenderLevel["B"]="B";})(RenderLevel||(RenderLevel={}));var BlendingMode;(function(BlendingMode){BlendingMode[BlendingMode["alpha"]=0]="alpha";BlendingMode[BlendingMode["ADD"]=1]="ADD";BlendingMode[BlendingMode["MULTIPLY"]=2]="MULTIPLY";BlendingMode[BlendingMode["BRIGHTNESS"]=3]="BRIGHTNESS";BlendingMode[BlendingMode["SUBTRACTION"]=4]="SUBTRACTION";BlendingMode[BlendingMode["STRONG_LIGHT"]=5]="STRONG_LIGHT";BlendingMode[BlendingMode["WEAK_LIGHT"]=6]="WEAK_LIGHT";BlendingMode[BlendingMode["SUPERPOSITION"]=7]="SUPERPOSITION";})(BlendingMode||(BlendingMode={}));var SideMode;(function(SideMode){SideMode[SideMode["DOUBLE"]=1032]="DOUBLE";SideMode[SideMode["FRONT"]=1028]="FRONT";SideMode[SideMode["BACK"]=1029]="BACK";})(SideMode||(SideMode={}));var MaskMode;(function(MaskMode){MaskMode[MaskMode["NONE"]=0]="NONE";MaskMode[MaskMode["MASK"]=1]="MASK";MaskMode[MaskMode["OBSCURED"]=2]="OBSCURED";MaskMode[MaskMode["REVERSE_OBSCURED"]=3]="REVERSE_OBSCURED";})(MaskMode||(MaskMode={}));var ShapeType;(function(ShapeType){ShapeType[ShapeType["NONE"]=0]="NONE";ShapeType[ShapeType["SPHERE"]=1]="SPHERE";ShapeType[ShapeType["CONE"]=2]="CONE";ShapeType[ShapeType["HEMISPHERE"]=3]="HEMISPHERE";ShapeType[ShapeType["CIRCLE"]=4]="CIRCLE";ShapeType[ShapeType["DONUT"]=5]="DONUT";ShapeType[ShapeType["RECTANGLE"]=6]="RECTANGLE";ShapeType[ShapeType["RECTANGLE_EDGE"]=7]="RECTANGLE_EDGE";ShapeType[ShapeType["RECTANGLEEDGE"]=7]="RECTANGLEEDGE";ShapeType[ShapeType["EDGE"]=8]="EDGE";ShapeType[ShapeType["TEXTURE"]=9]="TEXTURE";})(ShapeType||(ShapeType={}));var PluginType;(function(PluginType){PluginType[PluginType["GYROSCOPE"]=0]="GYROSCOPE";PluginType[PluginType["SPINE"]=1]="SPINE";})(PluginType||(PluginType={}));var InteractType;(function(InteractType){InteractType[InteractType["CLICK"]=0]="CLICK";InteractType[InteractType["MESSAGE"]=1]="MESSAGE";InteractType[InteractType["DRAG"]=2]="DRAG";})(InteractType||(InteractType={}));var InteractBehavior;(function(InteractBehavior){InteractBehavior[InteractBehavior["NONE"]=0]="NONE";InteractBehavior[InteractBehavior["NOTIFY"]=1]="NOTIFY";InteractBehavior[InteractBehavior["RESUME_PLAYER"]=2]="RESUME_PLAYER";InteractBehavior[InteractBehavior["REMOVE"]=3]="REMOVE";InteractBehavior[InteractBehavior["PAUSE"]=4]="PAUSE";})(InteractBehavior||(InteractBehavior={}));var ItemType;(function(ItemType){ItemType["base"]="0";ItemType["sprite"]="1";ItemType["particle"]="2";ItemType["null"]="3";ItemType["interact"]="4";ItemType["plugin"]="5";ItemType["camera"]="6";ItemType["composition"]="7";ItemType["filter"]="8";ItemType["spine"]="spine";})(ItemType||(ItemType={}));var RenderMode;(function(RenderMode){RenderMode[RenderMode["BILLBOARD"]=0]="BILLBOARD";RenderMode[RenderMode["MESH"]=1]="MESH";RenderMode[RenderMode["VERTICAL_BILLBOARD"]=2]="VERTICAL_BILLBOARD";RenderMode[RenderMode["HORIZONTAL_BILLBOARD"]=3]="HORIZONTAL_BILLBOARD";})(RenderMode||(RenderMode={}));var ParticleOrigin;(function(ParticleOrigin){ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_CENTER"]=0]="PARTICLE_ORIGIN_CENTER";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_LEFT_TOP"]=1]="PARTICLE_ORIGIN_LEFT_TOP";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_LEFT_CENTER"]=2]="PARTICLE_ORIGIN_LEFT_CENTER";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_LEFT_BOTTOM"]=3]="PARTICLE_ORIGIN_LEFT_BOTTOM";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_CENTER_TOP"]=4]="PARTICLE_ORIGIN_CENTER_TOP";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_CENTER_BOTTOM"]=5]="PARTICLE_ORIGIN_CENTER_BOTTOM";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_RIGHT_TOP"]=6]="PARTICLE_ORIGIN_RIGHT_TOP";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_RIGHT_CENTER"]=7]="PARTICLE_ORIGIN_RIGHT_CENTER";ParticleOrigin[ParticleOrigin["PARTICLE_ORIGIN_RIGHT_BOTTOM"]=8]="PARTICLE_ORIGIN_RIGHT_BOTTOM";})(ParticleOrigin||(ParticleOrigin={}));var END_BEHAVIOR_DESTROY=0;var END_BEHAVIOR_PAUSE=1;var END_BEHAVIOR_FORWARD=2;var END_BEHAVIOR_PAUSE_AND_DESTROY=3;var END_BEHAVIOR_FREEZE=4;var END_BEHAVIOR_RESTART=5;var END_BEHAVIOR_DESTROY_CHILDREN=6;var CAMERA_CLIP_MODE_VERTICAL=1;var CAMERA_CLIP_MODE_NORMAL=0;var CameraClipMode;(function(CameraClipMode){CameraClipMode[CameraClipMode["portrait"]=CAMERA_CLIP_MODE_VERTICAL]="portrait";CameraClipMode[CameraClipMode["landscape"]=CAMERA_CLIP_MODE_NORMAL]="landscape";})(CameraClipMode||(CameraClipMode={}));var CompositionEndBehavior;(function(CompositionEndBehavior){CompositionEndBehavior[CompositionEndBehavior["destroy"]=END_BEHAVIOR_DESTROY]="destroy";CompositionEndBehavior[CompositionEndBehavior["pause"]=END_BEHAVIOR_PAUSE]="pause";CompositionEndBehavior[CompositionEndBehavior["restart"]=END_BEHAVIOR_RESTART]="restart";CompositionEndBehavior[CompositionEndBehavior["forward"]=END_BEHAVIOR_FORWARD]="forward";CompositionEndBehavior[CompositionEndBehavior["pause_destroy"]=END_BEHAVIOR_PAUSE_AND_DESTROY]="pause_destroy";})(CompositionEndBehavior||(CompositionEndBehavior={}));var TextOverflow;(function(TextOverflow){TextOverflow[TextOverflow["display"]=0]="display";TextOverflow[TextOverflow["clip"]=1]="clip";TextOverflow[TextOverflow["ellipsis"]=2]="ellipsis";})(TextOverflow||(TextOverflow={}));var TextAlignment;(function(TextAlignment){TextAlignment[TextAlignment["left"]=0]="left";TextAlignment[TextAlignment["middle"]=1]="middle";TextAlignment[TextAlignment["right"]=2]="right";})(TextAlignment||(TextAlignment={}));var FontStyle;(function(FontStyle){FontStyle[FontStyle["normal"]=0]="normal";FontStyle[FontStyle["italic"]=1]="italic";FontStyle[FontStyle["oblique"]=2]="oblique";})(FontStyle||(FontStyle={}));var ValueType;(function(ValueType){ValueType[ValueType["CONSTANT"]=0]="CONSTANT";ValueType[ValueType["CONSTANT_VEC2"]=1]="CONSTANT_VEC2";ValueType[ValueType["CONSTANT_VEC3"]=2]="CONSTANT_VEC3";ValueType[ValueType["CONSTANT_VEC4"]=3]="CONSTANT_VEC4";ValueType[ValueType["RANDOM"]=4]="RANDOM";ValueType[ValueType["LINE"]=5]="LINE";ValueType[ValueType["CURVE"]=6]="CURVE";ValueType[ValueType["BEZIER_PATH"]=7]="BEZIER_PATH";ValueType[ValueType["RGBA_COLOR"]=8]="RGBA_COLOR";ValueType[ValueType["GRADIENT_COLOR"]=9]="GRADIENT_COLOR";ValueType[ValueType["SHAPE_POINTS"]=10]="SHAPE_POINTS";ValueType[ValueType["SHAPE_SPLITS"]=11]="SHAPE_SPLITS";ValueType[ValueType["LINEAR_PATH"]=12]="LINEAR_PATH";ValueType[ValueType["COLORS"]=13]="COLORS";ValueType[ValueType["BINARY"]=20]="BINARY";})(ValueType||(ValueType={}));var ItemEndBehavior;(function(ItemEndBehavior){ItemEndBehavior[ItemEndBehavior["destroy"]=END_BEHAVIOR_DESTROY]="destroy";ItemEndBehavior[ItemEndBehavior["loop"]=END_BEHAVIOR_RESTART]="loop";ItemEndBehavior[ItemEndBehavior["forward"]=END_BEHAVIOR_FREEZE]="forward";})(ItemEndBehavior||(ItemEndBehavior={}));var ParentItemEndBehavior;(function(ParentItemEndBehavior){ParentItemEndBehavior[ParentItemEndBehavior["destroyChildren"]=END_BEHAVIOR_DESTROY_CHILDREN]="destroyChildren";})(ParentItemEndBehavior||(ParentItemEndBehavior={}));var ParticleInteractionBehavior;(function(ParticleInteractionBehavior){ParticleInteractionBehavior[ParticleInteractionBehavior["none"]=0]="none";ParticleInteractionBehavior[ParticleInteractionBehavior["removeParticle"]=1]="removeParticle";})(ParticleInteractionBehavior||(ParticleInteractionBehavior={}));var ShapeArcMode;(function(ShapeArcMode){ShapeArcMode[ShapeArcMode["RANDOM"]=0]="RANDOM";ShapeArcMode[ShapeArcMode["UNIDIRECTIONAL_CYCLE"]=1]="UNIDIRECTIONAL_CYCLE";ShapeArcMode[ShapeArcMode["BIDIRECTIONAL_CYCLE"]=2]="BIDIRECTIONAL_CYCLE";ShapeArcMode[ShapeArcMode["UNIFORM_BURST"]=3]="UNIFORM_BURST";})(ShapeArcMode||(ShapeArcMode={}));var ModelBoundingType;(function(ModelBoundingType){ModelBoundingType[ModelBoundingType["box"]=2]="box";ModelBoundingType[ModelBoundingType["sphere"]=3]="sphere";})(ModelBoundingType||(ModelBoundingType={}));var MaterialType;(function(MaterialType){MaterialType["unlit"]="unlit";MaterialType["pbr"]="pbr";MaterialType["hair"]="hair";})(MaterialType||(MaterialType={}));var MaterialBlending;(function(MaterialBlending){MaterialBlending[MaterialBlending["opaque"]=100]="opaque";MaterialBlending[MaterialBlending["masked"]=101]="masked";MaterialBlending[MaterialBlending["translucent"]=102]="translucent";MaterialBlending[MaterialBlending["additive"]=103]="additive";})(MaterialBlending||(MaterialBlending={}));var RenderMode3D;(function(RenderMode3D){RenderMode3D["none"]="none";RenderMode3D["uv"]="uv";RenderMode3D["normal"]="normal";RenderMode3D["basecolor"]="basecolor";RenderMode3D["alpha"]="alpha";RenderMode3D["metallic"]="metallic";RenderMode3D["roughness"]="roughness";RenderMode3D["ao"]="ao";RenderMode3D["emissive"]="emissive";})(RenderMode3D||(RenderMode3D={}));var _assign=function __assign(){_assign=Object.assign||function __assign(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p];}return t};return _assign.apply(this,arguments)};function arrAdd(arr,item){if(!arr.includes(item)){arr.push(item);return true}}function forEach(object,callback,thisObj){if(object){for(var name_1 in object){if(Object.hasOwnProperty.call(object,name_1)){callback.call(thisObj,object[name_1],name_1);}}}return object}function ensureFixedNumber(a){if(Number.isFinite(a)){return [ValueType.CONSTANT,a]}if(a){if(a[0]==="lines"){return [ValueType.LINE,a[1]]}if(a[0]==="curve"){return [ValueType.CURVE,a[1]]}if(a[0]==="static"){return [ValueType.CONSTANT,a[1]]}}}function ensureFixedNumberWithRandom(a,p){if(Array.isArray(a)&&a[0]==="random"){return [ValueType.CONSTANT,a[1][p]]}return ensureFixedNumber(a)}function ensureRGBAValue(a){if(a&&a[0]==="color"){return colorToArr(a[1],true)}return [1,1,1,1]}function ensureColorExpression(a,normalized){if(a){if(a[0]==="colors"){return [ValueType.COLORS,a[1].map((function(color){return colorToArr(color,normalized)}))]}else if(a[0]==="gradient"){return ensureGradient(a[1],normalized)}else if(a[0]==="color"){return [ValueType.RGBA_COLOR,colorToArr(a[1],normalized)]}}}function ensureNumberExpression(a){if(a&&a[0]==="random"){return [ValueType.RANDOM,a[1]]}return ensureFixedNumber(a)}function ensureValueGetter(a){if(Array.isArray(a)&&typeof a[0]==="string"){return ensureNumberExpression(a)||ensureFixedVec3(a)||ensureColorExpression(a)||a}return a}function ensureGradient(a,normalized){if(a){var stops_1=[];Object.getOwnPropertyNames(a).forEach((function(p){var stop=parsePercent(p);var color=colorToArr(a[p],normalized);stops_1.push([stop,color[0],color[1],color[2],color[3]]);}));stops_1=stops_1.sort((function(a,b){return a[0]-b[0]}));return [ValueType.GRADIENT_COLOR,stops_1]}}function colorToArr(hex,normalized){var ret;if(typeof hex==="string"){hex=hex.replace(/[\s\t\r\n]/g,"");var m=/rgba?\(([.\d]+),([.\d]+),([.\d]+),?([.\d]+)?\)/.exec(hex);if(m){var a=+m[4];ret=[+m[1],+m[2],+m[3],isNaN(a)?255:Math.round(a*255)];}else if(/^#[a-f\d]{3}$/i.test(hex)){ret=[parseInt(hex[1]+hex[1],16),parseInt(hex[2]+hex[2],16),parseInt(hex[3]+hex[3],16),255];}else if(m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)){ret=[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16),255]||[0,0,0,255];}}else if(hex instanceof Array){ret=[hex[0],hex[1],hex[2],isNaN(hex[3])?255:Math.round(hex[3]*255)];}if(normalized){ret=normalizeColor(ret);}return ret}function normalizeColor(a){if(Array.isArray(a)){return a.map((function(i){return Number.isFinite(i/255)?Number((i/255).toFixed(6)):0}))}}function parsePercent(c){var match=/^(-)?([\d+.]+)%$/.exec(c);if(match){return +match[2]/100*(match[1]?-1:1)}return +c}function getGradientColor(color,normalized){if(Array.isArray(color)){return (color[0]==="gradient"||color[0]==="color")&&ensureGradient(color[1],normalized)}else {return ensureGradient(color,normalized)}}function ensureFixedVec3(a){if(a){if(a.length===3){return [ValueType.CONSTANT_VEC3,a]}if(a[0]==="path"){return [ValueType.LINEAR_PATH,a[1]]}if(a[0]==="bezier"){return [ValueType.BEZIER_PATH,a[1]]}}}function objectValueToNumber(o){for(var _i=0,_a=Object.entries(o);_i<_a.length;_i++){var _b=_a[_i],key=_b[0],value=_b[1];o[key]=Number(value);}return o}function deleteEmptyValue(o){for(var _i=0,_a=Object.keys(o);_i<_a.length;_i++){var key=_a[_i];if(o[key]===undefined){delete o[key];}}return o}var cos=Math.cos;var sin=Math.sin;var d2r=Math.PI/180;var r2d=180/Math.PI;function quatFromXYZRotation(out,x,y,z){var c1=cos(x*d2r/2);var c2=cos(y*d2r/2);var c3=cos(z*d2r/2);var s1=sin(x*d2r/2);var s2=sin(y*d2r/2);var s3=sin(z*d2r/2);out[0]=s1*c2*c3+c1*s2*s3;out[1]=c1*s2*c3-s1*c2*s3;out[2]=c1*c2*s3+s1*s2*c3;out[3]=c1*c2*c3-s1*s2*s3;return out}function clamp(v,min,max){return v>max?max:v<min?min:v}function rotationZYXFromQuat(out,quat){var x=quat[0];var y=quat[1];var z=quat[2];var w=quat[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var yx=y*x2;var yy=y*y2;var zx=z*x2;var zy=z*y2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;var m11=1-yy-zz,m12=yx-wz;var m21=yx+wz,m22=1-xx-zz;var m31=zx-wy,m32=zy+wx,m33=1-xx-yy;out[1]=Math.asin(clamp(-m31,-1,1))*r2d;if(Math.abs(m31)<.9999999){out[0]=Math.atan2(m32,m33)*r2d;out[2]=Math.atan2(m21,m11)*r2d;}else {out[0]=0;out[2]=Math.atan2(-m12,m22)*r2d;}return out}function getStandardParticleContent(particle){var options=particle.options;var transform=particle.transform;var shape={type:ShapeType.NONE};if(particle.shape){shape=_assign(_assign({},particle.shape),{type:ShapeType[particle.shape.shape.toUpperCase()]});if(particle.shape.upDirection){var _a=particle.shape.upDirection,x=_a[0],y=_a[1],z=_a[2];if(x===0&&y===0&&z===0){delete shape.upDirection;}}}if(options.startTurbulence){shape.turbulenceX=ensureNumberExpression(options.turbulenceX);shape.turbulenceY=ensureNumberExpression(options.turbulenceY);shape.turbulenceZ=ensureNumberExpression(options.turbulenceZ);}var emission=particle.emission;if(emission.bursts&&emission.bursts.length>0){emission.bursts=emission.bursts.map((function(b){return objectValueToNumber(b)}));}if(emission.burstOffsets&&emission.burstOffsets.length>0){emission.burstOffsets=emission.burstOffsets.map((function(b){return objectValueToNumber(b)}));}if(emission.rateOverTime){emission.rateOverTime=ensureNumberExpression(emission.rateOverTime);}var ret={renderer:particle.renderer,shape:shape,splits:particle.splits,emission:emission,options:{startLifetime:ensureNumberExpression(options.startLifetime),start3DSize:!!options.start3DSize,startSize:ensureNumberExpression(options.startSize),startSizeX:ensureNumberExpression(options.startSizeX),startSizeY:ensureNumberExpression(options.startSizeY),sizeAspect:ensureNumberExpression(options.sizeAspect),maxCount:options.maxCount,startDelay:ensureNumberExpression(options.startDelay),startColor:ensureColorExpression(options.startColor,true),startRotationZ:ensureNumberExpression(options.startRotation||options.startRotationZ),particleFollowParent:options.particleFollowParent}};if(options.start3DRotation){ret.options.startRotationX=ensureNumberExpression(options.startRotationX);ret.options.startRotationY=ensureNumberExpression(options.startRotationY);}if(particle.filter){var filter_1={};forEach(particle.filter,(function(val,key){filter_1[key]=ensureValueGetter(val);}));ret.filter=filter_1;}if(transform&&transform.path){ret.emitterTransform={path:ensureFixedVec3(transform.path)};}var sizeOverLifetime=particle.sizeOverLifetime;if(sizeOverLifetime){if(sizeOverLifetime.separateAxes){ret.sizeOverLifetime={separateAxes:true,x:ensureNumberExpression(sizeOverLifetime.x),y:ensureNumberExpression(sizeOverLifetime.y)};}else {ret.sizeOverLifetime={size:ensureNumberExpression(sizeOverLifetime.size)};}}var velocityOverLifetime=particle.velocityOverLifetime||{};var sol=velocityOverLifetime.speedOverLifetime;if(sol){sol=ensureFixedNumber(sol);}else {sol=undefined;}ret.positionOverLifetime={gravity:options.gravity,gravityOverLifetime:ensureFixedNumber(options.gravityModifier),startSpeed:ensureNumberExpression(options.startSpeed),speedOverLifetime:sol,asMovement:velocityOverLifetime.asMovement,linearX:ensureNumberExpression(velocityOverLifetime.linearX),linearY:ensureNumberExpression(velocityOverLifetime.linearY),linearZ:ensureNumberExpression(velocityOverLifetime.linearZ),asRotation:velocityOverLifetime.asRotation,orbCenter:velocityOverLifetime.orbCenter,orbitalX:ensureNumberExpression(velocityOverLifetime.orbitalX),orbitalY:ensureNumberExpression(velocityOverLifetime.orbitalY),orbitalZ:ensureNumberExpression(velocityOverLifetime.orbitalZ),forceTarget:velocityOverLifetime.forceTarget,target:velocityOverLifetime.target,forceCurve:ensureFixedNumber(velocityOverLifetime.forceCurve)};deleteEmptyValue(ret.positionOverLifetime);var rotationOverLifetime=particle.rotationOverLifetime;if(rotationOverLifetime){ret.rotationOverLifetime={separateAxes:rotationOverLifetime.separateAxes,asRotation:rotationOverLifetime.asRotation,z:ensureNumberExpression(rotationOverLifetime.separateAxes?rotationOverLifetime.z:rotationOverLifetime.angularVelocity)};if(rotationOverLifetime.separateAxes){ret.rotationOverLifetime.y=ensureFixedNumber(rotationOverLifetime.y);ret.rotationOverLifetime.x=ensureFixedNumber(rotationOverLifetime.x);}}var colorOverLifetime=particle.colorOverLifetime;if(colorOverLifetime){var col=ret.colorOverLifetime={opacity:ensureFixedNumber(colorOverLifetime.opacity)};if(colorOverLifetime.color){col.color=getGradientColor(colorOverLifetime.color);}}var textureSheetAnimation=particle.textureSheetAnimation;if(textureSheetAnimation){ret.textureSheetAnimation={row:textureSheetAnimation.row,col:textureSheetAnimation.col,total:textureSheetAnimation.total,animate:textureSheetAnimation.animate,cycles:ensureFixedNumber(textureSheetAnimation.cycles),animationDelay:ensureFixedNumberWithRandom(textureSheetAnimation.animationDelay,0),animationDuration:ensureFixedNumberWithRandom(textureSheetAnimation.animationDuration,0)};}var trials=particle.trails;if(trials){ret.trails={lifetime:ensureNumberExpression(trials.lifetime),dieWithParticles:trials.dieWithParticles,maxPointPerTrail:trials.maxPointPerTrail,minimumVertexDistance:trials.minimumVertexDistance,widthOverTrail:ensureFixedNumber(trials.widthOverTrail),colorOverTrail:trials.colorOverTrail&&getGradientColor(trials.colorOverTrail,false),blending:trials.blending,colorOverLifetime:trials.colorOverLifetime&&getGradientColor(trials.colorOverLifetime,false),inheritParticleColor:trials.inheritParticleColor,occlusion:trials.occlusion,transparentOcclusion:trials.transparentOcclusion,orderOffset:trials.orderOffset,sizeAffectsLifetime:trials.sizeAffectsLifetime,sizeAffectsWidth:trials.sizeAffectsWidth,texture:trials.texture,parentAffectsPosition:trials.parentAffectsPosition,opacityOverLifetime:ensureNumberExpression(trials.opacityOverLifetime)};}ret.trails&&deleteEmptyValue(ret.trails);var interaction=particle.interaction;if(interaction){ret.interaction={behavior:interaction.behavior,radius:interaction.radius,multiple:interaction.multiple};}return ret}function getStandardNullContent(sprite,transform){var _a;var opt=sprite.options;var velocityOverLifetime=sprite.velocityOverLifetime||{};var positionOverLifetime={path:ensureFixedVec3((_a=sprite.transform)===null||_a===void 0?void 0:_a.path),gravity:opt.gravity,gravityOverLifetime:ensureFixedNumber(opt.gravityModifier),direction:opt.direction,startSpeed:opt.startSpeed,asMovement:velocityOverLifetime.asMovement,linearX:ensureFixedNumber(velocityOverLifetime.linearX),linearY:ensureFixedNumber(velocityOverLifetime.linearY),linearZ:ensureFixedNumber(velocityOverLifetime.linearZ),asRotation:velocityOverLifetime.asRotation,orbCenter:velocityOverLifetime.orbCenter,orbitalX:ensureFixedNumber(velocityOverLifetime.orbitalX),orbitalY:ensureFixedNumber(velocityOverLifetime.orbitalY),orbitalZ:ensureFixedNumber(velocityOverLifetime.orbitalZ),speedOverLifetime:ensureFixedNumber(velocityOverLifetime.speedOverLifetime)};deleteEmptyValue(positionOverLifetime);var ret={options:{startColor:ensureRGBAValue(opt.startColor)},positionOverLifetime:positionOverLifetime};if(opt.startSize){transform.scale=[opt.startSize,opt.startSize/(opt.sizeAspect||1),1];}if(opt.startRotation){if(!transform.rotation){transform.rotation=[0,0,opt.startRotation];}else {transform.rotation[2]+=opt.startRotation;}}var rotationOverLifetime=sprite.rotationOverLifetime;if(rotationOverLifetime){var rot=ret.rotationOverLifetime={separateAxes:rotationOverLifetime.separateAxes,asRotation:rotationOverLifetime.asRotation};if(rot.separateAxes){rot.x=ensureFixedNumber(rotationOverLifetime.x);rot.y=ensureFixedNumber(rotationOverLifetime.y);rot.z=ensureFixedNumber(rotationOverLifetime.z);}else {rot.z=ensureFixedNumber(rotationOverLifetime.angularVelocity);}}var colorOverLifetime=sprite.colorOverLifetime;if(colorOverLifetime){var col=ret.colorOverLifetime={opacity:ensureFixedNumber(colorOverLifetime.opacity)};if(colorOverLifetime.color){col.color=getGradientColor(colorOverLifetime.color);}}var sizeOverLifetime=sprite.sizeOverLifetime;if(sizeOverLifetime){ret.sizeOverLifetime={separateAxes:sizeOverLifetime.separateAxes,size:ensureFixedNumber(sizeOverLifetime.size),x:ensureFixedNumber(sizeOverLifetime.x),y:ensureFixedNumber(sizeOverLifetime.y),z:ensureFixedNumber(sizeOverLifetime.z)};}return ret}function getStandardSpriteContent(sprite,transform){var ret=getStandardNullContent(sprite,transform);var texAni=sprite.textureSheetAnimation;if(texAni){ret.textureSheetAnimation={row:texAni.row,col:texAni.col,total:texAni.total||undefined,animate:texAni.animate};}ret.renderer=sprite.renderer;if(sprite.splits){ret.splits=sprite.splits;}if(sprite.interaction){ret.interaction=sprite.interaction;}return ret}function getStandardInteractContent(ui){var options=ui.options;var option;switch(options.type){case"click":{option={type:InteractType.CLICK,showPreview:options.showPreview,previewColor:options.previewColor&&ensureRGBAValue(options.previewColor),behavior:options.behavior||InteractBehavior.NOTIFY};break}case"drag":{option={type:InteractType.DRAG,enableInEditor:!!options.enableInEditor,dxRange:options.dxRange,dyRange:options.dyRange,target:options.target};break}case"message":{option={type:InteractType.MESSAGE};break}}var ret={options:option};return ret}function getStandardCameraContent(model){var _a,_b;var opt=model.options;var ret={options:{fov:ensureFixedNumber(opt.fov),far:ensureFixedNumber(opt.far),near:ensureFixedNumber(opt.near),clipMode:opt.clipMode}};var velocityOverLifetime=model.velocityOverLifetime;if(velocityOverLifetime||((_a=model.transform)===null||_a===void 0?void 0:_a.path)){var positionOverLifetime={path:ensureFixedVec3((_b=model.transform)===null||_b===void 0?void 0:_b.path),linearX:ensureFixedNumber(velocityOverLifetime===null||velocityOverLifetime===void 0?void 0:velocityOverLifetime.translateX),linearY:ensureFixedNumber(velocityOverLifetime===null||velocityOverLifetime===void 0?void 0:velocityOverLifetime.translateY),linearZ:ensureFixedNumber(velocityOverLifetime===null||velocityOverLifetime===void 0?void 0:velocityOverLifetime.translateZ)};deleteEmptyValue(positionOverLifetime);ret.positionOverLifetime=positionOverLifetime;}var rol=model.rotationOverLifetime;if(rol){var rotationOverLifetime={separateAxes:rol.separateAxes,x:ensureFixedNumber(rol===null||rol===void 0?void 0:rol.rotateX),y:ensureFixedNumber(rol===null||rol===void 0?void 0:rol.rotateY),z:rol.separateAxes?ensureFixedNumber(rol===null||rol===void 0?void 0:rol.rotateZ):ensureFixedNumber(rol.rotation)};deleteEmptyValue(rotationOverLifetime);ret.rotationOverLifetime=rotationOverLifetime;}return ret}var convertParams=["strength","bloomAddon","colorAddon","period","waveMovement","colorThreshold","xOpacity","yOpacity","feather"];var pathParams=["path","position"];function getStandardFilterContent(filter){var ret={};forEach(filter,(function(val,key){if(convertParams.includes(key)){ret[key]=ensureFixedNumber(val);}else if(pathParams.includes(key)){ret[key]=ensureFixedVec3(val);}else {ret[key]=val;}}));return ret}var v0=/^(\d+)\.(\d+)\.(\d+)(-(\w+)\.\d+)?$/;var standardVersion=/^(\d+)\.(\d+)$/;var reverseParticle=false;function getStandardJSON(json){var _a;if(!json||typeof json!=="object"){throw Error("expect a json object")}if(v0.test(json.version)){reverseParticle=((_a=/^(\d+)/.exec(json.version))===null||_a===void 0?void 0:_a[0])==="0";return getStandardJSONFromV0(json)}var match=standardVersion.exec(json.version);if(match){var main=match[1];if(main==="1"){return json}}throw Error("invalid json version "+json.version)}var currentVersion="1.0";function getStandardJSONFromV0(json){var _a;currentVersion="1.0";var plugins=json.plugins||[];if((_a=json.bins)===null||_a===void 0?void 0:_a.length){currentVersion="1.3";}var requires=(json.requires||[]).slice();var images=json.images.map((function(img,index){return getStandardImage(img,index,json.imageTags||[])}));var textures=json.textures||images.map((function(img,i){return {source:i,flipY:true}}));var ret={plugins:plugins,shapes:json.shapes||[],type:"mars",version:currentVersion,loaderVersion:json.version,compositionId:json.compositionId+"",compositions:json.compositions.map((function(comp){return getStandardComposition(comp,{plugins:plugins,requires:requires})})),images:images,imgUsage:json._imgs,binUsage:json.binUsage,spines:json.spines,requires:json.requires,textures:textures,bins:(json.bins||[]).slice()};if(json._textures){ret._textures=json._textures;}return ret}function getStandardImage(image,index,imageTags){var renderLevel=imageTags[index];var oriY=image.oriY;if(typeof image==="string"){return {renderLevel:renderLevel,url:image,oriY:oriY}}else if(image.template){return {url:image.url,template:image.template,webp:image.webp,renderLevel:renderLevel,oriY:oriY}}else if(image.compressed){return {url:image.url,oriY:oriY,compressed:{astc:image.compressed.android,pvrtc:image.compressed.iOS},webp:image.webp,renderLevel:renderLevel}}else if(image.url){return {url:image.url,type:image.type,webp:image.webp,renderLevel:renderLevel,oriY:oriY,loop:image.loop}}else if(image&&image.sourceType){return image}throw Error("invalid image type")}function getStandardComposition(composition,opt){var _a;if(opt===void 0){opt={};}var ret={id:composition.id+"",camera:Object.assign({clipMode:CAMERA_CLIP_MODE_NORMAL},composition.camera),duration:composition.duration,endBehavior:composition.endBehavior,items:composition.items.map((function(item){return getStandardItem(item,opt)})),name:composition.name};var startTime=composition.startTime||composition.st;if(startTime){ret.startTime=startTime;}var previewSize=(_a=composition.meta)===null||_a===void 0?void 0:_a.previewSize;if(previewSize&&previewSize[0]===previewSize[1]&&previewSize[0]===0){previewSize=undefined;}if(previewSize){ret.previewSize=previewSize;}return ret}var tempQuat=[0,0,0,1];var stdAnchor=.5;function getStandardItem(item,opt){var _a,_b,_c;if(opt===void 0){opt={};}var type=ItemType.base;var transform;var originContent;var content;var endBehavior=item.endBehavior;var renderLevel;var pluginName;var duration;var pn;if(item.content){type=item.type||ItemType.plugin;pn=item.pn;pluginName=item.pluginName;content=item.content;originContent=item.content;if(isNaN(pn)&&!pluginName){pluginName=content.options.type;}if(item.duration){duration=item.duration;}transform=item.transform||getTransform(originContent.transform);if(type===ItemType.filter){if(currentVersion<"1.1"){currentVersion="1.1";}content=getStandardSpriteContent(originContent,transform);content.filter=getStandardFilterContent(originContent.filter);}}else if(item.particle){type=ItemType.particle;originContent=item.particle;transform=getTransform(originContent.transform,reverseParticle,true);content=getStandardParticleContent(originContent);}else if(item.sprite){type=ItemType.sprite;originContent=item.sprite;transform=getTransform(originContent.transform,false,true);content=getStandardSpriteContent(originContent,transform);}else if(item.cal){type=ItemType.null;originContent=item.cal;transform=getTransform(originContent.transform,false,true);content=getStandardNullContent(originContent,transform);}else if(item.ui){type=ItemType.interact;originContent=item.ui;transform=getTransform(originContent.transform);content=getStandardInteractContent(originContent);transform.scale=[originContent.options.width||1,originContent.options.height||1,1];}else if(item.model){originContent=item.model;if(item.model.options.type===1){type=ItemType.camera;transform=getTransform(originContent.transform);content=getStandardCameraContent(originContent);}}if((_a=content.renderer)===null||_a===void 0?void 0:_a.anchor){var anchor=new Float32Array(content.renderer.anchor);if(anchor[0]==stdAnchor&&anchor[1]==stdAnchor){delete content.renderer.anchor;}else if(opt.requires){arrAdd(opt.requires,"anchor");}}if(originContent){var looping=(_b=originContent.options)===null||_b===void 0?void 0:_b.looping;if(looping){if(Array.isArray(looping)){endBehavior=looping[1]?ItemEndBehavior.loop:ItemEndBehavior.destroy;}else {endBehavior=ItemEndBehavior.loop;}}else {endBehavior=endBehavior||((_c=originContent===null||originContent===void 0?void 0:originContent.options)===null||_c===void 0?void 0:_c.endBehavior)||ItemEndBehavior.destroy;}if(originContent.options.renderLevel){renderLevel=originContent.options.renderLevel;}if(isNaN(duration)){duration=originContent.options.duration;}}var ret={type:type,name:item.name,delay:item.delay,duration:duration,id:item.id+"",transform:transform,endBehavior:endBehavior,renderLevel:renderLevel,content:content};if(pluginName){if(opt.plugins){arrAdd(opt.plugins,pluginName);ret.pn=opt.plugins.indexOf(pluginName);}else {ret.pluginName=pluginName;}}else if(Number.isInteger(pn)){ret.pn=pn;}if(item.parentId){ret.parentId=item.parentId+"";}return ret;function getTransform(originTransform,inverseRotation,changeOrder){if(originTransform){var transform_1={};var rotation=originTransform.rotation;if(rotation){if(inverseRotation){transform_1.rotation=[-rotation[0],-rotation[1],-rotation[2]];}else {transform_1.rotation=[rotation[0],rotation[1],rotation[2]];}if(changeOrder){var q=quatFromXYZRotation(tempQuat,transform_1.rotation[0],transform_1.rotation[1],transform_1.rotation[2]);transform_1.rotation=rotationZYXFromQuat([],q);}}var position=originTransform.position;if(position){transform_1.position=originTransform.position;}if(Array.isArray(originTransform.scale)){transform_1.scale=[originTransform.scale[0]||1,originTransform.scale[1]||1,originTransform.scale[2]||1];}return transform_1}return {}}}exports.arrAdd=arrAdd;exports.colorToArr=colorToArr;exports.deleteEmptyValue=deleteEmptyValue;exports.ensureColorExpression=ensureColorExpression;exports.ensureFixedNumber=ensureFixedNumber;exports.ensureFixedNumberWithRandom=ensureFixedNumberWithRandom;exports.ensureFixedVec3=ensureFixedVec3;exports.ensureGradient=ensureGradient;exports.ensureNumberExpression=ensureNumberExpression;exports.ensureRGBAValue=ensureRGBAValue;exports.ensureValueGetter=ensureValueGetter;exports.forEach=forEach;exports.getGradientColor=getGradientColor;exports.getStandardComposition=getStandardComposition;exports.getStandardImage=getStandardImage;exports.getStandardItem=getStandardItem;exports.getStandardJSON=getStandardJSON;exports.normalizeColor=normalizeColor;exports.objectValueToNumber=objectValueToNumber;exports.parsePercent=parsePercent;exports.quatFromXYZRotation=quatFromXYZRotation;exports.rotationZYXFromQuat=rotationZYXFromQuat;}));var DEFAULT_LOAD_TIMEOUT=10;var seed$4=1;var JSONLoader=function(){function JSONLoader(url,options){var _this=this;this.id=seed$4++;this.processCompositions=function(){var _ref=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(json){var scene,compositions,opt,usedImages,renderLevel,_loop,i,_i2,id,ids,j,_id,tag,count,_i4;return _regeneratorRuntime().wrap((function _callee$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:scene=_this._json=fallback.getStandardJSON(json);_this._pluginSystem=new PluginSystem(scene.plugins||[]);_context2.next=4;return _this._pluginSystem.processRawJSONAsync(scene,_this.options);case 4:compositions=[];opt=_this.options;usedImages={};renderLevel=_this.options.renderLevel;if(!opt.compositions){_context2.next=18;break}_loop=_regeneratorRuntime().mark((function _loop(){var name,comp;return _regeneratorRuntime().wrap((function _loop$(_context){while(1)switch(_context.prev=_context.next){case 0:name=opt.compositions[i];comp=scene.compositions.find((function(c){return c.name===name}));if(comp){_context.next=4;break}throw Error("composition not found");case 4:compositions.push(comp);case 5:case"end":return _context.stop()}}),_loop)}));i=0;case 11:if(!(i<opt.compositions.length)){_context2.next=16;break}return _context2.delegateYield(_loop(),"t0",13);case 13:i++;_context2.next=11;break;case 16:_context2.next=19;break;case 18:compositions=scene.compositions;case 19:if(scene.imgUsage){for(_i2=0;_i2<compositions.length;_i2++){id=compositions[_i2].id;ids=scene.imgUsage[id];if(ids){for(j=0;j<ids.length;j++){_id=ids[j];tag=scene.images[_id].renderLevel;if(passRenderLevel(tag,renderLevel)){usedImages[_id]=true;}}}}}else if(scene.images){count=scene.images.length;for(_i4=0;_i4<count;_i4++){usedImages[_i4]=true;}}_this._usedImages=usedImages;case 21:case"end":return _context2.stop()}}),_callee)})));return function(_x){return _ref.apply(this,arguments)}}();this.url=typeof url==="string"?url:"";this.options=objAssign({pluginData:{}},options);this._restoreData={};this._timeout=options.timeout;if(isObj$1(url)){this._json=objAssign({},url,{compositions:url.compositions.map((function(comp){var items=comp.items.map((function(item){var ret={};forEach$1(item,(function(val,key){ret[key]=clonePlainObj(val);}));return ret}));return objAssign({},comp,{items:items})}))});}}var _proto=JSONLoader.prototype;_proto.loadJSONAsync=function loadJSONAsync(){var _this2=this;if(this.url){var url=new URL(this.url,location.href).href;this.baseUrl=url;return requestAsync$1(url,{responseType:"json"}).then((function(json){return _this2.processCompositions(json)}),(function(ex){throw Error("load scene fail:"+url)}))}else if(this._json){this.baseUrl=location.href;return Promise.resolve(this.processCompositions(this._json))}return Promise.reject(Error("invalid scene url"))};_proto.loadBinsAsync=function(){var _loadBinsAsync=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var renderLevel;return _regeneratorRuntime().wrap((function _callee2$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:renderLevel=this.options.renderLevel;_context3.next=3;return Promise.all((this._json.bins||[]).map((function(b){if(b instanceof ArrayBuffer){return Promise.resolve(b)}if(passRenderLevel(b.renderLevel,renderLevel)){return requestAsync$1(b.url,{responseType:"arraybuffer"})}return Promise.resolve(undefined)})));case 3:this._loadedBins=_context3.sent;case 4:case"end":return _context3.stop()}}),_callee2,this)})));function loadBinsAsync(){return _loadBinsAsync.apply(this,arguments)}return loadBinsAsync}();_proto.loadImagesAsync=function(){var _loadImagesAsync=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(){var gpu,supportedCompressedTexture,useCompressedTexture,usage,baseUrl,opt,restoreData;return _regeneratorRuntime().wrap((function _callee4$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:gpu=getDefaultGPUCapability();supportedCompressedTexture=gpu.capability.compressedTexture;useCompressedTexture=this.options.useCompressedTexture&&supportedCompressedTexture;usage=this._usedImages;baseUrl=this.baseUrl;opt=this.options;restoreData=this._restoreData;_context5.next=9;return Promise.all(this._json.images.map(function(){var _ref2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(image,index){var imageURL,webpURL,template,result,url,name,replaced,src,bufferURL,ret;return _regeneratorRuntime().wrap((function _callee3$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:if(!usage[index]){_context4.next=59;break}imageURL=new URL(image.url,baseUrl).href;webpURL=image.webp&&new URL(image.webp,baseUrl).href;if(!image.template){_context4.next=36;break}template=image.template;if(!("v"in template&&template.v===2&&template.background)){_context4.next=30;break}url=getBackgroundImage(template,opt.variables);if(!(url instanceof Array)){_context4.next=24;break}name=template.background.name;_context4.prev=9;_context4.next=12;return loadImageWithTypeAsync(url[0]);case 12:replaced=_context4.sent;_context4.next=20;break;case 15:_context4.prev=15;_context4.t0=_context4["catch"](9);_context4.next=19;return loadImageWithTypeAsync(url[1]);case 19:replaced=_context4.sent;case 20:result=replaced;opt.variables[name]=result.url;_context4.next=27;break;case 24:_context4.next=26;return loadImageWithTypeAsync(url);case 26:result=_context4.sent;case 27:if(result.type!=="image/webp"){consoleWarn$1("image "+result.url+" may be replaced by webp format for better network speed,see:https://yuque.antfin.com/huoxing/knaszl/cnotmaqbuk9otp2z");}_context4.next=33;break;case 30:_context4.next=32;return loadWebpOptional(imageURL,webpURL);case 32:result=_context4.sent;case 33:return _context4.abrupt("return",combineImageTemplateAsync(result.image,template,opt.variables,opt,image.oriY===-1).catch((function(){throw Error("image template fail:"+imageURL)})));case 36:if(!(image.type==="video")){_context4.next=40;break}return _context4.abrupt("return",loadVideoAsync(image));case 40:if(!(image.compressed&&useCompressedTexture)){_context4.next=48;break}if(supportedCompressedTexture===2){src=image.compressed.astc;}else if(supportedCompressedTexture===1){src=image.compressed.pvrtc;}if(!src){_context4.next=46;break}bufferURL=new URL(src,baseUrl).href;restoreData[index]={url:bufferURL,type:TextureSourceType.compressed};return _context4.abrupt("return",requestAsync$1(bufferURL,{responseType:"arraybuffer"}).catch((function(){throw Error("compressed texture fail:"+bufferURL)})));case 46:_context4.next=54;break;case 48:if(!(image instanceof MarsTexture)){_context4.next=52;break}return _context4.abrupt("return",undefined);case 52:if(!(image instanceof ImageBitMap||image instanceof HTMLImageElement||image instanceof HTMLCanvasElement||image instanceof HTMLVideoElement)){_context4.next=54;break}return _context4.abrupt("return",Promise.resolve(image));case 54:_context4.next=56;return loadWebpOptional(imageURL,webpURL);case 56:ret=_context4.sent;restoreData[index]={url:ret.url,type:TextureSourceType.image};return _context4.abrupt("return",ret.image);case 59:return _context4.abrupt("return",Promise.resolve(undefined));case 60:case"end":return _context4.stop()}}),_callee3,null,[[9,15]])})));return function(_x2,_x3){return _ref2.apply(this,arguments)}}()));case 9:this._loadedImages=_context5.sent;case 10:case"end":return _context5.stop()}}),_callee4,this)})));function loadImagesAsync(){return _loadImagesAsync.apply(this,arguments)}return loadImagesAsync}();_proto.loadTexturesAsync=function(){var _loadTexturesAsync=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(){var scene,bins,images,restoreData,textures;return _regeneratorRuntime().wrap((function _callee5$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:scene=this._json;if(!scene._textures){_context6.next=3;break}return _context6.abrupt("return",Promise.resolve(this._loadedTextures=scene._textures));case 3:bins=this._loadedBins;images=this._loadedImages;restoreData=this._restoreData;textures=scene.textures||images.map((function(img,source){return {source:source}}));_context6.next=9;return Promise.all(textures.map((function(texOpt,index){if(texOpt.mipmaps){return deserializeMipmapTextureAsync(texOpt,bins,scene.bins).catch((function(ex){throw Error("load texture "+index+" fails")}))}var sourceIndex=texOpt==null?void 0:texOpt.source;var image=images[sourceIndex];if(image){var tex=createOptionsBySource(image,restoreData[index]);return tex.sourceType===TextureSourceType.compressed?tex:Object.assign(tex,texOpt)}throw Error("invalid texture source:"+sourceIndex)})));case 9:this._loadedTextures=_context6.sent;case 10:case"end":return _context6.stop()}}),_callee5,this)})));function loadTexturesAsync(){return _loadTexturesAsync.apply(this,arguments)}return loadTexturesAsync}();_proto.loadPluginAsync=function loadPluginAsync(){var pluginSystem=this._pluginSystem;var scene=this.getLoadedScene();return pluginSystem.loadResourcesAsync(scene,this.options)};_proto.getLoadedScene=function getLoadedScene(){return this._loadedJSON=objAssign({},this._json,{textures:this._loadedTextures,bins:this._loadedBins,storage:{},images:this._loadedImages,pluginSystem:this._pluginSystem,renderLevel:this.options.renderLevel})};_proto.loadSceneAsync=function(){var _loadSceneAsync=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(){var _this3=this;var url,timeLabel,timeout,waitPromise,start,timeInfos,hookTimeInfo,loadResourcePromise;return _regeneratorRuntime().wrap((function _callee8$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:url=this.url;timeLabel="load "+(url||this.id);waitPromise=new Promise((function(resolve,reject){return timeout=setTimeout((function(){reject("load time out:"+url);}),(_this3._timeout||DEFAULT_LOAD_TIMEOUT)*1e3)}));start=Date.now();timeInfos=[];hookTimeInfo=function(){var _ref3=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(promise,label){var st;return _regeneratorRuntime().wrap((function _callee6$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:st=Date.now();_context7.next=3;return promise;case 3:timeInfos.push("["+label+":"+(Date.now()-st)+"]");case 4:case"end":return _context7.stop()}}),_callee6)})));return function hookTimeInfo(_x4,_x5){return _ref3.apply(this,arguments)}}();loadResourcePromise=function(){var _ref4=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(){return _regeneratorRuntime().wrap((function _callee7$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:_context8.prev=0;_context8.next=3;return hookTimeInfo(_this3.loadJSONAsync(),"loadJSON");case 3:_context8.next=5;return hookTimeInfo(_this3.loadBinsAsync(),"loadBins");case 5:_context8.next=7;return hookTimeInfo(_this3.loadImagesAsync(),"loadImages");case 7:_context8.next=9;return hookTimeInfo(_this3.loadTexturesAsync(),"loadTextures");case 9:_context8.next=11;return hookTimeInfo(_this3.loadPluginAsync(),"loadPlugins");case 11:consoleLog$1(timeLabel+": "+(Date.now()-start)+"ms,"+timeInfos.join(" "));clearTimeout(timeout);return _context8.abrupt("return",_this3._loadedJSON);case 16:_context8.prev=16;_context8.t0=_context8["catch"](0);throw Error(_context8.t0);case 19:case"end":return _context8.stop()}}),_callee7,null,[[0,16]])})));return function loadResourcePromise(){return _ref4.apply(this,arguments)}}();_context9.next=9;return Promise.race([waitPromise,loadResourcePromise()]);case 9:return _context9.abrupt("return",_context9.sent);case 10:case"end":return _context9.stop()}}),_callee8,this)})));function loadSceneAsync(){return _loadSceneAsync.apply(this,arguments)}return loadSceneAsync}();return JSONLoader}();var ImageBitMap=window.ImageBitmap||noop;function clonePlainObj(from){if(isObj$1(from)){var ret={};forEach$1(from,(function(val,key){if(val instanceof Array){ret[key]=val.slice();}else if(isObj$1(val)){ret[key]=objAssign({},val);}else {ret[key]=val;}}));return ret}return from}function createOptionsBySource(image,sourceFrom){if(isObj$1(image)){if(image instanceof HTMLImageElement||image instanceof HTMLCanvasElement||image instanceof ImageBitMap){return {image:image,sourceType:TextureSourceType.image,sourceFrom:sourceFrom,keepImageSource:true,minFilter:constants.LINEAR,magFilter:constants.LINEAR}}else if(image instanceof HTMLVideoElement){return {sourceType:TextureSourceType.video,video:image,minFilter:constants.LINEAR,magFilter:constants.LINEAR}}else if(image instanceof ArrayBuffer){return getDefaultTextureFactory().loadCompressedTextureFromArrayBuffer(image,{sourceFrom:sourceFrom})}else if(image.width&&image.height&&image.data){return {sourceType:TextureSourceType.data,data:image,wrapS:constants.CLAMP_TO_EDGE,wrapT:constants.CLAMP_TO_EDGE,minFilter:constants.NEAREST,magFilter:constants.NEAREST}}throw Error("invalid texture options")}}function loadVideoAsync(opt){var video=document.createElement("video");if(isAndroid()){video.setAttribute("renderer","standard");}if(isObj$1(opt.url)){video.srcObject=opt.url;}else {video.src=opt.url;}video.crossOrigin="anonymous";video.muted=true;video.loop=!!opt.loop;video.setAttribute("playsinline","playsinline");return new Promise((function(resolve,reject){var p=video.play();if(p){void p.then((function(){return resolve(video)}));}else {video.addEventListener("loadeddata",(function h(){resolve(video);video.removeEventListener("loadeddata",h);}),true);}video.addEventListener("error",(function(e){reject(Error("load video fail:"+video.src));}));}))}var listOrder=0;function loadSceneAsync(url,opt){return new JSONLoader(url,opt).loadSceneAsync()}function getVFXItem(compositions,id,config,scene){listOrder=0;return _getVFXItem(compositions,id,config||{},scene)}function _getVFXItem(compositions,id,config,scene){var composition=getComposition(compositions,id);if(!composition){throw Error("invalid composition id:"+id)}var endBehavior=composition.endBehavior;var looping;if(config.options){endBehavior=config.options.endBehavior;looping=config.options.looping||endBehavior===5;}if(isNaN(config.mask)){config.mask=0;}var items=[];if(!scene._textures){if(!scene.textures){throw Error("scene.textures expected")}scene._textures=scene.textures.map((function(tex){return tex&&(tex instanceof MarsTexture?tex:new MarsTexture(tex))}));}var plugins=scene.plugins||[];var imageUsage=scene.imgUsage={};var compositionItems=composition.items;compositionItems.forEach((function(item){var opt={};if(item.visible===false){return}var itemType=item.type;var content=opt.content=Object.assign({},item.content);if(content){if(passRenderLevel(item.renderLevel,scene.renderLevel)){opt.type=itemType;var renderContent=opt.content;if(renderContent){if(renderContent.renderer){renderContent.renderer=changeTex(renderContent.renderer);if(!renderContent.renderer.mask){var maskMode=renderContent.renderer.maskMode;if(maskMode===1){renderContent.renderer.mask=++config.mask;}else if(maskMode===2||maskMode===3){renderContent.renderer.mask=config.mask;}}var split=renderContent.splits&&!renderContent.textureSheetAnimation&&renderContent.splits[0];if(Number.isInteger(renderContent.renderer.shape)){renderContent.renderer.shape=getGeometryByShape(scene.shapes[renderContent.renderer.shape],split);}else if(isObj$1(renderContent.renderer.shape)){renderContent.renderer.shape=getGeometryByShape(renderContent.renderer.shape,split);}}else {renderContent.renderer={order:0};}if(renderContent.trails){renderContent.trails=changeTex(renderContent.trails);}if(renderContent.filter){renderContent.filter=objAssign({},renderContent.filter);}}opt.name=item.name;opt.delay=item.delay||0;opt.id=item.id;if(item.parentId){opt.parentId=item.parentId;}opt.refCount=item.refCount;opt.duration=item.duration;opt.listIndex=listOrder++;opt.endBehavior=item.endBehavior;if(item.pluginName){opt.pluginName=item.pluginName;}else if(Number.isInteger(item.pn)){opt.pluginName=plugins[item.pn];}if(item.transform){opt.transform=item.transform;}items.push(opt);}}}));return {id:composition.id,duration:composition.duration,name:composition.name,endBehavior:endBehavior,looping:looping,items:items,camera:composition.camera,startTime:composition.startTime||0};function changeTex(renderer){var val=renderer.texture;var ret=objAssign({},renderer);ret._texture=ret.texture;ret.texture=addTextureUsage(val)||val;return ret}function addTextureUsage(textureIndex){if(Number.isInteger(textureIndex)){var tex=scene._textures[textureIndex];var texId=tex.id;if(!imageUsage.hasOwnProperty(texId)){imageUsage[texId]=0;}imageUsage[texId]++;return tex}}}function getComposition(compositions,id){return compositions.find((function(f){return f.id===id}))}function getCompositionByName(compositions,name){return compositions.find((function(comp){return comp.name===name}))}function getGeometryByShape(shape,uvTransform){var datas=[];var geometries=shape.gs?shape.gs:[shape.g];var indexBase=0;var aPoint=0;var index=0;for(var i=0;i<geometries.length;i++){var geometry=geometries[i];var data=getGeometry2DTriangles(geometry,{indexBase:indexBase,uvTransform:uvTransform});indexBase+=data.aPoint.length/5;datas.push(data);aPoint+=data.aPoint.length;index+=data.index.length;}if(datas.length===1){return datas[0]}var aPointData=new Float32Array(aPoint);var indexData=new Uint16Array(index);for(var _i2=0,pointIndex=0,idx=0;_i2<datas[_i2];_i2++){var _data=datas[_i2];aPointData.set(_data.aPoint,pointIndex);pointIndex+=_data.aPoint.length;indexData.set(_data.index,idx);idx+=_data.index.length;}return {aPoint:aPointData,index:indexData}}function formatMessage(level,msg){var result=["<MARS_PLAYER>","("+level+"):",msg];for(var _len=arguments.length,args=new Array(_len>2?_len-2:0),_key=2;_key<_len;_key++){args[_key-2]=arguments[_key];}args.forEach((function(i){if(typeof i==="string"){result.push(i);}else {result.push(JSON.stringify(i));}}));return result.join(" ")}var nativeLog={_log(type,msg){for(var _len2=arguments.length,args=new Array(_len2>2?_len2-2:0),_key2=2;_key2<_len2;_key2++){args[_key2-2]=arguments[_key2];}console.error(type,msg,args);},androidLog(level,msg){try{var _console;for(var _len3=arguments.length,args=new Array(_len3>2?_len3-2:0),_key3=2;_key3<_len3;_key3++){args[_key3-2]=arguments[_key3];}(_console=console)[level].apply(_console,[msg].concat(args));}catch(e){console.error(e);}},iosLog(level,msg){try{var _console2;for(var _len4=arguments.length,args=new Array(_len4>2?_len4-2:0),_key4=2;_key4<_len4;_key4++){args[_key4-2]=arguments[_key4];}(_console2=console)[level].apply(_console2,[msg].concat(args));var ap=window.AlipayJSBridge;var m=formatMessage.apply(void 0,[level,msg].concat(args));ap&&ap.call("H5APLog",{content:m});}catch(e){console.error(e);}},log(msg){for(var _len5=arguments.length,args=new Array(_len5>1?_len5-1:0),_key5=1;_key5<_len5;_key5++){args[_key5-1]=arguments[_key5];}_log.apply(void 0,["log",msg].concat(args));},info(msg){for(var _len6=arguments.length,args=new Array(_len6>1?_len6-1:0),_key6=1;_key6<_len6;_key6++){args[_key6-1]=arguments[_key6];}_log.apply(void 0,["info",msg].concat(args));},warn(msg){for(var _len7=arguments.length,args=new Array(_len7>1?_len7-1:0),_key7=1;_key7<_len7;_key7++){args[_key7-1]=arguments[_key7];}_log.apply(void 0,["warn",msg].concat(args));},error(msg){for(var _len8=arguments.length,args=new Array(_len8>1?_len8-1:0),_key8=1;_key8<_len8;_key8++){args[_key8-1]=arguments[_key8];}_log.apply(void 0,["error",msg].concat(args));}};var _log=console.error;if(/android/i.test(window.navigator.userAgent)){_log=nativeLog.androidLog;}else {_log=nativeLog.iosLog;}var isIOSSimulator;var deviceName="DESKTOP_DEBUG";var devicePerformance;var isIOS=false;var DEVICE_PERFORMANCE_LOW="low";var DEVICE_PERFORMANCE_MIDDLE="middle";var DEVICE_PERFORMANCE_HIGH="high";var mockIdPass="mock-pass";var mockIdFail="mock-fail";var registered=false;var AlipayDowngradePlugin=function(_MarsPlugin){_inheritsLoose(AlipayDowngradePlugin,_MarsPlugin);function AlipayDowngradePlugin(){return _MarsPlugin.apply(this,arguments)||this}AlipayDowngradePlugin.onPlayerCreated=function onPlayerCreated(player){if(_bizId){return checkDowngradeAsync(_bizId).then((function(result){if(result.downgrade){consoleWarn$1("automatically destroy downgraded player");player.destroy();}}))}};AlipayDowngradePlugin.processRawJSONAsync=function processRawJSONAsync(json,options){return checkDowngradeAsync(options.pluginData["alipayBizId"]||_bizId).then((function(result){if(result.downgrade){throw Error("downgraded "+result.reason)}if(!options.renderLevel){options.renderLevel=getRenderLevelByDevice(options.renderLevel);}}))};return AlipayDowngradePlugin}(MarsPlugin);var _bizId="";function setAlipayDowngradeBizId(bizId,opt){_bizId=bizId;var downgradeWhenGLLost=(opt==null?void 0:opt.ignoreGLLost)!==true;var autoPause=opt==null?void 0:opt.autoPause;if(!registered){registerPlugin("alipay-downgrade",AlipayDowngradePlugin,VFXItem,true);window.addEventListener("unload",(function(){getActivePlayers().forEach((function(player){player.destroy();}));}));window.addEventListener("webglcontextlost",(function(e){if(isCanvasUsedByPlayer(e.target)){if(downgradeWhenGLLost){consoleWarn$1("webgl lost occur,all players will be downgraded from now on");disableAllPlayer(true);getActivePlayers().forEach((function(player){player.destroy();}));}}}),true);if(autoPause){document.addEventListener("pause",pauseAllActivePlayers);document.addEventListener("resume",resumePausedPlayers);}registered=true;inspectLogger(nativeLog.log,nativeLog.warn,nativeLog.error);void getDeviceNameAsync();}}var internalPaused=Symbol("@@_inter_pause");function pauseAllActivePlayers(e){if(e.target===document){consoleLog$1("auto pause all players with data offloaded");var players=getActivePlayers();players.forEach((function(p){if(!p.paused){p.pause({offloadTexture:true});p[internalPaused]=true;}}));}}function resumePausedPlayers(e){if(e.target===document){consoleLog$1("auto resume all players");var players=getActivePlayers();players.forEach((function(p){if(p[internalPaused]){void p.resumeAsync();p[internalPaused]=false;}}));}}function getRenderLevelByDevice(renderLevel){if(renderLevel==="auto"||!renderLevel){if(devicePerformance===DEVICE_PERFORMANCE_HIGH){return "S"}else if(devicePerformance===DEVICE_PERFORMANCE_MIDDLE){return "A"}else if(devicePerformance===DEVICE_PERFORMANCE_LOW){return "B"}return isIOS?"S":"B"}return /[ABS]/.test(renderLevel)?renderLevel:"S"}function checkDowngradeAsync(bizId,opt){if(bizId===mockIdFail||bizId===mockIdPass){return Promise.resolve({downgrade:bizId===mockIdFail,reason:"mock"})}if(isIOSSimulator){return Promise.resolve({downgrade:false,reason:"mock"})}var ap=window.AlipayJSBridge;if(ap){var st=Date.now();return getDeviceNameAsync().then((function(){return new Promise((function(resolve){var techPoint=["mars"];var tc=opt==null?void 0:opt.techPoint;if(tc){techPoint.push.apply(techPoint,tc);}var callBridge=(opt==null?void 0:opt.callBridge)||ap.call;callBridge("getDowngradeResult",{bizId:bizId,scene:0,ext:{techPoint:techPoint}},(function(result){var reason=undefined;consoleLog$1("downgrade time:"+(Date.now()-st)+"ms");if(!result.error){try{var ret=isStr$1(result)?JSON.parse(result):result;if("downgradeResultType"in ret){reason=ret.downgradeResultType;}else if("resultType"in ret){reason=ret.resultType;}if(result.context){var deviceInfo=result.context.deviceInfo;if(deviceInfo){var level=deviceInfo.deviceLevel;if(level===DEVICE_PERFORMANCE_HIGH||level===DEVICE_PERFORMANCE_LOW){devicePerformance=level;}else if(level==="medium"){devicePerformance=DEVICE_PERFORMANCE_MIDDLE;}}}}catch(ex){console.error(ex);}}else {resolve({downgrade:result.error!==4,reason:"api error:"+result.error});}if(reason===undefined){resolve({downgrade:true,reason:"call downgrade fail"});}else {resolve({reason:reason,downgrade:reason===1});}}));}))}))}return Promise.resolve({downgrade:false,reason:"no AP env"})}function getDeviceNameAsync(){if(!devicePending){devicePending=getSystemInfoAsync().then((function(info){if(!devicePerformance){devicePerformance=info.performance;}isIOS=info.platform==="iOS";info.platform;deviceName=info.model||"UNKNOWN_DEVICE";if(/iPhone(\d+),/.test(deviceName)&&!devicePerformance){var gen=+RegExp.$1;if(gen<=9){devicePerformance=DEVICE_PERFORMANCE_LOW;}else if(gen<10){devicePerformance=DEVICE_PERFORMANCE_MIDDLE;}else {devicePerformance=DEVICE_PERFORMANCE_HIGH;}}if(isIOS&&deviceName==="x86_64"){isIOSSimulator=true;}if(deviceName.indexOf(info.brand)===0){deviceName=deviceName.replace(info.brand,"").trim();}return deviceName}),(function(ex){}));}return devicePending.then((function(){return deviceName}),(function(){return deviceName}))}function getSystemInfoAsync(){return new Promise((function(resolve,reject){var ap=window.AlipayJSBridge;if(ap){ap.call("getSystemInfo",(function(e){if(e.error){reject(e);}else {resolve(e);}}));}else {reject("no ap");}}))}var devicePending;var vs$3="\n#version 300 es\nprecision highp float;\n#define SHADER_VERTEX 1\n\n#define SPRITE_SHADER 1\nin vec4 aPoint;in vec2 aIndex;\n#ifdef WEBGL2\nlayout (std140) uniform uMainBlock {\n    uniform mat4 uMainData[MAX_ITEM_COUNT];\n};\nlayout (std140) uniform uTexBlock {\n    uniform vec4 uTexParams[MAX_ITEM_COUNT];//transparentOcclusion blending renderMode\n    uniform vec4 uTexOffset[MAX_ITEM_COUNT];// x y sx sy\n};\n#else\nuniform mat4 uMainData[MAX_ITEM_COUNT];\nuniform vec4 uTexParams[MAX_ITEM_COUNT];//transparentOcclusion blending renderMode\nuniform vec4 uTexOffset[MAX_ITEM_COUNT];// x y sx sy\n//pos v4 xyz\n//size v4 width height life\n//quat v4\n//color v4\n#endif\n\n\n\n\nuniform mat4 uModel;uniform mat4 uView;uniform mat4 uViewProjection;out vec4 vColor;out vec4 vTexCoord;\n#ifdef ADJUST_LAYER\nout vec2 vFeatherCoord;\n#endif\nout highp vec3 vParams;const float a=3.141592653589793/180.;\n#ifdef ENV_EDITOR\nuniform vec4 uEditorTransform;\n#endif\nvec4 filterMain(float b,vec4 c);\n#pragma FILTER_VERT\nvec3 d(vec3 e,vec4 f){vec3 g=f.xyz;vec3 h=cross(g,e);vec3 i=cross(g,h)*2.;return e+(h*2.*f.w+i);}void main(){int index=int(aIndex.x);vec4 j=uTexParams[index];mat4 k=uMainData[index];float l=k[1].z;if(l<0.||l>1.){gl_Position=vec4(3.,3.,3.,1.);}else{vec4 m=k[0];vec2 n=k[1].xy;vec3 o=d(vec3(aPoint.xy*n,0.),k[2]);vec4 p=vec4(m.xyz,1.0);float q=j.z;if(q==0.){p=uModel*p;p.xyz+=uView[0].xyz*o.x+uView[1].xyz*o.y;}else if(q==1.){p.xyz+=o;p=uModel*p;}else if(q==2.){p=uModel*p;p.xy+=o.xy;}else if(q==3.){p=uModel*p;p.xyz+=uView[0].xyz*o.x+uView[2].xyz*o.y;}gl_Position=uViewProjection*p;\n#ifdef ADJUST_LAYER\nvec4 r=filterMain(l,p);\n#endif\ngl_PointSize=6.0;\n#ifdef ENV_EDITOR\ngl_Position=vec4(gl_Position.xy*uEditorTransform.xy+uEditorTransform.zw*gl_Position.w,gl_Position.zw);\n#ifdef ADJUST_LAYER\nr=vec4(r.xy*uEditorTransform.xy+uEditorTransform.zw*r.w,r.zw);\n#endif\n#endif\n#ifdef ADJUST_LAYER\nvTexCoord=vec4(r.xy/r.w+1.,gl_Position.xy/gl_Position.w+1.)/2.;vFeatherCoord=aPoint.zw;\n#else\nvec4 texOffset=uTexOffset[index];vTexCoord=vec4(aPoint.zw*texOffset.zw+texOffset.xy,j.xy);\n#endif\nvColor=k[3];vParams=vec3(aIndex.y,j.y,j.x);}}";var fs$3="precision highp float;\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\nlayout (location = 0) out  vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\n\n\n\nvec4 a(vec4 b,vec4 c,float d){vec4 e=b*c;\n#ifdef PRE_MULTIPLY_ALPHA\nfloat f=c.a;\n#else\nfloat f=e.a;\n#endif\nif(d==1.){e.rgb*=f;}else if(d==2.){e.rgb*=f;e.a=dot(e.rgb,vec3(0.33333333));}else if(d==3.){f=b.r*f;e=vec4(c.rgb*f,f);}return e;}\n#define SPRITE_SHADER 1\nin vec4 vColor;in vec4 vTexCoord;in highp vec3 vParams;\n#ifdef ADJUST_LAYER\nuniform sampler2D uSamplerPre;vec4 filterMain(vec2 g,sampler2D h);in vec2 vFeatherCoord;uniform sampler2D uFeatherSampler;\n#endif\nuniform sampler2D uSampler0;uniform sampler2D uSampler1;uniform sampler2D uSampler2;uniform sampler2D uSampler3;uniform sampler2D uSampler4;uniform sampler2D uSampler5;uniform sampler2D uSampler6;uniform sampler2D uSampler7;\n#if MAX_FRAG_TEX == 16\nuniform sampler2D uSampler8;uniform sampler2D uSampler9;uniform sampler2D uSampler10;uniform sampler2D uSampler11;uniform sampler2D uSampler12;uniform sampler2D uSampler13;uniform sampler2D uSampler14;uniform sampler2D uSampler15;\n#endif\nvec4 texture2DbyIndex(float i,vec2 g);\n#pragma FILTER_FRAG\n\n#ifndef WEBGL2\n\n#define round(a) floor(0.5+a)\n\n#endif\nvoid main(){vec4 b=vec4(0.);\n#ifdef ADJUST_LAYER\nvec2 j=abs(vFeatherCoord-vec2(0.5))/0.5;float k=sqrt(max(j.x,j.y));float l=vColor.a*texture2D(uFeatherSampler,vec2(k,0.)).r;if(l>=1.){b=filterMain(vTexCoord.xy,uSamplerPre);}else if(l<=0.){b=texture2D(uSamplerPre,vTexCoord.zw);}else{b=mix(texture2D(uSamplerPre,vTexCoord.zw),filterMain(vTexCoord.xy,uSamplerPre),l);}\n#else\nvec4 m=texture2DbyIndex(round(vParams.x),vTexCoord.xy);b=a(m,vColor,round(vParams.y));if(vParams.z==0.&&b.a<0.04){discard;}\n#endif\nfragColor=b;}vec4 texture2DbyIndex(float i,vec2 g){\n#ifndef ADJUST_LAYER\nif(i==0.){return texture2D(uSampler0,g);}if(i==1.){return texture2D(uSampler1,g);}if(i==2.){return texture2D(uSampler2,g);}if(i==3.){return texture2D(uSampler3,g);}if(i==4.){return texture2D(uSampler4,g);}if(i==5.){return texture2D(uSampler5,g);}if(i==6.){return texture2D(uSampler6,g);}if(i==7.){return texture2D(uSampler7,g);}\n#if MAX_FRAG_TEX == 16\nif(i==8.){return texture2D(uSampler8,g);}if(i==9.){return texture2D(uSampler9,g);}if(i==10.){return texture2D(uSampler10,g);}if(i==11.){return texture2D(uSampler11,g);}if(i==12.){return texture2D(uSampler12,g);}if(i==13.){return texture2D(uSampler13,g);}if(i==14.){return texture2D(uSampler14,g);}if(i==15.){return texture2D(uSampler15,g);}\n#endif\nreturn texture2D(uSampler0,g);\n#else\nreturn vec4(0.);\n#endif\n}";var frameFS="precision highp float;\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\nlayout (location = 0) out  vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\n\n\n\nvec4 a(vec4 b,vec4 c,float d){vec4 e=b*c;\n#ifdef PRE_MULTIPLY_ALPHA\nfloat f=c.a;\n#else\nfloat f=e.a;\n#endif\nif(d==1.){e.rgb*=f;}else if(d==2.){e.rgb*=f;e.a=dot(e.rgb,vec3(0.33333333));}else if(d==3.){f=b.r*f;e=vec4(c.rgb*f,f);}return e;}in vec4 vColor;in vec4 vTexCoord;in highp vec2 vParams;uniform vec3 uFrameColor;void main(){fragColor=vec4(uFrameColor.xyz,1.0);}";var tempRot$2=[];function calculateTranslation(out,target,acc,time,duration,posData,velData,posStartIndex,velStartIndex){var ret=out;var lifetime=time/duration;var speedIntegrate=time;var speedOverLifetime=target.speedOverLifetime;if(speedOverLifetime){speedIntegrate=speedOverLifetime.getIntegrateValue(0,time,duration);}var d=target.gravityModifier?target.gravityModifier.getIntegrateByTime(0,time):0;posStartIndex=posStartIndex||0;velStartIndex=velStartIndex||0;for(var i=0;i<3;i++){ret[i]=posData[posStartIndex+i]+velData[velStartIndex+i]*speedIntegrate+acc[i]*d;}var linearVelocityOverLifetime=target.linearVelOverLifetime||{};var orbVelOverLifetime=target.orbitalVelOverLifetime||{};var map=["x","y","z"];if(orbVelOverLifetime.enabled){var center=orbVelOverLifetime.center||[0,0,0];var pos=[ret[0]-center[0],ret[1]-center[1],ret[2]-center[2]];var asRotation=orbVelOverLifetime.asRotation;var rot=vec3MulMat3(pos,pos,mat3FromRotation(tempRot$2,map.map((function(pro){var value=orbVelOverLifetime[pro];if(value){return asRotation?value.getValue(lifetime):value.getIntegrateValue(0,time,duration)}return 0}))));ret=vecAdd(ret,center,rot);}if(linearVelocityOverLifetime.enabled){var asMovement=linearVelocityOverLifetime.asMovement;for(var _i2=0;_i2<3;_i2++){var pro=linearVelocityOverLifetime[map[_i2]];if(pro){ret[_i2]+=asMovement?pro.getValue(lifetime):pro.getIntegrateValue(0,time,duration);}}}return ret}var particleOriginMap={[0]:translatePoint(0,0)};function translatePoint(x,y){var origin=[-.5,.5,-.5,-.5,.5,.5,.5,-.5];for(var i=0;i<8;i+=2){origin[i]+=x;origin[i+1]+=y;}return origin}var maxSpriteTextureCount=8;function setSpriteMeshMaxItemCountByGPU(gpu){maxSpriteTextureCount=Math.min(gpu.capability.maxFragmentTextures,16);if(gpu.capability.maxVertexUniforms>=256){return maxSpriteMeshItemCount=32}else if(gpu.capability.maxVertexUniforms>=128){return maxSpriteMeshItemCount=16}maxSpriteTextureCount=8;}function getImageItemRenderInfo(item){var _item$filter,_item$filter$mesh;var renderer=item.renderer;var blendingCache=+renderer.blending;var cachePrefix=(item.cachePrefix||0)+"";var filterId=((_item$filter=item.filter)==null?void 0:(_item$filter$mesh=_item$filter.mesh)==null?void 0:_item$filter$mesh.shaderCacheId)||"$F$";return {side:renderer.side,occlusion:renderer.occlusion,blending:renderer.blending,mask:renderer.mask,maskMode:renderer.maskMode,cachePrefix:cachePrefix,filter:item.filter,cacheId:cachePrefix+"."+filterId+"."+ +renderer.side+"+"+ +renderer.occlusion+"+"+blendingCache+"+"+renderer.order+"+"+renderer.maskMode+"."+renderer.mask}}var spriteReleasableData=true;var maxSpriteMeshItemCount=8;var seed$3=1;function spriteMeshShaderIdFromRenderInfo(renderInfo,count){return renderInfo.filter?renderInfo.filter.mesh.shaderCacheId+"_mars_filter":renderInfo.cachePrefix+"_mars_sprite_"+count}function spriteMeshShaderFromFilter(filter,options){options=options||{count:2,env:""};var marcos=[["MAX_ITEM_COUNT",options.count||2],["PRE_MULTIPLY_ALPHA",false],["ENV_EDITOR",options.env==="editor"],["ADJUST_LAYER",!!filter],["USE_BLEND",!options.ignoreBlend],["MAX_FRAG_TEX",maxSpriteTextureCount>=16?16:8]];var fragment=options.wireframe?frameFS:fs$3.replace(/#pragma\s+FILTER_FRAG/,(filter==null?void 0:filter.mesh.fragment)||"");var vertex=vs$3.replace(/#pragma\s+FILTER_VERT/,(filter==null?void 0:filter.mesh.vertex)||"vec4 filterMain(float t,vec4 pos){return uViewProjection * pos;}");return {fragment:fragment,vertex:vertex,marcos:marcos,shared:true,downgrade:true}}function spriteMeshShaderFromRenderInfo(renderInfo,count){var shader=spriteMeshShaderFromFilter(renderInfo.filter,{env:renderInfo.env,count:count,wireframe:renderInfo.wireframe});shader.shared=true;if(!renderInfo.wireframe){shader.cacheId=spriteMeshShaderIdFromRenderInfo(renderInfo,count);}return shader}var SpriteMesh=function(){function SpriteMesh(renderInfo,calculateGroup){var BYTES_PER_ELEMENT=Float32Array.BYTES_PER_ELEMENT;this.mesh=new MarsMesh({name:"MSprite"+seed$3++,priority:0,geometry:new MarsGeometry({attributes:{aPoint:{size:4,offset:0,stride:6*BYTES_PER_ELEMENT,releasable:spriteReleasableData,type:constants.FLOAT,data:new Float32Array(0)},aIndex:{size:2,offset:4*BYTES_PER_ELEMENT,stride:6*BYTES_PER_ELEMENT,dataSource:"aPoint",type:constants.FLOAT}},index:{data:new Uint16Array(0),releasable:spriteReleasableData},mode:renderInfo.wireframe?constants.LINES:constants.TRIANGLES}),worldMatrix:mat4create(),material:this.createMaterial(renderInfo,2)});this.items=[];this.isSpriteMesh=true;this.renderCacheId=renderInfo.cacheId;this._isDirty=false;this.maxItemCount=maxSpriteMeshItemCount;this._wireframe=renderInfo.wireframe;this.calculateGroup=calculateGroup;}var _proto=SpriteMesh.prototype;_proto.createMaterial=function createMaterial(renderInfo,count){var _renderInfo$filter;var filterMesh=((_renderInfo$filter=renderInfo.filter)==null?void 0:_renderInfo$filter.mesh)||{};var db=this.mainDataBlock=new MarsMaterialDataBlock({name:"uMainBlock",uniformValues:{uMainData:new Float32Array(16*count)}});var db2=this.texDataBlock=new MarsMaterialDataBlock({name:"uTexBlock",uniformValues:{uTexParams:new Float32Array(4*count),uTexOffset:new Float32Array(4*count)}});var mtl={shader:spriteMeshShaderFromRenderInfo(renderInfo,count),states:_extends({},sideToMtlStates(renderInfo.side),{depthTest:true,depthMask:!!renderInfo.occlusion}),uniformSemantics:_extends({uViewProjection:"VIEWPROJECTION",uView:"VIEWINVERSE",uModel:"MODEL",uEditorTransform:"EDITOR_TRANSFORM",uSamplerPre:"PRE_MAIN_COLOR_0"},filterMesh.uniformSemantics),uniformValues:_extends({},filterMesh.uniformValues)};this._preMultiAlpha=setMtlBlending(renderInfo.blending,mtl.states);setMtlStencil(renderInfo.maskMode,renderInfo.mask,mtl.states);Object.assign(mtl.states,filterMesh.materialStates);this._mtlSlotCount=count;var ret=new MarsMaterial(mtl);ret.addDataBlock(db);ret.addDataBlock(db2);return ret};_proto.setItems=function setItems(items){var _renderInfo$filter2,_renderInfo$filter2$p;var aPointLen=0;var indexLen=0;var pointCount=0;if(!items.length){return this.mesh.hide=true}var datas=[];this.items=items.slice();var textures=[];var itemSlot=2;if(items.length>2){itemSlot=maxSpriteMeshItemCount;}var renderInfo=items[0].renderInfo;if(this._mtlSlotCount!==itemSlot){this.mesh.setMaterial(this.createMaterial(renderInfo,itemSlot),{textures:DestroyOptions.keep});}this.splitLayer=((_renderInfo$filter2=renderInfo.filter)==null?void 0:(_renderInfo$filter2$p=_renderInfo$filter2.passSplitOptions.attachments)==null?void 0:_renderInfo$filter2$p.length)>0;for(var i=0;i<items.length;i++){var item=items[i];var texture=item==null?void 0:item.renderer.texture;if(texture){arrAdd$1(textures,texture);}item.mesh=this;}for(var _i2=0;_i2<items.length;_i2++){var _item=items[_i2];var _texture=_item==null?void 0:_item.renderer.texture;var textureIndex=_texture?textures.indexOf(_texture):-1;var data=this.getItemInitData(_item,_i2,pointCount,textureIndex);aPointLen+=data.aPoint.length;indexLen+=data.index.length;datas.push(data);pointCount+=data.aPoint.length/6;this.updateItem(_item,true);}var bundle={aPoint:new Float32Array(aPointLen),index:new Uint16Array(indexLen)};var cursor={aPoint:0,index:0};var _loop=function _loop(){var data=datas[_i3];forEach$1(bundle,(function(arr,name){var ta=data[name];arr.set(ta,cursor[name]);cursor[name]+=ta.length;}));};for(var _i3=0;_i3<datas.length;_i3++){_loop();}var mesh=this.mesh;var mtl=mesh.material;var geometry=mesh.geometries[0];var indexData=bundle.index;geometry.setIndexData(indexData);geometry.setAttributeData("aPoint",bundle.aPoint);geometry.drawCount=indexLen;mesh.hide=!geometry.drawCount;mesh.priority=items[0].listIndex;for(var _i5=0;_i5<textures.length;_i5++){var _texture2=textures[_i5];mtl.defaultDataBlock.setUniformValue("uSampler"+_i5,_texture2);}for(var k=textures.length;k<maxSpriteMeshItemCount;k++){var name="uSampler"+k;if(mtl.defaultDataBlock.getUniformValue(name)){mtl.defaultDataBlock.setUniformValue(name,undefined);}}if(this.splitLayer){var feather=items[0].feather;var tex;if(!feather){tex=createDataTexture();}else {var len=128;var _data=new Uint8Array(len);for(var _i7=0,s=len-1;_i7<len;_i7++){var p=_i7/s;var _val=feather.getValue(p);_data[_i7]=Math.round(_val*255);}tex=createDataTexture({width:len,height:1,data:_data},{name:"feather",format:constants.LUMINANCE,minFilter:constants.LINEAR,magFilter:constants.LINEAR,wrapS:constants.CLAMP_TO_EDGE,wrapT:constants.CLAMP_TO_EDGE});}mtl.defaultDataBlock.setUniformValue("uFeatherSampler",tex);}};_proto.destroy=function destroy(){this.mesh.destroy({material:{textures:DestroyOptions.keep}});};_proto.getItemInitData=function getItemInitData(item,idx,pointStartIndex,textureIndex){var geoData=item.__geoData;if(this.lineMode){geoData=this._getItemGeometryData(item,idx);}else if(!geoData){geoData=item.__geoData=this._getItemGeometryData(item,idx);}var pointData=geoData.aPoint;if(pointData[4]!==idx||pointData[5]!==textureIndex){for(var i=0;i<pointData.length;i+=6){pointData[i+4]=idx;pointData[i+5]=textureIndex;}}var index=geoData.index;var idxCount=index.length;var indexData=this._wireframe?new Uint8Array([0,1,1,3,2,3,2,0]):new index.constructor(idxCount);if(!this._wireframe){for(var _i9=0;_i9<idxCount;_i9++){indexData[_i9]=pointStartIndex+index[_i9];}}return {aPoint:geoData.aPoint,index:indexData}};_proto._getItemGeometryData=function _getItemGeometryData(item,aIndex){var splits=item.splits;var renderer=item.renderer;var textureSheetAnimation=item.textureSheetAnimation;var _item$startSize=item.startSize,sx=_item$startSize[0],sy=_item$startSize[1];item.fallbackAnchor();var _item$_anchor=item._anchor,anchorX=_item$_anchor[0],anchorY=_item$_anchor[1];if(renderer.shape){var _aPoint=new Float32Array(renderer.shape.aPoint);for(var i=0;i<_aPoint.length;i+=6){_aPoint[i]*=sx;_aPoint[i+1]*=sy;}return {index:renderer.shape.index,aPoint:_aPoint}}var originData=particleOriginMap[0];var col=2,row=2;var dx=0,dy=0;if(splits.length===1){col=1;row=1;}var aPoint=[];var eleIndex=[];for(var x=0;x<col;x++){for(var y=0;y<row;y++){var index=y*2+x;var split=textureSheetAnimation?[0,0,1,1,splits[0][4]]:splits[y*2+x];var texOffset=split[4]?[0,0,1,0,0,1,1,1]:[0,1,0,0,1,1,1,0];var dw=((x+x+1)/col-1)/2;var dh=((y+y+1)/row-1)/2;var tox=split[0];var toy=split[1];var tsx=split[4]?split[3]:split[2];var tsy=split[4]?split[2]:split[3];var origin=[(originData[0]+dx)/col+dw,(originData[1]+dy)/row+dh,(originData[2]+dx)/col+dw,(originData[3]+dy)/row+dh,(originData[4]+dx)/col+dw,(originData[5]+dy)/row+dh,(originData[6]+dx)/col+dw,(originData[7]+dy)/row+dh];aPoint.push((origin[0]-anchorX)*sx,(origin[1]-anchorY)*sy,texOffset[0]*tsx+tox,texOffset[1]*tsy+toy,aIndex,0,(origin[2]-anchorX)*sx,(origin[3]-anchorY)*sy,texOffset[2]*tsx+tox,texOffset[3]*tsy+toy,aIndex,0,(origin[4]-anchorX)*sx,(origin[5]-anchorY)*sy,texOffset[4]*tsx+tox,texOffset[5]*tsy+toy,aIndex,0,(origin[6]-anchorX)*sx,(origin[7]-anchorY)*sy,texOffset[6]*tsx+tox,texOffset[7]*tsy+toy,aIndex,0);var base=index*4;if(this.lineMode){eleIndex.push(base,1+base,1+base,3+base,3+base,2+base,2+base,base);}else {eleIndex.push(base,1+base,2+base,2+base,1+base,3+base);}}}return {index:eleIndex,aPoint:aPoint}};_proto.setItemInitData=function setItemInitData(data,geoStartIndex){var geo=this.mesh.geometries[0];geo.setAttributeSubData("aPoint",geoStartIndex*20,data.aPoint);geo.setIndexSubData(geoStartIndex*6,data.index);};_proto.getItemRenderData=function getItemRenderData(item){return this.getItemRegionData(item)};_proto.getItemRegionData=function getItemRegionData(item){var index=this.items.indexOf(item);if(index>-1){var mainData=this.mainDataBlock.getUniformValue("uMainData");var idx=index*16;return {position:[mainData[idx]||0,mainData[idx+1]||0,mainData[idx+2]||0],size:[mainData[idx+4],mainData[idx+5]],quat:[mainData[idx+8],mainData[idx+9],mainData[idx+10],mainData[idx+11]],color:[mainData[idx+12],mainData[idx+13],mainData[idx+14],mainData[idx+15]]}}};_proto.updateItem=function updateItem(item,init){var index=this.items.indexOf(item);if(index>-1){this.items.length;var texDb=this.texDataBlock;var parentData;var texData=texDb.getUniformValue("uTexParams");var idxStart=index*4;if(this.calculateGroup){parentData=this.calculateGroup.getRenderData(item.parentId);}var selfData=item.getRenderData(item.time,init||parentData);parentData=parentData||emptyObj;var byteStart=index*Float32Array.BYTES_PER_ELEMENT*16;var rowLen=Float32Array.BYTES_PER_ELEMENT*4;var mainData=this.mainDataBlock.getUniformValue("uMainData").buffer;var uPos=new Float32Array(mainData,byteStart,4);byteStart+=rowLen;var uSize=new Float32Array(mainData,byteStart,4);byteStart+=rowLen;var uQuat=new Float32Array(mainData,byteStart,4);byteStart+=rowLen;var uColor=new Float32Array(mainData,byteStart,4);if(parentData.hide||selfData.hide){return uSize[2]=-1}selfData.transform.getWorldTRS(uPos,uQuat,uSize);vecMulCombine(uColor,selfData.color,parentData.color);this.mainDataBlock.updateUniformSubData("uMainData",index,1);uSize[2]=selfData.life;if(init){var renderer=item.renderer;texData[idxStart]=renderer.occlusion?+renderer.transparentOcclusion:1;texData[idxStart+2]=renderer.renderMode;texData[idxStart+1]=+this._preMultiAlpha;texDb.updateUniformSubData("uTexParams",index,1);}if(selfData.texOffset){var texOffsetData=texDb.getUniformValue("uTexOffset");texOffsetData.set(selfData.texOffset,index*4);texDb.updateUniformSubData("uTexOffset",index,1);}}};_proto.removeItem=function removeItem(item){var index=this.items.indexOf(item);if(index>-1){this.items.splice(index,1);item.__geoData=null;this._isDirty=true;}};_proto.addItem=function addItem(item){if(this.itemCount<this.maxItemCount){var itemIndex=0;var items=this.items;for(var i=0;i<items.length;i++){var cur=items[i];if(cur.listIndex<=item.listIndex){itemIndex++;}else {break}}this._isDirty=true;items.splice(itemIndex,0,item);return itemIndex}};_proto.applyChange=function applyChange(){if(this._isDirty){this.setItems(this.items);this._isDirty=false;}};_createClass(SpriteMesh,[{key:"itemCount",get:function get(){return this.items.length}},{key:"availableItemCount",get:function get(){return maxSpriteMeshItemCount-this.itemCount}},{key:"listIndexStart",get:function get(){return this.items.length?this.items[0].listIndex:-1}},{key:"listIndexEnd",get:function get(){var len=this.items.length;return len>0?this.items[len-1].listIndex:-1}}]);return SpriteMesh}();var emptyObj={};var Ticker=function(){function Ticker(fps){this._paused=true;this._lastTime=0;this.fps=fps||60;this._tickers=[];}var _proto=Ticker.prototype;_proto.start=function start(){var _this=this;this._paused=false;if(!this._intervalId){this._lastTime=+new Date;var raf=requestAnimationFrame||function(func){return setTimeout(func,16)};var runLoop=function runLoop(){_this._intervalId=raf(runLoop);if(!_this._paused){_this._tick();}};runLoop();}};_proto.stop=function stop(){(cancelAnimationFrame||clearTimeout)(this._intervalId);this._intervalId=null;this._lastTime=0;this._paused=true;this._tickers=[];};_proto.pause=function pause(){this._paused=true;};_proto.resume=function resume(){this._paused=false;};_proto._tick=function _tick(){if(this._paused){return}var startTime=Date.now();var deltaTime=startTime-this._lastTime;if(deltaTime>=this._interval){this._lastTime=startTime;var tickers=this._tickers;if(this._resetTickers){tickers=this._tickers=tickers.filter((function(t){return t&&t.tick}));this._resetTickers=false;}for(var i=0,len=tickers.length;i<len;i++){var t=tickers[i];if(t){t.tick(deltaTime);}}}};_proto.addTicker=function addTicker(tickObject){if(!tickObject||typeof tickObject.tick!="function"){throw new Error("Ticker: The tick object must implement the tick method.")}this._tickers.push(tickObject);};_proto.removeTicker=function removeTicker(tickObject){var tickers=this._tickers,index=tickers.indexOf(tickObject);if(index>=0){tickers[index]=null;this._resetTickers=true;}};_proto.nextTick=function nextTick(callback){var _this2=this;var tickObj={tick:function tick(dt){_this2.removeTicker(tickObj);callback(dt);}};this.addTicker(tickObj);return tickObj};_createClass(Ticker,[{key:"fps",get:function get(){return this._targetFPS},set:function set(fps){this._targetFPS=clamp(fps,1,120);this._interval=Math.floor(1e3/fps)-1;}},{key:"paused",get:function get(){return this._paused}}]);return Ticker}();var EVENT_TYPE_CLICK="click";var EVENT_TYPE_TOUCH_START="touchstart";var EVENT_TYPE_TOUCH_MOVE="touchmove";var EVENT_TYPE_TOUCH_END="touchend";var EventSystem=function(){function EventSystem(target,player){this._enabled=true;this._handlerMap={};this._nativeHandlers={};this._target=target;this.player=player;}var _proto=EventSystem.prototype;_proto.watchEvents=function watchEvents(){var _this=this;var x,y;var currentTouch;var target=this._target;var player=this.player;var lastTouch;{var getTouch=function getTouch(e){return e};var touchstart="mousedown";var touchmove="mousemove";var touchend="mouseup";if(isSimulatorCellPhone()){getTouch=function getTouch(e){return e.touches[0]||e.changedTouches[0]};touchstart="touchstart";touchmove="touchmove";touchend="touchend";}this._nativeHandlers={[touchstart]:function(e){if(_this._enabled){var touch=getTouch(e);getCoord(touch);lastTouch=currentTouch={clientX:touch.clientX,clientY:touch.clientY,ts:Date.now(),x:x,y:y};_this.dispatchEvent(EVENT_TYPE_TOUCH_START,genArg(e,x,y));}},[touchmove]:function(e){if(currentTouch&&_this._enabled){getCoord(getTouch(e));_this.dispatchEvent(EVENT_TYPE_TOUCH_MOVE,genArg(e,x,y,x-currentTouch.x,y-currentTouch.y));}},[touchend]:function(e){if(currentTouch&&_this._enabled){var touch=getTouch(e);getCoord(touch);var dt=Math.abs(currentTouch.clientX-touch.clientX)+Math.abs(currentTouch.clientY-touch.clientY);if(dt<4){_this.dispatchEvent(EVENT_TYPE_CLICK,genArg(e,x,y));}_this.dispatchEvent(EVENT_TYPE_TOUCH_END,genArg(e,x,y,x-currentTouch.x,y-currentTouch.y));}currentTouch=0;}};forEach$1(this._nativeHandlers,(function(func,name){target.addEventListener(name,func);}));}return this;function genArg(e,x,y,dx,dy){if(dx===void 0){dx=0;}if(dy===void 0){dy=0;}var vx=0;var vy=0;var timestamp=Date.now();if(lastTouch){var dt=timestamp-lastTouch.ts;vx=(dx-lastTouch.dx)/dt||0;vy=(dy-lastTouch.dy)/dt||0;lastTouch={dx:dx,dy:dy,ts:timestamp};}return {x:x,y:y,vx:vx,vy:vy,ts:timestamp,dx:dx,dy:dy,player:player,width:target.width,height:target.height,origin:e}}function getCoord(e){var ele=e.target;var bounding=ele.getBoundingClientRect();x=(e.clientX-bounding.left)/bounding.width*2-1;y=1-(e.clientY-bounding.top)/bounding.height*2;}};_proto.dispatchEvent=function dispatchEvent(type,e){var hs=this._handlerMap[type];if(hs){for(var i=0;i<hs.length;i++){hs[i](e);}}};_proto.addEventListener=function addEventListener(type,handler){var hs=this._handlerMap[type];if(!hs){hs=this._handlerMap[type]=[];}arrAdd$1(hs,handler);return function(){arrRemove$1(hs,handler);}};_proto.removeEventListener=function removeEventListener(type,handler){var hs=this._handlerMap[type];if(hs){arrRemove$1(hs,handler);}};_proto.destroy=function destroy(){if(this._target){this._handlerMap={};this.player=null;var target=this._target;forEach$1(this._nativeHandlers,(function(func,name){target.removeEventListener(name,func);}));this._nativeHandlers={};this._target=null;}};_createClass(EventSystem,[{key:"enabled",get:function get(){return this._enabled},set:function set(t){this._enabled=!!t;}}]);return EventSystem}();var helpLink="https://yuque.antfin.com/huoxing/knaszl/qtnsf2g9ofigggor#MvjnY";var playerMap=new Map;var _disableAllPlayer=false;function disableAllPlayer(disable){_disableAllPlayer=!!disable;}function isCanvasUsedByPlayer(canvas){return playerMap.has(canvas)}function getPlayerByCanvas(canvas){return playerMap.get(canvas)}function getActivePlayers(){return Array.from(playerMap.values())}var seed$2=1;var MarsPlayer=function(){function MarsPlayer(options){var _this=this;this.pausePlayer=function(item){if(_this.pause()){_this.onPausedByItem({name:item.name,player:_this});}};this._onClick=function(e){var x=e.x,y=e.y;_this.compositions.forEach((function(comp){var regions=comp.hitTest(x,y);if(regions.length){for(var i=0;i<regions.length;i++){var region=regions[i];var b=region.behavior||HitTestBehavior.notify;if(b===HitTestBehavior.notify){_this.onItemClicked({name:region.name,player:_this,composition:comp.name,id:region.id,compositionId:comp.id,hitPositions:region.hitPositions});}else if(b===HitTestBehavior.resume){_this.resumeAsync().catch(consoleError$1);}}}}));};this._onResume=function(){_this.onPlayableUpdate({player:_this,playing:true});};var canvas;this.pixelRatio=Number.isFinite(options.pixelRatio)?options.pixelRatio:getPixelRatio();this._offscreenMode=true;var renderFramework=options.renderFramework||(isAndroid()?"webgl":"webgl2");var webglType=_disableAllPlayer?"debug-disable":renderFramework;var gl=options.gl;if(options.canvas){{canvas=options.canvas;}}else if(gl){canvas=gl.canvas;}else {var container=options.container;{assertContainer(container);canvas=document.createElement("canvas");container.appendChild(canvas);}}var onWebGLContextLost=isFunc$1(options.onWebGLContextLost)?options.onWebGLContextLost:noop;this._onWebGLContextLost=function(e){consoleWarn$1("Automatically destroy player due to context lost");_this.destroy(true);onWebGLContextLost(_this,e.target);};canvas.addEventListener("webglcontextlost",this._onWebGLContextLost);this.canvas=canvas;this.env=options.env||"";this._reportGPUTime=options.reportGPUTime;var frameworks=webglType==="webgl"?[webglType]:["webgl2","webgl"];if(webglType==="debug-disable"){frameworks=[];}this.renderer=gl?new MarsRenderer({gl:gl}):new MarsRenderer({canvas:canvas,frameworks:frameworks,willCaptureImage:options.willCaptureImage,premultiplyAlpha:options.premultiplyAlpha});this._clearPipeline=new MarsRenderFrame({clearAction:{stencilAction:TextureLoadAction.clear,clearStencil:0,depthAction:TextureLoadAction.clear,clearDepth:1,colorAction:TextureLoadAction.clear,clearColor:[0,0,0,0]}},this.renderer);if(!options.manualRender){var ticker=this.ticker=new Ticker(options.fps||60);ticker.addTicker(this);}this.event=new EventSystem(canvas,this).watchEvents();this.event.addEventListener(EVENT_TYPE_CLICK,this._onClick);this.interactive=options.interactive;this.name=options.name||seed$2+++"";if(!gl&&webglType!=="debug-disable"){this.resize();}setSpriteMeshMaxItemCountByGPU(this.renderer.gpu);if(isFunc$1(options.onPlayableUpdate)){this.onPlayableUpdate=options.onPlayableUpdate;}if(isFunc$1(options.onPausedByItem)){this.onPausedByItem=options.onPausedByItem;}if(isFunc$1(options.onItemClicked)){this.onItemClicked=options.onItemClicked;}if(isFunc$1(options.onMessageItem)){this.onMessageItem=options.onMessageItem;}if(isFunc$1(options.onRenderError)){this.onRenderError=options.onRenderError;}this.compositions=[];this.container=canvas.parentElement;playerMap.set(canvas,this);assertNoConcurrentPlayers();broadcastPlayerEvent(this,true);}var _proto=MarsPlayer.prototype;_proto.snapshot=function snapshot(options){throw new Error("Method not implemented.")};_proto.resizeToAspect=function resizeToAspect(aspect,scale){scale=scale||1;if(aspect!==this.displayAspect||scale!==this.displayScale){this.displayAspect=aspect;this.displayScale=scale;}this.resize();};_proto._getTargetSize=function _getTargetSize(parentEle){assertContainer(parentEle);var targetWidth;var targetHeight;var displayAspect=this.displayAspect;if(displayAspect){var pAspect=parentEle.clientWidth/parentEle.clientHeight;if(pAspect>displayAspect){targetHeight=parentEle.clientHeight*this.displayScale;targetWidth=targetHeight*displayAspect;}else {targetWidth=parentEle.clientWidth*this.displayScale;targetHeight=targetWidth/displayAspect;}}else {targetWidth=parentEle.clientWidth;targetHeight=parentEle.clientHeight;}var ratio=this.pixelRatio;var containerWidth=targetWidth;var containerHeight=targetHeight;targetWidth=Math.round(targetWidth*ratio);targetHeight=Math.round(targetHeight*ratio);if(targetHeight<1||targetHeight<1){if(this._offscreenMode){targetWidth=targetHeight=containerWidth=containerHeight=1;}else {throw Error("Invalid container size "+targetWidth+"x"+targetHeight+", see "+helpLink)}}return [containerWidth,containerHeight,targetWidth,targetHeight]};_proto.resize=function resize(){var parentEle=this.canvas.parentElement;var containerWidth;var containerHeight;var cvsWidth;var cvsHeight;if(parentEle){var size=this._getTargetSize(parentEle);containerWidth=size[0];containerHeight=size[1];cvsWidth=size[2];cvsHeight=size[3];}else {containerWidth=cvsWidth=this.canvas.width;containerHeight=cvsHeight=this.canvas.height;}var aspect=containerWidth/containerHeight;if(containerWidth&&containerHeight){var _this$compositions;{var dw=document.documentElement.clientWidth;if(cvsWidth>dw*2){consoleError$1("DPI overflowed, width "+cvsWidth+" is more than 2x document width "+dw+", see "+helpLink);}var maxSize=this.env?this.renderer.gpu.capability.maxTextureSize:2048;if(cvsWidth>maxSize||cvsHeight>maxSize){consoleError$1("Container size overflowed "+cvsWidth+"x"+cvsHeight+", see "+helpLink);if(aspect>1){cvsWidth=Math.round(maxSize);cvsHeight=Math.round(maxSize/aspect);}else {cvsHeight=Math.round(maxSize);cvsWidth=Math.round(maxSize*aspect);}}}this.renderer.resize(cvsWidth,cvsHeight);this.canvas.style.width=containerWidth+"px";this.canvas.style.height=containerHeight+"px";consoleLog$1("Resize player "+this.name+" ["+cvsWidth+","+cvsHeight+","+containerWidth+","+containerHeight+"].");(_this$compositions=this.compositions)==null?void 0:_this$compositions.forEach((function(comp){comp.camera={aspect:aspect};}));}};_proto._tick=function _tick(dt,forceRender){{dt=Math.min(dt,33);}var removed=false;var comps=this.compositions;var skipRender=false;for(var i=0;i<comps.length;i++){var _comp=comps[i];if(_comp._textureOffloaded){skipRender=true;consoleError$1("Composition "+_comp.name+" texture offloaded, skip render.");}if(_comp.renderer){_comp.tick(dt);}if(!_comp.renderer){comps[i]=null;removed=true;}}if(removed){comps=comps.filter((function(comp){return comp}));this.compositions=comps;}if(skipRender){var _this$ticker;this.onRenderError(this,new Error("play when texture offloaded"));return (_this$ticker=this.ticker)==null?void 0:_this$ticker.pause()}if(!this.paused||forceRender){var query=this._getGPUQuery();if(this.compositions.length||forceRender){this._clearPipeline.render();for(var _i2=0;_i2<comps.length;_i2++){comps[_i2].renderFrame.render();}}if(query){this._getGPUTime(query);}if(!this._forwardingTime){this.onPlayableUpdate({player:this,playing:true});}}};_proto._getGPUQuery=function _getGPUQuery(){if(this._reportGPUTime&&this.renderer.gpu.level===2){var gl=this.renderer.internal.gl;var ext=gl==null?void 0:gl.getExtension("EXT_disjoint_timer_query_webgl2");if(ext){var query=gl.createQuery();gl.beginQuery(ext.TIME_ELAPSED_EXT,query);return query}}};_proto._getGPUTime=function _getGPUTime(query){var gl=this.renderer.gpu.level===2&&this.renderer.internal.gl;var ext=gl==null?void 0:gl.getExtension("EXT_disjoint_timer_query_webgl2");var reportGPUTime=this._reportGPUTime;var getTime=function getTime(){if(query){var available=gl.getQueryParameter(query,gl.QUERY_RESULT_AVAILABLE);var disjoint=gl.getParameter(ext.GPU_DISJOINT_EXT);if(available&&!disjoint){var timeElapsed=gl.getQueryParameter(query,gl.QUERY_RESULT);reportGPUTime(timeElapsed/1e3/1e3);}if(available||disjoint){gl.deleteQuery(query);query=null;}if(query){setTimeout(getTime,1);}}};if(ext){gl.endQuery(ext.TIME_ELAPSED_EXT);}getTime();};_proto.tick=function tick(dt){this._tick(dt,this._forceRenderNextFrame);this._forceRenderNextFrame=false;};_proto.onRenderError=function onRenderError(player,err){throw err};_proto.loadSceneAsync=function loadSceneAsync$1(url,opt){var gpu=this.renderer.gpu;if(!gpu.level){return Promise.reject("WebGL not support, see "+helpLink)}return loadSceneAsync(url,objAssign({env:this.env},opt))};_proto.clearCanvas=function clearCanvas(immediate){if(immediate){this._clearPipeline.render();}else {this._forceRenderNextFrame=true;}};_proto.config=function config(options){var speed="speed";var singleComp=isStr$1(options.compositionName);var comp=singleComp&&this.compositions.find((function(comp){return comp.name===options.compositionName}));if(speed in options){var _speed=+options.speed||1;if(singleComp){if(comp){comp.speed=_speed;}}else {this.compositions.forEach((function(comp){return comp.speed=_speed}));}}};_proto.initializeComposition=function initializeComposition(scene,options){var _this2=this;var renderer=this.renderer;if(scene.consumed){throw Error("[mars-player]reload scene before second play,please see https://yuque.antfin.com/huoxing/knaszl/ttgbkb3tim643s9b")}if(renderer.gpu.level>0){options=options||{};var willReverse=!!options.willReverseTime;var compositionId=scene.compositionId;var compositionName=options.compositionName;if(compositionName){var _comp2=getCompositionByName(scene.compositions,compositionName);if(!_comp2){throw Error("composition for name "+compositionName+" not found")}compositionId=_comp2.id;}var item=getVFXItem(scene.compositions,compositionId,{mask:0},scene);if(isNaN(item.endBehavior)){item.endBehavior=1;}var transform=new Transform(options.transform);scene._textures.forEach((function(tex){return tex&&tex.assignRenderer(_this2.renderer)}));var _comp3=new Composition({baseRenderOrder:options.baseRenderOrder,speed:options.speed,content:item,imageUsage:!willReverse&&scene.imgUsage,keepResource:options.keepResource,keepCompiled:options.keepCompiled!==false,textures:scene._textures,renderer:this.renderer,pausePlayer:this.pausePlayer,onMessageItem:this.onMessageItem,onEnd:options.onEnd,pluginSystem:scene.pluginSystem,scene:scene,event:this.event,env:this.env,renderLevel:scene.renderLevel,camera:item.camera,willReverseTime:willReverse,rootTransform:transform,keepColorBuffer:options.multipleCompositions},this);scene.imgUsage=undefined;if(!options.keepResource){scene._textures=undefined;closeImageBitMap$1(scene.images);scene.consumed=true;}_comp3.start();return _comp3}};_proto._play=function _play(scene,options,asyncCallback){var _this3=this;options=options||{};var renderer=this.renderer;if(this._offscreenMode){this.resize();this._offscreenMode=false;}if(renderer.gpu.level>0){var composition;var multipleCompositions=!!options.multipleCompositions;if(!multipleCompositions){this.compositions.forEach((function(comp){return comp.destroy()}));}if(scene instanceof Composition){composition=scene;if(!composition.renderer){throw Error("Destroyed composition cannot be used again")}}else {composition=this.initializeComposition(scene,options);}var compileLabel=(this.renderer.gpu.capability.asyncShaderCompile?"async":"sync")+" compile "+composition.name;var startTime=Date.now();var onComp=function onComp(){consoleLog$1(compileLabel+" :"+(Date.now()-startTime)+"ms");if(multipleCompositions){arrAddWithOrder(_this3.compositions,composition,"renderOrder");}else {_this3.compositions=[composition];}composition.start();var ticker=_this3.ticker;if(ticker){if(composition.renderLevel==="B"){ticker.fps=Math.min(ticker.fps,30);}ticker.start();}var time=options.currentTime;if(isNaN(+time)){time=composition.startTime;}_this3.forwardCompositionTime(composition,time||0);_this3._renderFrame({pauseOnFirstFrame:options.pauseOnFirstFrame});};if(asyncCallback){this.renderer.shaderLibrary.compileAllShaders((function(){onComp();asyncCallback(composition);}));}else {this.renderer.shaderLibrary.compileAllShaders();onComp();}return composition}};_proto.play=function play(scene,options){consoleWarn$1("player.play has been deprecated,use player.playAsync instead");return this._play(scene,options)};_proto.playAsync=function playAsync(scene,options){var _this4=this;return new Promise((function(resolve){return _this4._play(scene,options,resolve)}))};_proto.forwardCompositionTime=function forwardCompositionTime(composition,timeInSeconds){if(timeInSeconds){this._forwardingTime=true;composition.forwardTime(timeInSeconds);this._forwardingTime=false;}};_proto._renderFrame=function _renderFrame(options){var _this5=this;this.compositions.forEach((function(comp){return _this5.forwardCompositionTime(comp,options.currentTime)}));this._tick(0,true);if(options.pauseOnFirstFrame){this.pause();}else {this.resumeAsync().catch(consoleError$1);}};_proto.onItemClicked=function onItemClicked(e){};_proto._offloadTexture=function _offloadTexture(){this.compositions.forEach((function(comp){return comp.offloadTexture()}));};_proto.pause=function pause(options){if(!this.paused){var _this$ticker2;(_this$ticker2=this.ticker)==null?void 0:_this$ticker2.pause();this.onPlayableUpdate({player:this,playing:false});if(options&&options.offloadTexture){this._offloadTexture();}return true}};_proto.resume=function resume(){consoleError$1("player.resume() has been deprecated, use resumeAsync() instead.");return this.resumeAsync()};_proto.resumeAsync=function resumeAsync(){var _this6=this,_this$ticker3;if(this._resumePending){return this._resumePending}if(this.paused){return this._resumePending=Promise.all(this.compositions.map((function(comp){return comp.reloadTextureAsync()}))).then((function(){var _this6$ticker;(_this6$ticker=_this6.ticker)==null?void 0:_this6$ticker.resume();if(isiOS()){var cvs=_this6.canvas;cvs.style.display="none";setTimeout((function(){cvs.style.display="";}),0);}_this6._onResume();_this6._resumePending=null;}),(function(e){_this6._resumePending=null;throw e}))}(_this$ticker3=this.ticker)==null?void 0:_this$ticker3.resume();return Promise.resolve()};_proto.onPlayableUpdate=function onPlayableUpdate(event){};_proto.onPausedByItem=function onPausedByItem(event){};_proto.destroy=function destroy(keepCanvas){var _this$ticker4;consoleLog$1("call player destroy:"+this.name+" ");var renderer=this.renderer;var supportWebGL=renderer.gpu;var cvs=renderer.canvas;playerMap.delete(this.canvas);(_this$ticker4=this.ticker)==null?void 0:_this$ticker4.stop();this.compositions.forEach((function(comp){return comp==null?void 0:comp.destroy()}));this.compositions.length=0;cvs.removeEventListener("webglcontextlost",this._onWebGLContextLost);this.event.destroy();renderer.destroy(!keepCanvas);broadcastPlayerEvent(this,false);{if(cvs instanceof HTMLCanvasElement&&!keepCanvas&&supportWebGL){cvs.remove();}}delete this.renderer;delete this.canvas;delete this.container;this._onWebGLContextLost=noop;this.destroy=this.loadSceneAsync=this._play=this.playAsync=this._tick=this.resumeAsync=this.resize=errorDestroyed;};_proto.useDowngradeImage=function useDowngradeImage(url){var _this$container;var canvasStyle=(_this$container=this.container)==null?void 0:_this$container.style;if(canvasStyle){canvasStyle.backgroundImage="url("+url+")";canvasStyle.backgroundRepeat="no-repeat";canvasStyle.backgroundSize="cover";canvasStyle.backgroundPosition="center";}};_proto.destroyItem=function destroyItem(id,opt){opt=opt||{};var comp=this.compositions[0];var compName=opt.composition;if(compName){comp=this.compositions.find((function(comp){return comp===compName}));}if(comp){var item=comp.items.find((function(item){return item.id===id}));if(item){comp.destroyItem(item);}}};_createClass(MarsPlayer,[{key:"currentCompositionName",get:function get(){var vfxItem=this.compositions[0];return vfxItem&&vfxItem.name}},{key:"hasPlayable",get:function get(){return this.compositions.length>0}},{key:"paused",get:function get(){var _this$ticker5;return (_this$ticker5=this.ticker)==null?void 0:_this$ticker5.paused}},{key:"interactive",get:function get(){return this.event.enabled},set:function set(t){this.event.enabled=t;}}]);return MarsPlayer}();function errorDestroyed(){var msg="Never use destroyed player again, see "+helpLink;consoleError$1(msg);return Promise.reject(msg)}function assertNoConcurrentPlayers(){var runningPlayers=[];for(var _iterator=_createForOfIteratorHelperLoose(playerMap.values()),_step;!(_step=_iterator()).done;){var cur=_step.value;if(!cur.paused){runningPlayers.push(cur);}}if(runningPlayers.length>1){consoleError$1("Current running player count: "+runningPlayers.length+", see "+helpLink,runningPlayers);}}function assertContainer(c){if(!(c instanceof HTMLElement)){throw Error("Container is not an HTMLElement, see "+helpLink)}}var CalculateLoader=function(_MarsPlugin){_inheritsLoose(CalculateLoader,_MarsPlugin);function CalculateLoader(){var _this;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_MarsPlugin.call.apply(_MarsPlugin,[this].concat(args))||this;_this.order=0;return _this}var _proto=CalculateLoader.prototype;_proto.onCompositionReset=function onCompositionReset(composition,pipeline){var group=composition.calculateGroup;var refCountMap={};var treeMap=composition.loaderData.treeMap={};composition.items.forEach((function(item){if(item.type==="3"){group.addItem(item.createContent());treeMap[item.id]=item;}else if(item.parentId){if(!refCountMap[item.parentId]){refCountMap[item.parentId]=1;}else {refCountMap[item.parentId]++;}}if(item.type==="tree"){treeMap[item.id]=item;}}));group.buildTree(refCountMap);};_proto._setItemsParentTransform=function _setItemsParentTransform(calculateGroup,items,item,treeMap){var id=item.id;var pt=item.composition.rootTransform;item.transform.parentTransform=pt;if(item.type==="3"){items.forEach((function(child){if(id===child.parentId&&child!==item){child.transform.parentTransform=item.transform;setItemParent(child,item);}}));}else if(item.type==="tree"){var _id=item.id;var idWithSubfix=_id+"^";items.forEach((function(child){var parentId=child.parentId;if(parentId&&item!==child){if(_id===parentId){setItemParent(child,item);}else if(parentId.indexOf(idWithSubfix)===0){setItemParent(child,item,item.content.getNodeTransform(parentId.substring(idWithSubfix.length)));}}}));}var parentId=item.parentId;var parentItem=parentId&&treeMap[getParentIdWithoutSuffix(parentId)];if(parentItem&&parentItem.lifetimeStarted){if(parentItem.type=="3"&&parentItem.content.active){pt=parentItem.transform;}else if(parentItem.type==="tree"){pt=parentItem.content.getNodeTransform(parentId.substring(parentId.indexOf("^")+1));}setItemParent(item,parentItem,pt);}};_proto.onCompositionUpdate=function onCompositionUpdate(composition,dt){forEach$1(composition.loaderData.treeMap,(function(item){if(item&&item.onUpdateByLoader){item.onUpdateByLoader(dt);}}));};_proto.onCompositionItemLifeBegin=function onCompositionItemLifeBegin(composition,item){if(item.type!=="7"){this._setItemsParentTransform(composition.calculateGroup,composition.items,item,composition.loaderData.treeMap);}};_proto.onCompositionItemRemoved=function onCompositionItemRemoved(composition,item){var group=composition.calculateGroup;delete composition.loaderData.treeMap[item.id];if(item.type==="3"){group.removeItemRef(item.id);}else if(item.parentId){group.removeItemRef(item.parentId);}var itemsToRemove;if(item.type==="tree"||item.type==="3"){var willRemove=item.endBehavior===6;if(willRemove){itemsToRemove=[];}var keepParent=item.type==="3"&&!!group._itemMap[item.id];composition.items.forEach((function(cit){if(cit.parent===item){if(!keepParent){setItemParent(cit,undefined);cit.transform.parentTransform=composition.rootTransform;}willRemove&&arrAdd$1(itemsToRemove,cit);}}));}if(!group._itemMap[item.parentId]){setItemParent(item,undefined);}if(itemsToRemove){for(var i=0;i<itemsToRemove.length;i++){itemsToRemove[i].destroy();}}};return CalculateLoader}(MarsPlugin);function getParentIdWithoutSuffix(id){var idx=id.lastIndexOf("^");return idx>-1?id.substring(0,idx):id}function setItemParent(item,parent,parentTransform){item.parent=parent;item.transform.parentTransform=parentTransform||(parent==null?void 0:parent.transform);}var singleSplits=[[0,0,1,1]];var tempRot$1=[0,0,0];var tempSize$1=[1,1,1];var tempColor=[1,1,1,1];var tempPos=[0,0,0];var SpriteItem=function(){function SpriteItem(props,opt,vfxItem){var _props$filter,_props$filter2;var positionOverLifeTime=props.positionOverLifetime||{};this._transform=vfxItem.transform;var scale=this._transform.scale;this.positionOverLifeTime=positionOverLifeTime;this.options={startSpeed:positionOverLifeTime.startSpeed||0,startSize:scale&&scale[0]||1,sizeAspect:scale&&scale[0]/(scale[1]||1)||1,startColor:props.options.startColor||[1,1,1,1],duration:vfxItem.duration||0,looping:vfxItem.endBehavior&&vfxItem.endBehavior===ItemEndBehavior.loop,gravity:ensureVec3(positionOverLifeTime.gravity),gravityModifier:positionOverLifeTime.gravityOverLifetime&&createValueGetter(positionOverLifeTime.gravityOverLifetime),direction:positionOverLifeTime.direction?vecNormalize([],positionOverLifeTime.direction):ensureVec3(),endBehavior:vfxItem.endBehavior||0};var renderer=props.renderer;this.interaction=props.interaction;this.renderer={renderMode:renderer.renderMode||0,blending:renderer.blending||0,texture:this._initTexture(renderer.texture,opt),occlusion:!!renderer.occlusion,transparentOcclusion:!!renderer.transparentOcclusion||renderer.maskMode===1,side:renderer.side||1032,shape:renderer.shape,mask:renderer.mask||0,maskMode:renderer.maskMode||0,order:props.listIndex||0,anchor:renderer.anchor,particleOrigin:renderer.particleOrigin};this._cache={color:[1,1,1,1],startSize:[scale[0],scale[1],scale[0]]};var colorOverLifetime=props.colorOverLifetime;if(colorOverLifetime){this.opacityOverLifetime=colorOverLifetime.opacity&&createValueGetter(colorOverLifetime.opacity);if(colorOverLifetime.color&&colorOverLifetime.color[0]===ValueType.GRADIENT_COLOR){this.colorOverLifetime=colorStopsFromGradient(colorOverLifetime.color[1]);}}var sizeOverLifetime=props.sizeOverLifetime;if(sizeOverLifetime){if(sizeOverLifetime.separateAxes){this.sizeSeparateAxes=true;this.sizeXOverLifetime=createValueGetter(sizeOverLifetime.x||1);this.sizeYOverLifetime=createValueGetter(sizeOverLifetime.y||1);this.sizeZOverLifetime=createValueGetter(sizeOverLifetime.z||1);}else {this.sizeXOverLifetime=createValueGetter(sizeOverLifetime.size||1);}}var linearVelEnable=positionOverLifeTime.linearX||positionOverLifeTime.linearY||positionOverLifeTime.linearZ;if(linearVelEnable){this.linearVelOverLifetime={x:positionOverLifeTime.linearX&&createValueGetter(positionOverLifeTime.linearX),y:positionOverLifeTime.linearY&&createValueGetter(positionOverLifeTime.linearY),z:positionOverLifeTime.linearZ&&createValueGetter(positionOverLifeTime.linearZ),asMovement:positionOverLifeTime.asMovement,enabled:!!linearVelEnable};}var orbitalVelEnable=positionOverLifeTime.orbitalX||positionOverLifeTime.orbitalY||positionOverLifeTime.orbitalZ;if(orbitalVelEnable){this.orbitalVelOverLifetime={x:positionOverLifeTime.orbitalX&&createValueGetter(positionOverLifeTime.orbitalX),y:positionOverLifeTime.orbitalY&&createValueGetter(positionOverLifeTime.orbitalY),z:positionOverLifeTime.orbitalZ&&createValueGetter(positionOverLifeTime.orbitalZ),center:ensureVec3(positionOverLifeTime.orbCenter),asRotation:positionOverLifeTime.asRotation,enabled:!!orbitalVelEnable};}this.speedOverLifetime=positionOverLifeTime.speedOverLifetime&&createValueGetter(positionOverLifeTime.speedOverLifetime);var rot=props.rotationOverLifetime;if(rot){this.rotationOverLifetime={asRotation:rot.asRotation,separateAxes:rot.separateAxes,z:createValueGetter(rot.z||0)};if(rot.separateAxes){var rotLt=this.rotationOverLifetime;rotLt.x=createValueGetter(rot.x||0);rotLt.y=createValueGetter(rot.y||0);}}if((_props$filter=props.filter)!=null&&_props$filter.feather&&((_props$filter2=props.filter)==null?void 0:_props$filter2.feather)!==1){this.feather=createValueGetter(props.filter.feather);}this._time=0;this._maxTime=this.options.duration;this.gravityModifier=this.options.gravityModifier;this.splits=props.splits||singleSplits;this.listIndex=vfxItem.listIndex||0;this.textureSheetAnimation=props.textureSheetAnimation;this.cachePrefix=vfxItem.cachePrefix||"-";this.parentId=vfxItem.parentId;this.reusable=vfxItem.reusable;this.name=vfxItem.name;this._renderInfo=getImageItemRenderInfo(this);this._renderInfo.env=opt.env;this.delay=vfxItem.delay||0;this.hide=vfxItem.hide;}var _proto=SpriteItem.prototype;_proto.fallbackAnchor=function fallbackAnchor(){if(!this._anchor){var renderer=this.renderer;var anchor=renderer.anchor;var setOffset=true;if(!anchor&&renderer.particleOrigin){anchor=convertParticleOrigin2Anchor(renderer.particleOrigin);setOffset=false;}anchor=anchor||[.5,.5];var rotation=deepClone(this._transform.rotation);var position=deepClone(this._transform.position);var transformPath=this.positionOverLifeTime.path;var path;if(transformPath){if(transformPath[0]===ValueType.CONSTANT_VEC3){vecAdd(position,position,transformPath[1]);}else {path=createValueGetter(transformPath);}}this.transform={position:position,rotation:rotation,path:path};this._anchor=anchor?[anchor[0]-.5,.5-anchor[1]]:[0,0];if(setOffset){var offset=getAnchorOffset(this._anchor,this._transform);position[0]+=offset[0];position[1]+=offset[1];}}return this._anchor};_proto._initTexture=function _initTexture(texture,options){var tex=texture||options.emptyTexture;tex.assignRenderer(options.renderer);return tex};_proto.willTranslate=function willTranslate(){var pro="_willTranslate";if(!this.hasOwnProperty(pro)){var linearVel=this.linearVelOverLifetime;if(linearVel&&linearVel.enabled){return this[pro]=true}var orbitalVelOverLifetime=this.orbitalVelOverLifetime;if(orbitalVelOverLifetime&&orbitalVelOverLifetime.enabled){return this[pro]=true}var options=this.options;if(options.gravityModifier&&!isZeroVec(options.gravity)||options.startSpeed&&!isZeroVec(options.direction)){return this[pro]=true}return this[pro]=false}return this[pro]};_proto.updateTime=function updateTime(globalTime){var time=globalTime-this.delay;var duration=this.options.duration;if(time>=this._maxTime&&this.options.looping){var start=time-this._maxTime;while(start>duration){start-=duration;}this._time=start;}else {var freeze=this.options.endBehavior===4;this._time=freeze?Math.min(this._maxTime,time):time;}};_proto.stop=function stop(){this._time=this._maxTime;};_proto.getTextures=function getTextures(){var ret=[];var tex=this.renderer.texture;if(tex){ret.push(tex);}return ret};_proto.getRenderData=function getRenderData(_time,init){var options=this.options;var sizeInc=vecFill(tempSize$1,1);var rotInc=vecFill(tempRot$1,0);var colorInc=vecFill(tempColor,1);var sizeChanged,rotChanged,colorChanged;var time=_time<0?_time:Math.max(_time,0);var duration=options.duration;var life=time/duration;this.fallbackAnchor();var ret={life:life,transform:this._transform,anchor:this._anchor};var transform=this.transform;life=life<0?0:life>1?1:life;if(this.sizeXOverLifetime){sizeInc[0]=this.sizeXOverLifetime.getValue(life);if(this.sizeSeparateAxes){sizeInc[1]=this.sizeYOverLifetime.getValue(life);sizeInc[2]=this.sizeZOverLifetime.getValue(life);}else {sizeInc[2]=sizeInc[1]=sizeInc[0];}sizeChanged=true;}if(sizeChanged||init){ret.transform.setScale(sizeInc[0],sizeInc[1],sizeInc[2]);}ret.startSize=this._cache.startSize;var rotationOverLifetime=this.rotationOverLifetime;if(rotationOverLifetime){var func=function func(v){return rotationOverLifetime.asRotation?v.getValue(life):v.getIntegrateValue(0,life,duration)};var incZ=func(rotationOverLifetime.z);var separateAxes=rotationOverLifetime.separateAxes;rotInc[0]=separateAxes?func(rotationOverLifetime.x):0;rotInc[1]=separateAxes?func(rotationOverLifetime.y):0;rotInc[2]=incZ;rotChanged=true;}if(rotChanged||init){var rot=vecAdd(tempRot$1,transform.rotation,rotInc);ret.transform.setRotation(rot[0],rot[1],rot[2]);}var opacityOverLifetime=this.opacityOverLifetime;var colorOverLifetime=this.colorOverLifetime;if(colorOverLifetime){colorInc=getColorFromGradientStops(colorOverLifetime,life,true);colorChanged=true;}if(opacityOverLifetime){colorInc[3]*=opacityOverLifetime.getValue(life);colorChanged=true;}if(colorChanged||init){ret.color=vecMulCombine(this._cache.color,colorInc,options.startColor);}var pos;if(this.willTranslate()||init){var out=vecFill(tempSize$1,0);pos=calculateTranslation(out,this,options.gravity,time,duration,transform.position,this.velocity);}if(transform.path){if(!pos){pos=vecAssign(tempPos,transform.position,3);}vecAdd(pos,pos,transform.path.getValue(life));}if(pos){ret.transform.setPosition(pos[0],pos[1],pos[2]);}var ta=this.textureSheetAnimation;if(ta){var total=ta.total||ta.row*ta.col;var texRectX=0;var texRectY=0;var texRectW=1;var texRectH=1;var flip;if(this.splits){var sp=this.splits[0];flip=sp[4];texRectX=sp[0];texRectY=sp[1];if(flip){texRectW=sp[3];texRectH=sp[2];}else {texRectW=sp[2];texRectH=sp[3];}}var dx,dy;if(flip){dx=1/ta.row*texRectW;dy=1/ta.col*texRectH;}else {dx=1/ta.col*texRectW;dy=1/ta.row*texRectH;}var texOffset;if(ta.animate){var frameIndex=Math.round(life*(total-1));var yIndex=Math.floor(frameIndex/ta.col);var xIndex=frameIndex-yIndex*ta.col;texOffset=flip?[dx*yIndex,dy*(ta.col-xIndex)]:[dx*xIndex,dy*(1+yIndex)];}else {texOffset=[0,dy];}ret.texOffset=[texRectX+texOffset[0],texRectH+texRectY-texOffset[1],dx,dy];}else if(init){ret.texOffset=[0,0,1,1];}ret.hide=this.hide;return ret};_createClass(SpriteItem,[{key:"filter",get:function get(){return this._filter},set:function set(f){this._filter=f;this._renderInfo.filter=f;}},{key:"renderInfo",get:function get(){return this._renderInfo}},{key:"isSpriteItem",get:function get(){return true}},{key:"ended",get:function get(){return this._time>this._maxTime&&!this.options.looping&&!this.reusable}},{key:"time",get:function get(){return this._time}},{key:"velocity",get:function get(){if(!this._velocity){this._velocity=vecMulScalar([],this.options.direction,this.options.startSpeed);}return this._velocity}},{key:"startSize",get:function get(){return this._cache.startSize}},{key:"anchor",get:function get(){return this._anchor}}]);return SpriteItem}();function convertParticleOrigin2Anchor(p){var point=ParticleOriginTranslateMap[p||0];return [.5-point[0],point[1]+.5]}function getAnchorOffset(anchor,transform){var scale=transform.scale;return [anchor[0]*scale[0],anchor[1]*scale[1]]}var ParticleOriginTranslateMap={[0]:[0,0],[5]:[0,.5],[4]:[0,-.5],[1]:[.5,-.5],[2]:[.5,0],[3]:[.5,.5],[7]:[-.5,0],[8]:[-.5,.5],[6]:[-.5,-.5]};var CalculateItem=function(_SpriteItem){_inheritsLoose(CalculateItem,_SpriteItem);function CalculateItem(props,options,item){var _this;_this=_SpriteItem.call(this,props,options,item)||this;_this.renderData=_this.getRenderData(0,true);_this.id=item.id;_this.active=false;return _this}var _proto=CalculateItem.prototype;_proto._initTexture=function _initTexture(texture,engine){return texture};_proto.willTranslate=function willTranslate(){return true};_proto.getRenderData=function getRenderData(_time,init){var ret=_SpriteItem.prototype.getRenderData.call(this,_time,init);if(ret.startSize){var scaling=ret.transform.scale;ret.transform.setScale(scaling[0]*ret.startSize[0],scaling[1]*ret.startSize[1],scaling[2]*ret.startSize[2]);delete ret.startSize;}ret.active=this.active;return ret};_proto._onUpdate=function _onUpdate(dt,group){this.updateTime(group.time);var data=this.getRenderData(this.time,true);var parentData=group.getRenderData(this.parentId);data=CalculateGroup.combineRenderData(data,parentData);this.renderData=data;};return CalculateItem}(SpriteItem);var CalculateVFXItem=function(_VFXItem){_inheritsLoose(CalculateVFXItem,_VFXItem);function CalculateVFXItem(){var _this;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_VFXItem.call.apply(_VFXItem,[this].concat(args))||this;_this._v_priority=1;_this._hideChildren=false;return _this}var _proto=CalculateVFXItem.prototype;_proto.onConstructed=function onConstructed(options){this.cal=options.content;this.relative=options.relative;this.onUpdateByLoader=this._onUpdate;this._onUpdate=noop;};_proto._createContent=function _createContent(renderer){var opt=renderer.getParticleOptions();return new CalculateItem(this.cal,opt,this)};_proto._onHideChanged=function _onHideChanged(hide){if(this._content){this._content.hide=hide&&this.hideChildren;}};_proto.getCurrentRenderData=function getCurrentRenderData(){var _this$_content;return (_this$_content=this._content)==null?void 0:_this$_content.renderData};_proto.onLifetimeBegin=function onLifetimeBegin(renderer,content){content.active=true;};_proto.onItemRemoved=function onItemRemoved(renderer,content){};_proto.getHitTestParams=function getHitTestParams(force){};_createClass(CalculateVFXItem,[{key:"hideChildren",get:function get(){return this._hideChildren},set:function set(h){if(this._hideChildren!=h){this._hideChildren=!!h;this._onHideChanged(this._hide);}}},{key:"type",get:function get(){return "3"},set:function set(v){}}]);return CalculateVFXItem}(VFXItem);var seed$1=1;var vertex="\n  precision highp float;\n  attribute vec4 aPoint;\n  uniform vec4 uPos;\n  uniform vec2 uSize;\n  uniform vec4 uQuat;\n  uniform vec4 uColor;\n  uniform mat4 uModel;\n  uniform mat4 uView;\n  uniform mat4 uViewProjection;\n  varying vec4 vColor;\n  #ifdef ENV_EDITOR\n  uniform vec4 uEditorTransform;\n  #endif\n  \n  vec3 rotateByQuat(vec3 a, vec4 quat){\n    vec3 qvec = quat.xyz;\n    vec3 uv = cross(qvec, a);\n    vec3 uuv = cross(qvec, uv) * 2.;\n    return a +(uv * 2. * quat.w + uuv);\n  }\n  \n  void main() {\n     vec4 _pos = uPos;\n     vec3 point = rotateByQuat(vec3(aPoint.xy * uSize, 0.),uQuat);\n     vec4 pos =  vec4(_pos.xyz, 1.0);\n     pos = uModel * pos;\n     pos.xyz += uView[0].xyz * point.x+ uView[1].xyz * point.y;\n     gl_Position = uViewProjection * pos;\n     vColor = uColor;\n     #ifdef ENV_EDITOR\n        gl_Position = vec4(gl_Position.xy * uEditorTransform.xy + uEditorTransform.zw * gl_Position.w, gl_Position.zw);\n     #endif\n  }\n";var fragment="\n precision highp float;\n varying vec4 vColor;\n void main(){\n  gl_FragColor = vColor;\n }\n\n";var InteractMesh=function(){function InteractMesh(props,renderInfo,vfxItem){this.color=props.options.previewColor;this.transform=vfxItem.transform;this.mesh=new MarsMesh({name:"Interact_preview"+seed$1++,priority:0,geometry:new MarsGeometry({attributes:{aPoint:{size:2,data:new Float32Array([-.5,.5,.5,.5,.5,-.5,-.5,-.5])}},index:{data:new Uint8Array([0,1,1,2,2,3,3,0])},mode:constants.LINES}),worldMatrix:mat4create(),material:this.createMaterial(renderInfo)});this.updateMesh();}var _proto=InteractMesh.prototype;_proto.createMaterial=function createMaterial(renderInfo){var marcos=[["ENV_EDITOR",renderInfo.env==="editor"]];var mtl={shader:{vertex:vertex,fragment:fragment,marcos:marcos,cacheId:renderInfo.cachePrefix+"_mars_interact"},states:{blending:false,depthTest:false},uniformSemantics:{uViewProjection:"VIEWPROJECTION",uView:"VIEWINVERSE",uModel:"MODEL",uEditorTransform:"EDITOR_TRANSFORM"},uniformValues:{uPos:new Float32Array(4),uSize:new Float32Array(2),uColor:new Float32Array(this.color||[1,1,1,1]),uQuat:new Float32Array(4)}};return new MarsMaterial(mtl)};_proto.updateMesh=function updateMesh(){var mesh=this.mesh;var mtl=mesh.material;var scale=deepClone(this.transform.scale);var uPos=new Float32Array(mtl.defaultDataBlock.getUniformValue("uPos").buffer,0,4);var uQuat=new Float32Array(mtl.defaultDataBlock.getUniformValue("uQuat").buffer,0,4);this.transform.getWorldTRS(uPos,uQuat,scale);var s=mtl.defaultDataBlock.getUniformValue("uSize");s[0]=scale[0];s[1]=scale[1];};return InteractMesh}();var InteractiveVFXItem=function(_VFXItem){_inheritsLoose(InteractiveVFXItem,_VFXItem);function InteractiveVFXItem(){return _VFXItem.apply(this,arguments)||this}var _proto=InteractiveVFXItem.prototype;_proto.onConstructed=function onConstructed(options){this.ui=options.content;};_proto._createContent=function _createContent(renderer){if(this.ui.options.type===InteractType.CLICK){this.clickable=true;var option=this.ui.options;if(option.showPreview&&this.composition.env==="editor"){var opt=renderer.getParticleOptions();this._previewContent=new InteractMesh(this.ui,opt,this);}}return null};_proto.onLifetimeBegin=function onLifetimeBegin(renderer,content){var options=this.ui.options;this.composition.addInteractiveItem(this,options);if(options.type===InteractType.DRAG){if(renderer.env!=="editor"||options.enableInEditor){this.beginDragTarget(options,renderer.event);}}};_proto.beginDragTarget=function beginDragTarget(options,eventSystem){var _this=this;if(options.target==="camera"){var ev;var handlerMap={touchstart:function touchstart(e){_this._dragEvent=_this._bouncingArg=null;ev={x:e.x,y:e.y,camera:JSON.parse(JSON.stringify(_this.composition.camera))};},touchmove:function touchmove(e){_this._onDragMove(ev,e);_this._bouncingArg=e;},touchend:function touchend(e){var bouncingArg=_this._bouncingArg;if(!shouldIgnoreBouncing(bouncingArg,3)&&bouncingArg){var speed=5;bouncingArg.vx*=speed;bouncingArg.vy*=speed;_this._dragEvent=ev;}ev=0;}};forEach$1(handlerMap,(function(func,name){eventSystem.addEventListener(name,func);}));handlerMap.touchmove({dx:0,dy:0,width:1,height:1});this.endDragTarget=function(){forEach$1(handlerMap,(function(func,name){eventSystem.removeEventListener(name,func);}));};}};_proto._onDragMove=function _onDragMove(ev,e){var options=this.ui.options;if(ev){var dy=e.dy;var dx=e.dx*e.width/e.height;var cameraPos=ev.camera.position;var depth=cameraPos[2];var sp=Math.tan(ev.camera.fov*Math.PI/180/2)*Math.abs(depth);var height=dy*sp;var width=dx*sp;var nx=cameraPos[0]-width;var ny=cameraPos[1]-height;if(options.dxRange){nx=clamp(nx,options.dxRange[0],options.dxRange[1]);if(nx!==options.dxRange[0]&&nx!==options.dxRange[1]&&options.dxRange[0]!==options.dxRange[1]){var _e$origin;(_e$origin=e.origin)==null?void 0:_e$origin.preventDefault();}}if(options.dyRange){ny=clamp(ny,options.dyRange[0],options.dyRange[1]);if(ny!==options.dyRange[0]&&ny!==options.dyRange[1]&&options.dyRange[0]!==options.dyRange[1]){var _e$origin2;(_e$origin2=e.origin)==null?void 0:_e$origin2.preventDefault();}}this.composition.camera={position:[nx,ny,depth]};}};_proto.onItemUpdate=function onItemUpdate(dt,lifetime){if(this._previewContent){this._previewContent.updateMesh();}if(this._dragEvent){var bouncingArg=this._bouncingArg;var downgrade=.95;bouncingArg.vx*=downgrade;bouncingArg.vy*=downgrade;bouncingArg.dy+=bouncingArg.vy;bouncingArg.dx+=bouncingArg.vx;if(shouldIgnoreBouncing(bouncingArg)){this._dragEvent=this._bouncingArg=null;}else {this._onDragMove(this._dragEvent,bouncingArg);}}};_proto.endDragTarget=function endDragTarget(){};_proto.onItemRemoved=function onItemRemoved(renderer,content){renderer.removeInteractiveItem(this,this.ui.options.type);this.clickable=false;if(this._previewContent){this._previewContent.mesh.destroy();}this.endDragTarget();};_proto.getHitTestParams=function getHitTestParams(force){if(this.clickable){var wm=this.transform.getWorldMatrix();var triangles=trianglesFromRect([0,0,0],.5,.5);triangles.forEach((function(triangle){triangle.forEach((function(p){vec3MulMat4(p,p,wm);}));}));return {type:HitTestType.triangle,triangles:triangles,behavior:this.ui.options.behavior}}};_createClass(InteractiveVFXItem,[{key:"type",get:function get(){return "4"},set:function set(v){}}]);return InteractiveVFXItem}(VFXItem);function shouldIgnoreBouncing(arg,mul){var threshold=1e-5*(mul||1);return arg&&Math.abs(arg.vx||0)<threshold&&Math.abs(arg.vy||0)<threshold}var InteractLoader=function(_MarsPlugin){_inheritsLoose(InteractLoader,_MarsPlugin);function InteractLoader(){var _this;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_MarsPlugin.call.apply(_MarsPlugin,[this].concat(args))||this;_this._mesh=[];return _this}var _proto=InteractLoader.prototype;_proto.addMesh=function addMesh(mesh){this._mesh.push(mesh);};_proto.removeMesh=function removeMesh(mesh,frame){frame.removeMeshFromDefaultRenderPass(mesh);};_proto.onCompositionItemLifeBegin=function onCompositionItemLifeBegin(composition,item){if(item instanceof InteractiveVFXItem&&item._previewContent){this.addMesh(item._previewContent.mesh);}};_proto.onCompositionItemRemoved=function onCompositionItemRemoved(composition,item){if(item instanceof InteractiveVFXItem&&item._previewContent){this.removeMesh(item._previewContent.mesh,composition.renderFrame);}};_proto.prepareRenderFrame=function prepareRenderFrame(composition,pipeline){this._mesh&&this._mesh.forEach((function(mesh){return pipeline.addMeshToDefaultRenderPass(mesh)}));this._mesh=[];return false};return InteractLoader}(MarsPlugin);var vs$2="precision highp float;\n#define SHADER_VERTEX 1\n\n#define PATICLE_SHADER 1\n\n#version 300 es\n\n#ifdef WEBGL2\n\n#define texture2D texture\n\n#else\n\n#endif\n\n#ifdef SHADER_VERTEX\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n#define CURVE_VALUE_ARRAY uVCurveValues\n#define CURVE_VALUE_COUNT VERT_CURVE_VALUE_COUNT\n#define FRAG_CURVE_VALUE_COUNT 0\n#else\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n#define CURVE_VALUE_ARRAY uFCurveValues\n#define CURVE_VALUE_COUNT FRAG_CURVE_VALUE_COUNT\n#define VERT_CURVE_VALUE_COUNT 0\n#endif\n\n#if CURVE_VALUE_COUNT > 0\n    #if LOOKUP_TEXTURE_CURVE\n            uniform sampler2D CURVE_VALUE_TEXTURE;\n            const float uCurveCount = 1./ float(CURVE_VALUE_COUNT);\n            #define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n    #else\n        #ifdef WEBGL2\n            layout(std140) uniform CurveValues{\n                #if VERT_CURVE_VALUE_COUNT > 0\n                vec4 uVCurveValues[VERT_CURVE_VALUE_COUNT];\n                #endif\n                #if FRAG_CURVE_VALUE_COUNT > 0\n                vec4 uFCurveValues[FRAG_CURVE_VALUE_COUNT];\n                #endif\n            };\n            #define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n        #else\n            uniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n            #define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n        #endif\n    #endif\n#else\n    #define lookup_curve(i) vec4(0.)\n#endif\n\n\n#ifdef WEBGL2\n#define ITR_END (count + 1)\n#else\n#define ITR_END MAX_C\n#endif\n\n\n#ifdef SHADER_VERTEX\nin float aSeed;out float vSeed;\n#define NONE_CONST_INDEX 1\n\n#else\n\n#if LOOKUP_TEXTURE_CURVE\n\n#define NONE_CONST_INDEX 1\n\n#endif\n\n#endif\n\n#ifdef NONE_CONST_INDEX\n\n#ifdef SHADER_VERTEX\n\n#define MAX_C VERT_MAX_KEY_FRAME_COUNT\n\n#else\n\n#define MAX_C FRAG_MAX_KEY_FRAME_COUNT\n\n#endif\n\n#else\n\n#define MAX_C CURVE_VALUE_COUNT\n\n#endif\nfloat a(float b,vec4 c,vec4 d){float e=d.x-c.x;float f=c.w*e;float g=d.z*e;float h=(b-c.x)/e;float i=h*h;float j=i*h;return dot(vec4(dot(vec3(2.,-3.,1.),vec3(j,i,1.)),dot(vec3(1,-2.,1),vec3(j,i,h)),j-i,dot(vec2(-2,3),vec2(j,i))),vec4(c.y,f,g,d.y));}float k(float b,float l,float m){int start=int(l);int count=int(m-1.);int end=start+count;for(int i=0;i<ITR_END;i++){\n#ifdef NONE_CONST_INDEX\nif(i==count){return lookup_curve(count).y;}vec4 n=lookup_curve(i+start);vec4 o=lookup_curve(i+1+start);\n#else\nif(i<start){continue;}vec4 n=lookup_curve(i);vec4 o=lookup_curve(i+1);if(i==end){return n.y;}\n#endif\nif(b>=n.x&&b<=o.x){return a(b,n,o);}}return lookup_curve(0).y;}float p(float h,vec2 q,vec2 r){return q.y+(r.y-q.y)*(h-q.x)/(r.x-q.x);}float s(float b,float l,float m){int start=int(l);int count=int(m-1.);int end=start+count;for(int i=0;i<ITR_END;i++){\n#ifdef NONE_CONST_INDEX\nif(i>count){return lookup_curve(i).w;}\n#else\nif(i<start){continue;}if(i>end){return lookup_curve(i-2).w;}\n#endif\n#ifdef NONE_CONST_INDEX\nvec4 t=lookup_curve(i+start);\n#else\nvec4 t=lookup_curve(i);\n#endif\nvec2 q=t.xy;vec2 r=t.zw;if(b>=q.x&&b<=r.x){return p(b,q,r);}\n#ifdef NONE_CONST_INDEX\nvec2 u=lookup_curve(i+start+1).xy;\n#else\nvec2 u=lookup_curve(i+1).xy;\n#endif\nif(b>r.x&&b<=u.x){return p(b,r,u);}}return lookup_curve(0).y;}float getValueFromTime(float b,vec4 v){float w=v.x;if(w==0.){return v.y;}else if(w==1.){return mix(v.y,v.z,b/v.w);}if(w==2.){return k(b,floor(v.y),floor(1./fract(v.y)+0.5))*v.w+v.z;}if(w==3.){return s(b,v.y,v.z);}if(w==4.){\n#ifdef SHADER_VERTEX\nfloat seed=aSeed;\n#else\nfloat seed=vSeed;\n#endif\nreturn mix(v.y,v.z,seed);}return 0.;}float x(float y,vec4 n,vec4 o){float z=o.x-n.x;float f=n.w*z;float g=o.z*z;float A=n.x;float B=n.y;float C=o.y;float e=A-y;float D=e*e;float E=D*e;vec4 F=vec4(E*e,E,D,e)/vec4(4.*z*z*z,3.*z*z,2.*z,1.);vec4 G=vec4(f+g+2.*B-2.*C,2.*f+g+3.*B-3.*C,f,-B);return dot(F,G);}float H(float y,vec4 n,vec4 o){float z=o.x-n.x;float f=n.w*z;float g=o.z*z;float A=n.x;float B=n.y;float C=o.y;float e=A-y;float D=e*e;float E=D*e;float I=z*z;float J=I*z;vec4 F=vec4(-30.*J,10.*I,5.*z,3.)*vec4(e,D,E,E*e);vec4 G=vec4(B,f,2.*f+g+3.*B-3.*C,f+g+2.*B-2.*C)*vec4(A+y,A+2.*y,A+3.*y,A+4.*y);return dot(F,G)/60./J;}float K(float y,float l,float m){if(y==0.){return 0.;}int start=int(l);int count=int(m-1.);float L=0.;for(int i=0;i<ITR_END;i++){if(i==count){return L;}vec4 n=lookup_curve(i+start);vec4 o=lookup_curve(i+1+start);if(y>n.x&&y<=o.x){return L+H(y,n,o);}L+=H(o.x,n,o);}return L;}float M(float b,float l,float m){if(b==0.){return 0.;}int start=int(l);int count=int(m-1.);float L=0.;for(int i=0;i<ITR_END;i++){if(i==count){return L;}vec4 n=lookup_curve(i+start);vec4 o=lookup_curve(i+1+start);if(b>n.x&&b<=o.x){return L+x(b,n,o);}L+=x(o.x,n,o);}return L;}float N(float h,vec2 q,vec2 r){float A=q.x;float y=r.x;float O=q.y;float P=r.y;float Q=dot(vec4(2.*h*h*h,3.*h*h,-A*A*A,3.*A*A),vec4(O-P,A*P-y*O,2.*O+P,y*O));return Q/(A-y)/6.;}float R(float b,vec2 q,vec2 r){float S=b-q.x;float O=q.y;return (O+O+(r.y-O)*S/(r.x-q.x))*S/2.;}float T(float b,float l,float m){if(b==0.){return 0.;}int start=int(l);int count=int(m-1.);float L=0.;for(int i=0;i<ITR_END;i++){if(i>count){return L;}vec4 U=lookup_curve(i+start);vec2 n=U.xy;vec2 o=U.zw;if(b>n.x&&b<=o.x){return L+R(b,n,o);}L+=R(o.x,n,o);vec2 I=lookup_curve(i+start+1).xy;if(b>o.x&&b<=I.x){return L+R(b,o,I);}L+=R(I.x,o,I);}return L;}float V(float b,float l,float m){if(b==0.){return 0.;}int start=int(l);int count=int(m-1.);float L=0.;for(int i=0;i<ITR_END;i++){if(i>count){return L;}vec4 U=lookup_curve(i+start);vec2 n=U.xy;vec2 o=U.zw;if(b>n.x&&b<=o.x){return L+N(b,n,o);}L+=N(o.x,n,o);vec2 I=lookup_curve(i+start+1).xy;if(b>o.x&&b<=I.x){return L+N(b,o,I);}L+=N(I.x,o,I);}return L;}float getIntegrateFromTime0(float y,vec4 v){float w=v.x;if(w==0.){return v.y*y;}else if(w==1.){vec2 q=vec2(0.,v.y);vec2 r=vec2(v.w,v.z);return R(y,q,r);}if(w==3.){return T(y,v.y,v.z);}if(w==2.){float W=floor(v.y);float X=floor(1./fract(v.y)+0.5);float Y=M(y,W,X);return Y*v.w+v.z*y;}if(w==4.){return mix(v.y,v.z,aSeed)*y;}return 0.;}float Z(float A,float y,vec4 v){float w=v.x;if(w==0.){return v.y*(y*y-A*A)/2.;}else if(w==1.){vec2 q=vec2(0.,v.y);vec2 r=vec2(v.w,v.z);return N(y,q,r)-N(A,q,r);}if(w==2.){float W=floor(v.y);float X=floor(1./fract(v.y)+0.5);float Y=K(y,W,X)-K(A,W,X);return Y*v.w+v.z*pow(y-A,2.)*0.5;}if(w==3.){return V(y,v.y,v.z)-V(A,v.y,v.z);}if(w==4.){return mix(v.y,v.z,aSeed)*(y*y-A*A)/2.;}return 0.;}const float ba=3.141592653589793/180.;in vec3 aPos;in vec4 aOffset;in vec3 aVel;in vec3 aRot;in vec4 aColor;in vec3 aDirX;in vec3 aDirY;\n#ifdef USE_SPRITE\nin vec3 aSprite;uniform vec4 uSprite;struct bb{vec2 uv0;vec3 uv1;};bb bc(vec2 bd,float be);out vec4 vTexCoordBlend;\n#endif\n\n#pragma EDITOR_VERT_DEFINE\n\n#ifdef FINAL_TARGET\nuniform vec3 uFinalTarget;uniform vec4 uForceCurve;\n#endif\nuniform mat4 uModel;uniform mat4 uView;uniform mat4 uViewProjection;uniform vec4 uParams;uniform vec4 uAcceleration;uniform vec4 uGravityModifierValue;uniform vec4 uOpacityOverLifetimeValue;\n#ifdef ROT_X_LIFETIME\nuniform vec4 uRXByLifeTimeValue;\n#endif\n\n#ifdef ROT_Y_LIFETIME\nuniform vec4 uRYByLifeTimeValue;\n#endif\n\n#ifdef ROT_Z_LIFETIME\nuniform vec4 uRZByLifeTimeValue;\n#endif\n\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\n\n#if LINEAR_VEL_X + LINEAR_VEL_Y + LINEAR_VEL_Z\n\n#if LINEAR_VEL_X\nuniform vec4 uLinearXByLifetimeValue;\n#endif\n\n#if LINEAR_VEL_Y\nuniform vec4 uLinearYByLifetimeValue;\n#endif\n\n#if LINEAR_VEL_Z\nuniform vec4 uLinearZByLifetimeValue;\n#endif\n\n#endif\n\n#ifdef SPEED_OVER_LIFETIME\nuniform vec4 uSpeedLifetimeValue;\n#endif\n\n#if ORB_VEL_X + ORB_VEL_Y + ORB_VEL_Z\n\n#if ORB_VEL_X\nuniform vec4 uOrbXByLifetimeValue;\n#endif\n\n#if ORB_VEL_Y\nuniform vec4 uOrbYByLifetimeValue;\n#endif\n\n#if ORB_VEL_Z\nuniform vec4 uOrbZByLifetimeValue;\n#endif\nuniform vec3 uOrbCenter;\n#endif\nuniform vec4 uSizeByLifetimeValue;\n#ifdef SIZE_Y_BY_LIFE\nuniform vec4 uSizeYByLifetimeValue;\n#endif\nout float vLife;out vec4 vColor;out vec2 vTexCoord;\n#ifdef USE_FILTER\n\n#pragma FILTER_VERT\n\n#endif\n\n#ifdef ENV_EDITOR\nuniform vec4 uEditorTransform;\n#endif\nvec3 bf(float _life,float _dur){vec3 bg=vec3(0.0);\n#ifdef AS_ORBITAL_MOVEMENT\n#define FUNC(a) getValueFromTime(_life,a)\n#else\n#define FUNC(a) getIntegrateFromTime0(_life,a) * _dur\n#endif\n#if ORB_VEL_X\nbg.x=FUNC(uOrbXByLifetimeValue);\n#endif\n#if ORB_VEL_Y\nbg.y=FUNC(uOrbYByLifetimeValue);\n#endif\n#if ORB_VEL_Z\nbg.z=FUNC(uOrbZByLifetimeValue);\n#endif\n#undef FUNC\nreturn bg;}vec3 bh(float _life,float _dur){vec3 bi=vec3(0.0);\n#ifdef AS_LINEAR_MOVEMENT\n#define FUNC(a) getValueFromTime(_life,a)\n#else\n#define FUNC(a) getIntegrateFromTime0(_life,a) * _dur\n#endif\n#if LINEAR_VEL_X\nbi.x=FUNC(uLinearXByLifetimeValue);\n#endif\n#if LINEAR_VEL_Y\nbi.y=FUNC(uLinearYByLifetimeValue);\n#endif\n#if LINEAR_VEL_Z\nbi.z=FUNC(uLinearZByLifetimeValue);\n#endif\n#undef FUNC\nreturn bi;}mat3 bj(vec3 bk){vec3 bl=sin(bk*ba);vec3 bm=cos(bk*ba);return mat3(bm.z,-bl.z,0.,bl.z,bm.z,0.,0.,0.,1.)*mat3(bm.y,0.,bl.y,0.,1.,0.,-bl.y,0,bm.y)*mat3(1.,0.,0.,0,bm.x,-bl.x,0.,bl.x,bm.x);}\n#ifdef USE_SPRITE\nbb bc(vec2 bd,float be){float h=fract(clamp((be-aSprite.x)/aSprite.y,0.0,1.)*aSprite.z);float bn=uSprite.z*h;float bo=max(ceil(bn)-1.,0.);float bp=floor((bo+0.1)/uSprite.x);float bq=bo-bp*uSprite.x;vec2 br=(vec2(bq,bp)+bd)/uSprite.xy;bb L;if(uSprite.w>0.){float bs=bn-bo;float bt=min(ceil(bn),uSprite.z-1.);float bu=floor((bt+0.1)/uSprite.x);float bv=bt-bu*uSprite.x;vec2 bw=(vec2(bv,bu)+bd)/uSprite.xy-br;L.uv1=vec3(bw.x,1.-bw.y,bs);}L.uv0=vec2(br.x,1.-br.y);return L;}\n#endif\nvec3 bx(vec3 by,float A,float y,float bz){float e=y-A;float Y=Z(0.,e,uGravityModifierValue);vec3 bA=uAcceleration.xyz*Y;\n#ifdef SPEED_OVER_LIFETIME\nreturn by*getIntegrateFromTime0(e/bz,uSpeedLifetimeValue)*bz+bA;\n#endif\nreturn by*e+bA;}mat3 bB(vec3 bC,float _life,float _dur){vec3 bk=bC;\n#ifdef ROT_LIFETIME_AS_MOVEMENT\n#define FUNC1(a) getValueFromTime(_life,a)\n#else\n#define FUNC1(a) getIntegrateFromTime0(_life,a) * _dur\n#endif\n#ifdef ROT_X_LIFETIME\nbk.x+=FUNC1(uRXByLifeTimeValue);\n#endif\n#ifdef ROT_Y_LIFETIME\nbk.y+=FUNC1(uRYByLifeTimeValue);\n#endif\n#ifdef ROT_Z_LIFETIME\nbk.z+=FUNC1(uRZByLifeTimeValue);\n#endif\nif(dot(bk,bk)==0.0){return mat3(1.0);}\n#undef FUNC1\nreturn bj(bk);}void main(){float b=uParams.x-aOffset.z;float bz=aOffset.w;if(b<0.||b>bz){gl_Position=vec4(-3.,-3.,-3.,1.);}else{float bD=clamp(b/bz,0.0,1.0);vLife=bD;\n#ifdef USE_SPRITE\nbb bE=bc(aOffset.xy,b);vTexCoord=bE.uv0;vTexCoordBlend=vec4(bE.uv1,uSprite.w);\n#else\nvTexCoord=aOffset.xy;\n#endif\nvColor=aColor;\n#ifdef COLOR_OVER_LIFETIME\n#ifdef ENABLE_VERTEX_TEXTURE\nvColor*=texture2D(uColorOverLifetime,vec2(bD,0.));\n#endif\n#endif\nvColor.a*=clamp(getValueFromTime(bD,uOpacityOverLifetimeValue),0.,1.);vec3 bF=vec3(vec2(getValueFromTime(bD,uSizeByLifetimeValue)),1.0);\n#ifdef SIZE_Y_BY_LIFE\nbF.y=getValueFromTime(bD,uSizeYByLifetimeValue);\n#endif\nvec3 bG=bB(aRot,bD,bz)*(aDirX*bF.x+aDirY*bF.y);vec3 bH=bx(aVel,aOffset.z,uParams.x,bz);vec3 bI=aPos+bH;\n#if ORB_VEL_X + ORB_VEL_Y + ORB_VEL_Z\nbI=bj(bf(bD,bz))*(bI-uOrbCenter);bI+=uOrbCenter;\n#endif\n#if LINEAR_VEL_X + LINEAR_VEL_Y + LINEAR_VEL_Z\nbI.xyz+=bh(bD,bz);\n#endif\n#ifdef FINAL_TARGET\nfloat bJ=getValueFromTime(bD,uForceCurve);vec4 bK=vec4(mix(bI,uFinalTarget,bJ),1.);\n#else\nvec4 bK=vec4(bI,1.0);\n#endif\n#if RENDER_MODE == 1\nbK.xyz+=bG;bK=uModel*bK;\n#elif RENDER_MODE == 3\nbK=uModel*bK;bK.xyz+=uView[0].xyz*bG.x+uView[2].xyz*bG.y;\n#elif RENDER_MODE == 2\nbK=uModel*bK;bK.xy+=bG.xy;\n#elif RENDER_MODE == 0\nbK=uModel*bK;bK.xyz+=uView[0].xyz*bG.x+uView[1].xyz*bG.y;\n#endif\ngl_Position=uViewProjection*bK;vSeed=aSeed;gl_PointSize=6.0;\n#ifdef USE_FILTER\nfilterMain(bD);\n#endif\n#ifdef ENV_EDITOR\ngl_Position=vec4(gl_Position.xy*uEditorTransform.xy+uEditorTransform.zw*gl_Position.w,gl_Position.zw);\n#endif\n#pragma EDITOR_VERT_TRANSFORM\n}}";var fs$2="precision mediump float;\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\nlayout (location = 0) out  vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\n\n\n\nvec4 a(vec4 b,vec4 c,float d){vec4 e=b*c;\n#ifdef PRE_MULTIPLY_ALPHA\nfloat f=c.a;\n#else\nfloat f=e.a;\n#endif\nif(d==1.){e.rgb*=f;}else if(d==2.){e.rgb*=f;e.a=dot(e.rgb,vec3(0.33333333));}else if(d==3.){f=b.r*f;e=vec4(c.rgb*f,f);}return e;}\n#define PATICLE_SHADER 1\nin float vLife;in vec2 vTexCoord;in vec4 vColor;uniform sampler2D uMaskTex;uniform vec4 uColorParams;uniform vec2 uTexOffset;\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\n\n#ifdef USE_SPRITE\nin vec4 vTexCoordBlend;\n#ifdef USE_FILTER\nuniform vec4 uFSprite;\n#endif\n\n#endif\nin float vSeed;\n#ifdef PREVIEW_BORDER\nuniform vec4 uPreviewColor;\n#endif\n\n#ifdef USE_SPRITE\nvec4 getTextureColor(sampler2D g,vec2 texCoord){if(vTexCoordBlend.w>0.){return mix(texture2D(g,texCoord),texture2D(g,vTexCoordBlend.xy+texCoord),vTexCoordBlend.z);}return texture2D(g,texCoord);}\n#else\n\n#define getTextureColor texture2D\n\n#endif\n\n#ifndef WEBGL2\n\n#define round(a) floor(0.5+a)\n\n#endif\n\n#ifdef PREVIEW_BORDER\nvoid main(){fragColor=uPreviewColor;}\n#else\n\n#pragma FILTER_FRAG\nvoid main(){vec4 b=vec4(1.0);vec4 h=vColor;vec2 texOffset=uTexOffset;if(vLife<0.){discard;}\n#ifdef USE_FILTER\n#ifdef USE_SPRITE\ntexOffset=uTexOffset/uFSprite.xy;\n#endif\nb=filterMain(vTexCoord,uMaskTex);\n#else\nif(uColorParams.x>0.0){b=getTextureColor(uMaskTex,vTexCoord);}\n#endif\n#ifdef COLOR_OVER_LIFETIME\n#ifndef ENABLE_VERTEX_TEXTURE\nh*=texture2D(uColorOverLifetime,vec2(vLife,0.));\n#endif\n#endif\nb=a(b,h,round(uColorParams.y));if(b.a<=0.01&&uColorParams.w>0.){float i=texture2D(uMaskTex,vTexCoord+texOffset).a+texture2D(uMaskTex,vTexCoord+texOffset*-1.).a;if(i<=0.02){discard;}}fragColor=b;}\n#endif\n";var ParticleMesh=function(){function ParticleMesh(props,options){var renderer=options.renderer;var ENV_EDITOR=options.env==="editor";var marcos=[["RENDER_MODE",+props.renderMode||0],["PRE_MULTIPLY_ALPHA",false],["ENV_EDITOR",ENV_EDITOR]];var isGL2=renderer.gpu.level===2;var vertex_lookup_texture=0;var shaderCacheId=0;var vertexKeyFrameMeta=createKeyFrameMeta();var fragmentKeyFrameMeta=createKeyFrameMeta();var enableVertexTexture=renderer.gpu.capability.maxVertexUniforms>0;var uniformValues={};if(enableVertexTexture){marcos.push(["ENABLE_VERTEX_TEXTURE",true]);}if(props.speedOverLifetime){marcos.push(["SPEED_OVER_LIFETIME",true]);shaderCacheId|=1<<1;uniformValues.uSpeedLifetimeValue=props.speedOverLifetime.toUniform(vertexKeyFrameMeta);}var sprite=props.sprite;this.renderFrame=props.renderFrame;if(sprite&&sprite.animate){marcos.push(["USE_SPRITE",true]);shaderCacheId|=1<<2;uniformValues.uFSprite=uniformValues.uSprite=new Float32Array([sprite.col,sprite.row,sprite.total,sprite.blend?1:0]);props.useSprite=true;}var filter;if(props.filter&&props.filter.name!=="none"){marcos.push(["USE_FILTER",true]);shaderCacheId|=1<<3;var f=createFilter(props.filter,options.composition);if(!f.particle){throw Error("particle filter "+props.filter.name+" not implement")}filter=f.particle;forEach$1(filter.uniforms,(function(getter,uName){if(uniformValues[uName]){throw Error("conflict uniform name:"+uName)}uniformValues[uName]=getter.toUniform(vertexKeyFrameMeta);}));forEach$1(filter.uniformValues,(function(val,uName){if(uniformValues[uName]){throw Error("conflict uniform name:"+uName)}uniformValues[uName]=val;}));}var colorOverLifetime=props.colorOverLifetime;if(colorOverLifetime&&colorOverLifetime.color){marcos.push(["COLOR_OVER_LIFETIME",true]);shaderCacheId|=1<<4;uniformValues.uColorOverLifetime=colorOverLifetime.color instanceof MarsTexture?colorOverLifetime.color:createGradientTexture(colorOverLifetime.color);}var opacity=colorOverLifetime&&colorOverLifetime.opacity;if(opacity){uniformValues.uOpacityOverLifetimeValue=opacity.toUniform(vertexKeyFrameMeta);}else {uniformValues.uOpacityOverLifetimeValue=createValueGetter(1).toUniform(vertexKeyFrameMeta);}var linearVelOverLifetime=props.linearVelOverLifetime;var orbitalVelOverLifetime=props.orbitalVelOverLifetime;var useOrbitalVel;["x","y","z"].forEach((function(pro,i){var defL=0;if(linearVelOverLifetime[pro]){uniformValues["uLinear"+pro.toUpperCase()+"ByLifetimeValue"]=linearVelOverLifetime[pro].toUniform(vertexKeyFrameMeta);defL=1;shaderCacheId|=1<<7+i;linearVelOverLifetime.enabled=true;}marcos.push(["LINEAR_VEL_"+pro.toUpperCase(),defL]);var defO=0;if(orbitalVelOverLifetime[pro]){uniformValues["uOrb"+pro.toUpperCase()+"ByLifetimeValue"]=orbitalVelOverLifetime[pro].toUniform(vertexKeyFrameMeta);defO=1;shaderCacheId|=1<<10+i;useOrbitalVel=true;orbitalVelOverLifetime.enabled=true;}marcos.push(["ORB_VEL_"+pro.toUpperCase(),defO]);}));if(linearVelOverLifetime.asMovement){marcos.push(["AS_LINEAR_MOVEMENT",true]);shaderCacheId|=1<<5;}if(useOrbitalVel){if(orbitalVelOverLifetime.asRotation){marcos.push(["AS_ORBITAL_MOVEMENT",true]);shaderCacheId|=1<<6;}uniformValues.uOrbCenter=new Float32Array(orbitalVelOverLifetime.center||[0,0,0]);}var sizeOverLifetime=props.sizeOverLifetime;uniformValues.uSizeByLifetimeValue=sizeOverLifetime.x.toUniform(vertexKeyFrameMeta);if(sizeOverLifetime!=null&&sizeOverLifetime.separateAxes){marcos.push(["SIZE_Y_BY_LIFE",1]);shaderCacheId|=1<<14;uniformValues.uSizeYByLifetimeValue=sizeOverLifetime.y.toUniform(vertexKeyFrameMeta);}var rot=props.rotationOverLifetime;if(rot.z){uniformValues.uRZByLifeTimeValue=rot.z.toUniform(vertexKeyFrameMeta);shaderCacheId|=1<<15;marcos.push(["ROT_Z_LIFETIME",1]);}if(rot.x){uniformValues.uRXByLifeTimeValue=rot.x.toUniform(vertexKeyFrameMeta);shaderCacheId|=1<<16;marcos.push(["ROT_X_LIFETIME",1]);}if(rot.y){uniformValues.uRYByLifeTimeValue=rot.y.toUniform(vertexKeyFrameMeta);shaderCacheId|=1<<17;marcos.push(["ROT_Y_LIFETIME",1]);}if(rot.asRotation){marcos.push(["ROT_LIFETIME_AS_MOVEMENT",1]);shaderCacheId|=1<<18;}var gravity=props.gravity;uniformValues.uAcceleration=[gravity[0]||0,gravity[1]||0,gravity[2]||0,0];uniformValues.uGravityModifierValue=props.gravityModifier.toUniform(vertexKeyFrameMeta);var forceOpt=props.forceTarget;if(forceOpt){marcos.push(["FINAL_TARGET",true]);shaderCacheId|=1<<19;uniformValues.uFinalTarget=new Float32Array(forceOpt.target);uniformValues.uForceCurve=forceOpt.curve.toUniform(vertexKeyFrameMeta);}var HALF_FLOAT=renderer.gpu.capability.halfFloatTexture;if(HALF_FLOAT&&fragmentKeyFrameMeta.max){shaderCacheId|=1<<20;uniformValues.uFCurveValueTexture=createHalfFloatTexture(CurveValue.getAllData(fragmentKeyFrameMeta,true),fragmentKeyFrameMeta.index,1);}else {uniformValues.uFCurveValues=CurveValue.getAllData(fragmentKeyFrameMeta);}var maxVertexUniforms=renderer.gpu.capability.maxVertexUniforms;var vertexCurveTexture=vertexKeyFrameMeta.max+vertexKeyFrameMeta.curves.length-32>maxVertexUniforms;if(getConfig(RENDER_PREFER_LOOKUP_TEXTURE)){vertexCurveTexture=true;}if(isGL2){vertexKeyFrameMeta.max=-1;vertexKeyFrameMeta.index=getSlot(vertexKeyFrameMeta.index);if(fragmentKeyFrameMeta.index>0){fragmentKeyFrameMeta.max=-1;fragmentKeyFrameMeta.index=getSlot(fragmentKeyFrameMeta.index);}}if(vertexCurveTexture&&HALF_FLOAT&&enableVertexTexture){var tex=createHalfFloatTexture(CurveValue.getAllData(vertexKeyFrameMeta,true),vertexKeyFrameMeta.index,1);uniformValues.uVCurveValueTexture=tex;vertex_lookup_texture=1;}else {uniformValues.uVCurveValues=CurveValue.getAllData(vertexKeyFrameMeta);}var shaderCache=["p",props.renderMode,shaderCacheId,vertexKeyFrameMeta.index,vertexKeyFrameMeta.max,fragmentKeyFrameMeta.index,fragmentKeyFrameMeta.max].join("+");var shader={fragment:fs$2,vertex:"#define LOOKUP_TEXTURE_CURVE "+vertex_lookup_texture+"\n"+vs$2,shared:true,cacheId:props.shaderCachePrefix+":"+shaderCache,marcos:marcos,downgrade:true,name:"particle#"+props.name};if(filter){shader.fragment=shader.fragment.replace(/#pragma\s+FILTER_FRAG/,filter.fragment);shader.vertex=shader.vertex.replace(/#pragma\s+FILTER_VERT/,filter.vertex||"void filterMain(float t){}\n");shader.cacheId+=props.filter.name;}marcos.push(["VERT_CURVE_VALUE_COUNT",vertexKeyFrameMeta.index],["FRAG_CURVE_VALUE_COUNT",fragmentKeyFrameMeta.index],["VERT_MAX_KEY_FRAME_COUNT",vertexKeyFrameMeta.max],["FRAG_MAX_KEY_FRAME_COUNT",fragmentKeyFrameMeta.max]);var mtlOptions={shader:shader,states:_extends({},sideToMtlStates(props.side),{depthTest:true,depthMask:!!props.occlusion}),uniformSemantics:{uView:"VIEW",uViewProjection:"VIEWPROJECTION",uEditorTransform:"EDITOR_TRANSFORM",uModel:"MODEL"}};var diffuse=props.diffuse||createDataTexture();props.diffuse=diffuse;diffuse.assignRenderer(renderer);uniformValues.uTexOffset=new Float32Array(diffuse?[1/diffuse.width,1/diffuse.height]:[0,0]);uniformValues.uParams=new Float32Array([0,props.duration,0,0]);uniformValues.uMaskTex=diffuse;var anchor=props.anchor;this.anchor=anchor?[anchor[0]-.5,.5-anchor[1]]:[0,0];var blending=props.blending;var preMulAlpha=setMtlBlending(blending,mtlOptions.states);setMtlStencil(props.maskMode,props.mask,mtlOptions.states);uniformValues.uColorParams=new Float32Array([diffuse?1:0,+preMulAlpha,0,+(props.occlusion&&!props.transparentOcclusion)]);mtlOptions.uniformValues=uniformValues;var geometry=new MarsGeometry(ParticleMesh.geometry(props.useSprite,"particle#"+props.name));this.mesh=new MarsMesh({name:"MParticle_"+props.name,priority:props.listIndex,material:new MarsMaterial(mtlOptions),geometry:geometry});if(isGL2){var db=new MarsMaterialDataBlock({name:"CurveValues"});db.setUniformValue("uVCurveValues",uniformValues.uVCurveValues);db.setUniformValue("uFCurveValues",uniformValues.uFCurveValues);this.mesh.material.addDataBlock(db);}this.geometry=this.mesh.geometry;this._time=0;this.forceTarget=forceOpt;this.sizeOverLifetime=props.sizeOverLifetime;this.speedOverLifetime=props.speedOverLifetime;this.linearVelOverLifetime=props.linearVelOverLifetime;this.orbitalVelOverLifetime=orbitalVelOverLifetime;this.orbitalVelOverLifetime=orbitalVelOverLifetime;this.gravityModifier=props.gravityModifier;this.maxCount=props.maxCount;this.useSprite=props.useSprite;this.duration=props.duration;this.emitterMatrix=props.matrix||mat4create();this.textureOffsets=props.textureFlip?[0,0,1,0,0,1,1,1]:[0,1,0,0,1,1,1,0];this.particleCount=0;}ParticleMesh.geometry=function geometry(useSprite,name){var bpe=Float32Array.BYTES_PER_ELEMENT;var j12=bpe*12;var attributes={aPos:{size:3,offset:0,stride:j12,data:new Float32Array(0)},aVel:{size:3,offset:3*bpe,stride:j12,dataSource:"aPos"},aDirX:{size:3,offset:6*bpe,stride:j12,dataSource:"aPos"},aDirY:{size:3,offset:9*bpe,stride:j12,dataSource:"aPos"},aRot:{size:3,offset:0,stride:8*bpe,data:new Float32Array(0)},aSeed:{size:1,offset:3*bpe,stride:8*bpe,dataSource:"aRot"},aColor:{size:4,offset:4*bpe,stride:8*bpe,dataSource:"aRot"},aOffset:{size:4,stride:4*bpe,data:new Float32Array(0)}};if(useSprite){attributes["aSprite"]={size:3,data:new Float32Array(0)};}return {attributes:attributes,index:{data:new Uint16Array(0)},name:name}};var _proto=ParticleMesh.prototype;_proto.getPointColor=function getPointColor(index){var data=this.geometry.getAttributeData("aRot");var i=index*32+4;return [data[i],data[i+1],data[i+2],data[i+3]]};_proto.getPointPosition=function getPointPosition(index){var geo=this.geometry;var posIndex=index*48;var posData=geo.getAttributeData("aPos");var offsetData=geo.getAttributeData("aOffset");var time=this.time-offsetData[index*16+2];var pointDur=offsetData[index*16+3];var mtl=this.mesh.material;var ret=calculateTranslation([0,0,0],this,mtl.defaultDataBlock.getUniformValue("uAcceleration"),time,pointDur,posData,posData,posIndex,posIndex+3);if(this.forceTarget){var target=mtl.defaultDataBlock.getUniformValue("uFinalTarget");var life=this.forceTarget.curve.getValue(time/pointDur);var dl=1-life;ret[0]=ret[0]*dl+target[0]*life;ret[1]=ret[1]*dl+target[1]*life;ret[2]=ret[2]*dl+target[2]*life;}return ret};_proto.clearPoints=function clearPoints(){this.resetGeometryData(this.geometry);this.particleCount=this.geometry.drawCount=this.maxParticleBufferCount=0;};_proto.resetGeometryData=function resetGeometryData(geometry){var names=geometry.getAttributeNames();for(var i=0;i<names.length;i++){var name=names[i];var data=geometry.getAttributeData(name);if(data){geometry.setAttributeData(name,new data.constructor(0));}}var index=geometry.getIndexData();geometry.setIndexData(new index.constructor(0));};_proto.reverseTime=function reverseTime(time){var data=this.geometry.getAttributeData("aOffset");for(var i=0;i<data.length;i+=4){data[i+2]-=time;}this.geometry.setAttributeData("aOffset",data);this.time-=time;};_proto.removePoint=function removePoint(index){if(index<this.particleCount){this.geometry.setAttributeSubData("aOffset",index*16,new Float32Array(16));}};_proto.setPoint=function setPoint(point,index){index=index||0;var maxCount=this.maxCount;if(index<maxCount){var particleCount=1+index;var vertexCount=particleCount*4;var geometry=this.geometry;var increaseBuffer=particleCount>this.maxParticleBufferCount;var inc=1;if(this.particleCount>300){inc=(this.particleCount+100)/this.particleCount;}else if(this.particleCount>100){inc=1.4;}else if(this.particleCount>0){inc=2;}var pointData={aPos:new Float32Array(48),aRot:new Float32Array(32),aOffset:new Float32Array(16)};var useSprite=this.useSprite;if(useSprite){pointData.aSprite=new Float32Array(12);}var offsets=this.textureOffsets;var off=[0,0,point.delay,point.lifetime];var wholeUV=[0,0,1,1];var pos=point.pos;var vel=point.vel;var color=point.color;var rot=ensureVec3(point.rot);var sprite;if(useSprite){sprite=point.sprite;}var anchor=this.anchor;var sizeOffsets=[-.5,.5,-.5,-.5,.5,.5,.5,-.5];var seed=Math.random();for(var j=0;j<4;j++){var offset=j*2;var j3=j*3;var j4=j*4;var j12=j*12;var j8=j*8;pointData.aPos.set(pos,j12);pointData.aPos.set(vel,j12+3);pointData.aRot.set(rot,j8);pointData.aRot[j8+3]=seed;pointData.aRot.set(color,j8+4);if(useSprite){pointData.aSprite.set(sprite,j3);}var uv=point.uv||wholeUV;if(uv){var uvy=useSprite?1-offsets[offset+1]:offsets[offset+1];off[0]=uv[0]+offsets[offset]*uv[2];off[1]=uv[1]+uvy*uv[3];}pointData.aOffset.set(off,j4);var ji=j+j;var sx=(sizeOffsets[ji]-anchor[0])*point.size[0];var sy=(sizeOffsets[ji+1]-anchor[1])*point.size[1];for(var k=0;k<3;k++){pointData.aPos[j12+6+k]=point.dirX[k]*sx;pointData.aPos[j12+9+k]=point.dirY[k]*sy;}}var indexData=new Uint16Array([0,1,2,2,1,3].map((function(x){return x+index*4})));if(increaseBuffer){var baseIndexData=geometry.getIndexData();var idx=enlargeBuffer(baseIndexData,particleCount*6,inc,maxCount*6);idx.set(indexData,index*6);geometry.setIndexData(idx);this.maxParticleBufferCount=idx.length/6;}else {geometry.setIndexSubData(index*6,indexData);}forEach$1(pointData,(function(data,name){var attrSize=geometry.getAttributeStride(name)/Float32Array.BYTES_PER_ELEMENT;if(increaseBuffer){var baseData=geometry.getAttributeData(name);var geoData=enlargeBuffer(baseData,vertexCount*attrSize,inc,maxCount*4*attrSize);geoData.set(data,data.length*index);geometry.setAttributeData(name,geoData);}else {geometry.setAttributeSubData(name,data.length*index,data);}}));this.particleCount=Math.max(particleCount,this.particleCount);geometry.drawCount=this.particleCount*6;}return this};_createClass(ParticleMesh,[{key:"time",get:function get(){return this.mesh.material.defaultDataBlock.getUniformValue("uParams")[0]},set:function set(v){this.mesh.material.defaultDataBlock.setUniformValue("uParams",new Float32Array([+v,this.duration,0,0]));}}]);return ParticleMesh}();var webgl2UniformSlots=[10,32,64,160];function getSlot(count){for(var w=0;w<webgl2UniformSlots.length;w++){var slot=webgl2UniformSlots[w];if(slot>count){return slot}}return count||webgl2UniformSlots[0]}var Cone=function(){function Cone(props){objAssign(this,props);}var _proto=Cone.prototype;_proto.generate=function generate(opt){var arc=getArcAngle(this.arc,this.arcMode,opt);var a=arc*.017453292519943295;var x=Math.cos(a)*this.radius;var y=Math.sin(a)*this.radius;var position=[x,y,0];var l=Math.tan(this.angle*.017453292519943295);var dir=vecDot([],position,l);dir[2]+=1;return {position:vecDot(position,position,random(0,1)),direction:vecNormalize(dir,dir)}};return Cone}();function getArcAngle(arc,arcMode,opt){if(arcMode===0){arc=random(0,arc);}else if(arcMode===1){var d=opt.index%(opt.total+1);arc=arc/opt.total*d;}else if(arcMode===2){var _d=opt.index/(opt.total+1);var i=_d-Math.floor(_d);arc=arc*(Math.floor(_d)%2?1-i:i);}else if(arcMode===3){arc=arc*opt.burstIndex/opt.burstCount;}return arc}var tempMat3$2=[];var Sphere=function(){function Sphere(props){objAssign(this,props);}var _proto=Sphere.prototype;_proto.getHorizontalAngle=function getHorizontalAngle(){return random(-90,90)};_proto.generate=function generate(opt){var rz=getArcAngle(this.arc,this.arcMode,opt)*.017453292519943295;var rh=this.getHorizontalAngle()*.017453292519943295;var radius=this.radius;var point=[Math.cos(rh),0,Math.sin(rh)];var mat3=mat3FromRotationZ(tempMat3$2,rz);var p=vec3MulMat3(point,point,mat3);return {position:p.map((function(a){return a*radius})),direction:p}};return Sphere}();var Hemisphere=function(_Sphere){_inheritsLoose(Hemisphere,_Sphere);function Hemisphere(){return _Sphere.apply(this,arguments)||this}var _proto2=Hemisphere.prototype;_proto2.getHorizontalAngle=function getHorizontalAngle(){return random(0,90)};return Hemisphere}(Sphere);var Circle=function(){function Circle(arg){objAssign(this,arg);}var _proto=Circle.prototype;_proto.generate=function generate(opt){var arc=getArcAngle(this.arc,this.arcMode,opt)*.017453292519943295;var direction=[Math.cos(arc),Math.sin(arc),0];var radius=this.radius;return {direction:direction,position:direction.map((function(n){return n*radius}))}};return Circle}();var Rectangle=function(){function Rectangle(arg){this._d=(arg.width||1)/2;this._h=(arg.height||1)/2;}var _proto2=Rectangle.prototype;_proto2.generate=function generate(opt){var x=random(-this._d,this._d);var y=random(-this._h,this._h);return {direction:[0,0,1],position:[x,y,0]}};return Rectangle}();var RectangleEdge=function(){function RectangleEdge(arg){this._d=(arg.width||1)/2;this._h=(arg.height||1)/2;this.arcMode=arg.arcMode;this.arc=arg.arc;}var _proto3=RectangleEdge.prototype;_proto3.generate=function generate(opt){var arc=getArcAngle(this.arc,this.arcMode,opt)*.017453292519943295;var direction=[Math.cos(arc),Math.sin(arc),0];var w=this._d;var h=this._h;var r0=Math.atan2(h,w);var tan=Math.tan(arc);var position;if(arc<r0){position=[w,w*tan,0];}else if(arc>=r0&&arc<Math.PI-r0){position=[h/tan,h,0];}else if(arc<Math.PI+r0){position=[-w,-w*tan,0];}else if(arc<PI2-r0){position=[-h/tan,-h,0];}else {position=[w,w*tan,0];}return {direction:direction,position:position}};return RectangleEdge}();var Edge=function(){function Edge(arg){this._d=(arg.width||1)/2;this.arcMode=arg.arcMode;}var _proto4=Edge.prototype;_proto4.generate=function generate(opt){var x=this.arcMode===3?opt.burstIndex%opt.burstCount/(opt.burstCount-1):random(0,1);return {direction:[0,1,0],position:[this._d*(x-.5),0,0]}};return Edge}();var tempMat3$1=[];var Donut=function(){function Donut(props){objAssign(this,props);}var _proto=Donut.prototype;_proto.generate=function generate(opt){var dradius=this.donutRadius;var center=this.radius-dradius;var angle=random(0,PI2);var arc=getArcAngle(this.arc,this.arcMode,opt)*.017453292519943295;var rot=mat3FromRotationZ(tempMat3$1,arc);var direction=[Math.cos(angle),Math.sin(angle),0];var position=[center+Math.cos(angle)*dradius,0,Math.sin(angle)*dradius];return {direction:vec3MulMat3(direction,direction,rot),position:vec3MulMat3(position,position,rot)}};return Donut}();var TextureShape=function(){function TextureShape(arg){var detail=arg.detail||{anchors:[.5,.5],block:[0,0]};this.anchors=new Float32Array(detail.anchors);this.width=arg.width||1;this.height=arg.height||1;this.block=detail.block;this.arcMode=arg.arcMode;this.random=clamp(arg.random||0,0,1);}var _proto=TextureShape.prototype;_proto.generate=function generate(opt){var anchors=this.anchors;var pointCount=anchors.length/2-1;var index=Math.floor(getArcAngle(pointCount,this.arcMode,opt));var pointX=(anchors[index*2]+this.block[0]*this.random*Math.random())%1-.5;var pointY=(anchors[index*2+1]+this.block[1]*this.random*Math.random())%1-.5;var dir=[pointX,pointY,0];return {position:[pointX*this.width,pointY*this.height,0],direction:vecNormalize(dir,dir)}};return TextureShape}();var ShapeNone=function(){function ShapeNone(){}var _proto=ShapeNone.prototype;_proto.generate=function generate(){return {position:[0,0,0],direction:[0,0,0]}};return ShapeNone}();var map={[ShapeType.NONE]:ShapeNone,[ShapeType.CONE]:Cone,[ShapeType.SPHERE]:Sphere,[ShapeType.HEMISPHERE]:Hemisphere,[ShapeType.CIRCLE]:Circle,[ShapeType.DONUT]:Donut,[ShapeType.RECTANGLE]:Rectangle,[ShapeType.EDGE]:Edge,[ShapeType.RECTANGLE_EDGE]:RectangleEdge,[ShapeType.TEXTURE]:TextureShape};var PI2=Math.PI*2;function createShape(arg){if(!arg){return new ShapeNone}var opt=objAssign({radius:1,arc:360,angle:0,arcMode:0},arg||{});var Ctrl=map[arg.type];if(!Ctrl){throw Error("invalid shape:"+arg.type)}var ret=new Ctrl(opt);if(arg.type!==ShapeType.NONE){objAssign(ret,{alignSpeedDirection:arg.alignSpeedDirection,upDirection:vecNormalize(arg.upDirection||[0,0,1])});}return ret}var Burst=function(){function Burst(opt){this.time=+opt.time||0;this.interval=+opt.interval||1;this.count=opt.count instanceof ValueGetter?opt.count:createValueGetter(opt.count);this.cycles=+opt.cycles||Infinity;this.probability=isNaN(opt.probability)?1:+opt.probability;this.reset();}var _proto=Burst.prototype;_proto.getGeneratorOptions=function getGeneratorOptions(timePassed,lifetime){var dt=timePassed-this.time-this._now;var interval=this.interval;if(dt>interval*this._i&&this._cycles>0){this._cycles--;this._i++;return Math.random()<=this.probability?{index:this._i,total:1/interval,count:this.count.getValue(lifetime),cycleIndex:this.cycles-this._cycles-1}:null}};_proto.reset=function reset(){this._cycles=this.cycles;this._i=0;this._now=0;return this};_proto.clone=function clone(){return new Burst(this)};return Burst}();var vs$1="precision mediump float;\n#define SHADER_VERTEX 1\n\n#version 300 es\n\n#ifdef WEBGL2\n\n#define texture2D texture\n\n#else\n\n#endif\n\n#ifdef SHADER_VERTEX\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n#define CURVE_VALUE_ARRAY uVCurveValues\n#define CURVE_VALUE_COUNT VERT_CURVE_VALUE_COUNT\n#define FRAG_CURVE_VALUE_COUNT 0\n#else\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n#define CURVE_VALUE_ARRAY uFCurveValues\n#define CURVE_VALUE_COUNT FRAG_CURVE_VALUE_COUNT\n#define VERT_CURVE_VALUE_COUNT 0\n#endif\n\n#if CURVE_VALUE_COUNT > 0\n    #if LOOKUP_TEXTURE_CURVE\n            uniform sampler2D CURVE_VALUE_TEXTURE;\n            const float uCurveCount = 1./ float(CURVE_VALUE_COUNT);\n            #define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n    #else\n        #ifdef WEBGL2\n            layout(std140) uniform CurveValues{\n                #if VERT_CURVE_VALUE_COUNT > 0\n                vec4 uVCurveValues[VERT_CURVE_VALUE_COUNT];\n                #endif\n                #if FRAG_CURVE_VALUE_COUNT > 0\n                vec4 uFCurveValues[FRAG_CURVE_VALUE_COUNT];\n                #endif\n            };\n            #define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n        #else\n            uniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n            #define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n        #endif\n    #endif\n#else\n    #define lookup_curve(i) vec4(0.)\n#endif\n\n\n#ifdef WEBGL2\n#define ITR_END (count + 1)\n#else\n#define ITR_END MAX_C\n#endif\n\n\n#ifdef SHADER_VERTEX\nin float aSeed;out float vSeed;\n#define NONE_CONST_INDEX 1\n\n#else\n\n#if LOOKUP_TEXTURE_CURVE\n\n#define NONE_CONST_INDEX 1\n\n#endif\n\n#endif\n\n#ifdef NONE_CONST_INDEX\n\n#ifdef SHADER_VERTEX\n\n#define MAX_C VERT_MAX_KEY_FRAME_COUNT\n\n#else\n\n#define MAX_C FRAG_MAX_KEY_FRAME_COUNT\n\n#endif\n\n#else\n\n#define MAX_C CURVE_VALUE_COUNT\n\n#endif\nfloat a(float b,vec4 c,vec4 d){float e=d.x-c.x;float f=c.w*e;float g=d.z*e;float h=(b-c.x)/e;float i=h*h;float j=i*h;return dot(vec4(dot(vec3(2.,-3.,1.),vec3(j,i,1.)),dot(vec3(1,-2.,1),vec3(j,i,h)),j-i,dot(vec2(-2,3),vec2(j,i))),vec4(c.y,f,g,d.y));}float k(float b,float l,float m){int start=int(l);int count=int(m-1.);int end=start+count;for(int i=0;i<ITR_END;i++){\n#ifdef NONE_CONST_INDEX\nif(i==count){return lookup_curve(count).y;}vec4 n=lookup_curve(i+start);vec4 o=lookup_curve(i+1+start);\n#else\nif(i<start){continue;}vec4 n=lookup_curve(i);vec4 o=lookup_curve(i+1);if(i==end){return n.y;}\n#endif\nif(b>=n.x&&b<=o.x){return a(b,n,o);}}return lookup_curve(0).y;}float p(float h,vec2 q,vec2 r){return q.y+(r.y-q.y)*(h-q.x)/(r.x-q.x);}float s(float b,float l,float m){int start=int(l);int count=int(m-1.);int end=start+count;for(int i=0;i<ITR_END;i++){\n#ifdef NONE_CONST_INDEX\nif(i>count){return lookup_curve(i).w;}\n#else\nif(i<start){continue;}if(i>end){return lookup_curve(i-2).w;}\n#endif\n#ifdef NONE_CONST_INDEX\nvec4 t=lookup_curve(i+start);\n#else\nvec4 t=lookup_curve(i);\n#endif\nvec2 q=t.xy;vec2 r=t.zw;if(b>=q.x&&b<=r.x){return p(b,q,r);}\n#ifdef NONE_CONST_INDEX\nvec2 u=lookup_curve(i+start+1).xy;\n#else\nvec2 u=lookup_curve(i+1).xy;\n#endif\nif(b>r.x&&b<=u.x){return p(b,r,u);}}return lookup_curve(0).y;}float getValueFromTime(float b,vec4 v){float w=v.x;if(w==0.){return v.y;}else if(w==1.){return mix(v.y,v.z,b/v.w);}if(w==2.){return k(b,floor(v.y),floor(1./fract(v.y)+0.5))*v.w+v.z;}if(w==3.){return s(b,v.y,v.z);}if(w==4.){\n#ifdef SHADER_VERTEX\nfloat seed=aSeed;\n#else\nfloat seed=vSeed;\n#endif\nreturn mix(v.y,v.z,seed);}return 0.;}in vec4 aPos;in vec3 aDir;in vec3 aInfo;in vec4 aColor;in float aTime;\n#ifdef ATTR_TRAIL_START\nin float aTrailStart;\n#else\nuniform float uTrailStart[64];in float aTrailStartIndex;\n#endif\nuniform mat4 uView;uniform mat4 uModel;uniform mat4 uViewProjection;uniform vec4 uTextureMap;uniform float uTime;uniform vec4 uParams;uniform vec4 uColorParams;uniform vec4 uOpacityOverLifetimeValue;uniform vec4 uWidthOverTrail;\n#ifdef COLOR_OVER_TRAIL\nuniform sampler2D uColorOverTrail;\n#endif\n\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\nout float vLife;out vec2 vTexCoord;out vec4 vColor;\n#ifdef ENV_EDITOR\nuniform vec4 uEditorTransform;\n#endif\nvoid main(){vec4 x=uViewProjection*vec4(aPos.xyz,1.);vec4 y=uViewProjection*vec4(aPos.xyz+aDir,1.);vec2 z=normalize(y.xy/y.w-x.xy/x.w);vec2 A=vec2(-z.y,z.x);vec4 B=uModel*vec4(aPos.xyz,1.);\n#ifdef ATTR_TRAIL_START\nfloat C=aTrailStart;\n#else\nfloat C=uTrailStart[int(aTrailStartIndex)];\n#endif\nfloat D=(C-aInfo.y)/uParams.y;float E=aPos.w*getValueFromTime(D,uWidthOverTrail)/max(abs(A.x),abs(A.y));B.xyz+=(uView[0].xyz*A.x+uView[1].xyz*A.y)*E;float b=min((uTime-aTime)/aInfo.x,1.0);gl_Position=uViewProjection*B;vColor=aColor;\n#ifdef COLOR_OVER_LIFETIME\n#ifdef ENABLE_VERTEX_TEXTURE\nvColor*=texture2D(uColorOverLifetime,vec2(b,0.));\n#endif\n#endif\n#ifdef COLOR_OVER_TRAIL\nvColor*=texture2D(uColorOverTrail,vec2(D,0.));\n#endif\nvColor.a*=clamp(getValueFromTime(b,uOpacityOverLifetimeValue),0.,1.);vLife=b;vTexCoord=uTextureMap.xy+vec2(D,aInfo.z)*uTextureMap.zw;vSeed=aSeed;\n#ifdef ENV_EDITOR\ngl_Position=vec4(gl_Position.xy*uEditorTransform.xy+uEditorTransform.zw*gl_Position.w,gl_Position.zw);\n#endif\n}";var TrailMesh=function(){function TrailMesh(props,options){var keyFrameMeta=createKeyFrameMeta();var renderer=options.renderer;var enableVertexTexture=renderer.gpu.capability.maxVertexTextures>0;var isGL2=renderer.gpu.level===2;var shaderCacheId=0;var uniformValues={};var lookUpTexture=getConfig(RENDER_PREFER_LOOKUP_TEXTURE)?1:0;var ENV_EDITOR=options.env==="editor";var marcos=[["ENABLE_VERTEX_TEXTURE",enableVertexTexture],["LOOKUP_TEXTURE_CURVE",lookUpTexture],["ENV_EDITOR",ENV_EDITOR]];if(props.colorOverLifetime){marcos.push(["COLOR_OVER_LIFETIME",true]);shaderCacheId|=1;uniformValues.uColorOverLifetime=createGradientTexture(props.colorOverLifetime).assignRenderer(renderer);}if(props.colorOverTrail){marcos.push(["COLOR_OVER_TRAIL",true]);shaderCacheId|=1<<2;uniformValues.uColorOverTrail=createGradientTexture(props.colorOverTrail).assignRenderer(renderer);}var useAttributeTrailStart=props.maxTrailCount>64;if(useAttributeTrailStart){marcos.push(["ATTR_TRAIL_START",1]);shaderCacheId|=1<<3;}else {uniformValues.uTrailStart=new Float32Array(props.maxTrailCount);}var opacityOverLifetime=props.opacityOverLifetime||createValueGetter(1);uniformValues.uOpacityOverLifetimeValue=opacityOverLifetime.toUniform(keyFrameMeta);var uWidthOverTrail=props.widthOverTrail.toUniform(keyFrameMeta);marcos.push(["VERT_CURVE_VALUE_COUNT",keyFrameMeta.index],["VERT_MAX_KEY_FRAME_COUNT",keyFrameMeta.max]);if(enableVertexTexture&&lookUpTexture){var tex=createHalfFloatTexture(CurveValue.getAllData(keyFrameMeta,true),keyFrameMeta.index,1);uniformValues.uVCurveValueTexture=tex.assignRenderer(renderer);}else {uniformValues.uVCurveValues=CurveValue.getAllData(keyFrameMeta);}var pointCountPerTrail=Math.max(props.pointCountPerTrail,2);var mtl={shader:{vertex:vs$1,fragment:fs$2,marcos:marcos,downgrade:true,shared:true,name:"trail#"+props.name,cacheId:props.shaderCachePrefix+":t+"+shaderCacheId+"+"+keyFrameMeta.index+"+"+keyFrameMeta.max},states:{depthMask:props.occlusion,cullFaceEnabled:false,depthTest:true},uniformSemantics:{uViewProjection:"VIEWPROJECTION",uView:"VIEWINVERSE",uModel:"MODEL",uEditorTransform:"EDITOR_TRANSFORM"}};var maxVertexCount=pointCountPerTrail*props.maxTrailCount*2;var maxTriangleCount=(pointCountPerTrail-1)*props.maxTrailCount;var bpe=Float32Array.BYTES_PER_ELEMENT;var v12=12*bpe;var geometryOptions={attributes:{aColor:{size:4,stride:v12,data:new Float32Array(maxVertexCount*12)},aSeed:{size:1,stride:v12,offset:4*bpe,dataSource:"aColor"},aInfo:{size:3,stride:v12,offset:5*bpe,dataSource:"aColor"},aPos:{size:4,stride:v12,offset:8*bpe,dataSource:"aColor"},aTime:{size:1,data:new Float32Array(maxVertexCount)},aDir:{size:3,data:new Float32Array(maxVertexCount*3)}},index:{data:new Uint16Array(maxVertexCount*6)},drawCount:maxTriangleCount*6,name:"trail#"+props.name,bufferUsage:constants.DYNAMIC_DRAW};if(useAttributeTrailStart){geometryOptions.attributes.aTrailStart={size:1,data:new Float32Array(maxVertexCount)};}else {var indexData=new Float32Array(maxVertexCount);geometryOptions.attributes.aTrailStartIndex={size:1,data:indexData};for(var i=0;i<props.maxTrailCount;i++){var c=pointCountPerTrail*2;var s=i*c;for(var j=0;j<c;j++){indexData[s+j]=i;}}}var preMulAlpha=setMtlBlending(props.blending,mtl.states);setMtlStencil(props.maskMode,props.mask,mtl.states);var mesh=this.mesh=new MarsMesh({name:"MTrail_"+props.name,material:new MarsMaterial(mtl),geometry:new MarsGeometry(geometryOptions),priority:props.order});mesh.assignRenderer(renderer);mesh.material.defaultDataBlock.setUniformValues(uniformValues);mesh.material.defaultDataBlock.setUniformValues({uTime:0,uWidthOverTrail:uWidthOverTrail,uTexOffset:[0,0],uTextureMap:new Float32Array(props.textureMap||[0,0,1,1]),uParams:new Float32Array([0,pointCountPerTrail-1,0,0]),uMaskTex:(props.texture||createDataTexture()).assignRenderer(renderer),uColorParams:new Float32Array([props.texture?1:0,+preMulAlpha,0,+(props.occlusion&&!props.transparentOcclusion)])});if(isGL2){var _uniformValues$uVCurv,_uniformValues$uFCurv;if((_uniformValues$uVCurv=uniformValues.uVCurveValues)!=null&&_uniformValues$uVCurv.length||(_uniformValues$uFCurv=uniformValues.uFCurveValues)!=null&&_uniformValues$uFCurv.length){var db=new MarsMaterialDataBlock({name:"CurveValues"});db.setUniformValue("uVCurveValues",uniformValues.uVCurveValues);db.setUniformValue("uFCurveValues",uniformValues.uFCurveValues);this.mesh.material.addDataBlock(db);}}this.maxTrailCount=props.maxTrailCount;this.pointCountPerTrail=pointCountPerTrail;this.checkVertexDistance=props.minimumVertexDistance>0;this.minimumVertexDistance=Math.pow(props.minimumVertexDistance||.001,2);this.useAttributeTrailStart=useAttributeTrailStart;this.lifetime=props.lifetime;if(props._matrix){this.mesh.worldMatrix=props._matrix;}this.geometry=mesh.geometry;this._trailCursors=new Uint16Array(props.maxTrailCount);this._pointStart=[];}var _proto=TrailMesh.prototype;_proto.addPoint=function addPoint(trailIndex,point,opt){opt=opt||{};var cursor=this._trailCursors[trailIndex];var pointCountPerTrail=this.pointCountPerTrail;var geometry=this.geometry;var segmentPerTrail=pointCountPerTrail-1;var pointIndex=cursor%pointCountPerTrail;var previousIndex=(cursor-1)%pointCountPerTrail;var bpreviousIndex=(cursor-2)%pointCountPerTrail;var previousPoint=this.getPoint(trailIndex,previousIndex,tmp0);if(previousPoint&&this.checkVertexDistance&&vecSquareDistance(previousPoint,point)<this.minimumVertexDistance){return}var pointStartIndex=trailIndex*pointCountPerTrail+pointIndex;var dir=calculateDirection(previousPoint,point);var time=opt.time||this.time;var info=[Math.random(),opt.lifetime||this.lifetime,cursor];var size=opt.size||1;var dirStartIndex=pointStartIndex*6;var dirData=new Float32Array(6);dirData.set(dir,0);dirData.set(dir,3);geometry.setAttributeSubData("aDir",dirStartIndex,dirData);geometry.setAttributeSubData("aTime",pointStartIndex*2,new Float32Array([time,time]));var color=opt.color||[1,1,1,1];var colorData=new Float32Array(24);colorData.set(color,0);colorData.set(info,4);colorData[7]=0;colorData.set(point,8);colorData[11]=.5*size;colorData.set(color,12);colorData.set(info,16);colorData[19]=1;colorData.set(point,20);colorData[23]=-.5*size;geometry.setAttributeSubData("aColor",pointStartIndex*24,colorData);if(previousIndex>=0){var bPreviousPoint=this.getPoint(trailIndex,bpreviousIndex,tmp1);var previousDir=new Float32Array(calculateDirection(bPreviousPoint,previousPoint,point));var previousDirStartIndex=(trailIndex*pointCountPerTrail+previousIndex)*6;geometry.setAttributeSubData("aDir",previousDirStartIndex,previousDir);geometry.setAttributeSubData("aDir",previousDirStartIndex+3,previousDir);var indicesStart=trailIndex*pointCountPerTrail*2;var indicesData=new Uint16Array([previousIndex*2+indicesStart,previousIndex*2+1+indicesStart,pointIndex*2+indicesStart,pointIndex*2+indicesStart,previousIndex*2+1+indicesStart,pointIndex*2+1+indicesStart]);var start=(trailIndex*segmentPerTrail+(cursor-1)%segmentPerTrail)*6;geometry.setIndexSubData(start,indicesData);}cursor=++this._trailCursors[trailIndex];var mtl=this.mesh.material;var params=mtl.defaultDataBlock.getUniformValue("uParams");var trailStart=info[2];if(this.useAttributeTrailStart){var len=pointCountPerTrail*2;var startData=new Float32Array(len);for(var i=0;i<len;i++){startData[i]=trailStart;}geometry.setAttributeSubData("aTrailStart",trailIndex*startData.length,startData);}else {var _value=mtl.defaultDataBlock.getUniformValue("uTrailStart");_value[trailIndex]=trailStart;mtl.defaultDataBlock.setUniformValue("uTrailStart",_value);}params[1]=Math.max(params[1],cursor-1)-Math.max(0,cursor-pointCountPerTrail);mtl.defaultDataBlock.setUniformValue("uParams",params);};_proto.getPoint=function getPoint(trail,index,out){var pointCountPerTrail=this.pointCountPerTrail;if(index>=0&&index<pointCountPerTrail){var startIndex=(trail*pointCountPerTrail+index)*24+8;var data=this.geometry.getAttributeData("aColor");out[0]=data[startIndex];out[1]=data[1+startIndex];out[2]=data[2+startIndex];return out}};_proto.clearAllTrails=function clearAllTrails(){var geo=this.geometry;this._trailCursors=new Uint16Array(this._trailCursors.length);geo.setIndexData(new Uint16Array(geo.getIndexData().length));};_proto.reverseTime=function reverseTime(time){var data=this.geometry.getAttributeData("aTime");for(var i=0;i<data.length;i++){data[i]-=time;}this.geometry.setAttributeData("aTime",data);this.time-=time;};_proto.clearTrail=function clearTrail(index){if(this._trailCursors[index]!==0){var pointCountPerTrail=this.pointCountPerTrail;var indicesPerTrail=(pointCountPerTrail-1)*6;var indices=this.geometry.getIndexData();indices.set(new Uint8Array(indicesPerTrail),index*indicesPerTrail);this.geometry.setIndexData(indices);this._trailCursors[index]=0;}};_proto.getPointStartPos=function getPointStartPos(index){return this._pointStart[index]};_proto.setPointStartPos=function setPointStartPos(index,pos){this._pointStart[index]=pos;};_proto._onUpdate=function _onUpdate(escapeTime){};_createClass(TrailMesh,[{key:"time",get:function get(){return this.mesh.material.defaultDataBlock.getUniformValue("uTime")},set:function set(t){this.mesh.material.defaultDataBlock.setUniformValue("uTime",t);}}]);return TrailMesh}();var tmp0=[];var tmp1=[];var tempDir$1=[0,0,0];var tempDa=[0,0,0];var tempDb=[0,0,0];function calculateDirection(prePoint,point,nextPoint){var dir=tempDir$1;if(!prePoint&&!nextPoint){return [0,0,0]}else if(!prePoint){vecMinus(dir,nextPoint,point);}else if(!nextPoint){vecMinus(dir,point,prePoint);}else {vecNormalize(tempDa,vecMinus(tempDa,point,prePoint));vecNormalize(tempDb,vecMinus(tempDa,nextPoint,point));vecAdd(dir,tempDa,tempDb);}return vecNormalize(dir,dir)}var LinkNode=function LinkNode(content){this.content=content;};var Link=function(){function Link(func){this.length=0;this._sort=func;}var _proto=Link.prototype;_proto.findNodeByContent=function findNodeByContent(filter){var node=this.first;if(node){do{if(filter(node.content)){return node}}while(node=node.next)}};_proto._insertNode=function _insertNode(a,next){var b=a.next;a.next=next;next.pre=a;next.next=b;if(b){b.pre=next;}};_proto.shiftNode=function shiftNode(content){var node=new LinkNode(content);this.length++;if(this.length===1){return this.first=this.last=node}var current=this.first;while(current){if(this._sort(current.content,node.content)<=0){if(current.next){current=current.next;}else {this._insertNode(current,node);return this.last=node}}else {if(current.pre){this._insertNode(current.pre,node);}else {this.first=node;node.next=current;current.pre=node;}return node}}};_proto.pushNode=function pushNode(content){var node=new LinkNode(content);this.length++;if(this.length===1){return this.last=this.first=node}var current=this.last;while(current){if(this._sort(node.content,current.content)<=0){if(this.first===current){current.pre=node;node.next=current;return this.first=node}else {current=current.pre;}}else {this._insertNode(current,node);if(current===this.last){this.last=node;}return node}}};_proto.removeNode=function removeNode(node){var current=this.first;this.length--;if(current===node){var _a=this.first=current.next;if(_a){_a.pre=null;}}else if((current=this.last)===node){var _a2=this.last=current.pre;if(_a2){_a2.next=null;}}else if(node){var pre=node.pre;var next=node.next;pre.next=next;if(next){next.pre=pre;}}node.pre=null;node.next=null;};_proto.forEach=function forEach(func,thisObj){var node=this.first;var i=0;if(node){do{func.call(thisObj||this,node.content,i++);}while(node=node.next)}};_proto.forEachReverse=function forEachReverse(func,thisObj){var node=this.last;var i=this.length-1;if(node){do{func.call(thisObj||this,node.content,i--);}while(node=node.pre)}};return Link}();var ParticleSystem=function(){function ParticleSystem(props,rendererOpt,vfxItem){var options=props.options;var positionOverLifetime=props.positionOverLifetime;var shape=props.shape;var duration=vfxItem.duration||1;var gravityModifier=positionOverLifetime.gravityOverLifetime;var _textureSheetAnimation=props.textureSheetAnimation;var textureSheetAnimation=_textureSheetAnimation?{animationDelay:createValueGetter(_textureSheetAnimation.animationDelay||0),animationDuration:createValueGetter(_textureSheetAnimation.animationDuration||1),cycles:createValueGetter(_textureSheetAnimation.cycles||1),animate:_textureSheetAnimation.animate,col:_textureSheetAnimation.col,row:_textureSheetAnimation.row,total:_textureSheetAnimation.total||_textureSheetAnimation.col*_textureSheetAnimation.row}:null;var renderMatrix=mat4create();this._worldMat4=mat4create();var startTurbulence=!!(shape&&shape.turbulenceX||shape.turbulenceY||shape.turbulenceZ);var turbulence;if(startTurbulence){turbulence=[createValueGetter(shape.turbulenceX||0),createValueGetter(shape.turbulenceY||0),createValueGetter(shape.turbulenceZ||0)];}var ctrl={renderMatrix:renderMatrix,options:{particleFollowParent:!!options.particleFollowParent,startLifetime:createValueGetter(options.startLifetime),startDelay:createValueGetter(options.startDelay||0),startSpeed:createValueGetter(positionOverLifetime.startSpeed||0),startColor:createValueGetter(options.startColor),endBehavior:vfxItem.endBehavior,duration:duration,looping:vfxItem.endBehavior===ItemEndBehavior.loop,maxCount:options.maxCount||0,gravityModifier:createValueGetter(gravityModifier||0).scaleXCoord(duration),start3DSize:!!options.start3DSize,startTurbulence:startTurbulence,turbulence:turbulence},shape:createShape(props.shape),emission:{rateOverTime:createValueGetter(props.emission.rateOverTime),burstOffsets:getBurstOffsets(props.emission.burstOffsets),bursts:(props.emission.bursts||[]).map((function(c){return new Burst(c)}))},textureSheetAnimation:textureSheetAnimation,name:vfxItem.name};if(options.startRotationZ){ctrl.options.startRotation=createValueGetter(options.startRotationZ||0);}if(options.startRotationX||options.startRotationY){ctrl.options.start3DRotation=true;ctrl.options.startRotationX=createValueGetter(options.startRotationX||0);ctrl.options.startRotationY=createValueGetter(options.startRotationY||0);ctrl.options.startRotationZ=createValueGetter(options.startRotationZ||0);}if(options.start3DSize){ctrl.options.startSizeX=createValueGetter(options.startSizeX);ctrl.options.startSizeY=createValueGetter(options.startSizeY);}else {ctrl.options.startSize=createValueGetter(options.startSize);ctrl.options.sizeAspect=createValueGetter(options.sizeAspect||1);}var renderer=props.renderer||{};var rotationOverLifetime={};var rotOverLt=props.rotationOverLifetime;if(rotOverLt){rotationOverLifetime.asRotation=!!rotOverLt.asRotation;rotationOverLifetime.z=rotOverLt.z?createValueGetter(rotOverLt.z):createValueGetter(0);if(rotOverLt.separateAxes){rotationOverLifetime.x=rotOverLt.x&&createValueGetter(rotOverLt.x);rotationOverLifetime.y=rotOverLt.y&&createValueGetter(rotOverLt.y);}}var forceTarget;if(positionOverLifetime.forceTarget){forceTarget={target:positionOverLifetime.target||[0,0,0],curve:createValueGetter(positionOverLifetime.forceCurve||[ValueType.LINE,[[0,0],[1,1]]])};}var linearVelOverLifetime={x:positionOverLifetime.linearX&&createValueGetter(positionOverLifetime.linearX||0),y:positionOverLifetime.linearY&&createValueGetter(positionOverLifetime.linearY||0),z:positionOverLifetime.linearZ&&createValueGetter(positionOverLifetime.linearZ||0),asMovement:positionOverLifetime.asMovement};var orbitalVelOverLifetime={x:positionOverLifetime.orbitalX&&createValueGetter(positionOverLifetime.orbitalX),y:positionOverLifetime.orbitalY&&createValueGetter(positionOverLifetime.orbitalY),z:positionOverLifetime.orbitalZ&&createValueGetter(positionOverLifetime.orbitalZ),center:positionOverLifetime.orbCenter,asRotation:positionOverLifetime.asRotation};var sizeOverLifetime=props.sizeOverLifetime;var colorOverLifetime=props.colorOverLifetime;var order=vfxItem.listIndex;var shaderCachePrefix=rendererOpt.cachePrefix||"";var meshOptions={renderFrame:vfxItem.composition.renderFrame,listIndex:order,name:vfxItem.name,matrix:renderMatrix,filter:props.filter,shaderCachePrefix:shaderCachePrefix,renderMode:renderer.renderMode||0,side:renderer.side||1032,gravityModifier:ctrl.options.gravityModifier,gravity:ensureVec3(positionOverLifetime.gravity),duration:vfxItem.duration,blending:renderer.blending||0,rotationOverLifetime:rotationOverLifetime,linearVelOverLifetime:linearVelOverLifetime,orbitalVelOverLifetime:orbitalVelOverLifetime,speedOverLifetime:positionOverLifetime.speedOverLifetime&&createValueGetter(positionOverLifetime.speedOverLifetime),sprite:textureSheetAnimation,occlusion:!!renderer.occlusion,transparentOcclusion:!!renderer.transparentOcclusion,maxCount:options.maxCount,mask:renderer.mask,maskMode:renderer.maskMode,forceTarget:forceTarget,diffuse:renderer.texture,sizeOverLifetime:sizeOverLifetime?{separateAxes:sizeOverLifetime.separateAxes,x:createValueGetter(sizeOverLifetime.separateAxes?sizeOverLifetime.x||1:sizeOverLifetime.size),y:createValueGetter(sizeOverLifetime.separateAxes?sizeOverLifetime.y||1:sizeOverLifetime.size)}:{x:createValueGetter(1)},anchor:renderer.anchor||convertParticleOrigin2Anchor(renderer.particleOrigin)};if(colorOverLifetime){var color=colorOverLifetime.color,opacity=colorOverLifetime.opacity;meshOptions.colorOverLifetime={};if(opacity){meshOptions.colorOverLifetime.opacity=createValueGetter(colorOverLifetime.opacity);}if(color&&color[0]===ValueType.GRADIENT_COLOR){meshOptions.colorOverLifetime.color=colorOverLifetime.color[1];}else if(color instanceof MarsTexture){meshOptions.colorOverLifetime.color=color;}}var uvs=[];var textureMap=[0,0,1,1];var flip;if(props.splits){var s=props.splits[0];flip=s[4];textureMap=flip?[s[0],s[1],s[3],s[2]]:[s[0],s[1],s[2],s[3]];}if(textureSheetAnimation&&!textureSheetAnimation.animate){var col=flip?textureSheetAnimation.row:textureSheetAnimation.col;var row=flip?textureSheetAnimation.col:textureSheetAnimation.row;var total=textureSheetAnimation.total||col*row;var index=0;for(var x=0;x<col;x++){for(var y=0;y<row&&index<total;y++,index++){uvs.push([x*textureMap[2]/col+textureMap[0],y*textureMap[3]/row+textureMap[1],textureMap[2]/col,textureMap[3]/row]);}}}else {uvs.push(textureMap);}meshOptions.textureFlip=flip;ctrl._uvs=uvs;ctrl.particleMesh=new ParticleMesh(meshOptions,rendererOpt);var trails=props.trails;if(trails){ctrl.trails={lifetime:createValueGetter(trails.lifetime),dieWithParticles:trails.dieWithParticles!==false,sizeAffectsWidth:trails.sizeAffectsWidth,sizeAffectsLifetime:trails.sizeAffectsLifetime,inheritParticleColor:trails.inheritParticleColor,parentAffectsPosition:trails.parentAffectsPosition};ctrl.trailMesh=new TrailMesh({name:vfxItem.name+"_trail",colorOverLifetime:trails.colorOverLifetime&&trails.colorOverLifetime[0]===ValueType.GRADIENT_COLOR&&trails.colorOverLifetime[1],_matrix:renderMatrix,minimumVertexDistance:trails.minimumVertexDistance||.02,maxTrailCount:options.maxCount,pointCountPerTrail:Math.round(trails.maxPointPerTrail)||32,blending:trails.blending,texture:trails.texture,opacityOverLifetime:createValueGetter(trails.opacityOverLifetime||1),widthOverTrail:createValueGetter(trails.widthOverTrail||1),colorOverTrail:trails.colorOverTrail&&trails.colorOverTrail[0]===ValueType.GRADIENT_COLOR&&trails.colorOverTrail[1],order:order+(trails.orderOffset||0),shaderCachePrefix:shaderCachePrefix,lifetime:trails.lifetime,occlusion:!!trails.occlusion,transparentOcclusion:!!trails.transparentOcclusion,textureMap:trails.textureMap,mask:renderer.mask,maskMode:renderer.maskMode},rendererOpt);}objAssign(this,ctrl);this.transform=vfxItem.transform;var position=deepClone(this.transform.position);var rotation=deepClone(this.transform.rotation);var transformPath=props.emitterTransform&&props.emitterTransform.path;var path;if(transformPath){if(transformPath[0]===ValueType.CONSTANT_VEC3){vecAdd(position,position,transformPath[1]);}else {path=createValueGetter(transformPath);}}this._transformFormula={position:position,rotation:rotation,path:path};this._updateEmitterTransform(0);var meshes=[this.particleMesh.mesh];if(this.trailMesh){meshes.push(this.trailMesh.mesh);}this.meshes=meshes;this.reusable=vfxItem.reusable;this.hide=vfxItem.hide;var interaction=props.interaction;if(interaction){this.interaction={multiple:interaction.multiple,radius:interaction.radius,behavior:interaction.behavior};}}var _proto=ParticleSystem.prototype;_proto.getTextures=function getTextures(){var ret=[];iterMesh(this.particleMesh.mesh);if(this.trailMesh){iterMesh(this.trailMesh.mesh);}return ret;function iterMesh(mesh){if(mesh){forEach$1(mesh.material.defaultDataBlock.getUniformValues(),(function(val,name){if(val instanceof MarsTexture){ret.push(val);mesh.material.defaultDataBlock.setUniformValue(name,undefined);}}));}}};_proto.start=function start(){if(!this._started||this._ended){this.reset();this._started=true;this._ended=false;}return this};_proto.stop=function stop(){this._ended=true;this._started=false;};_proto.reset=function reset(){this.particleMesh.clearPoints();if(this.trailMesh){this.trailMesh.clearAllTrails();}this._lastUpdate=this._loopStartTime=0;this._lastEmitTime=-1/this.emission.rateOverTime.getValue(0);this._info={generatedCount:0};this._particleLink=new Link((function(a,b){return a[0]-b[0]}));this.emission.bursts.forEach((function(b){return b.reset()}));this._frozen=false;return this};_proto._onUpdate=function _onUpdate(timeDelta){var _this=this;if(this._started&&!this._frozen){var now=this._lastUpdate+timeDelta/1e3;var particleMesh=this.particleMesh;var trailMesh=this.trailMesh;var options=this.options;var loopStartTime=this._loopStartTime;this._lastUpdate=now;var emission=this.emission;particleMesh.time=now;if(trailMesh){trailMesh.time=now;trailMesh._onUpdate(timeDelta);}this._upDirectionWorld=null;var link=this._particleLink;var emitterLifetime=(now-loopStartTime)/options.duration;var timePassed=this.timePassed;var trailUpdated=false;var updateTrail=function updateTrail(){if(_this.trails&&!trailUpdated){trailUpdated=true;link.forEach((function(_ref){var time=_ref[0],cursor=_ref[1],delay=_ref[2],size=_ref[3];if(time<timePassed){_this.clearPointTrail(cursor);}else if(timePassed>delay){_this.updatePointTrail(cursor,emitterLifetime,size,delay);}}));}};if(!this._ended){var duration=options.duration;var lifetime=this.lifetime;if(timePassed<duration){var interval=1/emission.rateOverTime.getValue(lifetime);var pointCount=Math.floor((timePassed-this._lastEmitTime)/interval);var maxEmissionCount=pointCount;var _timeDelta=interval/pointCount;var meshTime=now;var maxCount=options.maxCount;this._updateEmitterTransform(timePassed);var shouldSkipGenerate=function shouldSkipGenerate(){var first=link.first;return _this.emissionStopped||link.length===maxCount&&first&&first.content[0]-loopStartTime>timePassed};for(var i=0;i<maxEmissionCount&&i<maxCount;i++){if(shouldSkipGenerate()){break}var p=this.createPoint(lifetime);p.delay+=meshTime+i*_timeDelta;this._addParticle(p,maxCount);this._lastEmitTime=timePassed;}var bursts=emission.bursts;for(var j=(bursts==null?void 0:bursts.length)-1,cursor=0;j>=0&&cursor<maxCount;j--){if(shouldSkipGenerate()){break}var burst=bursts[j];var opts=!burst.disabled&&burst.getGeneratorOptions(timePassed,lifetime);if(opts){var originVec=[0,0,0];var offsets=emission.burstOffsets[j];var burstOffset=offsets&&offsets[opts.cycleIndex]||originVec;if(burst.once){this.removeBurst(j);}for(var _i2=0;_i2<opts.count&&cursor<maxCount;_i2++){if(shouldSkipGenerate()){break}var _p=this.initPoint(this.shape.generate({total:opts.total,index:opts.index,burstIndex:_i2,burstCount:opts.count}));_p.delay+=meshTime;cursor++;vecAdd(_p.pos,_p.pos,burstOffset);this._addParticle(_p,maxCount);}}}}else if(options.looping){now-=duration;this._loopStartTime=now;this._lastEmitTime-=duration;this._lastUpdate-=duration;updateTrail();emission.bursts.forEach((function(b){return b.reset()}));particleMesh.reverseTime(duration);if(trailMesh){trailMesh.reverseTime(duration);}this._particleLink.forEach((function(content){content[0]-=duration;content[2]-=duration;}));this.onIterate(this);}else {this._ended=true;this.onEnd(this);var endBehavior=options.endBehavior;if(endBehavior===4){this._frozen=true;}}}else if(!options.looping){if(this.reusable);else if(0===options.endBehavior){var node=link.last;if(node&&node.content[0]-loopStartTime<timePassed){this._onUpdate=function(){return _this._onDestroy(_this)};}}}updateTrail();}};_proto._updateEmitterTransform=function _updateEmitterTransform(time){var parentTransform=this._parentTransform;var transform=this._transformFormula;var node=this.transform;var changed;if(parentTransform||transform.path){changed=true;}if(transform.path){changed=true;}if(changed){var selfPos=vecFill(tempVec3,0);this.transform.invalid();if(transform.position){vecAdd(selfPos,selfPos,this._transformFormula.position);}if(transform.path){var duration=this.options.duration;vecAdd(selfPos,selfPos,transform.path.getValue(time/duration));}node.setPosition(selfPos[0],selfPos[1],selfPos[2]);if(this.options.particleFollowParent&&parentTransform){parentTransform.getWorldMatrix(this.particleMesh.mesh.worldMatrix);if(this.trailMesh){parentTransform.getWorldMatrix(this.trailMesh.mesh.worldMatrix);}}}};_proto._onDestroy=function _onDestroy(item){};_proto.raycast=function raycast(options){var currentTime=this.timePassed;var link=this._particleLink;var mesh=this.particleMesh;if(!(link&&mesh)){return}var node=link.last;var hitPositions=[];var finish=false;if(node){do{var nodeContent=node.content;var cursor=nodeContent[1];var temp=[];if(nodeContent[0]>currentTime){var pos=mesh.getPointPosition(cursor);var ray=options.ray;var pass=false;if(ray){pass=!!intersectRaySphere(temp,ray.center,ray.direction,pos,options.radius);}if(pass){if(options.removeParticle){mesh.removePoint(cursor);this.clearPointTrail(cursor);link.removeNode(node);nodeContent[0]=0;link.shiftNode(node.content);}hitPositions.push(pos);if(!options.multiple){finish=true;}}}else {break}}while((node=node.pre)&&!finish)}return hitPositions};_proto._addParticle=function _addParticle(point,maxCount){var link=this._particleLink;var linkContent=[point.delay+point.lifetime,0,point.delay,point.size[0]];var cursor;if(link.length<maxCount){cursor=linkContent[1]=link.length;}else {var first=link.first;link.removeNode(first);cursor=linkContent[1]=first.content[1];}link.pushNode(linkContent);this.particleMesh.setPoint(point,cursor);this.clearPointTrail(cursor);if(this._parentTransform&&this.trailMesh){this.trailMesh.setPointStartPos(cursor,this._parentTransform.position);}};_proto.clearPointTrail=function clearPointTrail(pointIndex){if(this.trails&&this.trails.dieWithParticles){this.trailMesh.clearTrail(pointIndex);}};_proto.updatePointTrail=function updatePointTrail(pointIndex,emitterLifetime,size,startTime){var trails=this.trails;var particleMesh=this.particleMesh;var position=particleMesh.getPointPosition(pointIndex);var color=trails.inheritParticleColor&&particleMesh.getPointColor(pointIndex);var width=1;var lifetime=trails.lifetime.getValue(emitterLifetime);if(trails.sizeAffectsWidth){width*=size;}if(trails.sizeAffectsLifetime){lifetime*=size;}if(trails.parentAffectsPosition&&this._parentTransform){vecAdd(position,position,this._parentTransform.position);var pos=this.trailMesh.getPointStartPos(pointIndex);if(pos){vecMinus(position,position,pos);}}this.trailMesh.addPoint(pointIndex,position,{color:color,lifetime:lifetime,size:width,time:startTime});};_proto.onEnd=function onEnd(particle){};_proto.onIterate=function onIterate(particle){};_proto.initPoint=function initPoint(data){var options=this.options;var lifetime=this.lifetime;var shape=this.shape;var speed=options.startSpeed.getValue(lifetime);var followParent=this.options.particleFollowParent;var matrix4=followParent?this.transform.matrix:this.transform.getWorldMatrix(this._worldMat4);var pos=vec3MulMat4(data.position,data.position,matrix4);var direction=data.direction;direction=vecNormalize(tempDir,vec3RotateByMat4(tempDir,direction,matrix4));if(options.startTurbulence){for(var i=0;i<3;i++){tempVec3[i]=options.turbulence[i].getValue(lifetime);}var mat3=mat3FromRotation(tempMat3,tempVec3);direction=vecNormalize(tempDir,vec3MulMat3(direction,direction,mat3));}var dirX=tmpDirX;var dirY=tmpDirY;if(shape.alignSpeedDirection){vecAssign(dirY,direction,3);if(!this._upDirectionWorld){this._upDirectionWorld=vec3RotateByMat4([],shape.upDirection,matrix4);}dirX=vecNormalize(dirX,vec3Cross(dirX,dirY,this._upDirectionWorld));}else {dirX[0]=1;dirX[1]=dirX[2]=0;dirY[1]=1;dirY[0]=dirY[2]=0;}var sprite;var tsa=this.textureSheetAnimation;if(tsa&&tsa.animate){sprite=tempSprite;sprite[0]=tsa.animationDelay.getValue(lifetime);sprite[1]=tsa.animationDuration.getValue(lifetime);sprite[2]=tsa.cycles.getValue(lifetime);}var rot=tempRot;if(options.start3DRotation){rot=[options.startRotationX.getValue(lifetime),options.startRotationY.getValue(lifetime),options.startRotationZ.getValue(lifetime)];}else if(options.startRotation){rot=[0,0,options.startRotation.getValue(lifetime)];}var color=options.startColor.getValue(lifetime);if(color.length===3){color[3]=1;}var size=tempSize;if(options.start3DSize){size[0]=options.startSizeX.getValue(lifetime);size[1]=options.startSizeY.getValue(lifetime);}else {var n=options.startSize.getValue(lifetime);var aspect=options.sizeAspect.getValue(lifetime);size[0]=n;size[1]=n/aspect;}if(!followParent){this.transform.getWorldTRS(null,null,tempVec3);vecMulCombine(size,size,tempVec3);}return {vel:vecDot(tempVel,direction,speed),color:color,pos:pos,delay:options.startDelay.getValue(lifetime),lifetime:options.startLifetime.getValue(lifetime),size:size,uv:randomArrItem(this._uvs,true),sprite:sprite,rot:rot,dirY:dirY,dirX:dirX}};_proto.addBurst=function addBurst(burst,offsets){if(arrAdd$1(this.emission.bursts,burst)&&offsets instanceof Array){var index=this.emission.bursts.indexOf(burst);this.emission.burstOffsets[index]=offsets;return index}return -1};_proto.removeBurst=function removeBurst(index){if(index<this.emission.bursts.length){this.emission.burstOffsets[index]=null;this.emission.bursts.splice(index,1);}};_proto.createPoint=function createPoint(lifetime){var generator={total:this.emission.rateOverTime.getValue(lifetime),index:this._info.generatedCount,burstIndex:0,burstCount:0};this._info.generatedCount++;return this.initPoint(this.shape.generate(generator))};_createClass(ParticleSystem,[{key:"timePassed",get:function get(){return this._lastUpdate-this._loopStartTime}},{key:"lifetime",get:function get(){return this.timePassed/this.options.duration}},{key:"parentTransform",set:function set(t){this._parentTransform=t;}},{key:"hide",set:function set(h){this.particleMesh.mesh.hide=h;if(this.trailMesh){this.trailMesh.mesh.hide=h;}}}]);return ParticleSystem}();var tempVel=[0,0,0];var tempDir=[0,0,0];var tempSize=[0,0];var tempRot=[0,0,0];var tmpDirX=[0,0,0];var tmpDirY=[0,0,0];var tempVec3=[0,0,0];var tempSprite=[0,0,0];var tempMat3=[];function getBurstOffsets(burstOffsets){var ret={};if(Array.isArray(burstOffsets)){burstOffsets.forEach((function(arr){var isArr=arr instanceof Array;var index=isArr?arr[0]:arr.index;var offsets=ret[index];if(!offsets){offsets=ret[index]=[];}if(isArr){offsets.push(arr.slice(1,4));}else {offsets.push([+arr.x,+arr.y,+arr.z]);}}));}return ret}var ParticleVFXItem=function(_VFXItem){_inheritsLoose(ParticleVFXItem,_VFXItem);function ParticleVFXItem(){var _this;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_VFXItem.call.apply(_VFXItem,[this].concat(args))||this;_this._destroyParticleItem=function(item){_this._particleDestroyed=true;};return _this}var _proto=ParticleVFXItem.prototype;_proto.onConstructed=function onConstructed(options){this.particle=options.content;};_proto.onLifetimeBegin=function onLifetimeBegin(renderer,particleSystem){if(particleSystem){particleSystem.name=this.name;particleSystem.start();particleSystem._onDestroy=this._destroyParticleItem;this._region={delegate:this,id:this.id,name:this.name,parentId:this.parentId,behavior:0};}return particleSystem};_proto.stopParticleEmission=function stopParticleEmission(){if(this._content){this._content.emissionStopped=true;}};_proto.resumeParticleEmission=function resumeParticleEmission(){if(this._content){this._content.emissionStopped=false;}};_proto.precompile=function precompile(shaderLibrary){var _particle$trailMesh;this.createContent();var particle=this._content;var renderer=this.composition.renderer;particle.particleMesh.mesh.assignRenderer(renderer);(_particle$trailMesh=particle.trailMesh)==null?void 0:_particle$trailMesh.mesh.assignRenderer(renderer);};_proto._createContent=function _createContent(renderer){if(this.particle){var opt=renderer.getParticleOptions();return new ParticleSystem(this.particle,opt,this)}};_proto.onItemRemoved=function onItemRemoved(composition,content){if(content){composition.destroyTextures(content.getTextures());content.meshes.forEach((function(mesh){return mesh.destroy({material:{textures:DestroyOptions.keep}})}));}};_proto._isEnded=function _isEnded(now){return _VFXItem.prototype._isEnded.call(this,now)&&this._particleDestroyed};_proto.getHitTestParams=function getHitTestParams(force){var _this2=this;var ui=this._content.interaction;if(force||ui){return {type:HitTestType.custom,collect:function collect(ray){return _this2._content.raycast({radius:ui&&ui.radius||.4,multiple:ui&&ui.multiple,removeParticle:ui&&ui.behavior===1,ray:ray})}}}};_proto.onItemUpdate=function onItemUpdate(dt,lifetime){if(this._content){var hide=this.hide;if(!hide&&this.parentId){var parentData=this.composition.calculateGroup.getRenderData(this.parentId);if(parentData){this._content.parentTransform=parentData.transform;if(parentData.hide){hide=true;}}}if(hide){this._content.hide=true;}else {this._content.hide=false;this._content._onUpdate(dt);}}};_createClass(ParticleVFXItem,[{key:"type",get:function get(){return "2"},set:function set(v){}},{key:"contentVisible",get:function get(){return !this._particleDestroyed}}]);return ParticleVFXItem}(VFXItem);var ParticleLoader=function(_MarsPlugin){_inheritsLoose(ParticleLoader,_MarsPlugin);function ParticleLoader(){var _this;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_MarsPlugin.call.apply(_MarsPlugin,[this].concat(args))||this;_this._meshesToAdd=[];return _this}var _proto=ParticleLoader.prototype;_proto.addParticle=function addParticle(particle){var _this2=this;particle.meshes.forEach((function(mesh){return arrAdd$1(_this2._meshesToAdd,mesh)}));};_proto.removeParticle=function removeParticle(particle,frame){var _this3=this;particle.meshes.forEach((function(mesh){arrRemove$1(_this3._meshesToAdd,mesh);frame.removeMeshFromDefaultRenderPass(mesh);}));};_proto.onCompositionItemLifeBegin=function onCompositionItemLifeBegin(composition,item){if(item instanceof ParticleVFXItem){this.addParticle(item.content);}};_proto.onCompositionItemRemoved=function onCompositionItemRemoved(composition,item){if(item instanceof ParticleVFXItem){if(item.content){this.removeParticle(item.content,composition.renderFrame);}}};_proto.onCompositionPrecompile=function onCompositionPrecompile(composition){var compileOptions={rotationOverLifetime:{x:false,y:false,z:false},positionOverLifetime:{speedOverLifetime:false,linearX:false,linearY:false,linearZ:false,orbitalX:false,orbitalY:false,orbitalZ:false},colorOverLifetime:{opacity:false,color:false}};var defValue={colorOverLifetime:{opacity:1,color:createDataTexture()},positionOverLifetime:{speedOverLifetime:1}};var pros=[];var items=[];if(composition.renderer.gpu.level===2){composition.items.forEach((function(item){if(item.type==="2"){items.push(item);var options=item.particle;forEach$1(compileOptions,(function(content,name){var target=options[name];if(target){Object.keys(content).forEach((function(pro){if(target[pro]){content[pro]=true;arrAdd$1(pros,name);}}));}}));}}));items.forEach((function(item){var options=item.particle;pros.forEach((function(name){var content=compileOptions[name];var target=options[name]||(options[name]={});Object.keys(content).forEach((function(pro){if(content[pro]&&!target[pro]){target[pro]=[ValueType.CONSTANT,defValue[name]&&defValue[name][pro]||0];}}));}));}));}};_proto.prepareRenderFrame=function prepareRenderFrame(composition,pipeline){this._meshesToAdd.forEach((function(mesh){return pipeline.addMeshToDefaultRenderPass(mesh)}));this._meshesToAdd.length=0;return false};return ParticleLoader}(MarsPlugin);var SpriteVFXItem=function(_VFXItem){_inheritsLoose(SpriteVFXItem,_VFXItem);function SpriteVFXItem(){return _VFXItem.apply(this,arguments)||this}var _proto=SpriteVFXItem.prototype;_proto.onConstructed=function onConstructed(options){this.sprite=options.content;};_proto._createContent=function _createContent(renderer){var opt=renderer.getParticleOptions();return new SpriteItem(this.sprite,opt,this)};_proto.onLifetimeBegin=function onLifetimeBegin(composition,content){this._contentVisible=true;};_proto.onItemRemoved=function onItemRemoved(composition,content){this._contentVisible=false;if(content){delete content.mesh;composition.destroyTextures(content.getTextures());}};_proto.precompile=function precompile(shaderLibrary){this.createContent();var item=this._content.renderInfo;if(!shaderLibrary.shaderResults[spriteMeshShaderIdFromRenderInfo(item,2)]){shaderLibrary.addShader(spriteMeshShaderFromRenderInfo(item,2));shaderLibrary.addShader(spriteMeshShaderFromRenderInfo(item,maxSpriteMeshItemCount));}};_proto.createSpriteMesh=function createSpriteMesh(renderInfo){return new SpriteMesh(renderInfo,this.composition.calculateGroup)};_proto._onHideChanged=function _onHideChanged(hide){if(this._content){this._content.hide=hide;}};_proto.getCurrentRenderData=function getCurrentRenderData(){var item=this._content;if(item){var ig=this.composition.loaderData.spriteGroup;if(ig){var mesh=ig.getSpriteMesh(item);if(mesh){return mesh.getItemRenderData(item)}}}};_proto.getCurrentPosition=function getCurrentPosition(){var pos=[0,0,0];this.transform.getWorldTRS(pos);return pos};_proto.getHitTestParams=function getHitTestParams(force){var item=this._content;var ig=this.composition.loaderData.spriteGroup;var ui=item&&item.interaction;if((force||ui)&&item&&ig){var mesh=ig.getSpriteMesh(item);if(!mesh){return}var renderData=this.getCurrentRenderData();if(renderData){var _item$interaction;var originalPos=[0,0,0];var position=renderData.position,quat=renderData.quat,scale=renderData.size;var startSize=this._content.startSize;var anchor=this._content._anchor;vecMinus(originalPos,position,[anchor[0]*startSize[0],anchor[1]*startSize[1],0]);var hw=startSize[0]*scale[0]/2,hh=startSize[1]*scale[1]/2;var aw=anchor[0]*startSize[0],ah=anchor[1]*startSize[1];var triangles=trianglesFromRect([-aw*scale[0],-ah*scale[1],0],hw,hh);triangles.forEach((function(triangle){triangle.forEach((function(p){rotateByQuat(p,p,quat);vecAdd(p,p,[aw+originalPos[0],ah+originalPos[1],originalPos[2]]);}));}));return {behavior:((_item$interaction=item.interaction)==null?void 0:_item$interaction.behavior)||0,type:HitTestType.triangle,triangles:triangles,backfaceCulling:item.renderer.side===1028}}else {console.error("Can not get SpriteVFXItem "+this.name+"'s renderer data");return}}};_proto.createWireframeMesh=function createWireframeMesh(item,color){var spMesh=new SpriteMesh(Object.assign({wireframe:true},item.renderInfo),this.composition.calculateGroup);spMesh.setItems([item]);spMesh.mesh.material.defaultDataBlock.setUniformValue("uFrameColor",new Float32Array([color[0],color[1],color[2]]));spMesh.mesh.priority=999;return spMesh};_createClass(SpriteVFXItem,[{key:"type",get:function get(){return "1"},set:function set(v){}}]);return SpriteVFXItem}(VFXItem);var seed=1;var FilterSpriteVFXItem=function(_SpriteVFXItem){_inheritsLoose(FilterSpriteVFXItem,_SpriteVFXItem);function FilterSpriteVFXItem(){return _SpriteVFXItem.apply(this,arguments)||this}var _proto=FilterSpriteVFXItem.prototype;_proto.onConstructed=function onConstructed(options){_SpriteVFXItem.prototype.onConstructed.call(this,options);this.filterOptions=options.content.filter;this.cachePrefix="filter:"+seed++;this.sprite.renderer.texture=this.composition.renderFrame.transparentTexture;};_proto.onItemUpdate=function onItemUpdate(dt,lifetime){var _this$_content;_SpriteVFXItem.prototype.onItemUpdate.call(this,dt,lifetime);var mesh=(_this$_content=this._content)==null?void 0:_this$_content.mesh;if(mesh){var db=mesh.mesh.material.defaultDataBlock;forEach$1(this.filter.mesh.variables,(function(func,uniformName){db.setUniformValue(uniformName,func(lifetime));}));}(this.filter.onItemUpdate||noop)(dt,this);};_proto.onItemRemoved=function onItemRemoved(composition,content){(this.filter.onItemRemoved||noop)(this);_SpriteVFXItem.prototype.onItemRemoved.call(this,composition,content);};_proto._createContent=function _createContent(composition){var c=_SpriteVFXItem.prototype._createContent.call(this,composition);var filter=this.filter=c.renderInfo.filter=c.filter=createFilter(this.filterOptions,composition);c.renderInfo.cacheId=c.renderInfo.cacheId.replace("$F$",filter.mesh.shaderCacheId);if(!filter.mesh.uniformValues){filter.mesh.uniformValues={};}forEach$1(filter.mesh.variables,(function(func,uniformName){filter.mesh.uniformValues[uniformName]=func(0);}));return c};_createClass(FilterSpriteVFXItem,[{key:"type",get:function get(){return "8"},set:function set(v){}}]);return FilterSpriteVFXItem}(SpriteVFXItem);var itemSortProperty="listIndex";var SpriteGroup=function(){function SpriteGroup(arg){this.time=0;this.calculateGroup=arg.calculateGroup;this.meshSplits=[];this._itemsToRemove=[];this._itemsToAdd=[];this._items=[];this.meshes=[];}var _proto=SpriteGroup.prototype;_proto.resetMeshSplits=function resetMeshSplits(){this.meshSplits.length=0;this.meshes.length=0;this._items.length=0;this._itemsToAdd.length=0;this._itemsToRemove.length=0;};_proto._check=function _check(){};_proto.diffMeshSplits=function diffMeshSplits(){var splits=this.meshSplits;var itemsToRemove=this._itemsToRemove;var itemsToAdd=this._itemsToAdd;var splitsToRemove=[];var meshToAdd=[];var meshToRemove=[];var meshToModify=[];var items=this._items;var layer={layerToAdd:[]};var combined=[];for(var i=0;i<itemsToRemove.length;i++){var item=itemsToRemove[i];if(isSprite(item)){splitsToRemove.push.apply(splitsToRemove,this.removeMeshSplitsItem(items,item,splits,itemsToRemove));this._check();}else {var itemIndex=items.indexOf(item);if(itemIndex>-1){items.splice(itemIndex,1);combined.length=0;if(itemIndex>0){combined=this.combineSplits(items,itemIndex-1,splits);splitsToRemove.push.apply(splitsToRemove,combined);}if(!combined.length&&itemIndex<=items.length-1){combined=this.combineSplits(items,itemIndex,splits);splitsToRemove.push.apply(splitsToRemove,combined);}this._check();}}}var checkCombine=false;for(var _i2=0;_i2<itemsToAdd.length;_i2++){var _item=itemsToAdd[_i2];var neoSplits=this.addMeshSplitsItem(items,_item,splits);for(var j=0;j<neoSplits.length;j++){var neoSplit=neoSplits[j];if(neoSplit.spriteMesh){throw Error("no sprite mesh in neo split")}var sp=neoSplit.spriteMesh=new SpriteMesh(neoSplit.renderInfo,this.calculateGroup);meshToAdd.push(sp.mesh);sp.setItems(neoSplit.items.map((function(c){return c.content})));sp.applyChange();if(sp.splitLayer){layer.layerToAdd.push(sp);}neoSplit.dirty=false;this._check();checkCombine=true;}}if(checkCombine){for(var _i4=0;_i4<splits.length-1;_i4++){var currentSplit=splits[_i4];var nextSplit=splits[_i4+1];if(nextSplit.cacheId===currentSplit.cacheId&&!nextSplit.spriteMesh.splitLayer&&!currentSplit.spriteMesh.splitLayer&&currentSplit.items.length+nextSplit.items.length<=maxSpriteMeshItemCount){var first=currentSplit.items[0];var last=nextSplit.items[nextSplit.items.length-1];var neo=this.getMeshSplits(items,items.indexOf(first),items.indexOf(last));if(neo.length===1){objAssign(currentSplit,neo[0]);currentSplit.spriteMesh.setItems(currentSplit.items.map((function(i){return i.content})));currentSplit.spriteMesh.applyChange();var mesh=nextSplit.spriteMesh.mesh;if(meshToAdd.includes(mesh)){arrRemove$1(meshToAdd,mesh);}else {arrAdd$1(meshToRemove,mesh);}splits.splice(_i4+1,1);_i4--;}}}}itemsToRemove.length=0;for(var _i6=0;_i6<splits.length;_i6++){var split=splits[_i6];var spriteMesh=split.spriteMesh;if(split.items.length===0){throw Error("split not combined")}if(split.dirty){var priority=split.indexStart;if(spriteMesh.mesh.priority!==priority){meshToModify.push(spriteMesh.mesh);}spriteMesh.setItems(split.items.map((function(item){return item._content})));}spriteMesh.applyChange();split.dirty=false;}if(splitsToRemove.length){for(var _i8=0;_i8<splitsToRemove.length;_i8++){var _split=splitsToRemove[_i8];var _sp=_split.spriteMesh;var _mesh=_sp.mesh;_mesh.destroy({material:{textures:DestroyOptions.keep}});meshToRemove.push(_mesh);}}this._itemsToRemove.length=this._itemsToAdd.length=0;if(meshToAdd.length+meshToRemove.length+meshToModify.length){var ms=this.meshes;this.meshSplits.forEach((function(split,i){return ms[i]=split.spriteMesh.mesh}));ms.length=this.meshSplits.length;return {add:meshToAdd.length?meshToAdd:undefined,remove:meshToRemove.length?meshToRemove:undefined,modify:meshToModify.length?meshToModify:undefined,layer:layer.layerToAdd.length>0?layer:undefined}}};_proto.addMeshSplitsItem=function addMeshSplitsItem(items,item,splits){var itemIndex=items.indexOf(item);if(itemIndex!==-1){throw Error("item has been added")}var firstSplit=splits[0];if(!firstSplit){arrAddWithOrder(items,item,itemSortProperty);if(isSprite(item)){var content=item.createContent();var split={indexStart:item.listIndex,indexEnd:item.listIndex,items:[item],renderInfo:content.renderInfo,cacheId:content.renderInfo.cacheId,textures:[item.content.renderer.texture]};splits.unshift(split);return [split]}return []}for(var i=0;i<splits.length;i++){var _split2=splits[i];var listIndex=item.listIndex;if(isSprite(item)){if(listIndex<=_split2.indexEnd){arrAddWithOrder(items,item,itemSortProperty);var _itemIndex=items.indexOf(item);var indexStart=Math.min(_itemIndex,items.indexOf(_split2.items[0]));var indexEnd=Math.max(_itemIndex,items.indexOf(_split2.items[_split2.items.length-1]));var neoSplits=this.getMeshSplits(items,indexStart,indexEnd);var neoSplitIndex=neoSplits.findIndex((function(split){return split.items.includes(item)}));if(neoSplits.length===2){splits.splice(i+neoSplitIndex,0,neoSplits[neoSplitIndex]);objAssign(_split2,neoSplits[1-neoSplitIndex]);return [neoSplits[neoSplitIndex]]}else if(neoSplits.length===3){objAssign(_split2,neoSplits[0]);splits.splice(i+1,0,neoSplits[1],neoSplits[2]);if(neoSplitIndex!==1){throw Error("neo split not in middle")}return [neoSplits[1],neoSplits[2]]}else if(neoSplits.length!==1){throw Error("invalid splits 1")}objAssign(_split2,neoSplits[0]);return []}}else {if(listIndex<_split2.indexStart||listIndex===_split2.indexEnd){arrAddWithOrder(items,item,itemSortProperty);return []}else if(listIndex<_split2.indexEnd){arrAddWithOrder(items,item,itemSortProperty);var lastItem=_split2.items[_split2.items.length-1];var endIndex=items.indexOf(lastItem);var _neoSplits=this.getMeshSplits(items,items.indexOf(_split2.items[0]),endIndex);objAssign(_split2,_neoSplits[0]);if(_neoSplits.length===2){splits.splice(i+1,0,_neoSplits[1]);return [_neoSplits[1]]}else if(_neoSplits.length!==1){throw Error("invalid splits 2")}}}}arrAddWithOrder(items,item,itemSortProperty);if(isSprite(item)){var last=splits[splits.length-1];var _neoSplits2=this.getMeshSplits(items,items.indexOf(last.items[0]),items.indexOf(item));objAssign(last,_neoSplits2[0]);if(_neoSplits2.length===2){splits.push(_neoSplits2[1]);return [_neoSplits2[1]]}else if(_neoSplits2.length!==1){throw Error("invalid splits 3")}}return []};_proto.removeMeshSplitsItem=function removeMeshSplitsItem(items,item,splits,itemsToRemove){var targetSplit;var targetSplitIndex;var ret=[];for(var i=0;i<splits.length;i++){var split=splits[i];if(split.indexStart<=item.listIndex&&split.indexEnd>=item.listIndex){targetSplit=split;targetSplitIndex=i;break}}if(targetSplit){var index=targetSplit.items.indexOf(item);if(index<0){if(itemsToRemove!=null&&itemsToRemove.includes(item)){return []}throw Error("item not found")}targetSplit.items.splice(index,1);targetSplit.dirty=true;arrRemove$1(items,item);if(targetSplit.items.length===0){arrRemove$1(splits,targetSplit);ret.push(targetSplit);targetSplitIndex=targetSplitIndex-1;targetSplit=splits[targetSplitIndex];if(!splits.length||targetSplitIndex<0){return ret}}else {targetSplit.indexEnd=targetSplit.items[targetSplit.items.length-1].listIndex;targetSplit.indexStart=targetSplit.items[0].listIndex;}if(targetSplitIndex===0||targetSplitIndex===splits.length-2){var p0=splits[targetSplitIndex];var p1=splits[targetSplitIndex+1];if(p0&&p1){var i0=p0.items[0];var i1=p1.items[p1.items.length-1];var meshes=this.getMeshSplits(items,items.indexOf(i0),items.indexOf(i1));if(meshes.length===1){meshes[0].spriteMesh=splits[targetSplitIndex].spriteMesh;splits[targetSplitIndex]=meshes[0];ret.push(splits.splice(targetSplitIndex+1,1)[0]);}}}else if(targetSplitIndex===splits.length-1){if(targetSplit.items.length===0){ret.push(splits.splice(targetSplitIndex,1)[0]);}else {var _p=splits[targetSplitIndex-1];var _p2=splits[targetSplitIndex];var _i9=_p.items[0];var _i10=_p2.items[_p2.items.length-1];var _meshes=this.getMeshSplits(items,items.indexOf(_i9),items.indexOf(_i10));if(_meshes.length===1){_meshes[0].spriteMesh=splits[targetSplitIndex-1].spriteMesh;splits[targetSplitIndex-1]=_meshes[0];ret.push(splits.splice(targetSplitIndex,1)[0]);}}}else {var _p3=splits[targetSplitIndex-1];var _p4=splits[targetSplitIndex+1];var _i11=_p3.items[0];var _i12=_p4.items[_p4.items.length-1];var _meshes2=this.getMeshSplits(items,items.indexOf(_i11),items.indexOf(_i12));if(_meshes2.length===2){_meshes2[0].spriteMesh=splits[targetSplitIndex].spriteMesh;_meshes2[1].spriteMesh=splits[targetSplitIndex+1].spriteMesh;splits[targetSplitIndex]=_meshes2[0];splits[targetSplitIndex+1]=_meshes2[1];ret.push(splits.splice(targetSplitIndex-1,1)[0]);}}}return ret};_proto.combineSplits=function combineSplits(items,itemIndex,splits){var item=items[itemIndex];var ret=[];if(isSprite(item)&&item.composition){var targetSplitIndex;for(var i=0;i<splits.length;i++){var split=splits[i];if(split.items.includes(item)){targetSplitIndex=i;break}}var p0,p1;if(targetSplitIndex===0){p0=splits[targetSplitIndex];p1=splits[targetSplitIndex+1];}else {p0=splits[targetSplitIndex-1];p1=splits[targetSplitIndex];}if(p0&&p1){var startIndex=items.indexOf(p0.items[0]);var endIndex=items.indexOf(p1.items[p1.items.length-1]);if(Number.isInteger(startIndex)&&Number.isInteger(endIndex)){var meshes=this.getMeshSplits(items,startIndex,endIndex);if(meshes.length===1){meshes[0].spriteMesh=splits[targetSplitIndex].spriteMesh;if(targetSplitIndex===0){splits[0]=meshes[0];ret.push(splits.splice(1,1)[0]);}else {ret.push(splits.splice(targetSplitIndex-1,1)[0]);splits[targetSplitIndex-1]=meshes[0];}}}}}return ret};_proto.getMeshSplits=function getMeshSplits(items,startIndex,endIndex,init){if(startIndex===void 0){startIndex=0;}if(endIndex===void 0){endIndex=items.length-1;}var current;var ret=[];for(var i=startIndex;i<=endIndex;i++){var item=items[i];if(!init&&(!item.contentVisible||item.lifetime<0)){continue}if(!isSprite(item)){if(init&&!item.contentVisible){continue}if(current){ret.push(current);current=null;}}else {var cacheId=item.createContent().renderInfo.cacheId;var texture=item.content.renderer.texture;var replaceCurrent=true;if(current){var texInc=current.textures.includes(texture)?0:1;if(current.cacheId===cacheId&&current.items.length<maxSpriteMeshItemCount&&texInc+current.textures.length<=maxSpriteTextureCount){arrAddWithOrder(current.items,item,itemSortProperty);arrAdd$1(current.textures,texture);replaceCurrent=false;}else {ret.push(current);}}if(replaceCurrent){current={indexStart:item.listIndex,cacheId:cacheId,renderInfo:item.content.renderInfo,items:[item],textures:[texture]};}}}if(current){ret.push(current);}ret.forEach((function(split){split.indexEnd=split.items[split.items.length-1].listIndex;split.dirty=true;}));return ret};_proto.addItem=function addItem(vfxItem){if(!this._items.includes(vfxItem)){arrAdd$1(this._itemsToAdd,vfxItem);}else {arrRemove$1(this._itemsToRemove,vfxItem);}};_proto.removeItem=function removeItem(item){if(this._items.includes(item)){if(isSprite(item)){this._itemsToRemove.unshift(item);}else {this._itemsToRemove.push(item);}}else {arrRemove$1(this._itemsToAdd,item);}};_proto.getSpriteMesh=function getSpriteMesh(item){var meshes=this.meshSplits;for(var i=0;i<meshes.length;i++){var mesh=meshes[i].spriteMesh;var itemIndex=mesh.items.indexOf(item);if(itemIndex>-1){return mesh}}};_proto._onUpdate=function _onUpdate(dt){var time=this.time+=dt/1e3;var splits=this.meshSplits;for(var i=0;i<splits.length;i++){var mesh=splits[i].spriteMesh;var _items=mesh.items;for(var j=0;j<_items.length;j++){var item=_items[j];item.updateTime(time);if(!item.ended){mesh.updateItem(item);}}mesh.applyChange();}};_proto.destroy=function destroy(){this.meshSplits.forEach((function(mesh){mesh.spriteMesh.mesh.destroy();}));};return SpriteGroup}();function isSprite(item){var type=item.type;return type==="1"||type==="8"}var SpriteLoader=function(_MarsPlugin){_inheritsLoose(SpriteLoader,_MarsPlugin);function SpriteLoader(){var _this;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_MarsPlugin.call.apply(_MarsPlugin,[this].concat(args))||this;_this.name="sprite";return _this}var _proto=SpriteLoader.prototype;_proto.spriteMeshShaderFromFilter=function spriteMeshShaderFromFilter$1(filter,options){return spriteMeshShaderFromFilter(filter,options)};_proto.onCompositionDestroyed=function onCompositionDestroyed(composition){var spriteGroup=composition.loaderData.spriteGroup;spriteGroup.destroy();};_proto.onCompositionReset=function onCompositionReset(composition,pipeline){var spriteGroup=composition.loaderData.spriteGroup=new SpriteGroup({calculateGroup:composition.calculateGroup});spriteGroup.resetMeshSplits();};_proto.onCompositionItemLifeBegin=function onCompositionItemLifeBegin(composition,item){var spriteGroup=composition.loaderData.spriteGroup;if(item.type!=="7"){spriteGroup.addItem(item);}};_proto.onCompositionItemRemoved=function onCompositionItemRemoved(composition,item){var spriteGroup=composition.loaderData.spriteGroup;spriteGroup.removeItem(item);};_proto.onCompositionUpdate=function onCompositionUpdate(composition,dt){var spriteGroup=composition.loaderData.spriteGroup;spriteGroup._onUpdate(dt);};_proto.prepareRenderFrame=function prepareRenderFrame(composition,renderFrame){var spriteGroup=composition.loaderData.spriteGroup;var ret=spriteGroup.diffMeshSplits();if(ret){var _ret$remove,_ret$add,_ret$modify;(_ret$remove=ret.remove)==null?void 0:_ret$remove.forEach((function(mesh){return renderFrame.removeMeshFromDefaultRenderPass(mesh)}));(_ret$add=ret.add)==null?void 0:_ret$add.forEach((function(mesh){return renderFrame.addMeshToDefaultRenderPass(mesh)}));(_ret$modify=ret.modify)==null?void 0:_ret$modify.forEach((function(mesh){renderFrame.removeMeshFromDefaultRenderPass(mesh);renderFrame.addMeshToDefaultRenderPass(mesh);}));return !!(this.layerInfo=ret.layer)}return false};_proto.postProcessFrame=function postProcessFrame(composition,pipeline){var _this$layerInfo$layer;(_this$layerInfo$layer=this.layerInfo.layerToAdd)==null?void 0:_this$layerInfo$layer.forEach((function(layer){var filterDefine=layer.items[0].filter;if(filterDefine){var rp=pipeline.splitDefaultRenderPassByMesh(layer.mesh,filterDefine.passSplitOptions);if(filterDefine.renderPassDelegate){rp.delegate=filterDefine.renderPassDelegate;}if(filterDefine.onRenderPassCreated){filterDefine.onRenderPassCreated(rp,pipeline);}}}));this.layerInfo=undefined;};return SpriteLoader}(MarsPlugin);var fs$1="uniform sampler2D uLastSource;uniform vec4 uParams;vec4 filterMain(vec2 a,sampler2D b){vec4 c=texture2D(b,a);if(uParams.x<1.){return c;}vec4 d=texture2D(uLastSource,a);return mix(c,d,uParams.y);}";function registerDelayFilter(comp){var tex=new MarsTexture({sourceType:TextureSourceType.framebuffer});var renderer=comp.renderer;var filterParams=[0,.96,0,0];return {mesh:{fragment:fs$1,shaderCacheId:"delay",uniformValues:{uLastSource:tex},variables:{uParams:function uParams(){return filterParams}},materialStates:{blending:true,blendSrc:constants.SRC_ALPHA,blendSrcAlpha:constants.SRC_ALPHA,blendDst:constants.ONE_MINUS_SRC_ALPHA,blendDstAlpha:constants.ONE_MINUS_SRC_ALPHA,depthTest:false}},passSplitOptions:{attachments:[{texture:{format:constants.RGBA}}]},onItemRemoved(){tex.destroy();},renderPassDelegate:{didEndRenderPass(pass,state){renderer.extension.copyTexture(pass.attachments[0].texture,tex);filterParams[0]=2;}}}}function cloneMeshWithShader(mesh,shader){var mtlOptions=Object.assign({},mesh.material.options);mtlOptions.shader=shader;mtlOptions.states={blending:false,cullFaceEnabled:false,depthTest:false};var ret=new MarsMesh({geometry:mesh.geometry,material:new MarsMaterial(mtlOptions)});mesh.material.dataBlocks.length=0;mesh.material.dataBlocks.forEach((function(d){return ret.material.addDataBlock(d)}));return ret}function cloneSpriteMesh(spriteMesh,composition,options){var plugin=composition.pluginSystem.plugins.find((function(p){return p.name==="sprite"}));var shader=plugin.spriteMeshShaderFromFilter({mesh:{fragment:options.fragment}},{env:composition.env,ignoreBlend:true});return cloneMeshWithShader(spriteMesh,shader)}function nearestPowerOfTwo(value){return Math.pow(2,Math.round(Math.log(value)/Math.LN2))}function getGaussianParams(radius){var sigma=(radius+1)/3.329;var nums=[];for(var i=-radius;i<=radius;i++){nums.push(gaussianParams(i,sigma));}return nums;function gaussianParams(x,sig){return Math.exp(-(x*x)/(2*sig*sig))/Math.sqrt(2*Math.PI)/sig}}function gaussianFilter(opt){var downSample=opt.radius<=3?1:2;var radius=opt.radius/downSample;var maxStep=opt.maxStep||4;while(radius>10&&downSample<maxStep){downSample*=2;radius=opt.radius/downSample;}var step=1+opt.radius%downSample/downSample/downSample;radius=Math.floor(radius);var floats=getGaussianParams(radius);var steps=[];for(var i=-radius;i<=radius;i++){var weight=floats[i+radius];steps.push("color += texture2D(uBlurSource,getTexCoord("+i.toFixed(1)+")) * "+weight+";");}var ret={shader:"\n  uniform sampler2D uBlurSource;\n  uniform vec2 uTexSize;\n  uniform vec2 uTexStep;\n  #define getTexCoord(i) coord + uTexStep/uTexSize * i\n  vec4 filterMain(vec2 coord,sampler2D tex){\n    vec4 color = vec4(0.);\n    vec2 texCoord;\n    "+steps.join("\n")+"\n    return color;\n  }\n  ",step:step,downSample:downSample,radius:radius};return ret}var GAUSSIAN_SEMANTIC_DIRECTION="GAUSSIAN_DIR";var GAUSSIAN_SOURCE="GAUSSIAN_SOURCE";function registerGaussianFilter(comp,filter){var f=gaussianFilter({radius:filter.radius});var texWidth=Math.round(comp.renderer.width/f.downSample);var texHeight=Math.round(comp.renderer.height/f.downSample);if(comp.renderer.gpu.level===1){texHeight=nearestPowerOfTwo(texHeight);texWidth=nearestPowerOfTwo(texWidth);}var viewport=[0,0,texWidth,texHeight];var gaussianTextureV=comp.renderFrame.passTextureCache.requestColorAttachmentTexture({minFilter:constants.LINEAR,magFilter:constants.LINEAR,name:"gaussianV",width:texWidth,height:texHeight});var gaussianTextureH=comp.renderFrame.passTextureCache.requestColorAttachmentTexture({minFilter:constants.LINEAR,magFilter:constants.LINEAR,name:"gaussianH",width:texWidth,height:texHeight});return {mesh:{fragment:copy,shaderCacheId:"gaussian:"+f.step,uniformValues:{uFrameSource:gaussianTextureV,uTexSize:[texWidth,texHeight]},uniformSemantics:{uBlurSource:GAUSSIAN_SOURCE,uTexStep:GAUSSIAN_SEMANTIC_DIRECTION,uFilterSource:"PRE_COLOR_ATTACHMENT_0",uFilterSourceSize:"PRE_COLOR_ATTACHMENT_SIZE_0"},materialStates:{blending:false,cullFaceEnabled:false}},passSplitOptions:{attachments:[{texture:{format:constants.RGBA}}],prePasses:[{setMeshes(meshes){return [meshes[0],cloneSpriteMesh(meshes[1],comp,{fragment:f.shader})]},pass:{name:"gaussianH",viewport:viewport,attachments:[{texture:gaussianTextureH}],clearAction:{colorAction:TextureLoadAction.clear},semantics:{[GAUSSIAN_SEMANTIC_DIRECTION]:[0,f.step],[GAUSSIAN_SOURCE]:function(state){var _comp$renderFrame$fin;return (_comp$renderFrame$fin=comp.renderFrame.findPreviousRenderPass(state.currentPass).attachments[0])==null?void 0:_comp$renderFrame$fin.texture}}}},{setMeshes(meshes){return [meshes[0],cloneSpriteMesh(meshes[1],comp,{fragment:f.shader})]},pass:{name:"gaussianV",viewport:viewport,attachments:[{texture:gaussianTextureV}],clearAction:{colorAction:TextureLoadAction.clear},semantics:{[GAUSSIAN_SEMANTIC_DIRECTION]:[f.step,0],[GAUSSIAN_SOURCE]:gaussianTextureH}}}]}}}var threshold="uniform vec4 uColorThreshold;vec4 filterMain(vec2 a,sampler2D b){vec4 c=texture2D(b,a);vec3 d=c.rgb*c.a;vec3 e=step(uColorThreshold.xyz,d);float f=min(e.r+e.g+e.b,1.);return c*f;}";var mix="uniform sampler2D uBloomBlur;uniform vec4 uBloomParams;vec4 filterMain(vec2 a,sampler2D b){const vec3 c=vec3(1./2.2);vec4 d=texture2D(b,a);vec4 e=texture2D(uBloomBlur,a);float f=max(d.a,e.a);vec3 g=max(d.rgb*d.a,e.rgb*e.a)/f*uBloomParams.y+e.rgb*uBloomParams.x;return vec4(g,f);}";function registerBloomFilter(comp,filter){var gaussian=gaussianFilter({radius:filter.radius||30});var width=Math.round(comp.renderer.width/gaussian.downSample);var height=Math.round(comp.renderer.width/gaussian.downSample);if(comp.renderer.gpu.level===1){width=nearestPowerOfTwo(width);height=nearestPowerOfTwo(height);}var viewport=[0,0,width,height];var blurTarget=comp.renderFrame.passTextureCache.requestColorAttachmentTexture({format:constants.RGBA,magFilter:constants.LINEAR,minFilter:constants.LINEAR,name:"gaussianV",width:width,height:height});var blurInterMedia=comp.renderFrame.passTextureCache.requestColorAttachmentTexture({format:constants.RGBA,magFilter:constants.LINEAR,minFilter:constants.LINEAR,name:"gaussianH",width:width,height:height});var bloomAddOn=createValueGetter(filter.bloomAddon||.4);var colorAddOn=createValueGetter(filter.colorAddon||1);var colorWeights=filter.colorThreshold||[255,255,255];return {mesh:{fragment:mix,shaderCacheId:"bloom:"+gaussian.step,variables:{uBloomParams:function uBloomParams(life){return [bloomAddOn.getValue(life),colorAddOn.getValue(life),0,1]}},uniformSemantics:{uBlurSource:GAUSSIAN_SOURCE,uSamplerPre:"PRE_MAIN_COLOR_0",uTexStep:GAUSSIAN_SEMANTIC_DIRECTION,uTexSize:"PRE_COLOR_ATTACHMENT_SIZE_0"},uniformValues:{uColorThreshold:[colorWeights[0]/255||1.1,colorWeights[1]/255||1.1,colorWeights[2]/255||1.1,0],uBloomBlur:blurTarget},materialStates:{blending:false}},onItemRemoved(){blurTarget.destroy();blurInterMedia.destroy();},passSplitOptions:{attachments:[{texture:{format:constants.RGBA}}],prePasses:[{setMeshes(meshes){return [cloneSpriteMesh(meshes[1],comp,{fragment:threshold})]},pass:{name:"threshold",attachments:[{texture:blurTarget}],viewport:viewport,clearAction:{colorAction:TextureLoadAction.clear}}},{pass:{name:"gaussianH",attachments:[{texture:blurInterMedia}],clearAction:{colorAction:TextureLoadAction.clear},viewport:viewport,semantics:{[GAUSSIAN_SEMANTIC_DIRECTION]:[gaussian.step,0],[GAUSSIAN_SOURCE]:blurTarget,["PRE_COLOR_ATTACHMENT_SIZE_0"]:function PRE_COLOR_ATTACHMENT_SIZE_0(){return [blurTarget.width,blurTarget.height]}}},setMeshes(ms){return [cloneSpriteMesh(ms[1],comp,{fragment:gaussian.shader})]}},{pass:{name:"gaussianV",attachments:[{texture:blurTarget}],viewport:viewport,semantics:{[GAUSSIAN_SEMANTIC_DIRECTION]:[0,gaussian.step],[GAUSSIAN_SOURCE]:blurInterMedia,["PRE_COLOR_ATTACHMENT_SIZE_0"]:function PRE_COLOR_ATTACHMENT_SIZE_0(){return [blurInterMedia.width,blurInterMedia.height]}}},setMeshes(ms){return [cloneSpriteMesh(ms[1],comp,{fragment:gaussian.shader})]}}]}}}var fs="uniform vec4 uWaveParams;\n#ifdef PATICLE_SHADER\nin vec4 vWaveParams;\n#else\nuniform vec4 vWaveParams;\n#endif\nvec4 filterMain(vec2 texCoord,sampler2D a){vec2 b=texCoord-uWaveParams.xy;float c=dot(b,uWaveParams.zw);float d=sin(vWaveParams.x*c+vWaveParams.y)*vWaveParams.z;vec2 e=vec2(-uWaveParams.w,uWaveParams.z)*d;return texture2D(a,clamp(texCoord+e,0.,1.));}";var vs="uniform vec4 uMovementValue;uniform vec4 uStrengthValue;uniform vec4 uPeriodValue;out vec4 vWaveParams;void filterMain(float lifetime){const float a=3.14159265;vWaveParams=vec4(getValueFromTime(lifetime,uPeriodValue)*a,getValueFromTime(lifetime,uMovementValue)*a,getValueFromTime(lifetime,uStrengthValue),0.);}";function registerDistortionFilter(comp,filter){var center=filter.center||[.5,.5];var dir=vecNormalize(filter.direction||[1,0]);var uWaveParams=[center[0],center[1],dir[0],dir[1]];var uPeriodValue=createValueGetter(filter.period);var uMovementValue=createValueGetter(filter.waveMovement);var uStrengthValue=createValueGetter(filter.strength);var PI2=Math.PI*2;return {particle:{fragment:fs,vertex:vs,uniforms:{uPeriodValue:uPeriodValue,uMovementValue:uMovementValue,uStrengthValue:uStrengthValue},uniformValues:{uWaveParams:uWaveParams}},mesh:{shaderCacheId:"distortion",fragment:fs,materialStates:{blending:false,cullFaceEnabled:false},variables:{vWaveParams(life){return [uPeriodValue.getValue(life)*PI2,uMovementValue.getValue(life)*PI2,uStrengthValue.getValue(life),0]}},uniformValues:{uWaveParams:uWaveParams}}}}var ArcModeRandom=0;var ArcModeLoop=1;var ArcModePingPong=2;var ArcModeBurstSpread=3;var RENDER_MODE_BILLBOARD=0;var RENDER_MODE_VERTICAL_BILLBOARD=2;var RENDER_MODE_HORIZONTAL_BILLBOARD=3;var RENDER_MODE_MESH=1;var BLEND_MODE_ADDITIVE=1;var BLEND_MODE_ALPHA=0;var BLEND_MODE_MULTIPLY=2;var BLEND_MODE_LUMINANCE_ALPHA=3;var BLEND_MODE_SUBTRACT=4;var BLEND_MODE_ADD_LIGHT=5;var BLEND_MODE_LIGHT=6;var BLEND_MODE_LUMINANCE_ADDITIVE=7;var PARTICLE_ORIGIN_CENTER=0;var PARTICLE_ORIGIN_LEFT_TOP=1;var PARTICLE_ORIGIN_LEFT_CENTER=2;var PARTICLE_ORIGIN_LEFT_BOTTOM=3;var PARTICLE_ORIGIN_CENTER_TOP=4;var PARTICLE_ORIGIN_CENTER_BOTTOM=5;var PARTICLE_ORIGIN_RIGHT_TOP=6;var PARTICLE_ORIGIN_RIGHT_CENTER=7;var PARTICLE_ORIGIN_RIGHT_BOTTOM=8;var END_BEHAVIOR_DESTROY=0;var END_BEHAVIOR_PAUSE=1;var END_BEHAVIOR_FORWARD=2;var END_BEHAVIOR_PAUSE_AND_DESTROY=3;var END_BEHAVIOR_FREEZE=4;var END_BEHAVIOR_RESTART=5;var END_BEHAVIOR_DESTROY_CHILDREN=6;var FILTER_NAME_NONE="none";var INTERACT_BEHAVIOR_NOTIFY=0;var INTERACT_BEHAVIOR_RESUME_PLAYER=1;var INTERACT_BEHAVIOR_NONE=2;var DEG2RAD=.017453292519943295;var MESSAGE_ITEM_PHRASE_BEGIN=2;var MESSAGE_ITEM_PHRASE_END=1;var CLICK_BEHAVIOR_NONE=0;var CLICK_BEHAVIOR_DESTROY_PARTICLE=1;var MASK_MODE_NONE=0;var MASK_MODE_WRITE_MASK=1;var MASK_MODE_READ_MASK=2;var MASK_MODE_READ_INVERT_MASK=3;var RENDER_LEVEL_B_PLUS="B+";var RENDER_LEVEL_B="B";var RENDER_LEVEL_A_PLUS="A+";var RENDER_LEVEL_A="A";var RENDER_LEVEL_S="S";var RENDER_LEVEL_FAIL="F";var SIDE_BOTH=1032;var SIDE_FRONT=1028;var SIDE_BACK=1029;var PARTICLE_HIT_TEST_MODE_RAY=0;var PARTICLE_HIT_TEST_MODE_BOX=1;var VFX_ITEM_TYPE_BASE="0";var VFX_ITEM_TYPE_SPRITE="1";var VFX_ITEM_TYPE_PARTICLE="2";var VFX_ITEM_TYPE_NULL="3";var VFX_ITEM_TYPE_INTERACT="4";var VFX_ITEM_TYPE_PLUGIN="5";var VFX_ITEM_TYPE_CAMERA="6";var VFX_ITEM_TYPE_COMPOSITION="7";var VFX_ITEM_TYPE_FILTER_SPRITE="8";var VFX_ITEM_TYPE_TREE="tree";var PLAYER_OPTIONS_ENV_EDITOR="editor";var DESTROY_OPT_NODE_CHILDREN=2;var DESTROY_OPT_MESH=4;var DESTROY_OPT_GEOMETRY=8;var DESTROY_OPT_TEXTURE=16;var DESTROY_OPT_ALL=30;var COMPRESSED_TEXTURE_NONE=0;var COMPRESSED_TEXTURE_PVRTC=1;var COMPRESSED_TEXTURE_ASTC=2;var SPRITE_VERTEX_STRIDE=6;var RESTORE_TYPE_IMAGE_URL=1;var RESTORE_TYPE_BUFFER_URL=2;var CAMERA_CLIP_MODE_NORMAL=0;var CAMERA_CLIP_MODE_VERTICAL=1;var SEMANTIC_PRE_COLOR_ATTACHMENT_0="PRE_COLOR_ATTACHMENT_0";var SEMANTIC_PRE_COLOR_ATTACHMENT_SIZE_0="PRE_COLOR_ATTACHMENT_SIZE_0";var SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_0="PRE_MAIN_COLOR_0";var SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_SIZE_0="PRE_MAIN_COLOR_SIZE_0";registerPlugin("camera",CameraVFXItemLoader,CameraVFXItem,true);registerPlugin("sprite",SpriteLoader,SpriteVFXItem,true);registerPlugin("particle",ParticleLoader,ParticleVFXItem,true);registerPlugin("cal",CalculateLoader,CalculateVFXItem,true);registerPlugin("interact",InteractLoader,InteractiveVFXItem,true);registerPlugin("filter",SpriteLoader,FilterSpriteVFXItem,true);registerPlugin("tree",CalculateLoader,TreeVFXItem,true);registerFilters({bloom:registerBloomFilter,gaussian:registerGaussianFilter,delay:registerDelayFilter,distortion:registerDistortionFilter});var version$1="1.1.37";consoleLog$1("version: "+"1.1.37");var Mars$1=Object.freeze({__proto__:null,MarsPlayer:MarsPlayer,registerFilter:registerFilter,registerFilters:registerFilters,getPlayerByCanvas:getPlayerByCanvas,unregisterPlugin:unregisterPlugin,getActivePlayers:getActivePlayers,RI:index,version:version$1,inspectLogger:inspectLogger,passRenderLevel:passRenderLevel,Camera:Camera,VFXItem:VFXItem,ParticleSystem:ParticleSystem,TrailMesh:TrailMesh,registerPlugin:registerPlugin,MarsPlugin:MarsPlugin,imageDataFromGradient:imageDataFromGradient,createValueGetter:createValueGetter,SpriteGroup:SpriteGroup,SpriteItem:SpriteItem,Composition:Composition,getVFXItem:getVFXItem,getCompositionByName:getCompositionByName,loadSceneAsync:loadSceneAsync,MarsPlayerRenderFrame:MarsPlayerRenderFrame,combineImageTemplateAsync:combineImageTemplateAsync,_combineImageTemplateAsync:combineImageTemplate2Async,CameraController:CameraController,setAlipayDowngradeBizId:setAlipayDowngradeBizId,checkDowngradeAsync:checkDowngradeAsync,get HitTestType(){return HitTestType},get HitTestBehavior(){return HitTestBehavior},ArcModeRandom:ArcModeRandom,ArcModeLoop:ArcModeLoop,ArcModePingPong:ArcModePingPong,ArcModeBurstSpread:ArcModeBurstSpread,RENDER_MODE_BILLBOARD:RENDER_MODE_BILLBOARD,RENDER_MODE_VERTICAL_BILLBOARD:RENDER_MODE_VERTICAL_BILLBOARD,RENDER_MODE_HORIZONTAL_BILLBOARD:RENDER_MODE_HORIZONTAL_BILLBOARD,RENDER_MODE_MESH:RENDER_MODE_MESH,BLEND_MODE_ADDITIVE:BLEND_MODE_ADDITIVE,BLEND_MODE_ALPHA:BLEND_MODE_ALPHA,BLEND_MODE_MULTIPLY:BLEND_MODE_MULTIPLY,BLEND_MODE_LUMINANCE_ALPHA:BLEND_MODE_LUMINANCE_ALPHA,BLEND_MODE_SUBTRACT:BLEND_MODE_SUBTRACT,BLEND_MODE_ADD_LIGHT:BLEND_MODE_ADD_LIGHT,BLEND_MODE_LIGHT:BLEND_MODE_LIGHT,BLEND_MODE_LUMINANCE_ADDITIVE:BLEND_MODE_LUMINANCE_ADDITIVE,PARTICLE_ORIGIN_CENTER:PARTICLE_ORIGIN_CENTER,PARTICLE_ORIGIN_LEFT_TOP:PARTICLE_ORIGIN_LEFT_TOP,PARTICLE_ORIGIN_LEFT_CENTER:PARTICLE_ORIGIN_LEFT_CENTER,PARTICLE_ORIGIN_LEFT_BOTTOM:PARTICLE_ORIGIN_LEFT_BOTTOM,PARTICLE_ORIGIN_CENTER_TOP:PARTICLE_ORIGIN_CENTER_TOP,PARTICLE_ORIGIN_CENTER_BOTTOM:PARTICLE_ORIGIN_CENTER_BOTTOM,PARTICLE_ORIGIN_RIGHT_TOP:PARTICLE_ORIGIN_RIGHT_TOP,PARTICLE_ORIGIN_RIGHT_CENTER:PARTICLE_ORIGIN_RIGHT_CENTER,PARTICLE_ORIGIN_RIGHT_BOTTOM:PARTICLE_ORIGIN_RIGHT_BOTTOM,END_BEHAVIOR_DESTROY:END_BEHAVIOR_DESTROY,END_BEHAVIOR_PAUSE:END_BEHAVIOR_PAUSE,END_BEHAVIOR_FORWARD:END_BEHAVIOR_FORWARD,END_BEHAVIOR_PAUSE_AND_DESTROY:END_BEHAVIOR_PAUSE_AND_DESTROY,END_BEHAVIOR_FREEZE:END_BEHAVIOR_FREEZE,END_BEHAVIOR_RESTART:END_BEHAVIOR_RESTART,END_BEHAVIOR_DESTROY_CHILDREN:END_BEHAVIOR_DESTROY_CHILDREN,FILTER_NAME_NONE:FILTER_NAME_NONE,INTERACT_BEHAVIOR_NOTIFY:INTERACT_BEHAVIOR_NOTIFY,INTERACT_BEHAVIOR_RESUME_PLAYER:INTERACT_BEHAVIOR_RESUME_PLAYER,INTERACT_BEHAVIOR_NONE:INTERACT_BEHAVIOR_NONE,DEG2RAD:DEG2RAD,MESSAGE_ITEM_PHRASE_BEGIN:MESSAGE_ITEM_PHRASE_BEGIN,MESSAGE_ITEM_PHRASE_END:MESSAGE_ITEM_PHRASE_END,CLICK_BEHAVIOR_NONE:CLICK_BEHAVIOR_NONE,CLICK_BEHAVIOR_DESTROY_PARTICLE:CLICK_BEHAVIOR_DESTROY_PARTICLE,MASK_MODE_NONE:MASK_MODE_NONE,MASK_MODE_WRITE_MASK:MASK_MODE_WRITE_MASK,MASK_MODE_READ_MASK:MASK_MODE_READ_MASK,MASK_MODE_READ_INVERT_MASK:MASK_MODE_READ_INVERT_MASK,RENDER_LEVEL_B_PLUS:RENDER_LEVEL_B_PLUS,RENDER_LEVEL_B:RENDER_LEVEL_B,RENDER_LEVEL_A_PLUS:RENDER_LEVEL_A_PLUS,RENDER_LEVEL_A:RENDER_LEVEL_A,RENDER_LEVEL_S:RENDER_LEVEL_S,RENDER_LEVEL_FAIL:RENDER_LEVEL_FAIL,SIDE_BOTH:SIDE_BOTH,SIDE_FRONT:SIDE_FRONT,SIDE_BACK:SIDE_BACK,PARTICLE_HIT_TEST_MODE_RAY:PARTICLE_HIT_TEST_MODE_RAY,PARTICLE_HIT_TEST_MODE_BOX:PARTICLE_HIT_TEST_MODE_BOX,VFX_ITEM_TYPE_BASE:VFX_ITEM_TYPE_BASE,VFX_ITEM_TYPE_SPRITE:VFX_ITEM_TYPE_SPRITE,VFX_ITEM_TYPE_PARTICLE:VFX_ITEM_TYPE_PARTICLE,VFX_ITEM_TYPE_NULL:VFX_ITEM_TYPE_NULL,VFX_ITEM_TYPE_INTERACT:VFX_ITEM_TYPE_INTERACT,VFX_ITEM_TYPE_PLUGIN:VFX_ITEM_TYPE_PLUGIN,VFX_ITEM_TYPE_CAMERA:VFX_ITEM_TYPE_CAMERA,VFX_ITEM_TYPE_COMPOSITION:VFX_ITEM_TYPE_COMPOSITION,VFX_ITEM_TYPE_FILTER_SPRITE:VFX_ITEM_TYPE_FILTER_SPRITE,VFX_ITEM_TYPE_TREE:VFX_ITEM_TYPE_TREE,PLAYER_OPTIONS_ENV_EDITOR:PLAYER_OPTIONS_ENV_EDITOR,DESTROY_OPT_NODE_CHILDREN:DESTROY_OPT_NODE_CHILDREN,DESTROY_OPT_MESH:DESTROY_OPT_MESH,DESTROY_OPT_GEOMETRY:DESTROY_OPT_GEOMETRY,DESTROY_OPT_TEXTURE:DESTROY_OPT_TEXTURE,DESTROY_OPT_ALL:DESTROY_OPT_ALL,COMPRESSED_TEXTURE_NONE:COMPRESSED_TEXTURE_NONE,COMPRESSED_TEXTURE_PVRTC:COMPRESSED_TEXTURE_PVRTC,COMPRESSED_TEXTURE_ASTC:COMPRESSED_TEXTURE_ASTC,SPRITE_VERTEX_STRIDE:SPRITE_VERTEX_STRIDE,RESTORE_TYPE_IMAGE_URL:RESTORE_TYPE_IMAGE_URL,RESTORE_TYPE_BUFFER_URL:RESTORE_TYPE_BUFFER_URL,CAMERA_CLIP_MODE_NORMAL:CAMERA_CLIP_MODE_NORMAL,CAMERA_CLIP_MODE_VERTICAL:CAMERA_CLIP_MODE_VERTICAL,SEMANTIC_PRE_COLOR_ATTACHMENT_0:SEMANTIC_PRE_COLOR_ATTACHMENT_0,SEMANTIC_PRE_COLOR_ATTACHMENT_SIZE_0:SEMANTIC_PRE_COLOR_ATTACHMENT_SIZE_0,SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_0:SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_0,SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_SIZE_0:SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_SIZE_0,setMtlBlending:setMtlBlending,setMtlStencil:setMtlStencil,enlargeBuffer:enlargeBuffer,createEmptyTextureContainer:createEmptyTextureContainer,sideToMtlStates:sideToMtlStates,createDataTexture:createDataTexture,createGradientTexture:createGradientTexture,createHalfFloatTexture:createHalfFloatTexture,Transform:Transform,setRayFromCamera:setRayFromCamera,intersectRaySphere:intersectRaySphere,intersectRayBox:intersectRayBox,trianglesFromRect:trianglesFromRect,intersectRayTriangle:intersectRayTriangle,dotInTriangle:dotInTriangle,Tree:Tree,TreeVFXItem:TreeVFXItem,vecAdd:vecAdd,vecFill:vecFill,vecAddCombine:vecAddCombine,vecAssign:vecAssign,vecMulCombine:vecMulCombine,mat3NormalFromMat4:mat3NormalFromMat4,vecMinus:vecMinus,vecSquareDistance:vecSquareDistance,NumberEpsilon:NumberEpsilon,vecNormalize:vecNormalize,vecMulScalar:vecMulScalar,vecDot:vecDot,vec3Cross:vec3Cross,vec3MulMat4:vec3MulMat4,vec3TranslateByMat4:vec3TranslateByMat4,vec3RotateByMat4:vec3RotateByMat4,vec3MulMat3:vec3MulMat3,mat3FromRotationZ:mat3FromRotationZ,mat3FromRotation:mat3FromRotation,invertMat4:invertMat4,isZeroVec:isZeroVec,ensureVec3:ensureVec3,rotateVec2:rotateVec2,rotationFromMat3:rotationFromMat3,mat3MulMat3:mat3MulMat3,clamp:clamp,mat4create:mat4create,mat4perspective:mat4perspective,mat4fromRotationTranslationScale:mat4fromRotationTranslationScale,mat4Determinate:mat4Determinate,getMat4TR:getMat4TR,getMat4TRS:getMat4TRS,mat4multiply:mat4multiply,mat4Clone:mat4Clone,mat4invert:mat4invert,RENDER_PREFER_LOOKUP_TEXTURE:RENDER_PREFER_LOOKUP_TEXTURE,LOAD_PREFER_IMAGE_BITMAP:LOAD_PREFER_IMAGE_BITMAP,TEMPLATE_USE_OFFSCREEN_CANVAS:TEMPLATE_USE_OFFSCREEN_CANVAS,getConfig:getConfig,setConfig:setConfig,isiOS:isiOS,getPixelRatio:getPixelRatio,isSimulatorCellPhone:isSimulatorCellPhone,isMac:isMac,isAndroid:isAndroid});if(typeof window==="object"){window.Mars=Mars$1;}else if(typeof global==="object"){global.Mars=Mars$1;}

  var version = "1.0.0";

  var _karas$refresh = karas__default["default"].refresh;
    _karas$refresh.level.CACHE;
    _karas$refresh.webgl.drawTextureCache;
    karas__default["default"].math.matrix.calRectPoint;
    karas__default["default"].util.isNil;
    var _karas$mode = karas__default["default"].mode;
    _karas$mode.CANVAS;
    var WEBGL = _karas$mode.WEBGL;
    karas__default["default"].inject;
  var vertexSimple = "\nprecision lowp float;\nattribute vec2 aPos;\nvoid main(){ gl_Position = vec4(aPos,.0,1.);}\n";
  var fragmentSimple = "\nprecision lowp float;\nvoid main(){ gl_FragColor = vec4(1.);}\n";
  var $ = /*#__PURE__*/function (_karas$Geom) {
    _inherits($, _karas$Geom);
    function $(tagName, props) {
      var _this;
      _this = _karas$Geom.call(this, tagName, props) || this;
      _defineProperty(_assertThisInitialized(_this), "scene", null);
      _defineProperty(_assertThisInitialized(_this), "mp", null);
      _defineProperty(_assertThisInitialized(_this), "timeDelta", 0);
      return _this;
    }
    _createClass$1($, [{
      key: "render",
      value: function render(renderMode, ctx, dx, dy) {
        var _this2 = this;
        var res = _get(_getPrototypeOf($.prototype), "render", this).call(this, renderMode, ctx, dx, dy);
        if (res["break"]) {
          return res;
        }
        var root = this.__root;
        if (renderMode !== root.__renderMode || renderMode !== WEBGL) {
          return res;
        }
        var scene = this.scene;
        if (scene) {
          var mp = this.mp;
          if (!mp) {
            var gl = ctx;
            mp = this.mp = new MarsPlayer({
              gl: gl,
              manualRender: true
            });
            this.gpu = mp.renderer.gpu;
            this.renderState = mp.renderer.internal.state;
            this.defaultMtl = new index.Material({
              name: 'defMtl',
              shader: {
                vertex: vertexSimple,
                fragment: fragmentSimple,
                shared: true
              },
              states: {
                blending: true,
                blendSrc: gl.ONE,
                blendSrcAlpha: gl.ONE,
                blendDst: gl.ONE_MINUS_SRC_ALPHA,
                blendDstAlpha: gl.ONE_MINUS_SRC_ALPHA,
                depthMask: true,
                depthTest: false,
                cullFaceEnabled: false,
                frontFace: gl.CCW,
                stencilTest: false,
                polygonOffsetFill: false,
                polygonOffset: [1, 0]
              }
            }).assignRenderer(mp.renderer);
            this.renderState.bindFramebuffer(gl.FRAMEBUFFER, null);
            this.renderState.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);
            this.renderState.noCache = true;
            var flipY = gl.getParameter(gl.UNPACK_FLIP_Y_WEBGL);
            var premultiply = gl.getParameter(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL);
            var program = gl.getParameter(gl.CURRENT_PROGRAM);
            gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);
            var activeTexIndex = gl.getParameter(gl.ACTIVE_TEXTURE);
            var originTexture = gl.getParameter(gl.TEXTURE_BINDING_2D);
            var composition = this.composition = mp.initializeComposition(scene, {
              onEnd: function onEnd() {},
              keepResource: false,
              willReverseTime: false
            });
            var onComp = function onComp() {
              composition.start();
              if (originTexture) {
                gl.bindTexture(gl.TEXTURE_2D, originTexture);
              }
              gl.activeTexture(activeTexIndex);
              composition.camera = {
                aspect: _this2.width / _this2.height
              };
              _this2.renderState.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, +premultiply);
              _this2.renderState.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, +flipY);
              _this2.renderState.useProgram(null);
              gl.useProgram(program);
              scene.textures = void 0;
            };
            onComp();
          }
          var comp = this.composition;
          var renderer = comp && comp.renderer;
          if (renderer && !renderer.isDestroyed && !mp.paused) {
            this._updateTransform();
            this._updateComposition();
            comp.renderFrame.render();
          }
        }
      }
    }, {
      key: "_updateTransform",
      value: function _updateTransform() {}
    }, {
      key: "_updateComposition",
      value: function _updateComposition() {
        var comp = this.composition;
        if (comp.shouldRestart) {
          comp.restart();
        } else if (!comp.shouldDestroy) {
          var dt = Math.min(this.timeDelta || 0, 33);
          comp.tick(dt);
        }
      }
    }]);
    return $;
  }(karas__default["default"].Geom);
  var Mars = /*#__PURE__*/function (_karas$Component) {
    _inherits(Mars, _karas$Component);
    function Mars(props) {
      var _this3;
      _this3 = _karas$Component.call(this, props) || this;
      _defineProperty(_assertThisInitialized(_this3), "isPlay", false);
      _defineProperty(_assertThisInitialized(_this3), "isLoaded", false);
      _defineProperty(_assertThisInitialized(_this3), "__playbackRate", 1);
      _this3.isPlay = props.autoPlay !== false;
      _this3.__playbackRate = props.playbackRate || 1;
      return _this3;
    }
    _createClass$1(Mars, [{
      key: "componentDidMount",
      value: function componentDidMount() {
        var _this4 = this;
        this.load();
        var fake = this.ref.fake;
        fake.frameAnimate(function (timeDelta) {
          fake.timeDelta = timeDelta;
          if (_this4.isPlay && _this4.isLoaded) {
            fake.refresh();
          }
        });
      }
    }, {
      key: "componentWillUnmount",
      value: function componentWillUnmount() {}
    }, {
      key: "load",
      value: function load() {
        var _this5 = this;
        var url = this.props.url;
        if (!url) {
          return;
        }
        var request = new XMLHttpRequest();
        request.open('get', url, true);
        request.responseType = 'json';
        request.onload = function () {
          if (request.response) {
            _this5.isLoaded = true;
            var json = request.response;
            loadSceneAsync(json, {}).then(function (scene) {
              var _this5$props$onLoad, _this5$props;
              (_this5$props$onLoad = (_this5$props = _this5.props).onLoad) === null || _this5$props$onLoad === void 0 ? void 0 : _this5$props$onLoad.call(_this5$props);
              _this5.playAnimation(scene);
            });
          }
        };
        request.send();
      }
    }, {
      key: "playAnimation",
      value: function playAnimation(scene) {
        console.log(scene);
        var fake = this.ref.fake;
        fake.scene = scene;
        // 第一帧强制显示
        fake.refresh();
      }
    }, {
      key: "render",
      value: function render() {
        // return karas.createElement('div', {},
        //   karas.createElement($, {
        //     ref: 'fake',
        //     style: {
        //       width: '100%',
        //       height: '100%',
        //       fill: 'none',
        //       stroke: 0,
        //     },
        //   }));
        return karas__default["default"].createElement("div", null, karas__default["default"].createElement($, {
          ref: "fake",
          style: {
            width: '100%',
            height: '100%',
            fill: 'none',
            stroke: 0
          }
        }));
      }
    }]);
    return Mars;
  }(karas__default["default"].Component);
  Mars.version = version;

  return Mars;

}));
//# sourceMappingURL=index.js.map
